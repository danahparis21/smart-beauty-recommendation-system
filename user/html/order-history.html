
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <title>Blessence | Order History</title>
    <link rel="icon" href="../../admin/images/mainlogo1.png" type="image/png" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary-pink: #ff69b4;
        --light-pink: #ffb6c1;
        --dark-pink: #ff1493;
        --gold: #d4af37;
        --light-gold: #f7e8c4;
        --soft-white: #fefefe;
        --light-gray: #f5f5f5;
        --medium-gray: #e0e0e0;
        --text-gray: #888;
        --dark-gray: #555;
        --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        --gradient-bg: linear-gradient(
          135deg,
          #ffffff 0%,
          #fff5f9 30%,
          #ffe6f2 70%,
          #ffd1dc 100%
        );
        --gradient-header: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.95) 0%,
          rgba(255, 249, 252, 0.95) 100%
        );
        --gradient-card: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.95) 0%,
          rgba(255, 249, 252, 0.95) 100%
        );
      }

      body {
        background: var(--gradient-bg);
        min-height: 100vh;
        font-family: "Montserrat", sans-serif;
        overflow-x: hidden;
        position: relative;
        background-attachment: fixed;
      }

      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(
            circle at 10% 20%,
            rgba(255, 255, 255, 0.8) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 90% 80%,
            rgba(255, 182, 193, 0.3) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 50% 50%,
            rgba(255, 105, 180, 0.1) 0%,
            transparent 50%
          );
        z-index: -1;
      }

      /* Header Styles */
      .header {
        background: var(--gradient-header);
        box-shadow: 0 5px 20px rgba(255, 105, 180, 0.1);
        padding: 15px 20px;
        position: sticky;
        top: 0;
        z-index: 100;
        display: flex;
        justify-content: space-between;
        align-items: center;
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 182, 193, 0.2);
      }

      .back-button {
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        color: white;
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(255, 105, 180, 0.3);
        font-size: 18px;
      }

      .back-button:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 8px 20px rgba(255, 105, 180, 0.4);
      }

      .brand-header {
        text-align: center;
        flex-grow: 1;
        padding: 0 20px;
      }

      .brand-name {
        color: var(--primary-pink);
        font-size: 26px;
        font-weight: 600;
        letter-spacing: 1.5px;
        font-family: "Cormorant Garamond", serif;
        margin-bottom: 2px;
        text-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .brand-tagline {
        color: var(--text-gray);
        font-size: 12px;
        letter-spacing: 1px;
        font-weight: 300;
      }

      /* Page Content */
      .page-content {
        padding: 30px 25px;
        min-height: 60vh;
        max-width: 800px;
        margin: 0 auto;
      }

      .section-title {
        font-size: 28px;
        font-weight: 600;
        color: var(--dark-gray);
        margin-bottom: 25px;
        font-family: "Cormorant Garamond", serif;
        position: relative;
        padding-bottom: 10px;
      }

      .section-title::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 60px;
        height: 3px;
        background: linear-gradient(
          to right,
          var(--primary-pink),
          var(--light-pink)
        );
        border-radius: 3px;
      }

      /* Order Cards */
      .order-card {
        background: var(--gradient-card);
        border-radius: 18px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: var(--card-shadow);
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 182, 193, 0.2);
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(10px);
      }

      .order-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
      }

      .order-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 5px;
        height: 100%;
        background: linear-gradient(
          to bottom,
          var(--primary-pink),
          var(--light-pink)
        );
      }

      .order-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px dashed rgba(0, 0, 0, 0.1);
        cursor: pointer;
      }

      .order-info h3 {
        color: var(--primary-pink);
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .order-info h3 i {
        transition: transform 0.3s;
      }

      .order-info p {
        color: var(--text-gray);
        font-size: 14px;
      }

      .order-status {
        background: rgba(255, 182, 193, 0.2);
        color: var(--primary-pink);
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .order-content {
        display: block;
      }

      .order-content.collapsed {
        display: none;
      }

      /* Product Items */
      .product-item {
        display: flex;
        background: white;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.03);
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 182, 193, 0.1);
      }

      .product-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      }

      .product-image {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, var(--light-pink), #ffe6f2);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        flex-shrink: 0;
      }

      .product-image i {
        font-size: 32px;
        color: var(--primary-pink);
      }

      .product-details {
        flex: 1;
      }

      .product-name {
        font-weight: 600;
        margin-bottom: 5px;
        color: var(--dark-gray);
        font-size: 16px;
      }

      .product-variant {
        font-size: 14px;
        color: var(--text-gray);
        margin-bottom: 8px;
      }

      .product-price {
        color: var(--primary-pink);
        font-weight: 700;
        margin-bottom: 10px;
        font-size: 16px;
      }

      .product-quantity {
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(255, 182, 193, 0.15);
        padding: 5px 12px;
        border-radius: 20px;
        width: fit-content;
        font-size: 14px;
        color: var(--dark-gray);
      }

      .product-actions {
        display: flex;
        flex-direction: column;
        gap: 15px;
        align-items: center;
        justify-content: center;
        margin-left: 15px;
        min-width: 180px;
      }

      .buy-again-container {
        display: flex;
        gap: 8px;
        align-items: center;
        width: 100%;
      }

      .quantity-input {
        width: 60px;
        text-align: center;
        border-radius: 8px;
        border: 1px solid var(--medium-gray);
        padding: 8px;
        font-size: 14px;
        background: white;
      }

      .buy-again-btn {
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 5px 15px rgba(255, 105, 180, 0.3);
        flex: 1;
      }

      .buy-again-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(255, 105, 180, 0.4);
      }

      .buy-again-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 105, 180, 0.3);
      }

      .buy-again-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      /* Notification Box Styles */
      .notification-box {
        position: fixed;
        top: 80px;
        right: 20px;
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(255, 105, 180, 0.4);
        z-index: 9999;
        font-weight: 500;
        transform: translateX(400px);
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        max-width: 300px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .notification-box.show {
        transform: translateX(0);
        opacity: 1;
      }

      .notification-box.error {
        background: linear-gradient(135deg, #ef4444, #dc2626);
      }

      @media (max-width: 480px) {
        .notification-box {
          right: 10px;
          left: 10px;
          max-width: none;
          top: 70px;
        }

        .buy-again-container {
          flex-direction: column;
          align-items: stretch;
        }

        .quantity-input {
          width: auto;
        }
      }

      .review-btn {
        background: var(--light-gold);
        color: var(--dark-gray);
        border: none;
        border-radius: 8px;
        padding: 8px 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        font-weight: 500;
        width: 100%;
      }

      .review-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        background: var(--gold);
        color: white;
      }

      .reviewed-note {
        color: var(--primary-pink);
        font-size: 12px;
        font-style: italic;
        margin-top: 5px;
        text-align: center;
      }

      .stars {
        color: #ddd;
        font-size: 16px;
        cursor: pointer;
        margin-top: 5px;
      }

      .stars .star {
        transition: color 0.2s;
      }

      .stars .star:hover,
      .stars .star.active {
        color: #ffc107;
      }

      /* Quick Rating */
      .quick-rating {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        margin-top: 10px;
      }

      .quick-rating-label {
        font-size: 12px;
        color: var(--text-gray);
      }

      /* Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
        backdrop-filter: blur(5px);
      }

      .modal-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .modal {
        background: white;
        border-radius: 25px;
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        transform: translateY(20px) scale(0.95);
        transition: all 0.4s;
        border: 1px solid rgba(255, 182, 193, 0.2);
      }

      .modal-overlay.active .modal {
        transform: translateY(0) scale(1);
      }

      .modal-header {
        padding: 25px 30px;
        border-bottom: 1px solid var(--medium-gray);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #fff9fc 0%, #ffffff 100%);
        border-radius: 25px 25px 0 0;
      }

      .modal-title {
        font-size: 22px;
        font-weight: 600;
        color: var(--dark-gray);
        font-family: "Cormorant Garamond", serif;
      }

      .close-modal {
        background: none;
        border: none;
        font-size: 24px;
        color: var(--text-gray);
        cursor: pointer;
        transition: all 0.3s;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .close-modal:hover {
        color: var(--dark-gray);
        background: rgba(0, 0, 0, 0.05);
      }

      .modal-body {
        padding: 30px;
      }

      .review-product {
        display: flex;
        gap: 15px;
        margin-bottom: 25px;
      }

      .review-product-image {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, var(--light-pink), #ffe6f2);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        flex-shrink: 0;
      }

      .review-product-image i {
        font-size: 32px;
        color: var(--primary-pink);
      }

      .review-product-details .product-name {
        font-size: 18px;
        margin-bottom: 5px;
      }

      .review-product-details .product-variant {
        font-size: 14px;
        color: var(--text-gray);
      }

      .rating-section {
        margin-bottom: 25px;
      }

      .rating-label {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--dark-gray);
      }

      .rating-stars {
        display: flex;
        gap: 5px;
        margin-bottom: 10px;
      }

      .rating-star {
        font-size: 28px;
        color: #ddd;
        cursor: pointer;
        transition: color 0.2s;
      }

      .rating-star:hover,
      .rating-star.active {
        color: #ffc107;
      }

      .rating-description {
        font-size: 14px;
        color: var(--text-gray);
        margin-top: 5px;
        min-height: 20px;
      }

      .comment-section {
        margin-bottom: 25px;
      }

      .comment-label {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--dark-gray);
      }

      .comment-textarea {
        width: 100%;
        min-height: 120px;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid var(--medium-gray);
        font-family: "Montserrat", sans-serif;
        font-size: 14px;
        resize: vertical;
        transition: border-color 0.3s;
      }

      .comment-textarea:focus {
        outline: none;
        border-color: var(--primary-pink);
      }

      .media-section {
        margin-bottom: 25px;
      }

      .media-label {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--dark-gray);
      }

      .media-upload {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .upload-btn {
        background: var(--light-gray);
        color: var(--dark-gray);
        border: 1px dashed var(--medium-gray);
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
      }

      .upload-btn:hover {
        background: rgba(255, 182, 193, 0.1);
        border-color: var(--primary-pink);
      }

      .upload-btn i {
        font-size: 24px;
        margin-bottom: 5px;
        display: block;
        color: var(--primary-pink);
      }

      .media-preview {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .media-item {
        position: relative;
        width: 80px;
        height: 80px;
        border-radius: 8px;
        overflow: hidden;
      }

      .media-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .remove-media {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        cursor: pointer;
      }

      .modal-footer {
        padding: 25px 30px;
        border-top: 1px solid var(--medium-gray);
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        background: #f9f9f9;
        border-radius: 0 0 25px 25px;
      }

      .btn {
        padding: 12px 24px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        border: none;
        font-family: "Montserrat", sans-serif;
        font-size: 14px;
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        color: white;
        box-shadow: 0 5px 15px rgba(255, 105, 180, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(255, 105, 180, 0.4);
      }

      .btn-secondary {
        background: var(--light-gray);
        color: var(--dark-gray);
        border: 1px solid var(--medium-gray);
      }

      .btn-secondary:hover {
        background: var(--medium-gray);
        transform: translateY(-2px);
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .product-item {
          flex-direction: column;
          text-align: center;
        }

        .product-image {
          margin-right: 0;
          margin-bottom: 15px;
          align-self: center;
        }

        .product-actions {
          flex-direction: column;
          align-items: center;
          width: 100%;
          margin-left: 0;
          margin-top: 15px;
        }

        .buy-again-container {
          flex-direction: row;
          gap: 8px;
          width: 100%;
        }

        .quantity-input {
          width: 60px;
        }

        .buy-again-btn {
          width: auto;
          flex: 1;
        }

        .order-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .order-status {
          align-self: flex-start;
        }

        .review-product {
          flex-direction: column;
          align-items: center;
          text-align: center;
        }
      }

      @media (max-width: 480px) {
        .header {
          padding: 12px 15px;
        }

        .brand-name {
          font-size: 22px;
        }

        .brand-tagline {
          font-size: 11px;
        }

        .back-button {
          width: 40px;
          height: 40px;
          font-size: 16px;
        }

        .page-content {
          padding: 20px;
        }

        .modal {
          max-width: 95%;
        }

        .buy-again-container {
          flex-direction: column;
          gap: 8px;
        }

        .buy-again-btn {
          width: 100%;
        }
      }
      /* Order Status Colors */
      .status-pending {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      .status-completed {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .status-cancelled {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .status-expired {
        background: #e2e3e5;
        color: #383d41;
        border: 1px solid #d6d8db;
      }

      /* QR Code Section */
      .qr-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
        border: 2px dashed #dee2e6;
      }

      .qr-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .qr-note {
        font-size: 14px;
        color: #6c757d;
        margin-top: 10px;
      }

      .qr-note i {
        color: #ff69b4;
        margin-right: 5px;
      }

      /* Order Summary */
      .order-summary {
        margin-bottom: 20px;
      }

      .total-section {
        background: white;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #e9ecef;
      }

      .total-line {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 16px;
        font-weight: 600;
      }

      .total-amount {
        color: #ff69b4;
        font-size: 18px;
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
      }

      .empty-state i {
        font-size: 64px;
        color: #dee2e6;
        margin-bottom: 20px;
      }

      .empty-state h3 {
        color: #495057;
        margin-bottom: 10px;
      }

      .empty-state p {
        margin-bottom: 20px;
        font-size: 16px;
      }

      /* Product Image Styling */
      .product-image img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 10px;
      }

      .product-image i {
        font-size: 40px;
        color: #ff69b4;
      }
      .pending-note {
        text-align: center;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 6px;
        border: 1px solid #e9ecef;
        font-style: italic;
      }

      .pending-note i {
        color: #ff69b4;
        margin-right: 5px;
      }
      .rating-section {
        margin-bottom: 25px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        border: 1px solid #e9ecef;
      }

      .rating-section:last-of-type {
        margin-bottom: 20px;
      }

      .rating-label {
        font-weight: 600;
        margin-bottom: 10px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .rating-label i {
        color: #ff69b4;
      }

      .rating-stars {
        display: flex;
        gap: 5px;
        margin-bottom: 8px;
      }

      .rating-star {
        font-size: 24px;
        color: #ddd;
        cursor: pointer;
        transition: color 0.2s ease;
      }

      .rating-star:hover,
      .rating-star.active {
        color: #ffc107;
      }

      .rating-description {
        font-size: 13px;
        color: #666;
        font-style: italic;
        min-height: 18px;
      }
      .comment-section {
        margin-bottom: 20px;
      }

      .comment-section:last-of-type {
        margin-bottom: 0;
      }

      .comment-label {
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .comment-label i {
        color: #ff69b4;
      }

      .comment-textarea {
        width: 100%;
        min-height: 80px;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-family: inherit;
        font-size: 14px;
        resize: vertical;
        transition: border-color 0.2s ease;
      }

      .comment-textarea:focus {
        outline: none;
        border-color: #ff69b4;
        box-shadow: 0 0 0 2px rgba(255, 105, 180, 0.1);
      }

      .comment-textarea::placeholder {
        color: #999;
        font-style: italic;
      }
      .rating-comment-group {
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 12px;
        border: 1px solid #e9ecef;
      }

      .rating-comment-group:last-of-type {
        margin-bottom: 0;
      }

      /* Read-only review styles */
      .review-readonly .rating-star {
        pointer-events: none;
        cursor: default;
      }

      .review-readonly .comment-textarea {
        background: #f8f9fa !important;
        border-color: #e5e7eb !important;
        color: #6b7280 !important;
        cursor: not-allowed;
      }

      .already-reviewed-btn {
        background: #10b981 !important;
        cursor: not-allowed;
      }

      .review-submitted-note {
        text-align: center;
        padding: 10px;
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        border-radius: 8px;
        color: #166534;
        margin-bottom: 15px;
        font-size: 14px;
      }
      /* Cancel Order Button */
      .cancel-order-btn {
        background: #ef4444;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .cancel-order-btn:hover {
        background: #dc2626;
        transform: translateY(-1px);
      }

      .cancel-order-btn:active {
        transform: translateY(0);
      }

      .cancel-section {
        text-align: center;
      }

      .status-cancelled {
        background: #6b7280;
        color: white;
      }
      .review-date-note {
        font-size: 12px;
        color: #6b7280;
        margin-top: 5px;
        text-align: center;
        font-style: italic;
      }
      /* Beautiful Toast Notification Styles */
      .toast {
        background: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        margin-bottom: 12px;
        border-left: 4px solid #4caf50;
        min-width: 320px;
        max-width: 400px;
        transform: translateX(400px);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 12px;
        position: relative;
        overflow: hidden;
      }

      .toast::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #4caf50, #45a049);
        transform: scaleX(0);
        transition: transform 5s linear;
      }

      .toast.show::before {
        transform: scaleX(1);
      }

      .toast.show {
        transform: translateX(0);
        animation: slideIn 0.4s ease-out;
      }

      @keyframes slideIn {
        0% {
          transform: translateX(400px);
          opacity: 0;
        }
        100% {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .toast.success {
        border-left-color: #4caf50;
        background: linear-gradient(135deg, #ffffff 0%, #f8fff8 100%);
      }

      .toast.error {
        border-left-color: #ff6b6b;
        background: linear-gradient(135deg, #ffffff 0%, #fff8f8 100%);
      }

      .toast.info {
        border-left-color: #2196f3;
        background: linear-gradient(135deg, #ffffff 0%, #f8fbff 100%);
      }

      .toast i {
        font-size: 20px;
        width: 24px;
        text-align: center;
      }

      .toast.success i {
        color: #4caf50;
        text-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
      }

      .toast.error i {
        color: #ff6b6b;
        text-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
      }

      .toast.info i {
        color: #2196f3;
        text-shadow: 0 2px 4px rgba(33, 150, 243, 0.3);
      }

      .toast-content {
        flex: 1;
        font-family: "Inter", sans-serif;
      }

      .toast-title {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 2px;
        color: #2d3748;
      }

      .toast.success .toast-title {
        color: #2d5a2d;
      }

      .toast.error .toast-title {
        color: #7c2a2a;
      }

      .toast.info .toast-title {
        color: #2c5282;
      }

      .toast-message {
        font-size: 13px;
        color: #718096;
        line-height: 1.4;
      }

      .toast-close {
        background: none;
        border: none;
        color: #a0aec0;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s ease;
        font-size: 14px;
      }

      .toast-close:hover {
        color: #718096;
        background: #f7fafc;
      }

      /* Progress bar for auto-dismiss */
      .toast-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 3px;
        background: linear-gradient(90deg, #4caf50, #45a049);
        width: 100%;
        transform: scaleX(1);
        transform-origin: left;
        animation: progress 5s linear forwards;
      }

      .toast.success .toast-progress {
        background: linear-gradient(90deg, #4caf50, #45a049);
      }

      .toast.error .toast-progress {
        background: linear-gradient(90deg, #ff6b6b, #ff5252);
      }

      .toast.info .toast-progress {
        background: linear-gradient(90deg, #2196f3, #1976d2);
      }

      @keyframes progress {
        to {
          transform: scaleX(0);
        }
      }

      /* Modal Button Styles */
      .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        padding: 20px;
        border-top: 1px solid var(--light-gray);
      }

      .cancel-btn {
        background: #f8f9fa;
        color: #6c757d;
        border: 2px solid #e9ecef;
        padding: 12px 24px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 120px;
        justify-content: center;
      }

      .cancel-btn:hover {
        background: #e9ecef;
        border-color: #dee2e6;
        color: #495057;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.15);
      }

      .save-btn {
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 140px;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
      }

      .save-btn:hover:not(:disabled) {
        background: linear-gradient(135deg, var(--dark-pink), #ff5252);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
      }

      .save-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* Specific style for cancel order button (red theme) */
      .save-btn[style*="background: #ff6b6b"] {
        background: linear-gradient(135deg, #ff6b6b, #ff5252) !important;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3) !important;
      }

      .save-btn[style*="background: #ff6b6b"]:hover:not(:disabled) {
        background: linear-gradient(135deg, #ff5252, #ff3838) !important;
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4) !important;
      }

      /* Loading state for buttons */
      .save-btn.loading {
        position: relative;
        color: transparent;
      }

      .save-btn.loading::after {
        content: "";
        position: absolute;
        width: 18px;
        height: 18px;
        top: 50%;
        left: 50%;
        margin-left: -9px;
        margin-top: -9px;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-right-color: transparent;
        animation: spin 0.8s linear infinite;
      }

      .cancel-btn.loading {
        position: relative;
        color: transparent;
      }

      .cancel-btn.loading::after {
        content: "";
        position: absolute;
        width: 18px;
        height: 18px;
        top: 50%;
        left: 50%;
        margin-left: -9px;
        margin-top: -9px;
        border: 2px solid #6c757d;
        border-radius: 50%;
        border-right-color: transparent;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      /* Button focus states for accessibility */
      .cancel-btn:focus,
      .save-btn:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
      }

      .save-btn:focus {
        box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.5);
      } /* Modal Button Styles - OPTIMIZED */
      .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        padding: 20px;
        border-top: 1px solid var(--light-gray);
      }

      .cancel-btn {
        background: #f8f9fa; /* Solid color instead of gradient */
        color: #6c757d;
        border: 2px solid #e9ecef;
        padding: 12px 24px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.2s ease-out; /* Simpler timing function */
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 120px;
        justify-content: center;
        will-change: transform; /* Performance hint */
      }

      .cancel-btn:hover {
        background: #e9ecef;
        border-color: #dee2e6;
        color: #495057;
        transform: translateY(-1px); /* Smaller movement */
        box-shadow: 0 2px 8px rgba(108, 117, 125, 0.12); /* Lighter shadow */
      }

      .save-btn {
        background: var(--primary-pink); /* Solid color instead of gradient */
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.2s ease-out; /* Simpler timing function */
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 140px;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(255, 107, 107, 0.2); /* Lighter shadow */
        will-change: transform; /* Performance hint */
      }

      .save-btn:hover:not(:disabled) {
        background: var(--dark-pink); /* Solid color */
        transform: translateY(-1px); /* Smaller movement */
        box-shadow: 0 4px 12px rgba(255, 107, 107, 0.25); /* Lighter shadow */
      }

      .save-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* Specific style for cancel order button (red theme) - OPTIMIZED */
      .save-btn[style*="background: #ff6b6b"] {
        background: #ff6b6b !important; /* Solid color */
        box-shadow: 0 2px 8px rgba(255, 107, 107, 0.2) !important;
      }

      .save-btn[style*="background: #ff6b6b"]:hover:not(:disabled) {
        background: #ff5252 !important; /* Solid color */
        box-shadow: 0 4px 12px rgba(255, 107, 107, 0.25) !important;
      }

      /* Loading state for buttons - OPTIMIZED */
      .save-btn.loading {
        position: relative;
        color: transparent;
        pointer-events: none; /* Prevent clicks during loading */
      }

      .save-btn.loading::after {
        content: "";
        position: absolute;
        width: 16px; /* Slightly smaller */
        height: 16px;
        top: 50%;
        left: 50%;
        margin-left: -8px;
        margin-top: -8px;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-right-color: transparent;
        animation: spin 0.6s linear infinite; /* Faster animation */
      }

      .cancel-btn.loading {
        position: relative;
        color: transparent;
        pointer-events: none; /* Prevent clicks during loading */
      }

      .cancel-btn.loading::after {
        content: "";
        position: absolute;
        width: 16px; /* Slightly smaller */
        height: 16px;
        top: 50%;
        left: 50%;
        margin-left: -8px;
        margin-top: -8px;
        border: 2px solid #6c757d;
        border-radius: 50%;
        border-right-color: transparent;
        animation: spin 0.6s linear infinite; /* Faster animation */
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      /* Button focus states for accessibility */
      .cancel-btn:focus,
      .save-btn:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2); /* Lighter focus */
      }

      .save-btn:focus {
        box-shadow: 0 0 0 2px rgba(255, 107, 107, 0.3); /* Lighter focus */
      }

      /* Hardware acceleration for smoother animations */
      .cancel-btn,
      .save-btn {
        transform: translateZ(0);
        backface-visibility: hidden;
        perspective: 1000px;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <button class="back-button" onclick="goBack()">
        <i class="fas fa-arrow-left"></i>
      </button>
      <div class="brand-header">
        <h1 class="brand-name">Blessence</h1>
        <p class="brand-tagline">Beauty & Blessed Online Makeup Store</p>
      </div>
      <!-- Empty div to maintain layout balance -->
      <div style="width: 44px"></div>
    </header>

    <!-- Page Content -->
    <main>
      <section class="page-content">
        <h2 class="section-title">Your Order History</h2>
        <div id="ordersList"></div>
      </section>
    </main>

    <!-- Review Modal -->
    <div class="modal-overlay" id="reviewModal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">Write a Review</h3>
          <button class="close-modal" id="closeModal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="review-product">
            <div class="review-product-image">
              <i class="fas fa-palette" id="modalProductIcon"></i>
            </div>
            <div class="review-product-details">
              <div class="product-name" id="modalProductName"></div>
              <div class="product-variant" id="modalProductVariant"></div>
            </div>
          </div>

          <!-- Product Quality Section -->
          <div class="rating-comment-group">
            <div class="rating-section">
              <div class="rating-label">
                <i class="fas fa-star"></i>
                How would you rate this product's quality?
              </div>
              <div class="rating-stars" id="productRatingStars">
                <span class="rating-star" data-rating="1">★</span>
                <span class="rating-star" data-rating="2">★</span>
                <span class="rating-star" data-rating="3">★</span>
                <span class="rating-star" data-rating="4">★</span>
                <span class="rating-star" data-rating="5">★</span>
              </div>
              <div
                class="rating-description"
                id="productRatingDescription"
              ></div>
            </div>

            <div class="comment-section">
              <div class="comment-label">
                <i class="fas fa-star"></i>
                Product Review (optional)
              </div>
              <textarea
                class="comment-textarea"
                id="productReview"
                placeholder="Share your thoughts about this product's quality, performance, etc..."
              ></textarea>
            </div>
          </div>

          <!-- Recommendation Accuracy Section -->
          <div class="rating-comment-group">
            <div class="rating-section">
              <div class="rating-label">
                <i class="fas fa-user-check"></i>
                How well did this match your preferences?
              </div>
              <div class="rating-stars" id="recommendationRatingStars">
                <span class="rating-star" data-rating="1">★</span>
                <span class="rating-star" data-rating="2">★</span>
                <span class="rating-star" data-rating="3">★</span>
                <span class="rating-star" data-rating="4">★</span>
                <span class="rating-star" data-rating="5">★</span>
              </div>
              <div
                class="rating-description"
                id="recommendationRatingDescription"
              ></div>
            </div>

            <div class="comment-section">
              <div class="comment-label">
                <i class="fas fa-user-check"></i>
                Recommendation Feedback (optional)
              </div>
              <textarea
                class="comment-textarea"
                id="recommendationComment"
                placeholder="How well did this match your preferences? What could make recommendations better?"
              ></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelReviewBtn">Cancel</button>
          <button class="btn btn-primary" id="submitReviewBtn">
            Submit Review
          </button>
        </div>
      </div>
    </div>

    <div
      id="toastContainer"
      style="position: fixed; top: 20px; right: 20px; z-index: 10000"
    ></div>
    <!-- Cancel Order Confirmation Modal -->
    <div class="modal-overlay" id="cancelOrderModal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">Cancel Order</h3>
          <button class="close-modal" onclick="closeCancelOrderModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="modal-body">
          <div style="text-align: center; padding: 20px 0">
            <div style="font-size: 48px; color: #ff6b6b; margin-bottom: 15px">
              <i class="fas fa-times-circle"></i>
            </div>
            <h4 style="margin: 0 0 10px 0; color: var(--dark-gray)">
              Cancel this order?
            </h4>
            <p style="color: var(--text-gray); margin: 0; font-size: 14px">
              This order will be cancelled and all items will be moved back to
              your cart.
            </p>
            <p
              style="
                color: #ff6b6b;
                margin: 10px 0 0 0;
                font-size: 13px;
                font-weight: 500;
              "
            >
              <i class="fas fa-exclamation-triangle"></i> This action cannot be
              undone.
            </p>
          </div>
        </div>

        <div class="modal-actions">
          <button class="cancel-btn" onclick="closeCancelOrderModal()">
            Keep Order
          </button>
          <button
            class="save-btn"
            style="background: #ff6b6b"
            onclick="confirmCancelOrder()"
            id="confirmCancelOrderBtn"
          >
            <i class="fas fa-times-circle" style="margin-right: 5px"></i>
            Yes, Cancel Order
          </button>
        </div>
      </div>
    </div>

    <script>
      // Current user from session
      let currentUser = null;
      let orders = [];

      // Get user session
      async function getUserSession() {
        try {
          const res = await fetch("../php/get-user-session.php");
          const data = await res.json();
          if (data.success && data.isLoggedIn) {
            return data.user;
          }
        } catch (err) {
          console.error("Error fetching session:", err);
        }
        return null;
      }

      const ordersList = document.getElementById("ordersList");
      const reviewModal = document.getElementById("reviewModal");
      const closeModal = document.getElementById("closeModal");
      const cancelReviewBtn = document.getElementById("cancelReviewBtn");
      const submitReviewBtn = document.getElementById("submitReviewBtn");
      const ratingStars = document.getElementById("ratingStars");
      const ratingDescription = document.getElementById("ratingDescription");
      const uploadMediaBtn = document.getElementById("uploadMediaBtn");
      const mediaPreview = document.getElementById("mediaPreview");
      const modalProductName = document.getElementById("modalProductName");
      const modalProductVariant = document.getElementById(
        "modalProductVariant"
      );
      const modalProductIcon = document.getElementById("modalProductIcon");

      let currentProduct = null;
      let currentOrderIndex = null;
      let currentProductIndex = null;
      let selectedRating = 0;
      let uploadedMedia = [];

      // Function to go back to previous page
      function goBack() {
        window.history.back();
      }

      // Function to toggle order collapse/expand
      function toggleOrder(orderId) {
        const orderContent = document.getElementById(
          `order-content-${orderId}`
        );
        const chevron = document.querySelector(`#order-header-${orderId} i`);

        if (orderContent.classList.contains("collapsed")) {
          orderContent.classList.remove("collapsed");
          chevron.style.transform = "rotate(0deg)";
        } else {
          orderContent.classList.add("collapsed");
          chevron.style.transform = "rotate(-90deg)";
        }
      }
      // Fetch orders from backend
      async function fetchOrders() {
        try {
          const response = await fetch("../php/get_order_history.php", {
            method: "GET",
            credentials: "same-origin",
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          if (data.success) {
            orders = data.orders;
            renderOrders();
          } else {
            console.error("Failed to fetch orders:", data.message);
            // Show empty state
            ordersList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-shopping-bag"></i>
                    <h3>No Orders Found</h3>
                    <p>${
                      data.message || "You haven't placed any orders yet."
                    }</p>
                </div>
            `;
          }
        } catch (error) {
          console.error("Error fetching orders:", error);
          ordersList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Error Loading Orders</h3>
                <p>Unable to load your order history. Please try again later.</p>
            </div>
        `;
        }
      }

      // Format price with commas for thousands
      function formatPrice(price) {
        return (
          "₱" +
          parseFloat(price)
            .toFixed(2)
            .replace(/\d(?=(\d{3})+\.)/g, "$&,")
        );
      }
      // Generate QR code for pending orders - USE SAME DATA AS CHECKOUT
      function generateOrderQRCode(orderId, qrCode, container) {
        try {
         

          // Clear previous QR code
          container.innerHTML = "";

          // Use the SAME QR data as in checkout - the order_id number
          const qrData = String(orderId); // Use order_id number, not the formatted qr_code string

          const qrDiv = document.createElement("div");
          qrDiv.style.padding = "10px";
          qrDiv.style.background = "white";
          qrDiv.style.borderRadius = "10px";
          qrDiv.style.display = "inline-block";
          qrDiv.style.margin = "10px 0";

          new QRCode(qrDiv, {
            text: qrData, // Use order_id number here
            width: 120,
            height: 120,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H,
          });

          // Add order reference - show both the display ID and the scan data
          const label = document.createElement("div");
          label.style.textAlign = "center";
          label.style.marginTop = "8px";
          label.style.fontSize = "12px";
          label.style.fontWeight = "bold";
          label.style.color = "#ff69b4";
          label.textContent = `Order #${orderId}`;

          const scanInfo = document.createElement("div");
          scanInfo.style.textAlign = "center";
          scanInfo.style.marginTop = "4px";
          scanInfo.style.fontSize = "10px";
          scanInfo.style.color = "#666";
          scanInfo.textContent = `Scan ID: ${qrData}`;

          container.appendChild(qrDiv);
          container.appendChild(label);
          container.appendChild(scanInfo);
        } catch (error) {
          console.error("Error generating QR code:", error);
          container.innerHTML =
            '<p style="color: #e74c3c; font-size: 14px;">QR Code unavailable</p>';
        }
      }
      // Rating descriptions for both types
      const productRatingDescriptions = {
        1: "Poor",
        2: "Fair",
        3: "Good",
        4: "Very Good",
        5: "Excellent",
      };

      const recommendationRatingDescriptions = {
        1: "Poor match",
        2: "Fair match",
        3: "Good match",
        4: "Very good match",
        5: "Perfect match",
      };

      let selectedProductRating = 0;
      let selectedRecommendationRating = 0;

      // Highlight stars based on rating
      function highlightStars(
        rating,
        starsContainer,
        descriptionContainer,
        descriptions
      ) {
        const stars = starsContainer.querySelectorAll(".rating-star");
        stars.forEach((star, index) => {
          if (index < rating) {
            star.classList.add("active");
          } else {
            star.classList.remove("active");
          }
        });

        // Update rating description
        if (rating > 0) {
          descriptionContainer.textContent = descriptions[rating];
        } else {
          descriptionContainer.textContent = "";
        }
      }
      async function openReviewModal(orderIndex, productIndex) {
        currentOrderIndex = orderIndex;
        currentProductIndex = productIndex;
        currentProduct = orders[orderIndex].products[productIndex];
        currentOrder = orders[orderIndex];

        // Set product details in modal
        modalProductName.textContent = currentProduct.name;
        modalProductVariant.textContent = currentProduct.variant;

        // In openReviewModal function - remove order_id from the check
        const existingReview = await checkExistingReview(currentProduct.id);
        // Remove currentOrder.order_id parameter
        if (existingReview) {
          // Show existing review (read-only mode)
          showExistingReview(existingReview);
        } else {
          // Show empty form for new review
          showNewReviewForm();
        }

        // Open modal
        reviewModal.classList.add("active");
      }
      // Function to show existing review (read-only) - UPDATED
      function showExistingReview(reviewData) {
        // Set ratings (read-only)
        selectedProductRating = reviewData.product_rating;
        selectedRecommendationRating = reviewData.recommendation_rating;

        // Highlight stars
        highlightStars(
          selectedProductRating,
          productRatingStars,
          productRatingDescription,
          productRatingDescriptions
        );
        highlightStars(
          selectedRecommendationRating,
          recommendationRatingStars,
          recommendationRatingDescription,
          recommendationRatingDescriptions
        );

        // Set comments (read-only)
        document.getElementById("productReview").value =
          reviewData.product_review || "No product review provided";
        document.getElementById("recommendationComment").value =
          reviewData.recommendation_comment ||
          "No recommendation feedback provided";

        // Make form read-only
        makeReviewFormReadOnly();

        // Update submit button and show review date
        const submitBtn = document.getElementById("submitReviewBtn");
        submitBtn.textContent = "✓ Review Submitted";
        submitBtn.disabled = true;
        submitBtn.style.background = "#10b981";

        // Optional: Show review date if available
        if (reviewData.review_date) {
          const reviewDate = new Date(
            reviewData.review_date
          ).toLocaleDateString();
          const dateNote = document.createElement("div");
          dateNote.className = "review-date-note";
          dateNote.textContent = `Reviewed on ${reviewDate}`;
          dateNote.style.fontSize = "12px";
          dateNote.style.color = "#6b7280";
          dateNote.style.marginTop = "5px";
          dateNote.style.textAlign = "center";

          submitBtn.parentNode.insertBefore(dateNote, submitBtn.nextSibling);
        }
      }

      // Function to show new review form (editable)
      function showNewReviewForm() {
        // Reset form
        selectedProductRating = 0;
        selectedRecommendationRating = 0;
        highlightStars(
          selectedProductRating,
          productRatingStars,
          productRatingDescription,
          productRatingDescriptions
        );
        highlightStars(
          selectedRecommendationRating,
          recommendationRatingStars,
          recommendationRatingDescription,
          recommendationRatingDescriptions
        );

        // Reset comment fields
        document.getElementById("productReview").value = "";
        document.getElementById("recommendationComment").value = "";

        // Make form editable
        makeReviewFormEditable();

        // Reset submit button
        const submitBtn = document.getElementById("submitReviewBtn");
        submitBtn.textContent = "Submit Review";
        submitBtn.disabled = false;
        submitBtn.style.background = "";
      }

      // Make review form read-only
      function makeReviewFormReadOnly() {
        // Make stars non-clickable
        const allStars = document.querySelectorAll(".rating-star");
        allStars.forEach((star) => {
          star.style.pointerEvents = "none";
          star.style.cursor = "default";
        });

        // Make textareas read-only
        document.getElementById("productReview").readOnly = true;
        document.getElementById("recommendationComment").readOnly = true;

        // Style read-only textareas
        const textareas = document.querySelectorAll(".comment-textarea");
        textareas.forEach((textarea) => {
          textarea.style.background = "#f8f9fa";
          textarea.style.borderColor = "#e5e7eb";
          textarea.style.color = "#6b7280";
        });
      }

      // Make review form editable
      function makeReviewFormEditable() {
        // Make stars clickable
        const allStars = document.querySelectorAll(".rating-star");
        allStars.forEach((star) => {
          star.style.pointerEvents = "auto";
          star.style.cursor = "pointer";
        });

        // Make textareas editable
        document.getElementById("productReview").readOnly = false;
        document.getElementById("recommendationComment").readOnly = false;

        // Style editable textareas
        const textareas = document.querySelectorAll(".comment-textarea");
        textareas.forEach((textarea) => {
          textarea.style.background = "";
          textarea.style.borderColor = "";
          textarea.style.color = "";
        });
      }
      // Close review modal - UPDATED to reset state
      function closeReviewModal() {
        reviewModal.classList.remove("active");

        // Reset form to editable state for next time
        makeReviewFormEditable();

        // Reset submit button
        const submitBtn = document.getElementById("submitReviewBtn");
        submitBtn.textContent = "Submit Review";
        submitBtn.disabled = false;
        submitBtn.style.background = "";
      }
      async function submitReview() {
        if (selectedProductRating === 0 || selectedRecommendationRating === 0) {
          showNotification(
            "Please provide both product and recommendation ratings.",
            "info"
          );
          return;
        }

        // Show loading state
        const submitBtn = document.getElementById("submitReviewBtn");
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Submitting...';
        submitBtn.disabled = true;

        try {
          const reviewData = {
            product_id: currentProduct.id,
            order_id: currentOrder.order_id,
            product_rating: selectedProductRating,
            recommendation_rating: selectedRecommendationRating,
            product_review: document
              .getElementById("productReview")
              .value.trim(),
            recommendation_comment: document
              .getElementById("recommendationComment")
              .value.trim(),
          };

         

          const response = await fetch("../php/submit_review.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(reviewData),
          });

      
          const responseText = await response.text();
      

          // Try to parse as JSON
          let data;
          try {
            data = JSON.parse(responseText);
          } catch (parseError) {
            console.error("JSON parse error:", parseError);
            console.error("Response was:", responseText);
            throw new Error(
              "Server returned invalid JSON: " + responseText.substring(0, 100)
            );
          }

      

          if (data.success) {
            // Update local data to show as rated
            orders[currentOrderIndex].products[
              currentProductIndex
            ].rated = true;
            orders[currentOrderIndex].products[
              currentProductIndex
            ].quickRating = selectedProductRating;

            showNotification(
              "Thank you for your review! Your feedback helps improve our recommendations. 💖",
              "success"
            );
            closeReviewModal();
            renderOrders();
          } else {
            showNotification(
              "Error submitting review: " + data.message,
              "error"
            );
          }
        } catch (error) {
          console.error("Error submitting review:", error);
          // ✅ REPLACED: Beautiful toast instead of alert
          showNotification("Error: " + error.message, "error");
        } finally {
          // Restore button state
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      }
      // Initialize rating stars event listeners
      function initializeRatingStars() {
        // Product quality rating stars
        productRatingStars.querySelectorAll(".rating-star").forEach((star) => {
          star.addEventListener("click", function () {
            selectedProductRating = parseInt(this.getAttribute("data-rating"));
            highlightStars(
              selectedProductRating,
              productRatingStars,
              productRatingDescription,
              productRatingDescriptions
            );
          });

          star.addEventListener("mouseover", function () {
            const rating = parseInt(this.getAttribute("data-rating"));
            highlightStars(
              rating,
              productRatingStars,
              productRatingDescription,
              productRatingDescriptions
            );
          });
        });

        // Recommendation accuracy rating stars
        recommendationRatingStars
          .querySelectorAll(".rating-star")
          .forEach((star) => {
            star.addEventListener("click", function () {
              selectedRecommendationRating = parseInt(
                this.getAttribute("data-rating")
              );
              highlightStars(
                selectedRecommendationRating,
                recommendationRatingStars,
                recommendationRatingDescription,
                recommendationRatingDescriptions
              );
            });

            star.addEventListener("mouseover", function () {
              const rating = parseInt(this.getAttribute("data-rating"));
              highlightStars(
                rating,
                recommendationRatingStars,
                recommendationRatingDescription,
                recommendationRatingDescriptions
              );
            });
          });

        // Reset stars when mouse leaves rating areas
        productRatingStars.addEventListener("mouseleave", function () {
          highlightStars(
            selectedProductRating,
            productRatingStars,
            productRatingDescription,
            productRatingDescriptions
          );
        });

        recommendationRatingStars.addEventListener("mouseleave", function () {
          highlightStars(
            selectedRecommendationRating,
            recommendationRatingStars,
            recommendationRatingDescription,
            recommendationRatingDescriptions
          );
        });
      }
      async function checkExistingReview(productId) {
        // Remove orderId parameter
        try {
          const response = await fetch(
            `../php/check_review.php?product_id=${productId}`
          );
          const data = await response.json();

          if (data.success && data.reviewExists) {
            return data.reviewData;
          }
          return null;
        } catch (error) {
          console.error("Error checking review:", error);
          return null;
        }
      }

      // Quick rating function
      function setQuickRating(orderIndex, productIndex, rating) {
        orders[orderIndex].products[productIndex].rated = true;
        orders[orderIndex].products[productIndex].quickRating = rating;

        // Show success message
        alert(`Thank you for your ${rating}-star rating!`);

        // Refresh the page to show updated ratings
        renderOrders();
      }

      // Handle media upload (simulated)
      function handleMediaUpload() {
        // In a real application, this would open a file picker
        // For this demo, we'll simulate adding some placeholder images

        if (uploadedMedia.length >= 5) {
          alert("You can only upload up to 5 media files.");
          return;
        }

        // Simulate adding a media file
        const mediaCount = uploadedMedia.length + 1;
        const mediaItem = {
          id: Date.now(),
          type: "image",
          url: `https://via.placeholder.com/150?text=Photo+${mediaCount}`,
        };

        uploadedMedia.push(mediaItem);

        // Update media preview
        const mediaElement = document.createElement("div");
        mediaElement.className = "media-item";
        mediaElement.innerHTML = `
                <img src="${mediaItem.url}" alt="Review photo">
                <button class="remove-media" data-id="${mediaItem.id}">&times;</button>
            `;

        mediaPreview.appendChild(mediaElement);

        // Add event listener to remove button
        mediaElement
          .querySelector(".remove-media")
          .addEventListener("click", function () {
            const id = parseInt(this.getAttribute("data-id"));
            uploadedMedia = uploadedMedia.filter((media) => media.id !== id);
            mediaElement.remove();
          });
      }

      function debugProductData(product, productIndex) {
        console.log(`🔍 Product ${productIndex} data:`, {
          product_id: product.product_id,
          id: product.id,
          name: product.name,
          variant: product.variant,
          price: product.price,
          quantity: product.quantity,
          // Log all available properties
          allProperties: Object.keys(product),
        });
      }

      function showNotification(message, type = "info") {
        const toastContainer = document.getElementById("toastContainer");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;

        // Add appropriate icon based on type
        let icon = "fas fa-info-circle";
        let title = "Information";
        if (type === "success") {
          icon = "fas fa-check-circle";
          title = "Success";
        }
        if (type === "error") {
          icon = "fas fa-exclamation-circle";
          title = "Error";
        }

        toast.innerHTML = `
    <i class="${icon}"></i>
    <div class="toast-content">
      <div class="toast-title">${title}</div>
      <div class="toast-message">${message}</div>
    </div>
    <button class="toast-close" onclick="this.parentElement.remove()">
      <i class="fas fa-times"></i>
    </button>
    <div class="toast-progress"></div>
  `;

        toastContainer.appendChild(toast);

        // Animate in
        setTimeout(() => toast.classList.add("show"), 100);

        // Auto remove after 5 seconds
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 400);
        }, 5000);

        // Add click to dismiss
        toast.addEventListener("click", function (e) {
          if (
            e.target.classList.contains("toast-close") ||
            e.target.closest(".toast-close")
          ) {
            this.classList.remove("show");
            setTimeout(() => {
              if (this.parentNode) {
                this.parentNode.removeChild(this);
              }
            }, 300);
          }
        });
      }

      function cleanProductName(name) {
        if (!name) return "";

        return name.replace(/(Parent Record:|Product Record:)\s*/gi, "").trim();
      }

      function renderOrders() {
        ordersList.innerHTML = "";

        if (orders.length === 0) {
          ordersList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-shopping-bag"></i>
                <h3>No Orders Yet</h3>
                <p>You haven't placed any orders yet. Start shopping to see your order history here!</p>
                <button class="btn btn-primary" onclick="window.location.href='../home.html'">Start Shopping</button>
            </div>
        `;
          return;
        }

        orders.forEach((order, orderIndex) => {
          const orderCard = document.createElement("div");
          orderCard.className = "order-card";

          // Order header
          const orderHeader = document.createElement("div");
          orderHeader.className = "order-header";
          orderHeader.id = `order-header-${order.order_id}`;
          orderHeader.addEventListener("click", () =>
            toggleOrder(order.order_id)
          );

          const orderInfo = document.createElement("div");
          orderInfo.className = "order-info";

          const orderTitle = document.createElement("h3");
          orderTitle.innerHTML = `<i class="fas fa-chevron-down"></i> Order #${order.id}`;

          const orderDate = document.createElement("p");
          orderDate.textContent = `Placed on ${order.date}`;

          orderInfo.appendChild(orderTitle);
          orderInfo.appendChild(orderDate);

          const orderStatus = document.createElement("div");
          orderStatus.className = `order-status status-${order.status.toLowerCase()}`;
          orderStatus.textContent =
            order.status.charAt(0).toUpperCase() + order.status.slice(1);

          orderHeader.appendChild(orderInfo);
          orderHeader.appendChild(orderStatus);

          // Order content
          const orderContent = document.createElement("div");
          orderContent.className = "order-content";
          orderContent.id = `order-content-${order.order_id}`;

          // Order summary (total, etc.)
          const orderSummary = document.createElement("div");
          orderSummary.className = "order-summary";

          // Show QR code only for pending orders
          if (order.status === "pending" && order.qr_code) {
            const qrSection = document.createElement("div");
            qrSection.className = "qr-section";

            const qrTitle = document.createElement("h4");
            qrTitle.textContent = "QR Code for Pickup";
            qrTitle.style.marginBottom = "10px";
            qrTitle.style.color = "#ff69b4";

            const qrContainer = document.createElement("div");
            qrContainer.className = "qr-container";

            generateOrderQRCode(order.id, order.qr_code, qrContainer);

            const qrNote = document.createElement("p");
            qrNote.className = "qr-note";
            qrNote.innerHTML =
              '<i class="fas fa-info-circle"></i> Show this QR code when picking up your order';
            qrNote.style.fontSize = "14px";
            qrNote.style.color = "#666";
            qrNote.style.marginTop = "10px";

            qrSection.appendChild(qrTitle);
            qrSection.appendChild(qrContainer);
            qrSection.appendChild(qrNote);
            orderSummary.appendChild(qrSection);
          }

          const totalSection = document.createElement("div");
          totalSection.className = "total-section";
          totalSection.innerHTML = `
            <div class="total-line">
                <span>Order Total:</span>
                <span class="total-amount">${formatPrice(
                  order.total_price
                )}</span>
            </div>
        `;

          // ✅ ADD CANCEL ORDER BUTTON FOR PENDING ORDERS
          if (order.status === "pending") {
            const cancelSection = document.createElement("div");
            cancelSection.className = "cancel-section";
            cancelSection.style.marginTop = "15px";
            cancelSection.style.paddingTop = "15px";
            cancelSection.style.borderTop = "1px solid #eee";

            const cancelBtn = document.createElement("button");
            cancelBtn.className = "cancel-order-btn";
            cancelBtn.innerHTML =
              '<i class="fas fa-times-circle"></i> Cancel Order';
            cancelBtn.addEventListener("click", (e) => {
              e.stopPropagation(); // Prevent triggering the order toggle
              cancelOrder(order.order_id);
            });

            cancelSection.appendChild(cancelBtn);
            orderSummary.appendChild(cancelSection);
          }

          orderSummary.appendChild(totalSection);
          orderContent.appendChild(orderSummary);

          // Products list
          const productsContainer = document.createElement("div");
          productsContainer.className = "products-container";

          order.products.forEach((product, productIndex) => {
            // debugProductData(product, productIndex);
            const productItem = document.createElement("div");
            productItem.className = "product-item";

            // Product image - CORRECTED PATH (FIXED VERSION)
            const productImage = document.createElement("div");
            productImage.className = "product-image";

            if (product.image && product.image !== "null") {
              const img = document.createElement("img");

             
              // let imagePath = product.image;

        
              if (!imagePath.includes("/admin/")) {
             
                imagePath = imagePath.replace(/^\/?uploads\//, "");
                imagePath = `/admin/uploads/product_images/${imagePath}`;
              }

           
              imagePath = imagePath.replace(/\\/g, "/"); 
              imagePath = imagePath.replace(/(\/\/+)/g, "/");

         

              img.src = product.image;
    img.alt = product.name;
              img.onerror = function () {
                console.error("Failed to load image from:", this.src);
                this.style.display = "none";
                const icon = document.createElement("i");
                icon.className = "fas fa-palette";
                productImage.appendChild(icon);
              };

              img.onload = function () {
             
              };

              productImage.appendChild(img);
            } else {
         
              
              const icon = document.createElement("i");
              icon.className = "fas fa-palette";
              productImage.appendChild(icon);
            }
            // Product details
            const productDetails = document.createElement("div");
            productDetails.className = "product-details";

            const productName = document.createElement("div");
            productName.className = "product-name";

            productName.textContent = cleanProductName(product.name);

            const productVariant = document.createElement("div");
            productVariant.className = "product-variant";
            productVariant.textContent = product.variant;

            const productPrice = document.createElement("div");
            productPrice.className = "product-price";
            productPrice.textContent = `${formatPrice(product.price)} x ${
              product.quantity
            }`;

            const productTotal = document.createElement("div");
            productTotal.className = "product-price";
            productTotal.textContent = `Total: ${formatPrice(product.total)}`;

            const productQuantity = document.createElement("div");
            productQuantity.className = "product-quantity";
            productQuantity.innerHTML = `<i class="fas fa-shopping-bag"></i><span>Quantity: ${product.quantity}</span>`;

            productDetails.appendChild(productName);
            productDetails.appendChild(productVariant);
            productDetails.appendChild(productPrice);
            productDetails.appendChild(productTotal);
            productDetails.appendChild(productQuantity);

            // Product actions
            const productActions = document.createElement("div");
            productActions.className = "product-actions";

            // Buy Again with quantity
            const buyAgainContainer = document.createElement("div");
            buyAgainContainer.className = "buy-again-container";

            const qtyInput = document.createElement("input");
            qtyInput.type = "number";
            qtyInput.min = 1;
            qtyInput.value = 1;
            qtyInput.className = "quantity-input";

            const buyAgainBtn = document.createElement("button");
            buyAgainBtn.className = "buy-again-btn";
            buyAgainBtn.innerHTML =
              '<i class="fas fa-cart-plus"></i> Buy Again';
            buyAgainBtn.addEventListener("click", async () => {
              const qty = parseInt(qtyInput.value);

              if (qty < 1) {
                showNotification("Quantity must be at least 1", "error");
                return;
              }

              // ✅ FIX: Use product.id instead of product.product_id
              const productId = product.id; // This should be LIP014, LIP008, etc.

              if (!productId) {
                showNotification(
                  "Error: Could not find product information",
                  "error"
                );
                console.error("Missing product ID for:", product);
                return;
              }

            

              // Show loading state
              const originalText = buyAgainBtn.innerHTML;
              buyAgainBtn.innerHTML =
                '<i class="fas fa-spinner fa-spin"></i> Adding...';
              buyAgainBtn.disabled = true;

              try {
                const success = await addToCart(productId, qty);

                if (success) {
                  const total = qty * product.price;
                  showNotification(
                    `Added ${qty} × ${
                      product.name
                    } to cart! Total: ${formatPrice(total)}`
                  );
                }
              } catch (error) {
                console.error("Error in buy again:", error);
                showNotification(
                  "Error adding to cart. Please try again.",
                  "error"
                );
              } finally {
                // Restore button state
                buyAgainBtn.innerHTML = originalText;
                buyAgainBtn.disabled = false;
              }
            });

            buyAgainContainer.appendChild(qtyInput);
            buyAgainContainer.appendChild(buyAgainBtn);

            // Review section - ONLY show for completed orders
            if (order.status === "completed") {
              if (!product.rated) {
                // Show Write Review button for unrated products in completed orders
                const reviewBtn = document.createElement("button");
                reviewBtn.className = "review-btn";
                reviewBtn.textContent = "Write Review";
                reviewBtn.addEventListener("click", () => {
                  openReviewModal(orderIndex, productIndex);
                });

                productActions.appendChild(buyAgainContainer);
                productActions.appendChild(reviewBtn);
              } else {
                // Show rating info for already rated products
                const reviewedNote = document.createElement("div");
                reviewedNote.className = "reviewed-note";
                reviewedNote.textContent = `You rated this product ${product.quickRating} stars`;

                // Show stars for already rated product
                const ratedStars = document.createElement("div");
                ratedStars.className = "stars";

                for (let i = 1; i <= 5; i++) {
                  const star = document.createElement("span");
                  star.className = `star ${
                    i <= product.quickRating ? "active" : ""
                  }`;
                  star.innerHTML = "★";
                  ratedStars.appendChild(star);
                }

                productActions.appendChild(buyAgainContainer);
                productActions.appendChild(reviewedNote);
                productActions.appendChild(ratedStars);
              }
            } else {
              // For pending orders, only show Buy Again button
              productActions.appendChild(buyAgainContainer);

              // Optional: Add a note that reviews are available after order completion
              if (order.status === "pending") {
                const pendingNote = document.createElement("div");
                pendingNote.className = "pending-note";
                pendingNote.innerHTML =
                  '<i class="fas fa-info-circle"></i> Review available after order completion';
                pendingNote.style.fontSize = "12px";
                pendingNote.style.color = "#666";
                pendingNote.style.marginTop = "8px";
                productActions.appendChild(pendingNote);
              }
            }

            // Assemble product item
            productItem.appendChild(productImage);
            productItem.appendChild(productDetails);
            productItem.appendChild(productActions);

            productsContainer.appendChild(productItem);
          });

          // Assemble order content
          orderContent.appendChild(productsContainer);

          // Assemble order card
          orderCard.appendChild(orderHeader);
          orderCard.appendChild(orderContent);

          ordersList.appendChild(orderCard);
        });
      }

      function getProductIdFromOrder(product) {
        // The product ID is in the 'id' field, not 'product_id'
        if (product.id) return product.id;
        if (product.product_id) return product.product_id;
        if (product.ProductID) return product.ProductID;

        console.error("❌ Could not find product ID in:", product);
        return null;
      }

      function showNotification(message, type = "success") {
        // Create notification element if it doesn't exist
        let notificationBox = document.getElementById("notification-box");

        if (!notificationBox) {
          notificationBox = document.createElement("div");
          notificationBox.id = "notification-box";
          notificationBox.className = "notification-box";
          document.body.appendChild(notificationBox);
        }

        // Set message and icon
        const iconClass =
          type === "success"
            ? "fas fa-check-circle"
            : "fas fa-exclamation-circle";
        notificationBox.innerHTML = `<i class="${iconClass}"></i> ${message}`;
        notificationBox.style.background =
          type === "success"
            ? "linear-gradient(135deg, var(--primary-pink), var(--dark-pink))"
            : "linear-gradient(135deg, #ef4444, #dc2626)";

        // Show notification
        notificationBox.classList.add("show");

        // Hide after 3 seconds
        setTimeout(() => {
          notificationBox.classList.remove("show");
        }, 3000);
      }
      async function addToCart(productId, quantity = 1) {
        try {
         

          const response = await fetch("../php/cart.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `action=add&product_id=${encodeURIComponent(
              productId
            )}&quantity=${quantity}`,
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
      
          

          if (result.success) {
            showNotification(result.message || "Added to cart! 🛒");
            return true;
          } else {
            // More specific error handling
            let errorMessage = result.message || "Failed to add to cart";

            if (result.message?.toLowerCase().includes("not found")) {
              errorMessage = `Product "${productId}" is no longer available`;
            } else if (result.message?.toLowerCase().includes("stock")) {
              errorMessage = "Insufficient stock available";
            } else if (result.message?.toLowerCase().includes("login")) {
              errorMessage = "Please login to add items to cart";
            }

            showNotification(errorMessage, "error");
            console.error("Add to cart failed:", result.message);
            return false;
          }
        } catch (error) {
          console.error("❌ Network error adding to cart:", error);
          showNotification(
            "Network error. Please check your connection.",
            "error"
          );
          return false;
        }
      }
      async function initializePage() {
        try {
          // Get user session first
          currentUser = await getUserSession();

          if (!currentUser) {
            // Show login prompt
            ordersList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-user-lock"></i>
                    <h3>Login Required</h3>
                    <p>Please log in to view your order history.</p>
                    <button class="btn btn-primary" onclick="window.location.href='../auth/login.html'">Login</button>
                </div>
            `;
            return;
          }

          initializeRatingStars();

          // Fetch orders from backend
          await fetchOrders();
        } catch (error) {
          console.error("Error initializing page:", error);
        }
      }

      let currentOrderIdToCancel = null;

      // Enhanced cancel order function with modal
      function cancelOrder(orderId) {
        currentOrderIdToCancel = orderId;
        openCancelOrderModal();
      }

      // Open cancel order confirmation modal
      function openCancelOrderModal() {
        const modal = document.getElementById("cancelOrderModal");
        if (modal) {
          modal.classList.add("active");
          document.body.style.overflow = "hidden";
        }
      }

      // Close cancel order confirmation modal
      function closeCancelOrderModal() {
        const modal = document.getElementById("cancelOrderModal");
        if (modal) {
          modal.classList.remove("active");
          document.body.style.overflow = "";

          // Reset loading state
          const confirmBtn = document.getElementById("confirmCancelOrderBtn");
          if (confirmBtn) {
            confirmBtn.classList.remove("loading");
            confirmBtn.disabled = false;
            confirmBtn.innerHTML =
              '<i class="fas fa-times-circle" style="margin-right: 5px;"></i> Yes, Cancel Order';
          }

          currentOrderIdToCancel = null;
        }
      }

      // Confirm and execute order cancellation
      async function confirmCancelOrder() {
        if (!currentOrderIdToCancel) {
          console.error("No order ID to cancel");
          return;
        }

        const confirmBtn = document.getElementById("confirmCancelOrderBtn");

        // Show loading state
        if (confirmBtn) {
          confirmBtn.classList.add("loading");
          confirmBtn.disabled = true;
          confirmBtn.innerHTML = "Cancelling...";
        }

        try {
          const response = await fetch("../php/cancel_order.php", {
            method: "POST",
            credentials: "same-origin",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ order_id: currentOrderIdToCancel }),
          });

          const result = await response.json();

          if (result.success) {
            // Close modal first
            closeCancelOrderModal();

            // Use your existing showNotification function
            showNotification("✅ " + result.message, "success");

            // Refresh the orders list
            await fetchOrders();
          } else {
            closeCancelOrderModal();
            showNotification("❌ " + result.message, "error");
          }
        } catch (error) {
          console.error("Error cancelling order:", error);
          closeCancelOrderModal();
          showNotification(
            "❌ Error cancelling order. Please try again.",
            "error"
          );
        }
      }

      // Add modal event listeners
      function initializeCancelOrderModal() {
        const cancelOrderModal = document.getElementById("cancelOrderModal");
        if (cancelOrderModal) {
          // Click outside to close
          cancelOrderModal.addEventListener("click", function (e) {
            if (e.target === cancelOrderModal) {
              closeCancelOrderModal();
            }
          });

          // Escape key to close
          document.addEventListener("keydown", function (e) {
            if (
              e.key === "Escape" &&
              cancelOrderModal.classList.contains("active")
            ) {
              closeCancelOrderModal();
            }
          });
        }
      }

      // Event Listeners
      closeModal.addEventListener("click", closeReviewModal);
      cancelReviewBtn.addEventListener("click", closeReviewModal);
      submitReviewBtn.addEventListener("click", submitReview);
      initializePage();
      initializeCancelOrderModal();
    </script>
  </body>
</html>
