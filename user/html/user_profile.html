<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Profile | Blessence</title>
    <link rel="icon" href="../../admin/images/mainlogo.png" type="image/png" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <script src="../js/user-session.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary-pink: #ff69b4;
        --light-pink: #ffb6c1;
        --dark-pink: #ff1493;
        --gold: #d4af37;
        --light-gold: #f7e8c4;
        --soft-white: #fefefe;
        --light-gray: #f5f5f5;
        --medium-gray: #e0e0e0;
        --text-gray: #888;
        --dark-gray: #555;
        --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        --gradient-bg: linear-gradient(
          135deg,
          #ffffff 0%,
          #fff5f9 30%,
          #ffe6f2 70%,
          #ffd1dc 100%
        );
        --gradient-header: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.95) 0%,
          rgba(255, 249, 252, 0.95) 100%
        );
        --gradient-card: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.95) 0%,
          rgba(255, 249, 252, 0.95) 100%
        );
      }

      body {
        background: var(--gradient-bg);
        min-height: 100vh;
        font-family: "Montserrat", sans-serif;
        overflow-x: hidden;
        position: relative;
        background-attachment: fixed;
      }

      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(
            circle at 10% 20%,
            rgba(255, 255, 255, 0.8) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 90% 80%,
            rgba(255, 182, 193, 0.3) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 50% 50%,
            rgba(255, 105, 180, 0.1) 0%,
            transparent 50%
          );
        z-index: -1;
      }

      /* Header Styles */
      .header {
        background: var(--gradient-header);
        box-shadow: 0 5px 20px rgba(255, 105, 180, 0.1);
        padding: 15px 20px;
        position: sticky;
        top: 0;
        z-index: 100;
        display: flex;
        justify-content: space-between;
        align-items: center;
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 182, 193, 0.2);
      }

      .brand-header {
        text-align: center;
        padding: 0 20px;
        flex: 1;
      }

      .brand-name {
        color: var(--primary-pink);
        font-size: 26px;
        font-weight: 600;
        letter-spacing: 1.5px;
        font-family: "Cormorant Garamond", serif;
        margin-bottom: 2px;
        text-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .brand-tagline {
        color: var(--text-gray);
        font-size: 12px;
        letter-spacing: 1px;
        font-weight: 300;
      }

      /* Back Button */
      .back-btn {
        background: none;
        border: none;
        color: var(--primary-pink);
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 20px;
        transition: all 0.3s ease;
        text-decoration: none;
      }

      .back-btn:hover {
        background: rgba(255, 182, 193, 0.1);
        transform: translateX(-3px);
      }

      /* Profile Page Styles */
      .profile-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 30px 20px;
      }

      .profile-header {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 30px;
      }

      .profile-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-pink), var(--gold));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 32px;
        font-weight: 600;
        position: relative;
        transition: transform 0.3s ease;
        overflow: hidden;
      }

      .profile-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .profile-info {
        flex: 1;
      }

      .profile-name {
        font-size: 24px;
        font-weight: 600;
        color: var(--dark-gray);
        margin-bottom: 5px;
        font-family: "Cormorant Garamond", serif;
      }

      .profile-username {
        font-size: 14px;
        color: var(--text-gray);
        margin-bottom: 10px;
      }

      .profile-location,
      .profile-member {
        color: var(--text-gray);
        margin-bottom: 3px;
        font-size: 13px;
      }

      .profile-location i,
      .profile-member i {
        margin-right: 6px;
        color: var(--primary-pink);
        font-size: 12px;
      }

      .edit-btn {
        background: var(--primary-pink);
        color: white;
        border: none;
        border-radius: 16px;
        padding: 6px 16px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 8px;
      }

      .edit-btn:hover {
        background: var(--dark-pink);
        transform: translateY(-2px);
      }

      /* Stats Section */
      .stats-section {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-bottom: 25px;
      }

      .stat-card {
        background: var(--gradient-card);
        border-radius: 14px;
        padding: 18px;
        text-align: center;
        box-shadow: var(--card-shadow);
        border: 1px solid rgba(255, 182, 193, 0.2);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }

      .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(
          to right,
          var(--primary-pink),
          var(--light-pink)
        );
      }

      .stat-number {
        font-size: 28px;
        font-weight: 700;
        color: var(--primary-pink);
        margin-bottom: 5px;
        font-family: "Cormorant Garamond", serif;
      }

      .stat-label {
        color: var(--dark-gray);
        font-size: 14px;
        font-weight: 500;
      }

      /* Menu Section */
      .menu-section {
        background: var(--gradient-card);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: var(--card-shadow);
        border: 1px solid rgba(255, 182, 193, 0.2);
        position: relative;
        overflow: hidden;
      }

      .menu-section::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(
          to bottom,
          var(--primary-pink),
          var(--light-pink)
        );
      }

      .section-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--dark-gray);
        margin-bottom: 15px;
        font-family: "Cormorant Garamond", serif;
        position: relative;
        padding-bottom: 8px;
      }

      .section-title::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 35px;
        height: 2px;
        background: linear-gradient(
          to right,
          var(--primary-pink),
          var(--light-pink)
        );
        border-radius: 2px;
      }

      .menu-grid {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .menu-item {
        display: flex;
        align-items: center;
        padding: 14px 16px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .menu-item:hover {
        background: rgba(255, 182, 193, 0.08);
        transform: translateX(3px);
      }

      .menu-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 182, 193, 0.15);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        color: var(--primary-pink);
        font-size: 16px;
      }

      .menu-text {
        flex: 1;
      }

      .menu-title {
        font-weight: 500;
        color: var(--dark-gray);
        margin-bottom: 2px;
        font-size: 15px;
      }

      .menu-desc {
        font-size: 12px;
        color: var(--text-gray);
      }

      .logout {
        color: #e74c3c;
      }

      .logout .menu-icon {
        background: rgba(231, 76, 60, 0.1);
        color: #e74c3c;
      }

      /* Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .modal-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .modal {
        background: white;
        border-radius: 16px;
        padding: 25px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        transform: translateY(20px);
        transition: transform 0.3s ease;
      }

      .modal-overlay.active .modal {
        transform: translateY(0);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--medium-gray);
      }

      .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--dark-gray);
        font-family: "Cormorant Garamond", serif;
      }

      .close-modal {
        background: none;
        border: none;
        font-size: 18px;
        color: var(--text-gray);
        cursor: pointer;
        transition: color 0.3s ease;
      }

      .close-modal:hover {
        color: var(--primary-pink);
      }

      .modal-body {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .form-label {
        font-weight: 500;
        color: var(--dark-gray);
        font-size: 14px;
      }

      .form-input {
        padding: 12px 45px 12px 15px; /* Extra right padding for eye icon */
        border: 1px solid var(--medium-gray);
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
        width: 100%;
      }

      .form-input:focus {
        outline: none;
        border-color: var(--primary-pink);
        box-shadow: 0 0 0 2px rgba(255, 105, 180, 0.2);
      }

      .password-input-container {
        position: relative;
        width: 100%;
      }

      .toggle-password {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--text-gray);
        cursor: pointer;
        z-index: 2;
        padding: 5px;
      }

      .photo-options {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .photo-preview {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: var(--light-gray);
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-gray);
        font-size: 32px;
        position: relative;
        overflow: hidden;
      }

      .photo-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .photo-actions {
        display: flex;
        justify-content: center;
        gap: 8px;
      }

      .photo-btn {
        background: var(--primary-pink);
        color: white;
        border: none;
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .photo-btn:hover {
        background: var(--dark-pink);
      }

      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 20px;
        padding-top: 16px;
        border-top: 1px solid var(--medium-gray);
      }

      .cancel-btn {
        background: var(--light-gray);
        color: var(--dark-gray);
        border: none;
        border-radius: 8px;
        padding: 8px 16px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .cancel-btn:hover {
        background: var(--medium-gray);
      }

      .save-btn {
        background: var(--primary-pink);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 16px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .save-btn:hover {
        background: var(--dark-pink);
      }

      .save-btn:disabled {
        background: var(--medium-gray);
        cursor: not-allowed;
      }

      /* Responsive Design */
      @media (max-width: 1023px) {
        .stats-section {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 480px) {
        .header {
          padding: 12px 15px;
        }

        .brand-name {
          font-size: 22px;
        }

        .brand-tagline {
          font-size: 11px;
        }

        .profile-container {
          padding: 20px 15px;
        }

        .profile-avatar {
          width: 80px;
          height: 80px;
          font-size: 24px;
        }

        .profile-name {
          font-size: 20px;
        }

        .section-title {
          font-size: 18px;
        }

        .stats-section {
          grid-template-columns: 1fr;
        }

        .menu-item {
          padding: 12px 14px;
        }

        .menu-icon {
          width: 36px;
          height: 36px;
          font-size: 14px;
        }

        .modal {
          padding: 20px;
          margin: 15px;
        }
      }
      /* Store Feedback Modal Styles */
      .existing-feedback-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--light-gray);
      }

      .existing-feedback-header h3 {
        margin: 0;
        color: var(--dark-gray);
        font-size: 16px;
      }

      .edit-feedback-btn {
        background: var(--primary-pink);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .edit-feedback-btn:hover {
        background: var(--dark-pink);
        transform: translateY(-1px);
      }

      .current-rating {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }

      .stars-display {
        color: var(--gold);
        font-size: 18px;
      }

      .rating-text {
        color: var(--text-gray);
        font-size: 14px;
      }

      .current-comment {
        background: var(--light-gray);
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 10px;
      }

      .current-comment p {
        margin: 0;
        color: var(--dark-gray);
        line-height: 1.4;
      }

      .feedback-date {
        font-size: 12px;
        color: var(--text-gray);
        text-align: right;
      }

      /* Star Rating Styles */
      .star-rating {
        display: flex;
        flex-direction: row-reverse;
        justify-content: flex-end;
        gap: 5px;
      }

      .star-rating input {
        display: none;
      }

      .star-label {
        font-size: 32px;
        color: #ddd;
        cursor: pointer;
        transition: color 0.2s;
      }

      .star-rating input:checked ~ .star-label,
      .star-rating .star-label:hover,
      .star-rating .star-label:hover ~ .star-label {
        color: var(--gold);
      }

      .star-rating input:checked + .star-label {
        color: var(--gold);
      }

      /* Form Styles */
      .form-textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--medium-gray);
        border-radius: 8px;
        font-family: inherit;
        font-size: 14px;
        resize: vertical;
        transition: border-color 0.3s;
      }

      .form-textarea:focus {
        outline: none;
        border-color: var(--primary-pink);
      }

      /* Modal Actions */
      .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        padding: 20px;
        border-top: 1px solid var(--light-gray);
      }

      .cancel-btn {
        background: var(--light-gray);
        color: var(--text-gray);
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .cancel-btn:hover {
        background: #d0d0d0;
      }

      .save-btn {
        background: var(--primary-pink);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .save-btn:hover:not(:disabled) {
        background: var(--dark-pink);
        transform: translateY(-1px);
      }

      .save-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }
      /* Logout Modal Specific Styles */
      #logoutModal .modal {
        max-width: 400px;
        text-align: center;
      }

      #logoutModal .modal-body {
        padding: 10px 0;
      }

      /* Loading state for logout button */
      .save-btn.loading {
        position: relative;
        color: transparent;
      }

      .save-btn.loading::after {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        top: 50%;
        left: 50%;
        margin-left: -8px;
        margin-top: -8px;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-right-color: transparent;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <a href="home.html" class="back-btn">
        <i class="fas fa-arrow-left"></i>
      </a>
      <div class="brand-header">
        <h1 class="brand-name">Blessence</h1>
        <p class="brand-tagline">Beauty & Blessed Online Makeup Store</p>
      </div>
      <div style="width: 40px"></div>
      <!-- Spacer for alignment -->
    </header>

    <!-- Profile Content -->
    <div class="profile-container">
      <!-- Profile Header -->
      <div class="profile-header">
        <div class="profile-avatar" id="profile-avatar-display">M</div>
        <!-- In your profile-info section, remove location and simplify -->
        <div class="profile-info">
          <h1 class="profile-name" id="profile-name-display">User Name</h1>
          <p class="profile-username" id="profile-username-display">@user</p>
          <p class="profile-member">
            <i class="far fa-calendar-alt"></i> Member since 2022
          </p>
          <button class="edit-btn" id="edit-profile-btn">
            <i class="fas fa-edit"></i> Edit Profile
          </button>
        </div>
      </div>

      <!-- Stats Section -->
      <div class="stats-section">
        <div class="stat-card">
          <div class="stat-number" id="orders-count">12</div>
          <div class="stat-label">Orders</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="favorites-count">5</div>
          <div class="stat-label">Favorites</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="cart-count">3</div>
          <div class="stat-label">Cart Items</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="unclaimed-count">2</div>
          <div class="stat-label">Unclaimed Orders</div>
        </div>
      </div>
      <!-- Menu Section -->
      <div class="menu-section">
        <h2 class="section-title">Account Settings</h2>
        <div class="menu-grid">
          <div class="menu-item" onclick="navigateTo('order-history')">
            <div class="menu-icon">
              <i class="fas fa-shopping-bag"></i>
            </div>
            <div class="menu-text">
              <div class="menu-title">Order History</div>
              <div class="menu-desc">View your past orders</div>
            </div>
          </div>
          <div class="menu-item" onclick="openStoreFeedbackModal()">
            <div class="menu-icon">
              <i class="fas fa-store"></i>
            </div>
            <div class="menu-text">
              <div class="menu-title">Store Feedback</div>
              <div class="menu-desc">Rate your experience</div>
            </div>
          </div>
          <div class="menu-item" onclick="openChangePasswordModal()">
            <div class="menu-icon">
              <i class="fas fa-lock"></i>
            </div>
            <div class="menu-text">
              <div class="menu-title">Change Password</div>
              <div class="menu-desc">Update your account password</div>
            </div>
          </div>
          <div class="menu-item logout" onclick="logout()">
            <div class="menu-icon">
              <i class="fas fa-sign-out-alt"></i>
            </div>
            <div class="menu-text">
              <div class="menu-title">Log Out</div>
              <div class="menu-desc">Log out of your account</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div class="modal-overlay" id="logoutModal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">Sign Out</h3>
          <button class="close-modal" onclick="closeLogoutModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="modal-body">
          <div style="text-align: center; padding: 20px 0">
            <div
              style="
                font-size: 48px;
                color: var(--primary-pink);
                margin-bottom: 15px;
              "
            >
              <i class="fas fa-sign-out-alt"></i>
            </div>
            <h4 style="margin: 0 0 10px 0; color: var(--dark-gray)">
              Are you sure you want to sign out?
            </h4>
            <p style="color: var(--text-gray); margin: 0; font-size: 14px">
              You'll need to sign in again to access your account.
            </p>
          </div>
        </div>

        <div class="modal-actions">
          <button class="cancel-btn" onclick="closeLogoutModal()">
            Cancel
          </button>
          <button
            class="save-btn"
            onclick="confirmLogout()"
            id="confirmLogoutBtn"
          >
            <i class="fas fa-sign-out-alt" style="margin-right: 5px"></i>
            Yes, Sign Out
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal-overlay" id="edit-profile-modal">
      <div class="modal">
        <div class="modal-header">
          <h2 class="modal-title">Edit Profile</h2>
          <button class="close-modal" id="close-edit-modal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="photo-options">
            <div class="photo-preview" id="photo-preview">M</div>
            <div class="photo-actions">
              <!-- REMOVED Take Photo button -->
              <button class="photo-btn" id="upload-photo-btn">
                <i class="fas fa-upload"></i> Upload Photo
              </button>
              <button class="photo-btn" id="remove-photo-btn">
                <i class="fas fa-trash"></i> Remove
              </button>
            </div>
          </div>
          <div class="form-group">
            <label for="edit-name" class="form-label">Full Name</label>
            <input
              type="text"
              id="edit-name"
              class="form-input"
              value="Maria Santos"
            />
          </div>
          <div class="form-group">
            <label for="edit-username" class="form-label">Username</label>
            <input
              type="text"
              id="edit-username"
              class="form-input"
              value="marias"
            />
          </div>
        </div>
        <div class="modal-actions">
          <button class="cancel-btn" id="cancel-edit">Cancel</button>
          <button class="save-btn" id="save-profile">Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal-overlay" id="change-password-modal">
      <div class="modal">
        <div class="modal-header">
          <h2 class="modal-title">Change Password</h2>
          <button class="close-modal" id="close-password-modal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="old-password" class="form-label">Old Password</label>
            <div class="password-input-container">
              <input
                type="password"
                id="old-password"
                class="form-input"
                placeholder="Enter your current password"
              />
              <button
                class="toggle-password"
                type="button"
                data-target="old-password"
              >
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </div>
          <div class="form-group">
            <label for="new-password" class="form-label">New Password</label>
            <div class="password-input-container">
              <input
                type="password"
                id="new-password"
                class="form-input"
                placeholder="Enter your new password"
              />
              <button
                class="toggle-password"
                type="button"
                data-target="new-password"
              >
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </div>
          <div class="form-group">
            <label for="confirm-password" class="form-label"
              >Confirm New Password</label
            >
            <div class="password-input-container">
              <input
                type="password"
                id="confirm-password"
                class="form-input"
                placeholder="Confirm your new password"
              />
              <button
                class="toggle-password"
                type="button"
                data-target="confirm-password"
              >
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </div>
          <div
            id="password-error"
            style="color: #e74c3c; font-size: 13px; display: none"
          ></div>
        </div>
        <div class="modal-actions">
          <button class="cancel-btn" id="cancel-password">Cancel</button>
          <button class="save-btn" id="save-password" disabled>
            Change Password
          </button>
        </div>
      </div>
    </div>

    <!-- Store Feedback Modal -->
    <div class="modal-overlay" id="store-feedback-modal">
      <div class="modal">
        <div class="modal-header">
          <h2 class="modal-title">Store Feedback</h2>
          <button class="close-modal" id="close-feedback-modal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <!-- Existing Feedback Display -->
          <div id="existing-feedback" style="display: none">
            <div class="existing-feedback-header">
              <h3>Your Current Feedback</h3>
              <button
                type="button"
                class="edit-feedback-btn"
                onclick="enableEditing()"
              >
                <i class="fas fa-edit"></i> Edit
              </button>
            </div>
            <div class="current-rating">
              <div class="stars-display" id="current-stars"></div>
              <span class="rating-text" id="current-rating-text"></span>
            </div>
            <div class="current-comment">
              <p id="current-comment-text"></p>
            </div>
            <div class="feedback-date">
              Last updated: <span id="feedback-date"></span>
            </div>
          </div>

          <!-- Feedback Form -->
          <form id="store-feedback-form">
            <div class="form-group">
              <label class="form-label"
                >How would you rate your experience?</label
              >
              <div class="star-rating">
                <input type="radio" id="star5" name="rating" value="5" />
                <label for="star5" class="star-label">★</label>
                <input type="radio" id="star4" name="rating" value="4" />
                <label for="star4" class="star-label">★</label>
                <input type="radio" id="star3" name="rating" value="3" />
                <label for="star3" class="star-label">★</label>
                <input type="radio" id="star2" name="rating" value="2" />
                <label for="star2" class="star-label">★</label>
                <input type="radio" id="star1" name="rating" value="1" />
                <label for="star1" class="star-label">★</label>
              </div>
            </div>

            <div class="form-group">
              <label for="feedback-comment" class="form-label"
                >Your Comments (Optional)</label
              >
              <textarea
                id="feedback-comment"
                class="form-textarea"
                placeholder="Share your thoughts about our store, service, or products..."
                rows="4"
              ></textarea>
            </div>

            <div
              id="feedback-error"
              style="color: #e74c3c; font-size: 13px; display: none"
            ></div>
            <div
              id="feedback-success"
              style="color: #27ae60; font-size: 13px; display: none"
            ></div>
          </form>
        </div>
        <div class="modal-actions">
          <button class="cancel-btn" id="cancel-feedback">Cancel</button>
          <button class="save-btn" id="submit-feedback" disabled>
            Submit Feedback
          </button>
        </div>
      </div>
    </div>

    <script>
      // Profile data - will be populated from API
      let profileData = {
        name: "",
        username: "",
        profilePhoto: null,
        stats: {
          orders: 0,
          favorites: 0,
          cartItems: 0,
          unclaimedOrders: 0,
        },
      };
      // DOM Elements
      const editProfileBtn = document.getElementById("edit-profile-btn");
      const editProfileModal = document.getElementById("edit-profile-modal");
      const changePasswordModal = document.getElementById(
        "change-password-modal"
      );
      const closeEditModalBtn = document.getElementById("close-edit-modal");
      const closePasswordModalBtn = document.getElementById(
        "close-password-modal"
      );
      const cancelEditBtn = document.getElementById("cancel-edit");
      const cancelPasswordBtn = document.getElementById("cancel-password");
      const saveProfileBtn = document.getElementById("save-profile");
      const savePasswordBtn = document.getElementById("save-password");
      const editNameInput = document.getElementById("edit-name");
      const editUsernameInput = document.getElementById("edit-username");
      const oldPasswordInput = document.getElementById("old-password");
      const newPasswordInput = document.getElementById("new-password");
      const confirmPasswordInput = document.getElementById("confirm-password");
      const profileNameDisplay = document.getElementById(
        "profile-name-display"
      );
      const profileUsernameDisplay = document.getElementById(
        "profile-username-display"
      );
      const profileAvatarDisplay = document.getElementById(
        "profile-avatar-display"
      );
      const photoPreview = document.getElementById("photo-preview");
      const takePhotoBtn = document.getElementById("take-photo-btn");
      const uploadPhotoBtn = document.getElementById("upload-photo-btn");
      const removePhotoBtn = document.getElementById("remove-photo-btn");
      const passwordError = document.getElementById("password-error");

      // Stats elements (ADD THESE - they were missing)
      const ordersCount = document.getElementById("orders-count");
      const favoritesCount = document.getElementById("favorites-count");
      const cartCount = document.getElementById("cart-count");
      const unclaimedCount = document.getElementById("unclaimed-count");

      // Get user session (same as home page)
      async function getUserSession() {
        try {
          const res = await fetch("../php/get-user-session.php");
          const data = await res.json();
          if (data.success && data.isLoggedIn) {
            return data.user;
          }
        } catch (err) {
          console.error("Error fetching session:", err);
        }
        return null;
      }

      async function fetchCustomerProfile() {
        try {
          console.log("Fetching customer profile...");

          if (!currentUser || !currentUser.id) {
            console.error("No user logged in - showing default profile");
            showDefaultProfile();
            return;
          }

          const response = await fetch("../php/get_profile.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              user_id: currentUser.id,
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          if (data.success) {
            console.log("Profile data received:", data);
            updateProfileDisplay(data.profile);
          } else {
            console.error("Failed to fetch profile:", data.message);
            showDefaultProfile();
          }
        } catch (error) {
          console.error("Error fetching customer profile:", error);
          showDefaultProfile();
        }
      }

      function updateProfileDisplay(profile) {
        // Update basic profile info
        profileData.name = profile.full_name || "Customer";
        profileData.username = profile.username || "user";

        // Update display elements
        profileNameDisplay.textContent = profileData.name;
        profileUsernameDisplay.textContent = `@${profileData.username}`;

        // Update avatar with first letter of name
        const firstLetter = profileData.name.charAt(0).toUpperCase();
        profileAvatarDisplay.textContent = firstLetter;
        photoPreview.textContent = firstLetter;

        // Update edit form inputs
        editNameInput.value = profileData.name;
        editUsernameInput.value = profileData.username;

        // Update stats
        if (profile.stats) {
          profileData.stats.orders = profile.stats.orders || 0;
          profileData.stats.favorites = profile.stats.favorites || 0;
          profileData.stats.cartItems = profile.stats.cart_items || 0;
          profileData.stats.unclaimedOrders =
            profile.stats.unclaimed_orders || 0;

          // Update the DOM elements
          if (ordersCount) ordersCount.textContent = profileData.stats.orders;
          if (favoritesCount)
            favoritesCount.textContent = profileData.stats.favorites;
          if (cartCount) cartCount.textContent = profileData.stats.cartItems;
          if (unclaimedCount)
            unclaimedCount.textContent = profileData.stats.unclaimedOrders;
        }

        // Update member since
        if (profile.member_since) {
          const memberElement = document.querySelector(".profile-member");
          if (memberElement) {
            const year = new Date(profile.member_since).getFullYear();
            memberElement.innerHTML = `<i class="far fa-calendar-alt"></i> Member since ${year}`;
          }
        }

        // Handle profile photo if available
        if (profile.profile_photo) {
          profileData.profilePhoto = profile.profile_photo;
          updateProfilePhoto(profile.profile_photo);
        }
      }

      // Update profile photo display function with debugging
      function updateProfilePhoto(photoUrl) {
        if (photoUrl) {
          console.log("Updating profile photo with:", photoUrl);

          // If it's a base64 image
          if (photoUrl.startsWith("data:")) {
            profileAvatarDisplay.innerHTML = `<img src="${photoUrl}" alt="Profile Photo" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            photoPreview.innerHTML = `<img src="${photoUrl}" alt="Profile Photo" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
          } else {
            // If it's a filename from database - TRY DIFFERENT PATHS
            const possiblePaths = [
              `../uploads/profiles/${photoUrl}`,
              `../../uploads/profiles/${photoUrl}`,
              `/uploads/profiles/${photoUrl}`,
              `uploads/profiles/${photoUrl}`,
              `http://localhost:8080/uploads/profiles/${photoUrl}`,
            ];

            console.log("Trying paths:", possiblePaths);

            // Try each path until one works
            let img = new Image();
            let foundWorkingPath = false;

            const tryPath = (index) => {
              if (index >= possiblePaths.length) {
                // No paths worked, show initial
                const firstLetter = profileData.name.charAt(0).toUpperCase();
                profileAvatarDisplay.textContent = firstLetter;
                photoPreview.textContent = firstLetter;
                return;
              }

              const testPath = possiblePaths[index];
              console.log(`Testing path: ${testPath}`);

              img.onload = function () {
                console.log(`Path works: ${testPath}`);
                profileAvatarDisplay.innerHTML = `<img src="${testPath}" alt="Profile Photo" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                photoPreview.innerHTML = `<img src="${testPath}" alt="Profile Photo" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                foundWorkingPath = true;
              };

              img.onerror = function () {
                console.log(`Path failed: ${testPath}`);
                tryPath(index + 1);
              };

              img.src = testPath;
            };

            tryPath(0);
          }
        }
      }

      async function saveProfileChanges() {
        try {
          const updatedData = {
            user_id: currentUser.id,
            name: editNameInput.value,
            username: editUsernameInput.value,
            profile_photo: profileData.profilePhoto,
          };

          console.log("Saving profile with photo:", !!profileData.profilePhoto);

          const response = await fetch("../php/update_profile.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(updatedData),
          });

          const responseText = await response.text();
          console.log("Raw response:", responseText);

          if (
            !responseText.trim().startsWith("{") &&
            !responseText.trim().startsWith("[")
          ) {
            throw new Error(
              "Server returned HTML instead of JSON. Check PHP file for errors."
            );
          }

          const data = JSON.parse(responseText);

          if (data.success) {
            // Update local data and display
            profileData.name = updatedData.name;
            profileData.username = updatedData.username;

            // If a photo was uploaded and saved, update the filename
            if (data.photo_filename) {
              profileData.profilePhoto = data.photo_filename;
            }

            profileNameDisplay.textContent = updatedData.name;
            profileUsernameDisplay.textContent = `@${updatedData.username}`;

            // Update avatar - if we have a photo, use it, otherwise use first letter
            if (profileData.profilePhoto) {
              if (profileData.profilePhoto.startsWith("data:")) {
                // It's still a base64 image (upload might have failed)
                profileAvatarDisplay.innerHTML = `<img src="${profileData.profilePhoto}" alt="Profile Photo" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
              } else {
                // It's a filename - construct the full URL
                const fullPhotoUrl = `../uploads/profiles/${profileData.profilePhoto}`;
                profileAvatarDisplay.innerHTML = `<img src="${fullPhotoUrl}" alt="Profile Photo" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
              }
            } else {
              const firstLetter = updatedData.name.charAt(0).toUpperCase();
              profileAvatarDisplay.textContent = firstLetter;
            }

            closeEditModal();
            alert("Profile updated successfully!");
          } else {
            alert("Error updating profile: " + data.message);
          }
        } catch (error) {
          console.error("Error saving profile:", error);
          alert("Error: " + error.message);
        }
      }
      // Update profile photo display function - USING PHP ENDPOINT
      function updateProfilePhoto(photoUrl) {
        if (photoUrl) {
          console.log("Updating profile photo with:", photoUrl);

          // If it's a base64 image
          if (photoUrl.startsWith("data:")) {
            profileAvatarDisplay.innerHTML = `<img src="${photoUrl}" alt="Profile Photo" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            photoPreview.innerHTML = `<img src="${photoUrl}" alt="Profile Photo" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
          } else {
            // Use PHP endpoint to serve the image
            const imageUrl = `../php/get_profile_image.php?filename=${encodeURIComponent(
              photoUrl
            )}&user_id=${currentUser.id}`;
            console.log("Using PHP endpoint:", imageUrl);

            profileAvatarDisplay.innerHTML = `<img src="${imageUrl}" alt="Profile Photo" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            photoPreview.innerHTML = `<img src="${imageUrl}" alt="Profile Photo" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
          }
        }
      }

      // Show default profile data (fallback)
      function showDefaultProfile() {
        if (currentUser) {
          profileNameDisplay.textContent =
            currentUser.firstName +
            (currentUser.lastName ? " " + currentUser.lastName : "");
          profileUsernameDisplay.textContent = `@${currentUser.username}`;

          const firstLetter = currentUser.firstName.charAt(0).toUpperCase();
          profileAvatarDisplay.textContent = firstLetter;
          photoPreview.textContent = firstLetter;

          editNameInput.value =
            currentUser.firstName +
            (currentUser.lastName ? " " + currentUser.lastName : "");
          editUsernameInput.value = currentUser.username;
        } else {
          // Show generic profile for non-logged in users
          profileNameDisplay.textContent = "Guest User";
          profileUsernameDisplay.textContent = "@guest";
          profileAvatarDisplay.textContent = "G";
          photoPreview.textContent = "G";
          editNameInput.value = "Guest User";
          editUsernameInput.value = "guest";

          // Hide edit button for guests
          const editBtn = document.getElementById("edit-profile-btn");
          if (editBtn) {
            editBtn.style.display = "none";
          }

          // Set default stats to 0
          if (ordersCount) ordersCount.textContent = "0";
          if (favoritesCount) favoritesCount.textContent = "0";
          if (cartCount) cartCount.textContent = "0";
          if (unclaimedCount) unclaimedCount.textContent = "0";
        }
      }
      // // Redirect to login if not authenticated
      // function redirectToLogin() {
      //     window.location.href = '../../auth/login.html';
      // }

      function initializeEventListeners() {
        // Edit Profile Modal
        editProfileBtn.addEventListener("click", openEditProfileModal);
        closeEditModalBtn.addEventListener("click", closeEditModal);
        cancelEditBtn.addEventListener("click", closeEditModal);

        // Change Password Modal
        closePasswordModalBtn.addEventListener("click", closePasswordModal);
        cancelPasswordBtn.addEventListener("click", closePasswordModal);

        // Save buttons
        saveProfileBtn.addEventListener("click", saveProfileChanges);
        savePasswordBtn.addEventListener("click", savePasswordChanges);

        // Photo actions - REMOVED takePhotoBtn
        uploadPhotoBtn.addEventListener("click", uploadPhoto);
        removePhotoBtn.addEventListener("click", removePhoto);

        // Password validation
        oldPasswordInput.addEventListener("input", validatePassword);
        newPasswordInput.addEventListener("input", validatePassword);
        confirmPasswordInput.addEventListener("input", validatePassword);

        // Initialize password toggles
        initializePasswordToggles();
      }
      // Initialize password toggle functionality
      function initializePasswordToggles() {
        const toggleButtons = document.querySelectorAll(".toggle-password");
        toggleButtons.forEach((button) => {
          button.addEventListener("click", function () {
            const targetId = this.getAttribute("data-target");
            const input = document.getElementById(targetId);
            const icon = this.querySelector("i");

            if (input.type === "password") {
              input.type = "text";
              icon.classList.remove("fa-eye");
              icon.classList.add("fa-eye-slash");
            } else {
              input.type = "password";
              icon.classList.remove("fa-eye-slash");
              icon.classList.add("fa-eye");
            }
          });
        });
      }

      // Change Password Functions
      function openChangePasswordModal() {
        const modal = document.getElementById("change-password-modal");
        modal.classList.add("active");
        resetPasswordForm();
      }

      function closeChangePasswordModal() {
        const modal = document.getElementById("change-password-modal");
        modal.classList.remove("active");
        resetPasswordForm();
      }

      function resetPasswordForm() {
        document.getElementById("old-password").value = "";
        document.getElementById("new-password").value = "";
        document.getElementById("confirm-password").value = "";
        document.getElementById("password-error").style.display = "none";
        document.getElementById("save-password").disabled = true;
      }

      function validatePasswordForm() {
        const oldPassword = document.getElementById("old-password").value;
        const newPassword = document.getElementById("new-password").value;
        const confirmPassword =
          document.getElementById("confirm-password").value;
        const saveBtn = document.getElementById("save-password");

        // Enable button only if all fields have values
        saveBtn.disabled = !(oldPassword && newPassword && confirmPassword);
      }

      async function changePassword() {
        const oldPassword = document.getElementById("old-password").value;
        const newPassword = document.getElementById("new-password").value;
        const confirmPassword =
          document.getElementById("confirm-password").value;
        const errorDiv = document.getElementById("password-error");
        const saveBtn = document.getElementById("save-password");

        // Reset error
        errorDiv.style.display = "none";

        // Validation
        if (newPassword !== confirmPassword) {
          showPasswordError("New passwords do not match");
          return;
        }

        if (newPassword.length < 8) {
          showPasswordError("Password must be at least 8 characters long");
          return;
        }

        if (oldPassword === newPassword) {
          showPasswordError("New password must be different from old password");
          return;
        }

        try {
          // Show loading state
          const originalText = saveBtn.innerHTML;
          saveBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Changing...';
          saveBtn.disabled = true;

          const response = await fetch("../php/change_password.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              old_password: oldPassword,
              new_password: newPassword,
              confirm_password: confirmPassword,
            }),
            credentials: "same-origin",
          });

          const data = await response.json();

          if (data.success) {
            // Success - close modal and show success message
            closeChangePasswordModal();
            showToast("Password changed successfully!", "success");
          } else {
            showPasswordError(data.error || "Failed to change password");
          }

          // Restore button state
          saveBtn.innerHTML = originalText;
          saveBtn.disabled = false;
        } catch (error) {
          console.error("Error changing password:", error);
          showPasswordError("Network error: Could not change password");

          // Restore button state
          saveBtn.innerHTML = "Change Password";
          saveBtn.disabled = false;
        }
      }

      function showPasswordError(message) {
        const errorDiv = document.getElementById("password-error");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
      }

      // Password visibility toggle
      function setupPasswordToggles() {
        document.querySelectorAll(".toggle-password").forEach((button) => {
          button.addEventListener("click", function () {
            const targetId = this.getAttribute("data-target");
            const input = document.getElementById(targetId);
            const icon = this.querySelector("i");

            if (input.type === "password") {
              input.type = "text";
              icon.classList.remove("fa-eye");
              icon.classList.add("fa-eye-slash");
            } else {
              input.type = "password";
              icon.classList.remove("fa-eye-slash");
              icon.classList.add("fa-eye");
            }
          });
        });
      }

      // Toast notification function (if not already exists)
      function showToast(message, type = "success") {
        // Create toast if it doesn't exist
        let toast = document.getElementById("toast-notification");
        if (!toast) {
          toast = document.createElement("div");
          toast.id = "toast-notification";
          toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            max-width: 300px;
        `;
          document.body.appendChild(toast);
        }

        // Set style based on type
        if (type === "success") {
          toast.style.background = "linear-gradient(135deg, #27ae60, #2ecc71)";
        } else {
          toast.style.background = "linear-gradient(135deg, #e74c3c, #c0392b)";
        }

        toast.textContent = message;

        // Show toast
        setTimeout(() => {
          toast.style.opacity = "1";
          toast.style.transform = "translateX(0)";
        }, 100);

        // Hide after 3 seconds
        setTimeout(() => {
          toast.style.opacity = "0";
          toast.style.transform = "translateX(100%)";
        }, 3000);
      }

      // Open edit profile modal - UPDATED
      function openEditProfileModal() {
        // Set current values in the form
        editNameInput.value = profileData.name;
        editUsernameInput.value = profileData.username;

        // Update photo preview in modal
        if (profileData.profilePhoto) {
          photoPreview.innerHTML = `<img src="${profileData.profilePhoto}" alt="Profile Photo" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
        } else {
          const firstLetter = profileData.name.charAt(0).toUpperCase();
          photoPreview.textContent = firstLetter;
        }

        editProfileModal.classList.add("active");
      }

      // Open change password modal - UPDATED
      function openChangePasswordModal() {
        // Clear previous inputs
        oldPasswordInput.value = "";
        newPasswordInput.value = "";
        confirmPasswordInput.value = "";
        passwordError.style.display = "none";
        savePasswordBtn.disabled = true;

        // Reset all eye icons to closed state
        const eyeIcons = document.querySelectorAll(".toggle-password i");
        eyeIcons.forEach((icon) => {
          icon.classList.remove("fa-eye-slash");
          icon.classList.add("fa-eye");
        });

        // Reset all password fields to password type
        const passwordInputs = document.querySelectorAll(
          'input[type="password"], input[type="text"]'
        );
        passwordInputs.forEach((input) => {
          if (input.id.includes("password")) {
            input.type = "password";
          }
        });

        changePasswordModal.classList.add("active");
      }

      // Close modal functions
      function closeEditModal() {
        editProfileModal.classList.remove("active");
      }

      function closePasswordModal() {
        changePasswordModal.classList.remove("active");
      }

      async function saveProfileChanges() {
        try {
          const updatedData = {
            user_id: currentUser.id,
            name: editNameInput.value,
            username: editUsernameInput.value,
            profile_photo: profileData.profilePhoto,
          };

          console.log("Sending data:", updatedData);

          const response = await fetch("../php/update_profile.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(updatedData),
          });

          // First, get the raw response text to see what's being returned
          const responseText = await response.text();
          console.log("Raw response:", responseText);

          // Then try to parse it as JSON
          const data = JSON.parse(responseText);

          if (data.success) {
            // Update local data and display
            profileData.name = updatedData.name;
            profileData.username = updatedData.username;
            profileNameDisplay.textContent = updatedData.name;
            profileUsernameDisplay.textContent = `@${updatedData.username}`;

            // Update avatar with first letter of new name
            const firstLetter = updatedData.name.charAt(0).toUpperCase();
            profileAvatarDisplay.textContent = firstLetter;

            closeEditModal();
            alert("Profile updated successfully!");
          } else {
            alert("Error updating profile: " + data.message);
          }
        } catch (error) {
          console.error("Error saving profile:", error);
          console.log(
            "This usually means the PHP file has an error and is returning HTML instead of JSON"
          );
          alert(
            "Error updating profile. Please check the console for details."
          );
        }
      }

      // Password validation
      function validatePassword() {
        const oldPassword = oldPasswordInput.value;
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        // Check if all fields are filled
        if (!oldPassword || !newPassword || !confirmPassword) {
          savePasswordBtn.disabled = true;
          passwordError.style.display = "none";
          return;
        }

        // Check if new password meets requirements
        if (newPassword.length < 6) {
          passwordError.textContent =
            "Password must be at least 6 characters long";
          passwordError.style.display = "block";
          savePasswordBtn.disabled = true;
          return;
        }

        // Check if passwords match
        if (newPassword !== confirmPassword) {
          passwordError.textContent = "New passwords do not match";
          passwordError.style.display = "block";
          savePasswordBtn.disabled = true;
          return;
        }

        // Check if new password is different from old password
        if (oldPassword === newPassword) {
          passwordError.textContent =
            "New password must be different from old password";
          passwordError.style.display = "block";
          savePasswordBtn.disabled = true;
          return;
        }

        // All validations passed
        passwordError.style.display = "none";
        savePasswordBtn.disabled = false;
      }

      // Save password changes - UPDATED to use API
      async function savePasswordChanges() {
        try {
          const passwordData = {
            user_id: currentUser.id,
            old_password: oldPasswordInput.value,
            new_password: newPasswordInput.value,
          };

          const response = await fetch("../php/change_password.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(passwordData),
          });

          const data = await response.json();

          if (data.success) {
            closePasswordModal();
            alert("Password changed successfully!");
          } else {
            alert("Error changing password: " + data.message);
          }
        } catch (error) {
          console.error("Error changing password:", error);
          alert("Error changing password. Please try again.");
        }
      }

      // Photo management functions
      function takePhoto() {
        alert("Camera functionality would be implemented here!");
      }
      function uploadPhoto() {
        // Create file input element
        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.accept = "image/*";

        fileInput.addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (file) {
            // Validate file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
              alert("Please select an image smaller than 2MB");
              return;
            }

            // Validate file type
            if (!file.type.startsWith("image/")) {
              alert("Please select a valid image file");
              return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
              // Store the base64 image data
              profileData.profilePhoto = e.target.result;

              // Update preview immediately
              photoPreview.innerHTML = `<img src="${e.target.result}" alt="Profile Photo" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            };
            reader.readAsDataURL(file);
          }
        });

        fileInput.click();
      }

      // Remove photo function - UPDATED
      function removePhoto() {
        profileData.profilePhoto = null;
        const firstLetter = (editNameInput.value || profileData.name)
          .charAt(0)
          .toUpperCase();
        photoPreview.textContent = firstLetter;

        // Also update the main avatar display if modal is open
        if (profileData.profilePhoto) {
          profileAvatarDisplay.textContent = firstLetter;
        }
      }

      // Update stats display
      function updateStatsDisplay() {
        if (ordersCount) ordersCount.textContent = profileData.stats.orders;
        if (favoritesCount)
          favoritesCount.textContent = profileData.stats.favorites;
        if (cartCount) cartCount.textContent = profileData.stats.cartItems;
        if (unclaimedCount)
          unclaimedCount.textContent = profileData.stats.unclaimedOrders;
      }

      // Navigate to different sections
      function navigateTo(section) {
        switch (section) {
          case "order-history":
            window.location.href = "order-history.html";
            break;
          case "review-orders":
            window.location.href = "../reviews/review_orders.html";
            break;
          case "all-reviews":
            window.location.href = "../reviews/all_reviews.html";
            break;
          case "preferences":
            window.location.href = "../preferences/customer_preferences.html";
            break;
          default:
            console.log("Navigation to", section);
        }
      }

      // Profile-specific greeting (you can keep this or use the generic one)
      async function updateProfileGreeting() {
        if (!currentUser) {
          console.warn("No user logged in for greeting");
          return;
        }

        const greetingElement = document.getElementById("user-greeting");
        if (greetingElement) {
          greetingElement.textContent = `Hi, ${currentUser.firstName}!`;
        }
      }

      // Store Feedback Functions
      async function openStoreFeedbackModal() {
        const modal = document.getElementById("store-feedback-modal");
        modal.classList.add("active");

        // Load existing feedback from database
        await loadExistingFeedback();
      }

      function closeStoreFeedbackModal() {
        const modal = document.getElementById("store-feedback-modal");
        modal.classList.remove("active");
        resetFeedbackForm();
      }

      async function loadExistingFeedback() {
        try {
          const response = await fetch("../php/get_store_feedback.php", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "same-origin",
          });

          if (response.ok) {
            const data = await response.json();

            if (data.success && data.feedback) {
              showExistingFeedback(data.feedback);
            } else {
              showNewFeedbackForm();
            }
          } else {
            throw new Error("Failed to load feedback");
          }
        } catch (error) {
          console.error("Error loading feedback:", error);
          showNewFeedbackForm();
        }
      }

      function showExistingFeedback(feedback) {
        document.getElementById("existing-feedback").style.display = "block";
        document.getElementById("store-feedback-form").style.display = "none";
        document.getElementById("submit-feedback").style.display = "none";

        // Display current feedback
        document.getElementById("current-stars").innerHTML = "★".repeat(
          feedback.rating
        );
        document.getElementById(
          "current-rating-text"
        ).textContent = `${feedback.rating}/5 stars`;
        document.getElementById("current-comment-text").textContent =
          feedback.comment || "No comment provided.";
        document.getElementById("feedback-date").textContent = new Date(
          feedback.created_at
        ).toLocaleDateString();
      }

      function showNewFeedbackForm() {
        document.getElementById("existing-feedback").style.display = "none";
        document.getElementById("store-feedback-form").style.display = "block";
        document.getElementById("submit-feedback").style.display = "block";
      }

      function enableEditing() {
        // We'll load the existing data into the form for editing
        document.getElementById("existing-feedback").style.display = "none";
        document.getElementById("store-feedback-form").style.display = "block";
        document.getElementById("submit-feedback").style.display = "block";

        // The form will be empty initially, we'll populate it when user clicks edit
        loadCurrentFeedbackIntoForm();
      }

      async function loadCurrentFeedbackIntoForm() {
        try {
          const response = await fetch("../php/get_store_feedback.php", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "same-origin",
          });

          if (response.ok) {
            const data = await response.json();

            if (data.success && data.feedback) {
              const feedback = data.feedback;

              // Populate form with existing data
              document.querySelector(
                `input[name="rating"][value="${feedback.rating}"]`
              ).checked = true;
              document.getElementById("feedback-comment").value =
                feedback.comment || "";

              updateSubmitButton();
            }
          }
        } catch (error) {
          console.error("Error loading current feedback:", error);
        }
      }

      async function submitFeedback() {
        const rating = document.querySelector('input[name="rating"]:checked');
        const comment = document.getElementById("feedback-comment").value;
        const errorDiv = document.getElementById("feedback-error");
        const successDiv = document.getElementById("feedback-success");

        if (!rating) {
          showError("Please select a rating");
          return;
        }

        try {
          const response = await fetch("../php/save_store_feedback.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              rating: parseInt(rating.value),
              comment: comment.trim(),
            }),
            credentials: "same-origin",
          });

          const data = await response.json();

          if (data.success) {
            // Show success message
            successDiv.textContent = "Thank you for your feedback!";
            successDiv.style.display = "block";
            errorDiv.style.display = "none";

            // Close modal after delay
            setTimeout(() => {
              closeStoreFeedbackModal();
            }, 1500);
          } else {
            showError(data.error || "Failed to save feedback");
          }
        } catch (error) {
          console.error("Error submitting feedback:", error);
          showError("Network error: Could not submit feedback");
        }
      }

      function resetFeedbackForm() {
        document.getElementById("feedback-error").style.display = "none";
        document.getElementById("feedback-success").style.display = "none";
        document.getElementById("store-feedback-form").reset();
        document.getElementById("submit-feedback").disabled = true;
      }

      function showError(message) {
        const errorDiv = document.getElementById("feedback-error");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
      }

      function updateSubmitButton() {
        const rating = document.querySelector('input[name="rating"]:checked');
        const submitBtn = document.getElementById("submit-feedback");
        submitBtn.disabled = !rating;
      }

      document.addEventListener("DOMContentLoaded", async function () {
        // Use setupPageProtection if it exists, otherwise skip
        if (typeof setupPageProtection === "function") {
          setupPageProtection();
        }

        console.log("Profile page loaded");

        // Use your existing authentication system
        currentUser = await fetchUserSession();
        if (!currentUser) return; // Will redirect if not logged in

        // updateUserGreeting() is already called by fetchUserSession internally
        // But you can call it again if you want to ensure it's updated
        await updateUserGreeting();

        console.log("User is logged in:", currentUser);

        try {
          // Fetch and display customer profile data
          await fetchCustomerProfile();

          // Initialize event listeners for modals and buttons
          initializeEventListeners();

          updateStatsDisplay();
        } catch (error) {
          console.error("Error initializing profile page:", error);
          showErrorState("Failed to load profile data");
        }

        // Star rating change
        document.querySelectorAll('input[name="rating"]').forEach((radio) => {
          radio.addEventListener("change", updateSubmitButton);
        });

        // Submit button
        document
          .getElementById("submit-feedback")
          .addEventListener("click", submitFeedback);

        // Close modal buttons
        document
          .getElementById("close-feedback-modal")
          .addEventListener("click", closeStoreFeedbackModal);
        document
          .getElementById("cancel-feedback")
          .addEventListener("click", closeStoreFeedbackModal);

        // Close modal when clicking outside
        document
          .getElementById("store-feedback-modal")
          .addEventListener("click", function (e) {
            if (e.target === this) {
              closeStoreFeedbackModal();
            }
          });
        setupPasswordToggles();

        // Real-time validation
        document
          .getElementById("old-password")
          .addEventListener("input", validatePasswordForm);
        document
          .getElementById("new-password")
          .addEventListener("input", validatePasswordForm);
        document
          .getElementById("confirm-password")
          .addEventListener("input", validatePasswordForm);

        // Save button
        document
          .getElementById("save-password")
          .addEventListener("click", changePassword);

        // Close modal buttons
        document
          .getElementById("close-password-modal")
          .addEventListener("click", closeChangePasswordModal);
        document
          .getElementById("cancel-password")
          .addEventListener("click", closeChangePasswordModal);

        // Close modal when clicking outside
        document
          .getElementById("change-password-modal")
          .addEventListener("click", function (e) {
            if (e.target === this) {
              closeChangePasswordModal();
            }
          });
      });

      function showErrorState(message) {
        console.error(message);
        // Optional: Show user-friendly error message
      }
    </script>
  </body>
</html>
