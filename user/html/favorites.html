<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Favorites | Blessence</title>
    <link rel="icon" href="../../admin/images/mainlogo.png" type="image/png" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="../styles/styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <script src="../js/user-session.js"></script>
    <script src="../js/notifications.js"></script>
    <script src="../js/user-profile-picture.js"></script>
    <script src="../js/load-profile-notification.js"></script>

    <style>
      :root {
        --primary-pink: #ec4899;
        --dark-pink: #db2777;
        --light-pink: #fbcfe8;
        --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      .nav-item {
        position: relative;
      }

      .nav-cart-count {
        position: absolute;
        top: -5px;
        right: -5px;
        background: var(--primary-pink);
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
      }
      .nav-cart-count.show {
        display: flex;
        animation: bounce 0.3s ease;
      }

      @keyframes bounce {
        0% {
          transform: scale(0.5);
        }
        50% {
          transform: scale(1.2);
        }
        100% {
          transform: scale(1);
        }
      }

      /* Search & Filter Container */
      .search-container {
        padding: 15px 20px;
        background-color: transparent;
        display: flex;
        align-items: center;
        gap: 10px;
        max-width: 1200px;
        margin: 0 auto;
        position: relative;
        z-index: 100;
      }

      .search-bar {
        flex-grow: 1;
        display: flex;
        align-items: center;
        background-color: #ffffff;
        border-radius: 25px;
        padding: 10px 20px;
        box-shadow: var(--card-shadow);
        transition: box-shadow 0.3s ease;
      }

      .search-bar:focus-within {
        box-shadow: 0 0 0 2px var(--light-pink);
      }

      .search-bar i {
        color: var(--text-gray, #888);
        margin-right: 10px;
      }

      .search-bar input {
        border: none;
        background: transparent;
        outline: none;
        width: 100%;
        font-size: 16px;
        font-family: "Montserrat", sans-serif;
        color: #333;
      }

      .search-bar input::placeholder {
        color: #999;
      }

      /* Filter Button Styles */
      .filter-wrapper {
        position: relative;
      }

      .filter-btn {
        background-color: #ffffff;
        border: none;
        border-radius: 25px;
        padding: 10px 20px;
        box-shadow: var(--card-shadow);
        color: var(--text-gray, #555);
        font-family: "Montserrat", sans-serif;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        height: 44px;
        white-space: nowrap;
        position: relative;
      }

      .filter-btn:hover, .filter-btn.active {
        color: var(--primary-pink);
        transform: translateY(-1px);
        box-shadow: 0 5px 15px rgba(236, 72, 153, 0.15);
      }

      .filter-badge {
        background: var(--primary-pink);
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 11px;
        display: none;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        position: absolute;
        top: -5px;
        right: -5px;
        animation: bounceIn 0.3s ease;
      }

      .filter-badge.show {
        display: flex;
      }

      @keyframes bounceIn {
        0% { transform: scale(0); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
      }

      .filter-dropdown {
        position: absolute;
        top: 110%;
        right: 0;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        width: 200px;
        padding: 8px 0;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
        z-index: 2100;
        overflow: hidden;
      }

      .filter-dropdown.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .filter-option {
        padding: 10px 20px;
        font-size: 13px;
        color: #444;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-family: "Montserrat", sans-serif;
      }

      .filter-option:hover {
        background-color: #fff0f7;
        color: var(--primary-pink);
      }

      .filter-option.selected {
        background-color: #fff0f7;
        color: var(--primary-pink);
        font-weight: 600;
      }

      .filter-option.selected::after {
        content: 'âœ“';
        font-weight: bold;
        margin-left: 8px;
      }
      
      .filter-option.remove-filter {
        border-top: 1px solid #eee;
        color: #ef4444;
        margin-top: 5px;
      }
      .filter-option.remove-filter:hover {
        background-color: #fef2f2;
      }

      /* Active Filters Display */
      .active-filters-container {
        padding: 10px 20px;
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        min-height: 40px;
        transition: all 0.3s ease;
      }

      .active-filters-container:empty {
        display: none;
      }

      .filter-tag {
        background: linear-gradient(135deg, var(--primary-pink), var(--dark-pink));
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-family: "Montserrat", sans-serif;
        display: flex;
        align-items: center;
        gap: 6px;
        animation: slideIn 0.3s ease;
        box-shadow: 0 2px 8px rgba(236, 72, 153, 0.3);
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .filter-tag i {
        cursor: pointer;
        font-size: 10px;
        padding: 2px;
        transition: transform 0.2s;
      }

      .filter-tag i:hover {
        transform: scale(1.3);
      }

      .clear-all-filters {
        background: #ef4444;
        color: white;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 12px;
        font-family: "Montserrat", sans-serif;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s ease;
        font-weight: 500;
      }

      .clear-all-filters:hover {
        background: #dc2626;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
      }

      /* Results Counter */
      .results-counter {
        text-align: left;
        padding: 10px 20px;
        max-width: 1200px;
        margin: 0 auto;
        font-family: "Montserrat", sans-serif;
        font-size: 14px;
        color: #666;
      }

      /* Products Grid */
      .products-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
        text-align: center;
      }

      .section-title {
        font-size: 28px;
        font-weight: 600;
        color: var(--dark-gray);
        margin-bottom: 30px;
        font-family: "Cormorant Garamond", serif;
        position: relative;
        padding-bottom: 10px;
        text-align: center;
      }

      .section-title::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 3px;
        background: linear-gradient(
          to right,
          var(--primary-pink),
          var(--light-pink)
        );
        border-radius: 3px;
      }

      .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 20px;
        justify-items: center;
      }

      .product-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        width: 100%;
        max-width: 280px;
        position: relative;
        display: flex;
        flex-direction: column;
        height: 100%;
        cursor: pointer;
      }

      .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      }

      .product-image-container {
        width: 100%;
        height: 200px;
        background: #f35693;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        flex-shrink: 0;
      }

      .product-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: opacity 0.4s ease-in-out;
      }

      .product-image.fade-out {
        opacity: 0;
      }

      .product-image.fade-in {
        opacity: 1;
      }

      .product-card:hover .product-image {
        transform: scale(1.05);
      }

      .product-info {
        padding: 20px;
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        justify-content: space-between;
      }

      .product-name {
        font-size: 20px;
        font-weight: 500;
        color: #272727;
        margin-bottom: 6px;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        font-family: "Cormorant Garamond", serif;
        -webkit-box-orient: vertical;
        overflow: hidden;
        min-height: auto;
      }

      .product-price {
        font-size: 16px;
        font-weight: 600;
        color: var(--primary-pink);
        margin-bottom: 8px;
        text-align: center;
      }

      .product-ratings {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 12px;
        gap: 6px;
      }

      .stars {
        display: flex;
        gap: 1px;
        justify-content: center;
      }

      .stars i {
        color: #f3b8d3;
        font-size: 12px;
      }

      .rating-count {
        font-size: 11px;
        color: #666;
      }

      .variant-colors {
        display: flex;
        gap: 6px;
        margin-bottom: 15px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .color-circle {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid #f3b8d3;
        cursor: pointer;
        transition: all 0.3s ease;
        display: block;
        text-align: center;
      }

      .color-circle:hover {
        transform: scale(1.3);
        border-color: #ec4899;
        box-shadow: 0 4px 12px rgba(255, 157, 217, 0.932);
      }

      .color-circle.active {
        border: 2px solid #ff3a9d;
        transform: scale(1.2);
      }

      .product-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 12px;
        border-top: 1px solid #f0f0f0;
        margin-top: auto;
      }

      .like-btn {
        background: none;
        border: none;
        color: #ccc;
        font-size: 16px;
        cursor: pointer;
        transition: color 0.3s ease;
        padding: 6px;
      }

      .like-btn:hover,
      .like-btn.liked {
        color: var(--primary-pink);
      }

      .add-to-cart-btn {
        background: var(--primary-pink);
        color: white;
        border: none;
        border-radius: 18px;
        padding: 6px 14px;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .add-to-cart-btn:hover {
        background: var(--dark-pink);
        transform: translateY(-1px);
      }

      .no-image-placeholder {
        width: 80px;
        height: 80px;
        opacity: 0.3;
        object-fit: contain !important;
      }

      .stock-alert {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #dc2626;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: bold;
        z-index: 10;
      }

      /* Notification Box */
      #notification-box {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        color: white;
        padding: 15px 25px;
        border-radius: 12px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        opacity: 0;
        transform: translateY(-20px);
        transition: all 0.3s ease;
        pointer-events: none;
      }

      #notification-box.show {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }

      /* Responsive Design */
      @media (min-width: 768px) {
        .products-grid {
          grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
          gap: 25px;
        }

        .product-image-container {
          height: 220px;
        }

        .product-name {
          font-size: 15px;
        }

        .product-price {
          font-size: 17px;
        }
      }

      @media (min-width: 1024px) {
        .products-container {
          max-width: 12000px;
          margin: 0 auto;
          padding-top: 40px;
        }

        .products-grid {
          grid-template-columns: repeat(5, 1fr);
          gap: 30px;
        }

        .product-image-container {
          height: 280px;
        }

        .product-name {
          font-size: 18px;
        }

        .product-price {
          font-size: 18px;
        }
      }

      @media (max-width: 767px) {
        .products-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 15px;
        }

        .product-image-container {
          height: 180px;
        }

        .filter-btn span {
          display: none;
        }
        .filter-btn {
          padding: 10px;
        }
      }

      @media (max-width: 480px) {
        .products-container {
          padding: 15px;
        }

        .products-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 12px;
        }

        .product-image-container {
          height: 160px;
        }

        .product-info {
          padding: 12px;
        }

        .product-name {
          font-size: 13px;
        }

        .product-price {
          font-size: 15px;
        }
      }

      @media (max-width: 360px) {
        .products-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 10px;
        }

        .product-image-container {
          height: 140px;
        }

        .product-info {
          padding: 10px;
        }

        .product-name {
          font-size: 12px;
        }

        .variant-colors {
          gap: 4px;
          margin-bottom: 10px;
        }

        .color-circle {
          width: 16px;
          height: 16px;
        }
      }

      /* Unlike Modal */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }

      .modal-content {
        background: white;
        padding: 25px 30px;
        border-radius: 12px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        font-family: "Cormorant Garamond", serif;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      }

      .modal-content p {
        font-size: 16px;
        margin-bottom: 20px;
        color: #272727;
      }

      .modal-buttons {
        display: flex;
        justify-content: space-around;
        gap: 15px;
      }

      .modal-btn {
        padding: 8px 16px;
        border-radius: 20px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: "Montserrat", sans-serif;
      }

      .cancel-btn {
        background: #f3f3f3;
        color: #272727;
      }

      .cancel-btn:hover {
        background: #e0e0e0;
      }

      .confirm-btn {
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        color: white;
      }

      .confirm-btn:hover {
        background: linear-gradient(
          135deg,
          var(--dark-pink),
          var(--primary-pink)
        );
        transform: translateY(-2px);
      }

      /* Cart total popup */
      .cart-total-popup {
        position: absolute;
        background: white;
        border-radius: 12px;
        padding: 12px 16px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        min-width: 160px;
        max-width: 180px;
        transform: translateY(-8px) scale(0.95);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1000;
        border: 1px solid #f3f4f6;
        text-align: center;
      }

      .desktop-nav .cart-total-popup {
        top: calc(100% + 8px);
        right: 50%;
        transform: translateX(50%) translateY(-8px) scale(0.95);
      }

      .desktop-nav .cart-total-popup::before {
        content: "";
        position: absolute;
        top: -6px;
        left: 50%;
        transform: translateX(-50%) rotate(45deg);
        width: 12px;
        height: 12px;
        background: white;
        border-left: 1px solid #f3f4f6;
        border-top: 1px solid #f3f4f6;
      }

      .mobile-nav .cart-total-popup {
        bottom: calc(100% + 8px);
        right: 50%;
        transform: translateX(50%) translateY(8px) scale(0.95);
      }

      .mobile-nav .cart-total-popup::before {
        content: "";
        position: absolute;
        bottom: -6px;
        left: 50%;
        transform: translateX(-50%) rotate(45deg);
        width: 12px;
        height: 12px;
        background: white;
        border-right: 1px solid #f3f4f6;
        border-bottom: 1px solid #f3f4f6;
      }

      .cart-total-popup.show {
        transform: translateX(50%) translateY(0) scale(1);
        opacity: 1;
        visibility: visible;
      }

      .cart-total-amount {
        font-size: 16px;
        font-weight: 700;
        color: var(--primary-pink);
        margin: 3px 0;
        line-height: 1.2;
      }

      .cart-total-label {
        font-size: 11px;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
      }

      .cart-total-popup small {
        font-size: 10px;
        color: #9ca3af;
        display: block;
        margin-top: 2px;
        line-height: 1.3;
      }

      /* Categories */
      .categories {
        padding: 12px 18px;
        overflow-x: auto;
        white-space: nowrap;
        background: transparent;
        position: relative;
        backdrop-filter: blur(10px);
      }
      .categories::-webkit-scrollbar {
        height: 4px;
      }
      .categories::-webkit-scrollbar-track {
        background: rgba(255, 182, 193, 0.15);
        border-radius: 10px;
      }
      .categories::-webkit-scrollbar-thumb {
        background: linear-gradient(90deg, var(--primary-pink), var(--dark-pink));
        border-radius: 10px;
      }
      #categories-container {
        display: inline-flex;
        gap: 10px;
        padding: 3px;
      }

      .category-btn {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
        color: #ea9ec4;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        position: relative;
        overflow: hidden;
        white-space: nowrap;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 182, 193, 0.2);
        flex: 1;
        min-width: 140px;
        text-align: center;
        justify-content: center;
      }
      .category-btn:before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
        transition: left 0.7s;
      }
      .category-btn:hover:before {
        left: 100%;
      }
      .category-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 12px rgba(255, 105, 180, 0.2);
        color: var(--primary-pink);
      }
      .category-btn.active {
        background: linear-gradient(135deg, var(--primary-pink), var(--dark-pink));
        color: white;
        box-shadow: 0 4px 12px rgba(255, 105, 180, 0.3);
        transform: translateY(-1px);
      }
      .category-btn i {
        margin-right: 6px;
        font-size: 14px;
      }

      @media (max-width: 768px) {
        .categories {
          padding: 10px 15px;
          border-radius: 16px;
        }
        .category-btn {
          padding: 7px 14px;
          font-size: 13px;
          border-radius: 18px;
        }
        .category-btn i {
          margin-right: 5px;
          font-size: 13px;
        }
      }
    </style>
  </head>

  <body>
    <!-- Notification Box -->
    <div id="notification-box"></div>

    <!-- Header -->
    <header class="header">
      <div class="brand-header">
        <h1 class="brand-name">Blessence</h1>
        <p class="brand-tagline">Beauty & Blessed Online Makeup Store</p>
      </div>

      <div class="user-section">
        <span class="user-greeting" id="user-greeting">Hi, User!</span>

        <div class="notification-container">
          <button class="notif-btn" id="notif-btn">
            <i class="fas fa-bell"></i>
            <span class="notif-badge" id="notif-badge">0</span>
          </button>

          <div class="notif-dropdown" id="notif-dropdown">
            <div class="notif-header">
              <span>Notifications</span>
              <i
                class="fas fa-check-double"
                style="font-size: 12px; cursor: pointer; color: #999"
                title="Mark all as read"
              ></i>
            </div>
            <div class="notif-list" id="notif-list">
              <div class="notif-empty">Loading...</div>
            </div>
          </div>
        </div>

        <button
          class="profile-btn"
          onclick="window.location.href='user_profile.html'"
        >
          <i class="fas fa-user"></i>
        </button>
      </div>

      <button
        class="mobile-profile-btn"
        onclick="window.location.href='user_profile.html'"
      >
        <i class="fas fa-user"></i>
      </button>
    </header>

    <!-- Navigation -->
    <nav class="desktop-nav">
      <a href="home.html" class="nav-item" data-page="home"
        ><i class="fas fa-home"></i><span>Home</span></a
      >
      <a href="favorites.html" class="nav-item active" data-page="favorites"
        ><i class="fas fa-heart"></i><span>Favorites</span></a
      >
      <a href="recommender.html" class="nav-item" data-page="recommender"
        ><i class="fas fa-star"></i><span>Recommender</span></a
      >
      <a href="cart.html" class="nav-item" data-page="cart">
        <i class="fas fa-shopping-cart"></i>
        <span>Cart</span>
        <div class="nav-cart-count">0</div>
      </a>
      <a href="try-on.html" class="nav-item" data-page="tryon"
        ><i class="fas fa-camera"></i><span>Virtual Try-On</span></a
      >
    </nav>

    <!-- Search Bar and Filter -->
    <div class="search-container">
      <div class="search-bar">
        <i class="fas fa-search"></i>
        <input type="text" id="search-input" placeholder="Search favorites..." />
      </div>
      
      <div class="filter-wrapper">
        <button class="filter-btn" id="filter-toggle">
            <i class="fas fa-filter"></i>
            <span>Sort</span>
            <span class="filter-badge" id="filter-badge">0</span>
        </button>
        <div class="filter-dropdown" id="filter-options">
            <div class="filter-option" data-sort="az">A-Z Name</div>
            <div class="filter-option" data-sort="za">Z-A Name</div>
            <div class="filter-option" data-sort="price_asc">Lowest Price</div>
            <div class="filter-option" data-sort="price_desc">Highest Price</div>
            <div class="filter-option" data-sort="rating_desc">Highest Rating</div>
            <div class="filter-option remove-filter" data-sort="none">Remove Sort</div>
        </div>
      </div>
    </div>

    <!-- Active Filters Display -->
    <div class="active-filters-container" id="active-filters"></div>

    <!-- Categories -->
    <div class="categories overflow-x-auto whitespace-nowrap">
      <div id="categories-container" class="inline-flex space-x-3 pb-2"></div>
    </div>

    <!-- Results Counter -->
    <div class="results-counter" id="results-counter"></div>

    <main>
      <section id="favorites" class="page-content">
        <div class="products-container">
          <div class="products-grid" id="favorites-grid">
            <p class="text-center p-4 text-gray-500">
              Loading your favorites...
            </p>
          </div>
        </div>
      </section>
    </main>

    <!-- Unlike Confirmation Modal -->
    <div id="unlike-modal" class="modal">
      <div class="modal-content">
        <p>Are you sure you want to remove this product from your favorites?</p>
        <div class="modal-buttons">
          <button id="cancel-unlike" class="modal-btn cancel-btn">
            Cancel
          </button>
          <button id="confirm-unlike" class="modal-btn confirm-btn">
            Yes, Remove
          </button>
        </div>
      </div>
    </div>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
      <div class="mobile-nav-items">
        <a href="home.html" class="nav-item" data-page="home">
          <i class="fas fa-home"></i>
          <span>Home</span>
        </a>
        <a href="favorites.html" class="nav-item active" data-page="favorites">
          <i class="fas fa-heart"></i>
          <span>Favorites</span>
        </a>
        <a href="recommender.html" class="nav-item" data-page="recommender">
          <i class="fas fa-star"></i>
          <span>Recommender</span>
        </a>
        <a href="cart.html" class="nav-item" data-page="cart">
          <i class="fas fa-shopping-cart"></i>
          <span>Cart</span>
          <div class="nav-cart-count">0</div>
        </a>
        <a href="try-on.html" class="nav-item" data-page="tryon">
          <i class="fas fa-camera"></i>
          <span>Try-On</span>
        </a>
      </div>
    </nav>

    <script>
      // --- GLOBAL STATE ---
      let allFavorites = [];
      let currentButton = null;
      let currentProductId = null;
      let currentUserId = null;
      let selectedCategories = []; // Array for multiple categories
      let currentSort = null;
      let currentSearchTerm = '';

      const normalizeCategory = (cat) => (cat || "").toLowerCase();

      // --- FILTER & DISPLAY FUNCTIONS ---
      function updateActiveFiltersDisplay() {
        const container = document.getElementById('active-filters');
        const filterBadge = document.getElementById('filter-badge');
        if (!container) return;

        container.innerHTML = '';
        let filterCount = 0;

        // Display selected categories
        selectedCategories.forEach(cat => {
          filterCount++;
          const tag = document.createElement('div');
          tag.className = 'filter-tag';
          tag.innerHTML = `
            <i class="fas fa-tag"></i>
            <span>${cat.charAt(0).toUpperCase() + cat.slice(1)}</span>
            <i class="fas fa-times" onclick="removeCategory('${cat}')"></i>
          `;
          container.appendChild(tag);
        });

        // Display current sort
        if (currentSort) {
          filterCount++;
          const sortLabels = {
            'az': 'A-Z',
            'za': 'Z-A',
            'price_asc': 'Price: Low to High',
            'price_desc': 'Price: High to Low',
            'rating_desc': 'Top Rated'
          };
          const tag = document.createElement('div');
          tag.className = 'filter-tag';
          tag.innerHTML = `
            <i class="fas fa-sort"></i>
            <span>${sortLabels[currentSort]}</span>
            <i class="fas fa-times" onclick="removeSort()"></i>
          `;
          container.appendChild(tag);
        }

        // Display search term
        if (currentSearchTerm) {
          filterCount++;
          const tag = document.createElement('div');
          tag.className = 'filter-tag';
          tag.innerHTML = `
            <i class="fas fa-search"></i>
            <span>"${currentSearchTerm}"</span>
            <i class="fas fa-times" onclick="clearSearch()"></i>
          `;
          container.appendChild(tag);
        }

        // Clear all button
        if (filterCount > 0) {
          const clearBtn = document.createElement('button');
          clearBtn.className = 'clear-all-filters';
          clearBtn.innerHTML = '<i class="fas fa-times-circle"></i> Clear All';
          clearBtn.onclick = clearAllFilters;
          container.appendChild(clearBtn);
        }

        // Update badge
        if (filterBadge) {
          filterBadge.textContent = filterCount;
          if (filterCount > 0) {
            filterBadge.classList.add('show');
          } else {
            filterBadge.classList.remove('show');
          }
        }
      }

      function removeCategory(category) {
        selectedCategories = selectedCategories.filter(c => c !== category);
        updateCategoryButtons();
        updateActiveFiltersDisplay();
        applyFilters();
      }

      function removeSort() {
        currentSort = null;
        document.querySelectorAll('.filter-option').forEach(o => o.classList.remove('selected'));
        updateActiveFiltersDisplay();
        applyFilters();
      }

      function clearSearch() {
        currentSearchTerm = '';
        const searchInput = document.getElementById('search-input');
        if (searchInput) searchInput.value = '';
        updateActiveFiltersDisplay();
        applyFilters();
      }

      function clearAllFilters() {
        selectedCategories = [];
        currentSort = null;
        currentSearchTerm = '';
        const searchInput = document.getElementById('search-input');
        if (searchInput) searchInput.value = '';
        document.querySelectorAll('.filter-option').forEach(o => o.classList.remove('selected'));
        updateCategoryButtons();
        updateActiveFiltersDisplay();
        applyFilters();
      }

      function applyFilters() {
        let result = [...allFavorites];

        // 1. Filter by Categories (multiple selection)
        if (selectedCategories.length > 0) {
          result = result.filter(p => 
            selectedCategories.includes(normalizeCategory(p.category))
          );
        }

        // 2. Filter by Search Term
        if (currentSearchTerm) {
          result = result.filter(p => {
            const term = currentSearchTerm.toLowerCase();
            const inName = (p.name || '').toLowerCase().includes(term);
            const inCat = (p.category || '').toLowerCase().includes(term);
            const inVariants = p.variants && p.variants.some(v => v.name.toLowerCase().includes(term));
            return inName || inCat || inVariants;
          });
        }

        // 2. Apply Sort
        if (currentSort) {
          result.sort((a, b) => {
            switch(currentSort) {
              case 'az': 
                return a.name.localeCompare(b.name);
              case 'za': 
                return b.name.localeCompare(a.name);
              case 'price_asc': 
                return parseFloat(a.price) - parseFloat(b.price);
              case 'price_desc': 
                return parseFloat(b.price) - parseFloat(a.price);
              case 'rating_desc': 
                return (parseFloat(b.average_rating) || 0) - (parseFloat(a.average_rating) || 0);
              default: return 0;
            }
          });
        }

        updateResultsCounter(result.length);
        renderFilteredFavorites(result);
      }

      // --- CATEGORY FILTER (MULTI-SELECT) ---
      function handleCategoryClick(category) {
        const normalizedCat = normalizeCategory(category);
        
        if (normalizedCat === 'all') {
          // Reset all categories
          selectedCategories = [];
        } else {
          // Toggle category selection
          const index = selectedCategories.indexOf(normalizedCat);
          if (index > -1) {
            selectedCategories.splice(index, 1);
          } else {
            selectedCategories.push(normalizedCat);
          }
        }
        
        updateCategoryButtons();
        updateActiveFiltersDisplay();
        applyFilters();
      }

      function updateCategoryButtons() {
        document.querySelectorAll(".category-btn").forEach((btn) => {
          const cat = btn.getAttribute("data-category");
          if (cat === 'all') {
            // "All" button is active only when no categories are selected
            if (selectedCategories.length === 0) {
              btn.classList.add("active");
            } else {
              btn.classList.remove("active");
            }
          } else {
            // Other buttons are active if they're in the selectedCategories array
            if (selectedCategories.includes(cat)) {
              btn.classList.add("active");
            } else {
              btn.classList.remove("active");
            }
          }
        });
      }

      function updateResultsCounter(count) {
        const counter = document.getElementById('results-counter');
        if (!counter) return;
        
        if (count === allFavorites.length) {
          counter.textContent = `Showing all ${count} favorite${count !== 1 ? 's' : ''}`;
        } else {
          counter.textContent = `Found ${count} of ${allFavorites.length} favorite${allFavorites.length !== 1 ? 's' : ''}`;
        }
      }

      function renderFilteredFavorites(filteredFavorites) {
        const favoritesGrid = document.getElementById("favorites-grid");
        if (!favoritesGrid) return;
        favoritesGrid.innerHTML = "";

        if (filteredFavorites.length === 0) {
          if (currentSearchTerm || currentSort) {
            favoritesGrid.innerHTML = '<p class="text-center p-4 text-gray-500">No favorites match your filters.</p>';
          } else {
            favoritesGrid.innerHTML = '<p class="text-center p-4 text-gray-500">You have no favorite products yet.</p>';
          }
          return;
        }

        filteredFavorites.forEach((product) => {
          favoritesGrid.appendChild(createProductCard(product));
        });
      }

      function initFilterDropdown() {
        const btn = document.getElementById('filter-toggle');
        const dropdown = document.getElementById('filter-options');
        const options = document.querySelectorAll('.filter-option');

        if(!btn || !dropdown) return;

        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          dropdown.classList.toggle('show');
          btn.classList.toggle('active');
        });

        document.addEventListener('click', (e) => {
          if (!btn.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.remove('show');
            btn.classList.remove('active');
          }
        });

        options.forEach(option => {
          option.addEventListener('click', () => {
            const sortType = option.getAttribute('data-sort');
            
            if (sortType === 'none') {
              currentSort = null;
              options.forEach(o => o.classList.remove('selected'));
            } else {
              currentSort = sortType;
              options.forEach(o => o.classList.remove('selected'));
              option.classList.add('selected');
            }

            dropdown.classList.remove('show');
            btn.classList.remove('active');
            
            updateActiveFiltersDisplay();
            applyFilters();
          });
        });
      }

      function initSearch() {
        const searchInput = document.getElementById("search-input");
        const searchIcon = document.querySelector(".search-bar .fa-search");
        if (!searchInput) return;

        const performSearch = () => {
          currentSearchTerm = searchInput.value.trim();
          updateActiveFiltersDisplay();
          applyFilters();
        };

        let debounceTimer;
        searchInput.addEventListener("input", () => {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(performSearch, 300);
        });
        
        if(searchIcon) searchIcon.addEventListener("click", performSearch);
        searchInput.addEventListener("keypress", (e) => { 
          if (e.key === "Enter") performSearch(); 
        });
      }

      // --- Get User Session ---
      async function getUserSession() {
        try {
          const res = await fetch("../php/get-user-session.php");
          const data = await res.json();
          if (data.success && data.isLoggedIn) {
            currentUserId = data.user.id;
            return data.user;
          }
        } catch (err) {
          console.error("Error fetching session:", err);
        }
        return null;
      }

      // --- Clean Product Name ---
      const cleanProductName = (name) => {
        if (!name) return "";
        return name
          .toString()
          .replace(/Product Record/gi, "")
          .replace(/Parent Record/gi, "")
          .replace(/:\s*/g, "")
          .replace(/\s+/g, " ")
          .trim();
      };

      function createProductCard(product) {
        const card = document.createElement("div");
        card.className = "product-card";
        card.style.cursor = "pointer";

        const LOCAL_FALLBACK_IMAGE =
          "/admin/uploads/product_images/no-image.png";
        const previewImage =
          product.previewImage || product.image || LOCAL_FALLBACK_IMAGE;
        const defaultImage =
          product.image || previewImage || LOCAL_FALLBACK_IMAGE;

        const priceDisplay =
          parseFloat(product.price) > 0
            ? `â‚±${parseFloat(product.price).toFixed(2)}`
            : "â‚±0.00";
        const stockAlert =
          product.stockQuantity && product.stockQuantity <= 5
            ? `<div class="stock-alert">Only ${product.stockQuantity} left!</div>`
            : "";

        const averageRating = parseFloat(product.average_rating) || 0;
        const generateStarHTML = (rating) => {
          const fullStars = Math.floor(rating);
          const halfStar = rating % 1 >= 0.5 ? 1 : 0;
          const emptyStars = 5 - fullStars - halfStar;
          let starsHTML = "";
          for (let i = 0; i < fullStars; i++)
            starsHTML += '<i class="fas fa-star"></i>';
          if (halfStar) starsHTML += '<i class="fas fa-star-half-alt"></i>';
          for (let i = 0; i < emptyStars; i++)
            starsHTML += '<i class="far fa-star"></i>';
          return starsHTML;
        };

        const ratingsHTML = `
        <div class="product-ratings">
            <div class="stars">${generateStarHTML(averageRating)}</div>
            <span class="rating-count">${averageRating.toFixed(1)}</span>
        </div>
    `;

        const variantListHTML =
          (product.variants || []).length > 0
            ? `<div class="variant-colors">
            ${product.variants
              .map((variant, index) => {
                const hex = variant.hexCode || "#CCCCCC";
                return `<div class="color-circle ${
                  index === 0 ? "active" : ""
                }" 
                           style="background-color: ${hex}; border: 2px solid white;"
                           data-variant-id="${variant.id}" 
                           data-variant-image="${
                             variant.image || LOCAL_FALLBACK_IMAGE
                           }" 
                           title="${cleanProductName(variant.name)}"></div>`;
              })
              .join("")}
          </div>`
            : "";

        card.innerHTML = `
        <div class="product-image-container">
            ${stockAlert}
            <img src="${previewImage}" alt="${cleanProductName(
          product.name
        )}" class="product-image"
                 data-default="${defaultImage}" data-preview="${previewImage}"
                 onerror="this.onerror=null; this.src='${LOCAL_FALLBACK_IMAGE}'; this.classList.add('no-image-placeholder')">
        </div>
        <div class="product-info">
            <div class="product-name">${cleanProductName(product.name)}</div>
            <div class="product-price">${priceDisplay}</div>
            ${ratingsHTML}
            ${variantListHTML}
            <div class="product-actions">
                <button class="like-btn liked" onclick="event.stopPropagation(); toggleFavorite('${
                  product.id
                }', this)">
                    <i class="fas fa-heart"></i>
                </button>
                <button class="add-to-cart-btn" onclick="event.stopPropagation(); window.location.href='productdetail.html?productId=${
                  product.id
                }'">
                    <i class="fas fa-shopping-cart"></i>Add to Cart
                </button>
            </div>
        </div>
    `;

        card.addEventListener("click", (e) => {
          if (
            e.target.closest(".like-btn") ||
            e.target.closest(".add-to-cart-btn") ||
            e.target.closest(".color-circle")
          )
            return;
          window.location.href = `productdetail.html?productId=${product.id}`;
        });

        const img = card.querySelector(".product-image");
        card.querySelectorAll(".color-circle").forEach((circle) => {
          circle.addEventListener("click", (e) => {
            e.stopPropagation();
            card
              .querySelectorAll(".color-circle")
              .forEach((c) => c.classList.remove("active"));
            circle.classList.add("active");
            const variantImage = circle.dataset.variantImage;
            if (variantImage && variantImage !== LOCAL_FALLBACK_IMAGE) {
              img.src = variantImage;
              img.dataset.default = variantImage;
              img.classList.remove("no-image-placeholder");
              img.style.objectFit = "cover";
            }
          });
        });

        return card;
      }

      // --- Toggle Favorite ---
      async function toggleFavorite(productId, button) {
        currentButton = button;
        currentProductId = productId;
        document.getElementById("unlike-modal").style.display = "flex";
      }

      document.getElementById("cancel-unlike").addEventListener("click", () => {
        document.getElementById("unlike-modal").style.display = "none";
        currentButton = null;
        currentProductId = null;
      });

      document
        .getElementById("confirm-unlike")
        .addEventListener("click", async () => {
          const modal = document.getElementById("unlike-modal");
          modal.style.display = "none";
          if (!currentButton || !currentProductId) return;

          const confirmBtn = document.getElementById("confirm-unlike");
          confirmBtn.disabled = true;

          const card = currentButton.closest(".product-card");

          try {
            const formData = new FormData();
            formData.append("action", "toggle");
            formData.append("product_id", currentProductId);

            const res = await fetch("../php/favorites-handler.php", {
              method: "POST",
              body: formData,
              credentials: "same-origin",
            });
            const data = await res.json();

            if (data.success && data.action === "unliked") {
              // Remove from allFavorites array
              allFavorites = allFavorites.filter(p => p.id !== currentProductId);
              
              if (card) {
                card.style.transition = "all 0.3s ease";
                card.style.opacity = "0";
                card.style.transform = "scale(0.9)";
                setTimeout(() => {
                  card.remove();
                  applyFilters(); // Re-render with updated count
                }, 300);
              }
              showNotification("Removed from favorites ðŸ’”");
            } else {
              showNotification(data.message ?? "Failed to remove favorite");
            }
          } catch (err) {
            console.error("Error removing favorite:", err);
            showNotification("Error removing favorite");
          } finally {
            currentButton = null;
            currentProductId = null;
            confirmBtn.disabled = false;
          }
        });

      document.getElementById("unlike-modal").addEventListener("click", (e) => {
        if (e.target.id === "unlike-modal") {
          e.currentTarget.style.display = "none";
          currentButton = null;
          currentProductId = null;
        }
      });

      async function updateCartCount() {
        try {
          const response = await fetch("../php/get-cart-count.php");
          const data = await response.json();

          if (data.success) {
            const cartCounts = document.querySelectorAll(".nav-cart-count");
            cartCounts.forEach((count) => {
              if(count.id === 'notif-badge') return;
              count.textContent = data.count;
              if (data.count > 0) {
                count.classList.add("show");
              } else {
                count.classList.remove("show");
              }
            });
          }
        } catch (error) {
          console.log("Cart count update failed, setting to 0");
          const cartCounts = document.querySelectorAll(".nav-cart-count");
          cartCounts.forEach((count) => {
            if(count.id === 'notif-badge') return;
            count.textContent = "0";
            count.classList.remove("show");
          });
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        if (typeof setupPageProtection === "function") {
          setupPageProtection();
        }

        await updateUserGreeting();
        await updateCartCount();

        initFilterDropdown();
        initSearch();

        // Load categories first
        loadCategories();

        const favoritesGrid = document.getElementById("favorites-grid");

        if (!currentUser) {
          favoritesGrid.innerHTML =
            "<p class='text-center p-4 text-gray-500'>Please log in to view your favorites.</p>";
          return;
        }

        try {
          const res = await fetch("../php/favorites-handler.php", {
            credentials: "same-origin",
          });
          const data = await res.json();
          
          if (!data.success || !data.products?.length) {
            favoritesGrid.innerHTML =
              "<p class='text-center p-4 text-gray-500'>You have no favorite products yet. ðŸ’”</p>";
            return;
          }

          allFavorites = data.products;
          applyFilters(); // Initial render with filters
        } catch (err) {
          console.error(err);
          favoritesGrid.innerHTML = `<p class='text-center text-red-500'>Error loading favorites: ${err.message}</p>`;
        }
        
        setupCartHoverListeners();
      });

      // Load categories function
      async function loadCategories() {
        const categoriesContainer = document.getElementById("categories-container");
        if (!categoriesContainer) return;

        try {
          const response = await fetch("../php/categories.php");
          const data = await response.json();
          
          if (data.success) {
            categoriesContainer.innerHTML = "";
            
            // All Button
            const allBtn = document.createElement("button");
            allBtn.className = "category-btn active";
            allBtn.innerHTML = '<i class="fas fa-th"></i> All';
            allBtn.setAttribute("data-category", "all");
            categoriesContainer.appendChild(allBtn);
            allBtn.addEventListener("click", () => handleCategoryClick("all"));

            // Category Icons Map
            const categoryIcons = {
              'lips': 'fa-kiss-wink-heart',
              'eyes': 'fa-eye',
              'face': 'fa-smile',
              'cheeks': 'fa-grin-hearts',
              'nails': 'fa-hand-sparkles',
              'tools': 'fa-tools',
              'skincare': 'fa-spa',
              'brushes': 'fa-paint-brush'
            };

            // Other Categories
            data.categories.filter((c) => normalizeCategory(c) !== "all").forEach((cat) => {
              const btn = document.createElement("button");
              btn.className = "category-btn";
              const iconClass = categoryIcons[normalizeCategory(cat)] || 'fa-star';
              btn.innerHTML = `<i class="fas ${iconClass}"></i> ${cat}`;
              btn.setAttribute("data-category", normalizeCategory(cat));
              categoriesContainer.appendChild(btn);
              btn.addEventListener("click", () => handleCategoryClick(cat));
            });
          }
        } catch (error) {
          console.error("Error loading categories:", error);
        }
      }

      function setupCartHoverListeners() {
        const desktopCartNav = document.querySelector(
          '.desktop-nav .nav-item[data-page="cart"]'
        );
        const mobileCartNav = document.querySelector(
          '.mobile-nav .nav-item[data-page="cart"]'
        );

        if (desktopCartNav) {
          desktopCartNav.addEventListener("mouseenter", function () {
            showCartTotalOnHover();
          });
        }

        if (mobileCartNav) {
          let touchTimer;

          mobileCartNav.addEventListener("touchstart", function () {
            touchTimer = setTimeout(() => {
              showCartTotalOnHover();
            }, 500);
          });

          mobileCartNav.addEventListener("touchend", function () {
            clearTimeout(touchTimer);
          });

          mobileCartNav.addEventListener("click", function (e) {
            if (!e.target.closest("a")) {
              showCartTotalOnHover();
            }
          });
        }
      }

      function showNotification(message, type = "success") {
        const existingNotification =
          document.querySelector(".cart-notification");
        if (existingNotification) {
          existingNotification.remove();
        }

        const notification = document.createElement("div");
        notification.className = `cart-notification ${type}`;
        notification.innerHTML = `
    <div class="notification-content">
        <i class="fas ${
          type === "success" ? "fa-check-circle" : "fa-exclamation-circle"
        }"></i>
        <span>${message}</span>
    </div>
  `;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.classList.add("show");
        }, 10);

        setTimeout(() => {
          notification.classList.remove("show");
          setTimeout(() => {
            if (notification.parentNode) {
              notification.remove();
            }
          }, 300);
        }, 3000);
      }

      function formatNumberWithCommas(number) {
        return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }

      async function showCartTotalOnHover() {
        try {
          const response = await fetch("../php/cart.php?action=get");
          const result = await response.json();

          if (result.success && result.cartCount > 0) {
            const existingPopups =
              document.querySelectorAll(".cart-total-popup");

            if (existingPopups.length > 0) return;

            const desktopCartNav = document.querySelector(
              '.desktop-nav .nav-item[data-page="cart"]'
            );
            const mobileCartNav = document.querySelector(
              '.mobile-nav .nav-item[data-page="cart"]'
            );

            if (desktopCartNav) {
              const desktopPopup = document.createElement("div");
              desktopPopup.className = "cart-total-popup";
              desktopPopup.innerHTML = `
                    <div class="cart-total-label">Cart Total</div>
                    <div class="cart-total-amount">â‚±${formatNumberWithCommas(
                      parseFloat(result.totalAmount).toFixed(2)
                    )}</div>
                `;

              desktopCartNav.appendChild(desktopPopup);
              setTimeout(() => desktopPopup.classList.add("show"), 10);

              desktopCartNav.addEventListener(
                "mouseleave",
                function () {
                  desktopPopup.classList.remove("show");
                  setTimeout(() => {
                    if (desktopPopup.parentNode) desktopPopup.remove();
                  }, 300);
                },
                { once: true }
              );
            }

            if (mobileCartNav) {
              const mobilePopup = document.createElement("div");
              mobilePopup.className = "cart-total-popup";
              mobilePopup.innerHTML = `
                    <div class="cart-total-label">Cart Total</div>
                    <div class="cart-total-amount">â‚±${formatNumberWithCommas(
                      parseFloat(result.totalAmount).toFixed(2)
                    )}</div>
                `;

              mobileCartNav.appendChild(mobilePopup);
              setTimeout(() => mobilePopup.classList.add("show"), 10);

              setTimeout(() => {
                mobilePopup.classList.remove("show");
                setTimeout(() => {
                  if (mobilePopup.parentNode) mobilePopup.remove();
                }, 300);
              }, 3000);
            }
          }
        } catch (error) {
          console.error("Error fetching cart total:", error);
        }
      }
    </script>
  </body>
</html>