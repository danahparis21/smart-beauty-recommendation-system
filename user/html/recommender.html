<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Recommender | Beauty & Blessed</title>
    <link rel="stylesheet" href="../styles/styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <!-- Add this BEFORE your page-specific scripts -->
    <script src="../js/user-session.js"></script>
    <style>
      /* ===== CRITICAL: QUIZ STEP MANAGEMENT ===== */
      .quiz-step {
        display: none !important;
      }

      .quiz-step.active {
        display: block !important;
      }

      /* Ensure floating product only appears in intro step */
      #step-intro .floating-product {
        display: flex !important;
      }

      #step-1 .floating-product,
      #step-2 .floating-product,
      #step-3 .floating-product,
      #step-4 .floating-product,
      #step-5 .floating-product,
      #step-results .floating-product {
        display: none !important;
      }

      /* ===== NAVIGATION STYLES ===== */
      .nav-item {
        position: relative;
      }

      .nav-cart-count {
        position: absolute;
        top: -5px;
        right: -5px;
        background: var(--primary-pink);
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
      }
      .nav-cart-count.show {
        display: flex;
        animation: bounce 0.3s ease;
      }

      @keyframes bounce {
        0% {
          transform: scale(0.5);
        }
        50% {
          transform: scale(1.2);
        }
        100% {
          transform: scale(1);
        }
      }

      /* ===== MAIN QUIZ CONTAINER ===== */
      .recommender-main {
        padding: 40px 20px;
        max-width: 1000px; /* Increased from 800px */
        margin: 0 auto;
        min-height: calc(100vh - 200px);
      }

      .quiz-container {
        background: var(--gradient-card);
        border-radius: 24px; /* Slightly larger radius */
        box-shadow: var(--card-shadow);
        border: 1px solid rgba(255, 182, 193, 0.2);
        overflow: hidden;
        max-width: 100%; /* Allow it to use full available space */
      }

      .quiz-step {
        padding: 50px 40px; /* Increased padding for more spacious feel */
      }

      /* ===== QUIZ INTRO STEP ===== */
      .quiz-hero {
        text-align: center;
        padding: 40px 20px;
      }

      .hero-icon {
        width: 100px;
        height: 100px;
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 30px;
        color: white;
        font-size: 40px;
        box-shadow: 0 10px 30px rgba(255, 105, 180, 0.3);
      }

      .quiz-hero h1 {
        font-size: 2.5rem;
        color: var(--dark-gray);
        margin-bottom: 20px;
        font-family: "Cormorant Garamond", serif;
      }

      .quiz-hero p {
        font-size: 1.1rem;
        color: var(--text-gray);
        margin-bottom: 40px;
        line-height: 1.6;
      }

      .quiz-start-btn {
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        color: white;
        border: none;
        border-radius: 25px;
        padding: 15px 40px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 5px 15px rgba(255, 105, 180, 0.3);
      }

      .quiz-start-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(255, 105, 180, 0.4);
      }

      /* ===== FLOATING PRODUCT STYLES ===== */
      .floating-product {
        margin: 50px 0;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
      }

      .floating-product .product-image {
        width: 250px !important;
        height: 250px !important;
        object-fit: contain !important;
        position: relative !important;
        z-index: 10 !important;
        filter: drop-shadow(0 15px 30px rgba(255, 105, 180, 0.4))
          drop-shadow(0 5px 15px rgba(255, 20, 147, 0.3)) !important;
        animation: float 3s ease-in-out infinite !important;
        background: transparent !important;
        border: none !important;
        border-radius: 0 !important;
        padding: 0 !important;
        margin: 0 auto !important;
      }

      .floating-product::before {
        content: "";
        position: absolute;
        width: 260px;
        height: 260px;
        background: radial-gradient(
          circle at center,
          rgba(255, 182, 193, 0.25) 0%,
          rgba(255, 105, 180, 0.15) 40%,
          rgba(255, 20, 147, 0.08) 70%,
          transparent 85%
        );
        border-radius: 50%;
        filter: blur(20px);
        z-index: 1;
        animation: glow 4s ease-in-out infinite;
        opacity: 0.5;
      }

      .floating-product::after {
        content: "";
        position: absolute;
        width: 300px;
        height: 300px;
        background: radial-gradient(
          circle at center,
          rgba(255, 182, 193, 0.15) 0%,
          rgba(255, 105, 180, 0.08) 25%,
          rgba(255, 20, 147, 0.05) 50%,
          transparent 70%
        );
        border-radius: 50%;
        z-index: 0;
        animation: pulse 8s ease-in-out infinite;
        opacity: 0.3;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px) scale(1) rotate(0deg);
        }
        33% {
          transform: translateY(-15px) scale(1.08) rotate(2deg);
        }
        66% {
          transform: translateY(-8px) scale(1.04) rotate(-1deg);
        }
      }

      @keyframes glow {
        0%,
        100% {
          opacity: 0.4;
          transform: scale(1) rotate(0deg);
        }
        50% {
          opacity: 0.6;
          transform: scale(1.05) rotate(3deg);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 0.2;
          transform: scale(1);
        }
        50% {
          opacity: 0.4;
          transform: scale(1.03);
        }
      }

      /* ===== QUIZ HEADER & PROGRESS ===== */
      .quiz-header {
        text-align: center;
        margin-bottom: 40px;
      }

      .progress-bar {
        width: 100%;
        height: 6px;
        background: var(--light-gray);
        border-radius: 3px;
        margin-bottom: 30px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(
          to right,
          var(--primary-pink),
          var(--dark-pink)
        );
        border-radius: 3px;
        transition: width 0.3s ease;
      }

      .quiz-header h2 {
        font-size: 2rem;
        color: var(--dark-gray);
        margin-bottom: 10px;
        font-family: "Cormorant Garamond", serif;
      }

      .quiz-header p {
        color: var(--text-gray);
        font-size: 1rem;
      }

      /* ===== QUIZ OPTIONS ===== */
      .options-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }

      .option-card {
        background: white;
        border: 2px solid var(--light-gray);
        border-radius: 15px;
        padding: 25px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .option-card:hover {
        transform: translateY(-5px);
        border-color: var(--primary-pink);
        box-shadow: 0 10px 25px rgba(255, 105, 180, 0.1);
      }

      .option-card.selected {
        border-color: var(--primary-pink);
        background: linear-gradient(135deg, #fff5f9, #ffe6f2);
        box-shadow: 0 5px 15px rgba(255, 105, 180, 0.2);
      }

      .option-icon {
        width: 60px;
        height: 60px;
        background: var(--light-gray);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        color: var(--primary-pink);
        font-size: 24px;
        transition: all 0.3s ease;
      }

      .option-card.selected .option-icon {
        background: var(--primary-pink);
        color: white;
      }

      .option-card h3 {
        font-size: 1.2rem;
        color: var(--dark-gray);
        margin-bottom: 8px;
      }

      .option-card p {
        font-size: 0.9rem;
        color: var(--text-gray);
        line-height: 1.4;
      }

      /* ===== SKIN TONE OPTIONS ===== */
      .skin-tone-options {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 40px;
        flex-wrap: wrap;
      }

      .tone-option {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .tone-option:hover {
        transform: scale(1.05);
      }

      .tone-option.selected .tone-swatch {
        transform: scale(1.1);
        box-shadow: 0 0 0 3px var(--primary-pink);
      }

      .tone-swatch {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .tone-option span {
        font-size: 0.9rem;
        color: var(--dark-gray);
        font-weight: 500;
      }

      /* ===== CONCERNS GRID ===== */
      .concerns-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 40px;
      }

      .concern-option {
        position: relative;
      }

      .concern-checkbox {
        display: none;
      }

      .concern-label {
        display: block;
        background: white;
        border: 2px solid var(--light-gray);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .concern-checkbox:checked + .concern-label {
        border-color: var(--primary-pink);
        background: linear-gradient(135deg, #fff5f9, #ffe6f2);
        box-shadow: 0 5px 15px rgba(255, 105, 180, 0.2);
      }

      .concern-label:hover {
        transform: translateY(-3px);
        border-color: var(--primary-pink);
        box-shadow: 0 8px 20px rgba(255, 105, 180, 0.1);
      }

      .concern-icon {
        width: 50px;
        height: 50px;
        background: var(--light-gray);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 12px;
        color: var(--primary-pink);
        font-size: 20px;
        transition: all 0.3s ease;
      }

      .concern-checkbox:checked + .concern-label .concern-icon {
        background: var(--primary-pink);
        color: white;
      }

      .concern-label h3 {
        font-size: 1.1rem;
        color: var(--dark-gray);
        margin-bottom: 5px;
      }

      .concern-label p {
        font-size: 0.8rem;
        color: var(--text-gray);
        line-height: 1.3;
      }

      /* ===== QUIZ NAVIGATION ===== */
      .quiz-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 40px;
      }

      .nav-btn {
        padding: 12px 25px;
        border: none;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .nav-btn.primary {
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        color: white;
        box-shadow: 0 4px 15px rgba(255, 105, 180, 0.3);
      }

      .nav-btn.primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 105, 180, 0.4);
      }

      .nav-btn.primary:disabled {
        background: var(--medium-gray);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .nav-btn.secondary {
        background: transparent;
        color: var(--text-gray);
        border: 2px solid var(--medium-gray);
      }

      .nav-btn.secondary:hover {
        border-color: var(--primary-pink);
        color: var(--primary-pink);
      }

      /* ===== LOADING STEP ===== */
      .loading-container {
        text-align: center;
        padding: 60px 20px;
      }

      .loading-spinner {
        font-size: 4rem;
        color: var(--primary-pink);
        margin-bottom: 30px;
      }

      .loading-container h2 {
        font-size: 2.2rem;
        color: var(--dark-gray);
        margin-bottom: 40px;
        font-family: "Cormorant Garamond", serif;
      }

      .loading-messages {
        display: flex;
        flex-direction: column;
        gap: 20px;
        max-width: 400px;
        margin: 0 auto;
      }

      .loading-message {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px 20px;
        background: white;
        border-radius: 12px;
        border: 2px solid var(--light-gray);
        transition: all 0.3s ease;
        opacity: 0.5;
      }

      .loading-message.active {
        border-color: var(--primary-pink);
        background: linear-gradient(135deg, #fff5f9, #ffe6f2);
        opacity: 1;
        transform: translateX(10px);
      }

      .loading-message i {
        color: var(--primary-pink);
        font-size: 1.2rem;
      }

      .loading-message span {
        color: var(--dark-gray);
        font-weight: 500;
      }

      /* ===== RESULTS STEP ===== */
      #step-results.quiz-step {
        max-width: none !important;
        padding: 40px 20px !important;
      }

      #step-results .quiz-header {
        text-align: center;
        margin-bottom: 30px;
      }

      #step-results .quiz-header h2 {
        font-size: 2.2rem;
        color: var(--dark-gray);
        margin-bottom: 10px;
        font-family: "Cormorant Garamond", serif;
      }

      #step-results .quiz-header p {
        color: var(--text-gray);
        font-size: 1.1rem;
        max-width: 600px;
        margin: 0 auto;
      }

      /* ===== RECOMMENDATIONS GRID ===== */
      .recommendations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 25px;
        margin: 40px auto;
        max-width: 1400px;
        padding: 0 20px;
      }

      .recommendations-grid .product-card {
        background: white;
        border-radius: 16px;
        padding: 0;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        position: relative;
        transition: all 0.3s ease;
        overflow: hidden;
        border: 1px solid #f8f8f8;
        height: fit-content;
      }

      .recommendations-grid .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
      }

      .recommendations-grid .product-image-container {
        width: 100%;
        height: 200px;
        overflow: hidden;
        position: relative;
        background: #fafafa;
      }

      .recommendations-grid .product-image {
        width: 100% !important;
        height: 100% !important;
        object-fit: cover !important;
        border-radius: 0 !important;
        margin-bottom: 0 !important;
        filter: none !important;
        animation: none !important;
        background: white !important;
        border: none !important;
        transition: transform 0.3s ease !important;
      }

      .recommendations-grid .product-card:hover .product-image {
        transform: scale(1.05) !important;
      }

      .recommendations-grid .product-info {
        padding: 20px;
      }

      .recommendations-grid .product-name {
        font-size: 1.1em;
        font-weight: 600;
        margin: 0 0 8px 0;
        color: #2d3748;
        line-height: 1.3;
        height: 2.6em;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
      }

      .recommendations-grid .product-category {
        color: #718096;
        font-size: 0.8em;
        margin: 0 0 8px 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
      }

      .recommendations-grid .product-price {
        font-weight: bold;
        color: var(--primary-pink);
        font-size: 1.2em;
        margin: 0 0 12px 0;
      }

      .recommendations-grid .match-info {
        margin: 12px 0;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .recommendations-grid .match-score {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
        font-size: 0.85em;
      }

      .recommendations-grid .match-score .score {
        font-weight: bold;
        color: var(--primary-pink);
        font-size: 1em;
      }

      .recommendations-grid .match-bar {
        width: 100%;
        height: 6px;
        background: #e2e8f0;
        border-radius: 3px;
        overflow: hidden;
      }

      .recommendations-grid .match-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-pink), #ff6b6b);
        border-radius: 3px;
        transition: width 1s ease;
      }

      .recommendations-grid .product-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
      }

      .recommendations-grid .btn-primary,
      .recommendations-grid .btn-secondary {
        flex: 1;
        padding: 10px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85em;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
      }

      .recommendations-grid .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        color: white;
        box-shadow: 0 2px 8px rgba(255, 105, 180, 0.3);
      }

      .recommendations-grid .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 105, 180, 0.4);
      }

      .recommendations-grid .btn-secondary {
        background: white;
        color: #4a5568;
        border: 1px solid #e2e8f0;
        font-size: 0.8em;
      }

      .recommendations-grid .btn-secondary:hover {
        background: #f7fafc;
        border-color: var(--primary-pink);
        color: var(--primary-pink);
        transform: translateY(-2px);
      }

      /* ===== MATCH BADGES ===== */
      .recommendations-grid .match-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.7em;
        font-weight: 700;
        color: white;
        z-index: 20;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      /* ===== MATCH BADGES ===== */
      .recommendations-grid .match-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.7em;
        font-weight: 700;
        color: white;
        z-index: 20;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      /* ===== RATING BADGES ===== */
      .recommendations-grid .rating-badge {
        position: absolute;
        top: 40px; /* Position below match badge */
        right: 10px;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.7em;
        font-weight: 700;
        color: white;
        z-index: 20;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      @media (max-width: 768px) {
        .recommendations-grid .match-badge,
        .recommendations-grid .rating-badge {
          padding: 3px 6px;
          font-size: 0.65em;
        }

        .recommendations-grid .match-badge {
          top: 8px;
          right: 8px;
        }

        .recommendations-grid .rating-badge {
          top: 35px; /* Adjusted for mobile */
          right: 8px;
        }
      }

      /* Match Quality Badge Styles */
      .perfect-match {
        background: linear-gradient(135deg, #667eea, #764ba2);
        animation: glow-pulse 2s ease-in-out infinite;
      }

      .close-match {
        background: linear-gradient(135deg, #f093fb, #f5576c);
      }

      .normal-match {
        background: linear-gradient(135deg, #4facfe, #00f2fe);
      }

      .low-match {
        background: linear-gradient(135deg, #fda085, #f6d365);
      }

      .fallback-match {
        background: linear-gradient(135deg, #a8edea, #fed6e3);
        color: #2d3748;
      }

      /* Rating Quality Badge Styles */
      .top-rated {
        background: linear-gradient(135deg, #ff9a9e, #fecfef);
        animation: glow-pulse 2s ease-in-out infinite;
      }

      .highly-rated {
        background: linear-gradient(135deg, #a8edea, #fed6e3);
        color: #2d3748;
      }

      .well-rated {
        background: linear-gradient(135deg, #d4fc79, #96e6a1);
        color: #2d3748;
      }

      .good-rating {
        background: linear-gradient(135deg, #84fab0, #8fd3f4);
        color: #2d3748;
      }

      .average-rating {
        background: linear-gradient(135deg, #a3bded, #6991c7);
      }

      .low-rating {
        background: linear-gradient(135deg, #fad0c4, #ffd1ff);
        color: #2d3748;
      }

      .unrated {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        color: #6c757d !important; /* Darker gray for better contrast */
        border: 1px solid #dee2e6;
        font-weight: 600;
      }
      @keyframes glow-pulse {
        0%,
        100% {
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        50% {
          box-shadow: 0 4px 20px rgba(102, 126, 234, 0.8);
        }
      }

      /* Make sure product cards can accommodate two badges */
      .product-card {
        position: relative;
        padding-top: 50px; /* Extra space for badges */
      }

      @media (max-width: 768px) {
        .product-card {
          padding-top: 45px;
        }
      }

      /* ===== NO RESULTS STATE ===== */
      .no-results {
        text-align: center;
        padding: 40px 20px;
        color: #666;
      }

      .no-results i {
        font-size: 3em;
        color: #ddd;
        margin-bottom: 20px;
      }

      /* ===== RESPONSIVE DESIGN ===== */

      /* Very small mobile devices - under 360px */
      @media (max-width: 359px) {
        .recommendations-grid {
          grid-template-columns: 1fr;
          gap: 12px;
          padding: 0 5px;
        }

        .recommendations-grid .product-image-container {
          height: 150px;
        }

        .recommendations-grid .product-name {
          font-size: 0.85em;
        }
      }

      /* Small mobile devices - 360px to 399px */
      @media (min-width: 360px) and (max-width: 399px) {
        .recommendations-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 10px;
          padding: 0 8px;
        }

        .recommendations-grid .product-image-container {
          height: 140px;
        }
      }

      @media (min-width: 360px) and (max-width: 768px) {
        .recommender-main {
          padding: 20px 15px;
          min-height: calc(100vh - 150px);
        }

        .quiz-container {
          border-radius: 20px;
        }

        .quiz-step {
          padding: 30px 20px !important;
        }

        #step-results.quiz-step {
          padding: 30px 15px !important;
        }

        .recommendations-grid {
          grid-template-columns: repeat(2, 1fr); /* 2 columns */
          gap: 12px;
          padding: 0 5px;
          max-width: 100%;
        }

        .recommendations-grid .product-card {
          min-height: auto;
        }

        .recommendations-grid .product-image-container {
          height: 140px;
        }

        .recommendations-grid .product-info {
          padding: 12px 10px;
        }

        .recommendations-grid .product-name {
          font-size: 0.9em;
          height: 2.6em;
          line-height: 1.3;
          margin-bottom: 6px;
        }

        .recommendations-grid .product-category {
          font-size: 0.7em;
          margin-bottom: 6px;
        }

        .recommendations-grid .product-price {
          font-size: 1em;
          margin-bottom: 8px;
        }

        .recommendations-grid .match-info {
          padding: 6px;
          margin: 8px 0;
          font-size: 0.75em;
        }

        .recommendations-grid .match-score {
          font-size: 0.75em;
        }

        .recommendations-grid .match-bar {
          height: 4px;
        }

        .recommendations-grid .product-actions {
          flex-direction: column;
          gap: 5px;
        }

        .recommendations-grid .btn-primary,
        .recommendations-grid .btn-secondary {
          padding: 7px 8px;
          font-size: 0.75em;
          min-height: 32px;
        }

        .recommendations-grid .match-badge {
          padding: 2px 6px;
          font-size: 0.6em;
          top: 6px;
          right: 6px;
        }

        .attribute-header {
          padding: 8px 10px;
          font-size: 0.8em;
        }
      }

      @media (max-width: 380px) {
        .recommendations-grid .product-actions {
          flex-direction: column;
        }

        .recommendations-grid .btn-primary,
        .recommendations-grid .btn-secondary {
          width: 100%;
          text-align: center;
        }

        .recommendations-grid .attribute-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 3px;
        }
      }

      /* Tablet */
      @media (min-width: 769px) and (max-width: 1024px) {
        .recommendations-grid {
          grid-template-columns: repeat(3, 1fr);
          gap: 20px;
          padding: 0 20px;
        }

        .recommendations-grid .product-image-container {
          height: 180px;
        }
      }

      /* Desktop */
      @media (min-width: 1025px) {
        .recommendations-grid {
          grid-template-columns: repeat(4, 1fr);
          gap: 25px;
          padding: 0 30px;
          max-width: 1400px;
        }

        .recommendations-grid .product-image-container {
          height: 200px;
        }
      }

      /* Large Desktop */
      @media (min-width: 1440px) {
        .recommender-main {
          max-width: 1200px;
        }

        .recommendations-grid {
          grid-template-columns: repeat(4, 1fr);
          gap: 30px;
          max-width: 1600px;
        }

        .recommendations-grid .product-image-container {
          height: 220px;
        }
      }
      /* Hide all modals by default */
      #existing-prefs-modal,
      #current-prefs-modal,
      #add-to-cart-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
      }

      /* Show modals when active */
      #existing-prefs-modal.active,
      #current-prefs-modal.active,
      #add-to-cart-modal.active {
        display: flex;
      }

      /* Modal content styling */
      #existing-prefs-modal .modal-content,
      #current-prefs-modal .modal-content,
      #add-to-cart-modal .modal-content {
        background: white;
        border-radius: 20px;
        padding: 30px;
        text-align: center;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 182, 193, 0.2);
      }

      /* Success Modal Styles */
      #success-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
      }

      #success-modal.active {
        display: flex;
      }

      #success-modal .modal-content {
        background: white;
        border-radius: 20px;
        padding: 40px 30px;
        text-align: center;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 182, 193, 0.2);
      }

      .success-icon {
        font-size: 64px;
        color: #10b981;
        margin-bottom: 20px;
        animation: bounceIn 0.6s ease;
      }

      .success-title {
        font-size: 1.5em;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 10px;
      }

      .success-message {
        color: #6b7280;
        line-height: 1.5;
        margin-bottom: 25px;
      }

      .success-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
      }

      @keyframes bounceIn {
        0% {
          transform: scale(0.3);
          opacity: 0;
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      /* Modal buttons */
      .modal-buttons {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 20px;
      }
      .modal-btn {
        padding: 12px 20px;
        border: none;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .modal-btn.primary {
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        color: white;
        box-shadow: 0 4px 15px rgba(255, 105, 180, 0.3);
      }

      .modal-btn.secondary {
        background: var(--light-gray);
        color: var(--dark-gray);
        border: 2px solid var(--medium-gray);
      }

      .modal-btn.cancel-btn {
        background: transparent;
        color: var(--text-gray);
        border: 2px solid var(--medium-gray);
      }

      .modal-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .modal-btn.primary:hover {
        box-shadow: 0 6px 20px rgba(255, 105, 180, 0.4);
      }

      /* Modal headers */
      #existing-prefs-modal h3,
      #current-prefs-modal h3 {
        font-size: 1.5rem;
        color: var(--dark-gray);
        margin-bottom: 15px;
        font-family: "Cormorant Garamond", serif;
      }

      #existing-prefs-modal p,
      #current-prefs-modal p {
        color: var(--text-gray);
        margin-bottom: 25px;
        line-height: 1.5;
      }
      /* ===== MODAL STYLES ===== */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        backdrop-filter: blur(5px);
      }

      .modal-overlay.active {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .exit-modal {
        background: white;
        border-radius: 20px;
        padding: 30px;
        text-align: center;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 182, 193, 0.2);
      }

      .modal-icon {
        font-size: 3rem;
        color: var(--gold);
        margin-bottom: 20px;
      }

      .exit-modal h3 {
        font-size: 1.5rem;
        color: var(--dark-gray);
        margin-bottom: 10px;
        font-family: "Cormorant Garamond", serif;
      }

      .exit-modal p {
        color: var(--text-gray);
        margin-bottom: 25px;
      }

      .modal-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .modal-btn {
        padding: 12px 20px;
        border: none;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
      }

      .modal-btn.primary {
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        color: white;
      }

      .modal-btn.secondary {
        background: var(--light-gray);
        color: var(--dark-gray);
      }

      .modal-btn.tertiary {
        background: transparent;
        color: var(--text-gray);
        border: 2px solid var(--medium-gray);
      }

      .modal-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      /* ===== RESULTS HERO STYLES ===== */
      .results-hero {
        text-align: center;
        margin-bottom: 40px;
        padding: 2px 2px;
      }

      .results-hero i {
        font-size: 4rem;
        color: var(--primary-pink);
        margin-bottom: 20px;
        display: block;
      }

      .results-hero h2 {
        font-size: 2.2rem;
        color: var(--dark-gray);
        margin-bottom: 15px;
        font-family: "Cormorant Garamond", serif;
      }

      .results-hero p {
        font-size: 14px;
        color: var(--text-gray);
        line-height: 1.6;
        max-width: 600px;
        margin: 0 auto;
      }

      /* ===== RESULTS ACTIONS BUTTONS ===== */
      .results-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 40px;
      }

      .retake-btn,
      .shop-all-btn {
        padding: 12px 25px;
        border: none;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 1rem;
      }

      .retake-btn {
        background: transparent;
        color: var(--text-gray);
        border: 2px solid var(--medium-gray);
      }

      .retake-btn:hover {
        border-color: var(--primary-pink);
        color: var(--primary-pink);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 105, 180, 0.1);
      }

      .shop-all-btn {
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        color: white;
        box-shadow: 0 4px 15px rgba(255, 105, 180, 0.3);
      }

      .shop-all-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 105, 180, 0.4);
      }

      /* ===== RESULTS CONTAINER ===== */
      .results-container {
        text-align: center;
        padding: 20px 0;
      }

      /* ===== PREFERENCES MODALS ===== */
      #current-preferences-display {
        background: var(--light-gray);
        padding: 20px;
        border-radius: 12px;
        margin: 15px 0;
        text-align: left;
      }

      .preference-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--medium-gray);
      }

      .preference-item:last-child {
        margin-bottom: 0;
        border-bottom: none;
      }

      .preference-label {
        font-weight: 600;
        color: var(--dark-gray);
      }

      .preference-value {
        color: var(--primary-pink);
        text-transform: capitalize;
      }

      .concerns-list {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
      }

      .concern-tag {
        background: var(--primary-pink);
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        text-transform: capitalize;
      }

      /* ===== RESPONSIVE DESIGN FOR MISSING STYLES ===== */
      @media (max-width: 768px) {
        /* Modal Mobile */
        .exit-modal {
          padding: 25px 20px;
          margin: 20px;
          border-radius: 16px;
        }

        .modal-icon {
          font-size: 2.5rem;
          margin-bottom: 15px;
        }

        .exit-modal h3 {
          font-size: 1.3rem;
          margin-bottom: 8px;
        }

        .exit-modal p {
          font-size: 0.9rem;
          margin-bottom: 20px;
        }

        .modal-actions {
          gap: 8px;
        }

        .modal-btn {
          padding: 14px 20px;
          font-size: 1rem;
          border-radius: 20px;
        }

        /* Results Hero Mobile */
        .results-hero {
          padding: 30px 15px;
          margin-bottom: 15px;
        }

        .results-hero i {
          font-size: 3rem;
          margin-bottom: 15px;
        }

        .results-hero h2 {
          font-size: 1.8rem;
          margin-bottom: 12px;
        }

        .results-hero p {
          font-size: 1rem;
        }

        /* Results Actions Mobile */
        .results-actions {
          flex-direction: column;
          gap: 12px;
          margin-top: 30px;
        }

        .retake-btn,
        .shop-all-btn {
          padding: 14px 20px;
          width: 100%;
          justify-content: center;
          font-size: 1rem;
          border-radius: 20px;
        }
      }

      /* Tablet Optimization */
      @media (min-width: 769px) and (max-width: 1024px) {
        .results-hero {
          padding: 40px 30px;
        }

        .results-actions {
          gap: 20px;
        }
      }
      /* ===== SAVED PREFERENCES INDICATOR ===== */
      .saved-preferences-indicator {
        color: var(--text-gray);
        font-size: 0.8em;
        font-weight: 400;
        display: block;
        text-align: center;
        margin-top: 8px;
        opacity: 0.8;
      }

      .saved-preferences-indicator i {
        font-size: 0.8em;
        margin-right: 4px;
      }

      /* ===== ATTRIBUTE MATCHES STYLES - COMPACT ===== */
      .attribute-summary {
        margin: 10px 0;
        position: relative;
      }

      .attribute-header {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.85em;
        font-weight: 600;
        color: #1e40af;
        text-align: left;
        justify-content: space-between;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
      }

      .attribute-header:hover {
        background: rgba(59, 130, 246, 0.15);
        transform: translateY(-1px);
      }

      .attribute-header:active {
        transform: translateY(0);
        background: rgba(59, 130, 246, 0.2);
      }

      .attribute-toggle {
        font-weight: bold;
        opacity: 0.7;
        font-size: 1em;
      }

      /* EXTERNAL FLOATING CARD - SINGLE SOURCE OF TRUTH */
      #external-attribute-card {
        display: none;
        position: fixed;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 14px;
        box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.15);
        z-index: 10000;
        width: 300px;
        max-height: 350px;
        overflow-y: auto;
        text-align: left;
        font-size: 0.85em;
      }

      /* MOBILE: Centered with smooth animation */
      @media (max-width: 768px) {
        #external-attribute-card {
          width: 280px !important; /* Force mobile width */
          max-height: 320px !important;
          padding: 12px !important;
          top: 50% !important;
          left: 50% !important;
          transform: translate(-50%, -50%) !important; /* Force centering */
          animation: modalSlideUp 0.3s ease-out !important; /* Force mobile animation */
        }
      }

      /* DESKTOP: Positioned above with different animation */
      @media (min-width: 769px) {
        #external-attribute-card {
          width: 320px;
          max-height: 380px;
          padding: 16px;
          font-size: 0.9em;
          transform: none;
          animation: slideUp 0.2s ease-out;
          /* Remove top/left positioning - let JavaScript handle it */
        }

        .attribute-header {
          padding: 8px 12px;
          font-size: 0.8em;
        }
      }

      /* Mobile animation - smooth center slide */
      @keyframes modalSlideUp {
        from {
          opacity: 0;
          transform: translate(-50%, -45%) !important;
        }
        to {
          opacity: 1;
          transform: translate(-50%, -50%) !important;
        }
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* CLEAN MINIMALIST STYLES */
      .attribute-detail-clean {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        padding: 8px 10px;
        border-radius: 6px;
        margin-bottom: 4px;
        min-height: 36px;
      }

      .attribute-detail-clean.match {
        background: rgba(34, 197, 94, 0.08);
        border: 1px solid rgba(34, 197, 94, 0.12);
      }

      .attribute-detail-clean.no-match {
        background: rgba(239, 68, 68, 0.08);
        border: 1px solid rgba(239, 68, 68, 0.12);
      }

      .attribute-line {
        flex: 1;
        display: flex;
        align-items: flex-start;
        gap: 10px;
        min-width: 0;
      }

      .attribute-label-clean {
        font-weight: 600;
        color: #374151;
        font-size: 0.8em;
        min-width: 70px;
        flex-shrink: 0;
        margin-top: 1px;
      }

      .attribute-values {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 6px;
        font-size: 0.8em;
        flex: 1;
        min-width: 0;
      }

      .product-value-clean {
        color: #1e40af;
        font-weight: 500;
        word-break: break-word;
        flex-shrink: 1;
        min-width: 0;
      }

      .user-value-clean {
        color: #7c3aed;
        font-weight: 500;
        word-break: break-word;
        flex-shrink: 1;
        min-width: 0;
      }

      .separator {
        color: #9ca3af;
        font-size: 0.75em;
        flex-shrink: 0;
      }

      .detail-status-clean {
        font-weight: bold;
        font-size: 0.85em;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        flex-shrink: 0;
        margin-top: 1px;
      }

      .attribute-detail-clean.match .detail-status-clean {
        background: rgba(34, 197, 94, 0.15);
        color: #16a34a;
      }

      .attribute-detail-clean.no-match .detail-status-clean {
        background: rgba(239, 68, 68, 0.15);
        color: #dc2626;
      }

      /* Mobile optimization for content */
      @media (max-width: 768px) {
        .attribute-detail-clean {
          padding: 6px 8px;
          min-height: 32px;
          margin-bottom: 3px;
        }

        .attribute-line {
          gap: 6px;
        }

        .attribute-label-clean {
          min-width: 65px;
          font-size: 0.75em;
        }

        .attribute-values {
          gap: 4px;
          font-size: 0.75em;
        }

        .detail-status-clean {
          width: 16px;
          height: 16px;
          font-size: 0.8em;
        }
      }

      /* Extra small mobile optimization */
      @media (max-width: 400px) {
        #external-attribute-card {
          width: 260px !important;
          max-height: 300px !important;
          padding: 10px !important;
        }

        .attribute-detail-clean {
          padding: 5px 6px;
          min-height: 30px;
        }

        .attribute-label-clean {
          min-width: 60px;
          font-size: 0.7em;
        }

        .attribute-values {
          font-size: 0.7em;
        }
      }

      /* Better scrollbar */
      #external-attribute-card::-webkit-scrollbar {
        width: 4px;
      }

      #external-attribute-card::-webkit-scrollbar-track {
        background: #f8fafc;
        border-radius: 2px;
      }

      #external-attribute-card::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 2px;
      }

      #external-attribute-card::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }
      /* ===== ELEGANT COMPACT FILTERS ===== */
      .filters-section {
        margin: 20px auto 30px auto;
        padding: 0;
        background: transparent;
        border: none;
        max-width: 900px;
      }

      .filters-container {
        display: flex;
        gap: 16px;
        margin-bottom: 12px;
        flex-wrap: wrap;
        align-items: end;
        justify-content: center;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex: 0 1 auto;
      }

      .filter-group label {
        font-weight: 500;
        font-size: 11px;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        font-family: "Inter", sans-serif;
      }

      .filter-group select {
        padding: 10px 14px;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        background: white;
        font-size: 13px;
        color: #374151;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        appearance: none;
        background-position: right 12px center;
        background-size: 14px;
        padding-right: 36px;
        min-width: 140px;
        font-family: "Inter", sans-serif;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      .filter-group select:hover {
        border-color: #d1d5db;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transform: translateY(-1px);
      }

      .filter-group select:focus {
        outline: none;
        border-color: var(--primary-pink);
        box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
      }

      .results-count {
        font-weight: 500;
        color: #6b7280;
        font-size: 12px;
        text-align: center;
        margin-top: 8px;
        font-family: "Inter", sans-serif;
        letter-spacing: 0.3px;
      }

      /* ===== REDUCE SPACING IN RESULTS CONTAINER ===== */
      .results-container {
        text-align: center;
        padding: 10px 0 0 0;
      }

      .results-hero {
        margin-bottom: 25px;
      }

      .results-hero h2 {
        margin-bottom: 8px;
      }

      .results-hero p {
        margin-bottom: 0;
        line-height: 1.5;
      }
      /* ===== FILTER DESCRIPTION ===== */
      .filter-description {
        color: var(--primary-pink);
        font-size: 12px;
        text-align: center;
        margin-top: 8px;
        padding: 8px 12px;
        background: rgba(236, 72, 153, 0.05);
        border-radius: 8px;
        border: 1px solid rgba(236, 72, 153, 0.1);
        line-height: 1.4;
        transition: all 0.3s ease;
      }

      .filter-description strong {
        color: var(--primary-pink);
        font-weight: 600;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .filter-description {
          font-size: 11px;
          padding: 6px 10px;
          margin-top: 6px;
        }
      }

      /* ===== RESPONSIVE DESIGN ===== */
      @media (max-width: 1024px) {
        .filters-container {
          gap: 12px;
        }

        .filter-group select {
          min-width: 130px;
          padding: 9px 12px;
          font-size: 12.5px;
        }
      }

      @media (max-width: 768px) {
        .filters-section {
          margin: 15px auto 25px auto;
          padding: 0 16px;
        }

        .filters-container {
          gap: 10px;
          flex-direction: row;
          justify-content: space-between;
          flex-wrap: nowrap;
          overflow-x: auto;
          padding-bottom: 8px;
          margin-bottom: 15px;
        }

        .filter-group {
          flex: 0 0 auto;
          min-width: 120px;
        }

        .filter-group select {
          min-width: 120px;
          padding: 8px 12px;
          font-size: 12px;
          padding-right: 32px;
          background-position: right 10px center;
        }

        .results-hero {
          margin-bottom: 20px;
        }

        .results-hero h2 {
          font-size: 1.8rem;
        }

        .results-hero p {
          font-size: 1rem;
        }
      }

      @media (max-width: 640px) {
        .filters-container {
          gap: 8px;
        }

        .filter-group {
          min-width: 110px;
        }

        .filter-group select {
          min-width: 110px;
          padding: 7px 10px;
          font-size: 11.5px;
        }

        .filter-group label {
          font-size: 10px;
        }

        .results-count {
          font-size: 11px;
        }
      }

      @media (max-width: 480px) {
        .filters-section {
          margin: 12px auto 20px auto;
          padding: 0 12px;
        }

        .filters-container {
          gap: 6px;
        }

        .filter-group {
          min-width: 100px;
        }

        .filter-group select {
          min-width: 100px;
          padding: 6px 8px;
          font-size: 11px;
          padding-right: 28px;
          background-size: 12px;
        }

        .results-hero h2 {
          font-size: 1.6rem;
        }

        .results-hero p {
          font-size: 0.9rem;
        }
      }
      /* ===== USER RATINGS ===== */
      .user-rating {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin: 12px 0;
        padding: 8px 0;
      }

      .stars {
        display: flex;
        gap: 2px;
      }

      .stars i {
        font-size: 12px;
        color: #e5e7eb; /* Empty star color */
        transition: color 0.2s ease;
      }

      .stars i.active {
        color: #fbbf24; /* Gold color for filled stars */
      }

      .rating-text {
        font-size: 12px;
        font-weight: 600;
        color: #6b7280;
      }

      .user-rating.no-ratings .stars i {
        color: #d1d5db;
      }

      .user-rating.no-ratings .rating-text {
        color: #9ca3af;
        font-weight: normal;
      }

      /* Hover effects */
      .user-rating:not(.no-ratings):hover .stars i.active {
        color: #f59e0b; /* Slightly darker gold on hover */
      }

      /* Responsive */
      @media (max-width: 768px) {
        .user-rating {
          margin: 10px 0;
          padding: 6px 0;
        }

        .stars i {
          font-size: 11px;
        }

        .rating-text {
          font-size: 11px;
        }
      }
      /* Discreet pink scrollbar that appears on hover */
      body::-webkit-scrollbar {
        width: 6px !important;
        display: block !important;
      }

      body::-webkit-scrollbar-track {
        background: transparent !important;
      }

      body::-webkit-scrollbar-thumb {
        background: rgba(255, 105, 180, 0.1) !important; /* Very subtle pink */
        border-radius: 3px !important;
        transition: all 0.3s ease !important;
      }

      body:hover::-webkit-scrollbar-thumb {
        background: rgba(
          255,
          105,
          180,
          0.4
        ) !important; /* Medium pink on hover */
      }

      body::-webkit-scrollbar-thumb:hover {
        background: rgba(
          255,
          105,
          180,
          0.7
        ) !important; /* Bright pink when active */
      }

      body {
        overflow-y: auto !important;
        overflow-x: hidden !important;
      }
      .recommendations-section {
        margin-bottom: 30px;
        padding: 0 15px;
      }

      /* Elegant Pink Divider Headers */
      .section-divider {
        display: flex;
        align-items: center;
        margin: 25px 0 15px 0;
        cursor: pointer;
        padding: 6px 0;
        transition: all 0.3s ease;
      }

      .section-divider:hover {
        opacity: 0.8;
      }

      .section-divider::before,
      .section-divider::after {
        content: "";
        flex: 1;
        height: 1px;
        background: linear-gradient(90deg, transparent, #f9a8d4, transparent);
      }

      .section-divider-content {
        padding: 0 12px;
        display: flex;
        align-items: center;
        gap: 6px;
        color: #ec4899;
        font-size: 1em;
        font-weight: 500;
        font-family: "Inter", sans-serif;
        white-space: nowrap;
      }

      .section-divider .toggle-icon {
        font-size: 0.7em;
        color: #9ca3af;
        transition: transform 0.3s ease;
        margin-left: 3px;
      }

      .universal-section.expanded .section-divider .toggle-icon {
        transform: rotate(180deg);
        color: #ec4899;
      }

      /* Specific Products */
      .specific-section .section-divider-content {
        color: #ec4899;
      }

      /* Universal Products */
      .universal-section .section-divider-content {
        color: #9ca3af;
      }

      .universal-section.expanded .section-divider-content {
        color: #ec4899;
      }

      /* Tooltip for descriptions */
      .section-divider-content {
        position: relative;
      }

      .section-divider-content:hover::before {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(236, 72, 153, 0.9);
        color: white;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 0.75em;
        white-space: nowrap;
        z-index: 1000;
        margin-bottom: 6px;
        font-family: "Inter", sans-serif;
      }

      .section-divider-content:hover::after {
        content: "";
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 4px solid transparent;
        border-top-color: rgba(236, 72, 153, 0.9);
        margin-bottom: 0;
      }

      /* Results count - very subtle light gray */
      .results-count-subtle {
        color: #9ca3af;
        font-size: 0.7em;
        font-family: "Inter", sans-serif;
        text-align: center;
        margin: -12px 0 15px 0;
        font-style: italic;
      }

      /* Universal products grid - initially hidden */
      .universal-section .recommendations-grid {
        display: none;
        animation: fadeIn 0.3s ease;
      }

      .universal-section.expanded .recommendations-grid {
        display: grid;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .pagination-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin: 30px 0;
        padding: 20px;
      }

      .pagination-btn {
        padding: 10px 20px;
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
      }

      .pagination-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .page-info {
        font-weight: 500;
        color: #666;
      }
      /* Results Actions Styling */
      .results-actions {
        text-align: center;
        margin-top: 40px;
        padding-top: 30px;
        border-top: 1px solid #f1f5f9;
        display: block;
      }

      .quiz-info {
        text-align: center;
        margin-bottom: 20px;
        color: #9ca3af;
        font-size: 0.85em;
        font-style: italic;
        display: block;
        width: 100%;
      }

      .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        align-items: center;
        width: 100%;
      }

      .retake-btn,
      .shop-all-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 0.95em;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 140px;
      }

      .retake-btn {
        background: #f8fafc;
        color: #6b7280;
        border: 1px solid #e5e7eb;
      }

      .retake-btn:hover {
        background: #f1f5f9;
        border-color: #d1d5db;
      }

      .shop-all-btn {
        background: var(--primary-pink);
        color: white;
      }

      .shop-all-btn:hover {
        background: #be185d;
      }
      /* Add All to Cart Styles - Optimized */
      .add-all-container {
        text-align: center;
        margin-top: 2px; /* Reduced from 20px */
        padding-top: 2px; /* Reduced from 20px */
      }

      .add-all-btn {
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 1em;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        position: relative;
        overflow: hidden;
      }

      /* Enhanced hover effects */
      .add-all-btn:hover {
        background: linear-gradient(135deg, var(--dark-pink), #be185d);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(236, 72, 153, 0.4),
          0 0 0 1px rgba(255, 255, 255, 0.1) inset;
      }

      /* Active/click effect */
      .add-all-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(236, 72, 153, 0.3),
          0 0 0 1px rgba(255, 255, 255, 0.1) inset;
      }

      /* Ripple effect on click */
      .add-all-btn::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.3s ease, height 0.3s ease;
      }

      .add-all-btn:active::after {
        width: 100px;
        height: 100px;
      }

      /* Loading state */
      .add-all-btn.loading {
        pointer-events: none;
        opacity: 0.8;
      }

      .add-all-btn.loading::before {
        content: "";
        border: 2px solid transparent;
        border-top: 2px solid white;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .add-all-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .add-all-count {
        color: #6b7280;
        font-size: 0.9em;
        margin-top: 8px;
        font-style: italic;
        transition: color 0.3s ease;
      }

      .add-all-count.highlight {
        color: #6b7280;
        font-weight: 400;
        font-size: 14px;
      }

      /* Success state after adding to cart */
      .add-all-btn.success {
        background: linear-gradient(135deg, #10b981, #059669);
      }

      .add-all-btn.success:hover {
        background: linear-gradient(135deg, #059669, #047857);
      }
      /* Feedback Section Styles */
      .feedback-section {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #f1f5f9;
      }

      .feedback-label {
        font-size: 0.85em;
        color: #6b7280;
        margin-bottom: 8px;
        text-align: center;
      }

      .feedback-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 8px;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        width: fit-content;
      }

      .feedback-indicator.up {
        background: #dcfce7;
        color: #166534;
      }

      .feedback-indicator.down {
        background: #fee2e2;
        color: #991b1b;
      }

      .feedback-indicator i {
        font-size: 0.9em;
      }
      .feedback-buttons {
        display: flex;
        gap: 8px;
        justify-content: center;
      }

      .feedback-btn {
        padding: 6px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 20px;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.8em;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .feedback-btn.thumbs-up:hover {
        background: #dcfce7;
        border-color: #22c55e;
        color: #166534;
      }

      .feedback-btn.thumbs-down:hover {
        background: #fee2e2;
        border-color: #ef4444;
        color: #991b1b;
      }

      .feedback-btn.submitted {
        background: #f3f4f6;
        border-color: #d1d5db;
        cursor: default;
      }

      .feedback-btn.submitted.thumbs-up {
        background: #dcfce7;
        border-color: #22c55e;
        color: #166534;
      }

      .feedback-btn.submitted.thumbs-down {
        background: #fee2e2;
        border-color: #ef4444;
        color: #991b1b;
      }
      .feedback-btn.active {
        background: #f3f4f6;
        border-color: #9ca3af;
        font-weight: 600;
      }

      .feedback-btn.thumbs-up.active {
        background: #dcfce7;
        border-color: #22c55e;
        color: #166534;
      }

      .feedback-btn.thumbs-down.active {
        background: #fee2e2;
        border-color: #ef4444;
        color: #991b1b;
      }

      .feedback-timestamp {
        text-align: center;
        margin-top: 8px;
        color: #9ca3af;
        font-size: 0.75em;
      }

      .feedback-label small {
        display: block;
        font-size: 0.7em;
        color: #6b7280;
        margin-top: 2px;
      }
      .feedback-btn.active {
        background: #f3f4f6;
        border-color: #9ca3af;
        font-weight: 600;
      }

      .feedback-btn.thumbs-up.active {
        background: #dcfce7;
        border-color: #22c55e;
        color: #166534;
      }

      .feedback-btn.thumbs-down.active {
        background: #fee2e2;
        border-color: #ef4444;
        color: #991b1b;
      }

      /* Add transition for smooth color changes */
      .feedback-btn {
        transition: all 0.2s ease;
      }
      .feedback-btn.thumbs-neutral {
        /* Neutral styling */
      }

      .feedback-btn.thumbs-neutral.active {
        background: #fef3c7;
        border-color: #f59e0b;
        color: #92400e;
      }

      .feedback-btn.thumbs-neutral:hover {
        background: #fef3c7;
        border-color: #f59e0b;
        color: #92400e;
      }
      /* Add neutral button styles */
      .feedback-btn.thumbs-neutral {
        /* Base styling */
      }

      .feedback-btn.thumbs-neutral.active {
        background: #fef3c7;
        border-color: #f59e0b;
        color: #92400e;
      }

      .feedback-btn.thumbs-neutral:hover {
        background: #fef3c7;
        border-color: #f59e0b;
        color: #92400e;
      }

      /* Feedback indicator styles for all types */
      .feedback-indicator.up {
        background: #dcfce7;
        color: #166534;
      }

      .feedback-indicator.neutral {
        background: #fef3c7;
        color: #92400e;
      }

      .feedback-indicator.down {
        background: #fee2e2;
        color: #991b1b;
      }
    </style>
  </head>

  <body>
    <!-- Header -->
    <header class="header">
      <div class="brand-header">
        <h1 class="brand-name">Beauty & Blessed</h1>
        <p class="brand-tagline">Elevate Your Everyday Glam.</p>
      </div>
      <div class="user-section">
        <span class="user-greeting" id="user-greeting">Hi, Maria!</span>
        <button
          class="profile-btn"
          onclick="window.location.href='../../profile/html/user_profile.html'"
        >
          <i class="fas fa-user"></i>
        </button>
      </div>
      <button
        class="mobile-profile-btn"
        onclick="window.location.href='../../profile/html/user_profile.html'"
      >
        <i class="fas fa-user"></i>
      </button>
    </header>

    <!-- Desktop Navigation -->
    <nav class="desktop-nav">
      <a href="home.html" class="nav-item" data-page="home">
        <i class="fas fa-home"></i>
        <span>Home</span>
      </a>
      <a href="favorites.html" class="nav-item" data-page="favorites">
        <i class="fas fa-heart"></i>
        <span>Favorites</span>
      </a>
      <a
        href="recommender.html"
        class="nav-item active"
        data-page="recommender"
      >
        <i class="fas fa-star"></i>
        <!-- Keep this as star -->
        <span>Recommender</span>
        <span class="tooltip">Smart Recommender</span>
      </a>
      <a href="cart.html" class="nav-item" data-page="cart">
        <i class="fas fa-shopping-cart"></i>
        <span>Cart</span>
        <div class="nav-cart-count">0</div>
        <!-- ADD THIS -->
      </a>
      <a href="try-on.html" class="nav-item" data-page="tryon">
        <i class="fas fa-camera"></i>
        <span>Virtual Try-On</span>
      </a>
    </nav>

    <!-- Exit Confirmation Modal -->
    <div class="modal-overlay" id="exit-modal">
      <div class="modal-content exit-modal">
        <div class="modal-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3>Are you sure you want to exit?</h3>
        <p>Your quiz progress will not be saved.</p>
        <div class="modal-actions">
          <button class="modal-btn primary" onclick="confirmExit()">
            Yes, Exit
          </button>
          <button class="modal-btn tertiary" onclick="closeExitModal()">
            No, Continue
          </button>
        </div>
      </div>
    </div>

    <!-- Recommender Content -->
    <main class="recommender-main">
      <div class="quiz-container">
        <div class="quiz-step active" id="step-intro">
          <div class="quiz-hero">
            <h1>Find Your Perfect Beauty Match!</h1>
            <p>
              Take our quick 5-step quiz to discover personalized product
              recommendations tailored to your unique skin needs and
              preferences.
            </p>

            <!-- Simple Floating Product Display -->
            <div class="floating-product">
              <img
                src=""
                alt="Beauty Product"
                class="product-image"
                id="floating-product-img"
              />
            </div>

            <button class="nav-btn primary" onclick="startQuizWithCheck()">
              Start Quiz
            </button>
          </div>
        </div>
        <!-- Step 1: Skin Type -->
        <div class="quiz-step" id="step-1">
          <div class="quiz-header">
            <div class="progress-bar">
              <div class="progress-fill" style="width: 20%"></div>
            </div>
            <h2>What's Your Skin Type?</h2>
            <p>This helps us recommend products that work best for your skin</p>
          </div>

          <div class="options-grid">
            <div class="option-card" data-value="normal">
              <div class="option-icon">
                <i class="fas fa-check-circle"></i>
              </div>
              <h3>Normal</h3>
              <p>Balanced, not too oily or dry, few imperfections</p>
            </div>

            <div class="option-card" data-value="oily">
              <div class="option-icon">
                <i class="fas fa-tint"></i>
              </div>
              <h3>Oily</h3>
              <p>Shiny appearance, large pores, prone to breakouts</p>
            </div>

            <div class="option-card" data-value="dry">
              <div class="option-icon">
                <i class="fas fa-leaf"></i>
              </div>
              <h3>Dry</h3>
              <p>Flaky, rough texture, feels tight after washing</p>
            </div>

            <div class="option-card" data-value="combination">
              <div class="option-icon">
                <i class="fas fa-balance-scale"></i>
              </div>
              <h3>Combination</h3>
              <p>Oily T-zone, dry cheeks, mixed characteristics</p>
            </div>

            <div class="option-card" data-value="sensitive">
              <div class="option-icon">
                <i class="fas fa-heartbeat"></i>
              </div>
              <h3>Sensitive</h3>
              <p>Easily irritated, prone to redness and reactions</p>
            </div>
          </div>

          <div class="quiz-nav">
            <button class="nav-btn secondary" onclick="prevStep()">
              <i class="fas fa-arrow-left"></i>
              Back
            </button>
            <button
              class="nav-btn primary"
              id="step1-next"
              onclick="nextStep(2)"
              disabled
            >
              Next
              <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>

        <!-- Step 2: Skin Tone -->
        <div class="quiz-step" id="step-2">
          <div class="quiz-header">
            <div class="progress-bar">
              <div class="progress-fill" style="width: 40%"></div>
            </div>
            <h2>What's Your Skin Tone?</h2>
            <p>Choose the shade that most closely matches your complexion</p>
          </div>

          <div class="skin-tone-options">
            <div class="tone-option" data-value="fair">
              <div class="tone-swatch" style="background: #f8e0c8"></div>
              <span>Fair</span>
            </div>
            <div class="tone-option" data-value="medium">
              <div class="tone-swatch" style="background: #d2a679"></div>
              <span>Medium</span>
            </div>
            <div class="tone-option" data-value="tan">
              <div class="tone-swatch" style="background: #b88c67"></div>
              <span>Tan</span>
            </div>
            <div class="tone-option" data-value="deep">
              <div class="tone-swatch" style="background: #8c6b4f"></div>
              <span>Deep</span>
            </div>
          </div>

          <div class="quiz-nav">
            <button class="nav-btn secondary" onclick="prevStep()">
              <i class="fas fa-arrow-left"></i>
              Back
            </button>
            <button
              class="nav-btn primary"
              id="step2-next"
              onclick="nextStep(3)"
              disabled
            >
              Next
              <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>

        <!-- Step 3: Undertone -->
        <div class="quiz-step" id="step-3">
          <div class="quiz-header">
            <div class="progress-bar">
              <div class="progress-fill" style="width: 60%"></div>
            </div>
            <h2>What's Your Undertone?</h2>
            <p>This helps match foundations and concealers perfectly</p>
          </div>

          <div class="options-grid">
            <div class="option-card" data-value="warm">
              <div class="option-icon">
                <i class="fas fa-sun"></i>
              </div>
              <h3>Warm</h3>
              <p>Yellow, golden, or peachy undertones</p>
            </div>

            <div class="option-card" data-value="cool">
              <div class="option-icon">
                <i class="fas fa-snowflake"></i>
              </div>
              <h3>Cool</h3>
              <p>Pink, red, or bluish undertones</p>
            </div>

            <div class="option-card" data-value="neutral">
              <div class="option-icon">
                <i class="fas fa-adjust"></i>
              </div>
              <h3>Neutral</h3>
              <p>Balance of warm and cool undertones</p>
            </div>

            <div class="option-card" data-value="not-sure">
              <div class="option-icon">
                <i class="fas fa-question"></i>
              </div>
              <h3>Not Sure</h3>
              <p>I'm not sure about my undertone</p>
            </div>
          </div>

          <div class="quiz-nav">
            <button class="nav-btn secondary" onclick="prevStep()">
              <i class="fas fa-arrow-left"></i>
              Back
            </button>
            <button
              class="nav-btn primary"
              id="step3-next"
              onclick="nextStep(4)"
              disabled
            >
              Next
              <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>

        <!-- Step 4: Skin Concerns -->
        <div class="quiz-step" id="step-4">
          <div class="quiz-header">
            <div class="progress-bar">
              <div class="progress-fill" style="width: 80%"></div>
            </div>
            <h2>What Are Your Skin Concerns?</h2>
            <p>Select all that apply (multiple choices allowed)</p>
          </div>

          <div class="concerns-grid">
            <div class="concern-option" data-value="acne">
              <input
                type="checkbox"
                id="concern-acne"
                class="concern-checkbox"
              />
              <label for="concern-acne" class="concern-label">
                <div class="concern-icon">
                  <i class="fas fa-dot-circle"></i>
                </div>
                <h3>Acne & Breakouts</h3>
                <p>Pimples, blackheads, and blemishes</p>
              </label>
            </div>

            <div class="concern-option" data-value="dryness">
              <input
                type="checkbox"
                id="concern-dryness"
                class="concern-checkbox"
              />
              <label for="concern-dryness" class="concern-label">
                <div class="concern-icon">
                  <i class="fas fa-wind"></i>
                </div>
                <h3>Dryness</h3>
                <p>Flaky, dehydrated, or tight skin</p>
              </label>
            </div>

            <div class="concern-option" data-value="dark-spots">
              <input
                type="checkbox"
                id="concern-dark-spots"
                class="concern-checkbox"
              />
              <label for="concern-dark-spots" class="concern-label">
                <div class="concern-icon">
                  <i class="fas fa-circle"></i>
                </div>
                <h3>Dark Spots</h3>
                <p>Hyperpigmentation and uneven tone</p>
              </label>
            </div>

            <div class="concern-option" data-value="aging">
              <input
                type="checkbox"
                id="concern-aging"
                class="concern-checkbox"
              />
              <label for="concern-aging" class="concern-label">
                <div class="concern-icon">
                  <i class="fas fa-clock"></i>
                </div>
                <h3>Aging</h3>
                <p>Fine lines, wrinkles, and firmness</p>
              </label>
            </div>

            <div class="concern-option" data-value="none">
              <input
                type="checkbox"
                id="concern-none"
                class="concern-checkbox"
              />
              <label for="concern-none" class="concern-label">
                <div class="concern-icon">
                  <i class="fas fa-times"></i>
                </div>
                <h3>None</h3>
                <p>No specific concerns</p>
              </label>
            </div>
          </div>

          <div class="quiz-nav">
            <button class="nav-btn secondary" onclick="prevStep()">
              <i class="fas fa-arrow-left"></i>
              Back
            </button>
            <button
              class="nav-btn primary"
              id="step4-next"
              onclick="nextStep(5)"
              disabled
            >
              Next
              <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>

        <!-- Step 5: Product Finish -->
        <div class="quiz-step" id="step-5">
          <div class="quiz-header">
            <div class="progress-bar">
              <div class="progress-fill" style="width: 100%"></div>
            </div>
            <h2>What Product Finish Do You Prefer?</h2>
            <p>Choose your desired makeup finish</p>
          </div>

          <div class="options-grid">
            <div class="option-card" data-value="matte">
              <div class="option-icon">
                <i class="fas fa-circle"></i>
              </div>
              <h3>Matte</h3>
              <p>Flat, shine-free finish</p>
            </div>

            <div class="option-card" data-value="dewy">
              <div class="option-icon">
                <i class="fas fa-circle"></i>
              </div>
              <h3>Dewy</h3>
              <p>Luminous, glowing finish</p>
            </div>

            <div class="option-card" data-value="long-lasting">
              <div class="option-icon">
                <i class="fas fa-shield-alt"></i>
              </div>
              <h3>Long-lasting</h3>
              <p>Stays put all day</p>
            </div>

            <div class="option-card" data-value="dont-care">
              <div class="option-icon">
                <i class="fas fa-infinity"></i>
              </div>
              <h3>Don't Care</h3>
              <p>Any finish is fine</p>
            </div>
          </div>

          <div class="quiz-nav">
            <button class="nav-btn secondary" onclick="prevStep()">
              <i class="fas fa-arrow-left"></i>
              Back
            </button>
            <button
              class="nav-btn primary"
              id="step5-next"
              onclick="showLoading()"
            >
              Get Results
              <i class="fas fa-sparkles"></i>
            </button>
          </div>
        </div>

        <!-- Loading Step -->
        <div class="quiz-step" id="step-loading">
          <div class="loading-container">
            <div class="loading-spinner">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
            <h2>Quiz Complete!</h2>
            <div class="loading-messages">
              <div class="loading-message active">
                <i class="fas fa-check-circle"></i>
                <span>Preparing your product matches...</span>
              </div>
              <div class="loading-message">
                <i class="fas fa-gem"></i>
                <span>Polishing your personalized recommendations...</span>
              </div>
              <div class="loading-message">
                <i class="fas fa-rocket"></i>
                <span>Almost there...</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Results Step -->
        <div class="quiz-step" id="step-results">
          <div class="results-container">
            <div class="results-hero">
              <i class="fas fa-sparkles"></i>
              <h2>Your Personalized Recommendations</h2>
            </div>

            <!-- Filters Section -->
            <div class="filters-section">
              <div class="filters-container">
                <div class="filter-group">
                  <label for="category-filter">Category</label>
                  <select id="category-filter">
                    <option value="all">All Categories</option>
                  </select>
                </div>

                <div class="filter-group">
                  <label for="match-type-filter">Match Type</label>
                  <select id="match-type-filter">
                    <option value="all">All Matches</option>
                    <option value="PERFECT MATCH">Perfect Matches</option>
                    <option value="CLOSE MATCH">Close Matches</option>
                    <option value="NORMAL MATCH">Normal Matches</option>
                  </select>
                </div>

                <div class="filter-group">
                  <label for="sort-by-filter">Sort By</label>
                  <select id="sort-by-filter">
                    <option value="relevance">Relevance</option>
                    <option value="matches">Most Matches</option>
                    <option value="rating">Highest Rated</option>
                    <option value="price-low">Price: Low to High</option>
                    <option value="price-high">Price: High to Low</option>
                  </select>
                </div>
              </div>
            </div>
            <!-- <div id="results-count" class="results-count">
              ... total products found
            </div> -->
            <!-- ADD ALL TO CART BUTTON
            <div class="add-all-container">
              <button id="add-all-to-cart" class="add-all-btn">
                <i class="fas fa-cart-plus"></i>
                Add All to Cart
              </button>
              <div id="add-all-count" class="add-all-count">
                You will add <span id="product-count">0</span> products to your
                cart!
              </div>
            </div> -->

            <div class="recommended-products" id="recommended-products">
              <!-- Products will be dynamically inserted here -->
            </div>

            <div class="results-actions">
              <!-- Quiz date centered above buttons -->
              <div class="quiz-info">
                Based on your quiz from <span id="quiz-date">11/11/2025</span>
              </div>

              <!-- Buttons side by side -->
              <div class="action-buttons">
                <button class="retake-btn" onclick="restartQuiz()">
                  <i class="fas fa-redo"></i>
                  Retake Quiz
                </button>
                <button
                  class="shop-all-btn"
                  onclick="window.location.href='home.html'"
                >
                  Shop All Products
                  <i class="fas fa-shopping-bag"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
      <div class="mobile-nav-items">
        <a href="home.html" class="nav-item" data-page="home">
          <i class="fas fa-home"></i>
          <span>Home</span>
        </a>
        <a href="favorites.html" class="nav-item" data-page="favorites">
          <i class="fas fa-heart"></i>
          <span>Favorites</span>
        </a>
        <a
          href="recommender.html"
          class="nav-item active"
          data-page="recommender"
        >
          <i class="fas fa-star"></i>
          <span>Recommender</span>
        </a>
        <a href="cart.html" class="nav-item" data-page="cart">
          <i class="fas fa-shopping-cart"></i>
          <span>Cart</span>
          <div class="nav-cart-count">0</div>
          <!-- ADD THIS -->
        </a>
        <a href="try-on.html" class="nav-item" data-page="tryon">
          <i class="fas fa-camera"></i>
          <span>Try-On</span>
        </a>
      </div>
    </nav>

    <!-- Add to Cart Confirmation Modal -->
    <div id="add-to-cart-modal" class="modal">
      <div class="modal-content">
        <h3>Add to Cart</h3>
        <p>
          You will add <span id="cart-modal-product-count">0</span> products to
          your cart!
        </p>
        <div class="modal-buttons">
          <button class="modal-btn primary" onclick="confirmAddToCart()">
            <i class="fas fa-cart-plus"></i> Add to Cart
          </button>
          <button class="modal-btn secondary" onclick="closeAddToCartModal()">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="modal">
      <div class="modal-content">
        <div class="success-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <h3 class="success-title" id="success-title">Success!</h3>
        <p class="success-message" id="success-message">
          Products have been added to your cart.
        </p>
        <div class="success-actions">
          <a href="cart.html" class="modal-btn primary">
            <i class="fas fa-shopping-cart"></i> View Cart
          </a>
          <button class="modal-btn secondary" onclick="closeSuccessModal()">
            <i class="fas fa-shopping-bag"></i> Continue Shopping
          </button>
        </div>
      </div>
    </div>

    <!-- Remove style="display: none" from both modals -->
    <div id="existing-prefs-modal" class="modal">
      <div class="modal-content">
        <h3>Existing Preferences Found</h3>
        <p>
          You already have beauty preferences saved from
          <span id="preferences-date">a previous quiz</span>. Would you like to:
        </p>
        <div class="modal-buttons">
          <button
            class="modal-btn secondary"
            onclick="viewCurrentPreferences()"
          >
            <i class="fas fa-eye"></i> View Current Preferences
          </button>
          <button class="modal-btn primary" onclick="replacePreferences()">
            <i class="fas fa-sync"></i> Retake Quiz & Replace
          </button>
          <button
            class="modal-btn cancel-btn"
            onclick="closeExistingPrefsModal()"
          >
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </div>
    </div>

    <div id="current-prefs-modal" class="modal">
      <div class="modal-content">
        <h3>Your Current Preferences</h3>
        <div id="current-preferences-display">
          <!-- Preferences will be loaded here -->
        </div>
        <div class="modal-buttons">
          <button class="modal-btn primary" onclick="closeCurrentPrefsModal()">
            <i class="fas fa-check"></i> Keep Current Preferences
          </button>
          <button
            class="modal-btn secondary"
            onclick="showReplaceConfirmation()"
          >
            <i class="fas fa-sync"></i> Back
          </button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        // Initialize user session
        await updateUserGreeting();

        if (!currentUser) return;

        console.log("User ID:", currentUser.id);
        console.log("Username:", currentUser.username);

        // Check if user already has preferences
        await checkExistingPreferences();

        // If user has existing preferences, automatically load their results
        if (hasExistingPreferences && currentPreferences) {
          console.log("User has existing preferences, auto-loading results...");
          await loadExistingUserResults();
        }

        // Continue with other initializations
        updateCartCount();
        initFloatingProduct();
      });

      // NEW FUNCTION: Auto-load results for returning users
      async function loadExistingUserResults() {
        try {
          // Show loading state immediately
          nextStep("results");

          const container = document.getElementById("recommended-products");
          container.innerHTML = `
            <div class="loading">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
          `;

          // Use the existing preferences to get recommendations
          const response = await fetch("../php/recommend-products.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              skinType: currentPreferences.skin_type,
              skinTone: currentPreferences.skin_tone,
              undertone: currentPreferences.undertone,
              concerns: JSON.parse(currentPreferences.skin_concerns || "[]"),
              finish: currentPreferences.preferred_finish,
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const text = await response.text();
          let result;

          try {
            result = JSON.parse(text);
          } catch (parseError) {
            throw new Error("Invalid JSON response from server");
          }

          if (result.success && result.recommendations) {
            displayRecommendations(result.recommendations);

            // Update the quiz date at the bottom
            const quizDateElement = document.getElementById("quiz-date");
            if (quizDateElement) {
              quizDateElement.textContent = new Date(
                currentPreferences.updated_at
              ).toLocaleDateString();
            }

            // Keep the header clean and simple
            const resultsHero = document.querySelector(".results-hero");
            if (resultsHero) {
              const existingTitle = resultsHero.querySelector("h2");
              if (existingTitle) {
                existingTitle.textContent = "Your Personalized Recommendations";
              }

              // Remove any existing subtitle
              const existingSubtitle = resultsHero.querySelector("p");
              if (existingSubtitle) {
                existingSubtitle.remove();
              }
            }
          } else {
            showErrorState(
              "No recommendations available for your saved preferences"
            );
          }
        } catch (error) {
          console.error("Error loading existing results:", error);
          showErrorState("Error loading your saved recommendations");
        }
      }

      // Global variable to track if user has existing preferences
      let hasExistingPreferences = false;
      let currentPreferences = null;

      // Check if user already has preferences
      async function checkExistingPreferences() {
        try {
          const response = await fetch("../php/check-user-preferences.php");
          const data = await response.json();

          if (data.success && data.hasPreferences) {
            hasExistingPreferences = true;
            currentPreferences = data.preferences;
            console.log("User has existing preferences:", currentPreferences);

            // Return true to indicate preferences exist
            return true;
          }
          return false;
        } catch (error) {
          console.error("Error checking preferences:", error);
          return false;
        }
      }
      function showExistingPrefsModal() {
        // Update the date in the modal if we have currentPreferences
        if (currentPreferences && currentPreferences.updated_at) {
          const dateElement = document.getElementById("preferences-date");
          if (dateElement) {
            const lastUpdated = new Date(
              currentPreferences.updated_at
            ).toLocaleDateString();
            dateElement.textContent = lastUpdated;
          }
        }

        document.getElementById("existing-prefs-modal").classList.add("active");
      }
      // Start quiz with preference check
      function startQuizWithCheck() {
        if (hasExistingPreferences) {
          showExistingPrefsModal();
        } else {
          nextStep(1); // Start quiz normally
        }
      }

      function showStep(stepId) {
        // Hide all steps
        document.querySelectorAll(".quiz-step").forEach((step) => {
          step.classList.remove("active");
        });

        // Show current step
        document.getElementById(stepId).classList.add("active");

        // Add scrollable class to body when on results page
        if (stepId === "step-results") {
          document.body.classList.add("step-results-active");
        } else {
          document.body.classList.remove("step-results-active");
        }
      }

      // Modal functions
      function showExistingPrefsModal() {
        document.getElementById("existing-prefs-modal").classList.add("active");
      }

      function closeExistingPrefsModal() {
        document
          .getElementById("existing-prefs-modal")
          .classList.remove("active");
      }

      function viewCurrentPreferences() {
        closeExistingPrefsModal();
        showCurrentPreferences();
      }

      function showCurrentPreferences() {
        const display = document.getElementById("current-preferences-display");

        if (currentPreferences) {
          display.innerHTML = `
                        <div class="preference-item">
                          <span class="preference-label">Skin Type:</span>
                          <span class="preference-value">${
                            currentPreferences.skin_type
                          }</span>
                        </div>
                        <div class="preference-item">
                          <span class="preference-label">Skin Tone:</span>
                          <span class="preference-value">${
                            currentPreferences.skin_tone
                          }</span>
                        </div>
                        <div class="preference-item">
                          <span class="preference-label">Undertone:</span>
                          <span class="preference-value">${
                            currentPreferences.undertone
                          }</span>
                        </div>
                        <div class="preference-item">
                          <span class="preference-label">Preferred Finish:</span>
                          <span class="preference-value">${
                            currentPreferences.preferred_finish
                          }</span>
                        </div>
                        <div class="preference-item">
                          <span class="preference-label">Skin Concerns:</span>
                          <div class="concerns-list">
                            ${JSON.parse(
                              currentPreferences.skin_concerns || "[]"
                            )
                              .map(
                                (concern) =>
                                  `<span class="concern-tag">${concern}</span>`
                              )
                              .join("")}
                          </div>
                        </div>
                        <div class="preference-item">
                          <span class="preference-label">Last Updated:</span>
                          <span class="preference-value">${new Date(
                            currentPreferences.updated_at
                          ).toLocaleDateString()}</span>
                        </div>
                      `;
        }

        document.getElementById("current-prefs-modal").classList.add("active");
      }

      function closeCurrentPrefsModal() {
        document
          .getElementById("current-prefs-modal")
          .classList.remove("active");
      }

      function showReplaceConfirmation() {
        closeCurrentPrefsModal();
        showExistingPrefsModal();
      }

      function replacePreferences() {
        closeExistingPrefsModal();
        resetQuizAndRestart();
      }

      async function showResults() {
        nextStep("results");

        // Show loading state
        const container = document.getElementById("recommended-products");
        container.innerHTML = `
                      <div class="loading">
                          <i class="fas fa-spinner fa-spin"></i>
                          <h3>Finding your perfect matches...</h3>
                          <p>Analyzing ${quizData.concerns.length} concerns across our product database</p>
                      </div>
                      `;

        try {
          const saveSuccess = await saveUserPreferences();

          if (!saveSuccess) {
            console.warn(
              " Failed to save preferences, but continuing with recommendations"
            );
          } else {
            console.log(" Preferences saved successfully");
          }

          // THEN: Get recommendations
          const response = await fetch("../php/recommend-products.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              skinType: quizData.skinType,
              skinTone: quizData.skinTone,
              undertone: quizData.undertone,
              concerns: quizData.concerns,
              finish: quizData.finish,
            }),
          });

          // Check if response is OK before parsing JSON
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const text = await response.text();
          console.log(" Raw response:", text);

          let result;
          try {
            result = JSON.parse(text);
          } catch (parseError) {
            console.error(" JSON parse error:", parseError);
            throw new Error("Invalid JSON response from server");
          }

          if (result.error) {
            console.warn(" ML system error, using fallback:", result.error);
          }

          if (result.success && result.recommendations) {
            displayRecommendations(result.recommendations);
          } else {
            showErrorState("No recommendations available");
          }
        } catch (error) {
          console.error("Error getting recommendations:", error);
          showErrorState("Connection error - please try again");
        }
      }

      function showErrorState(
        message = "We're still building our product database. Check back soon!"
      ) {
        const container = document.getElementById("recommended-products");
        container.innerHTML = `
                          <div class="no-results">
                              <i class="fas fa-search"></i>
                              <h3>No Perfect Matches Found</h3>
                              <p>${message}</p>
                              <button class="btn-primary" onclick="showResults()">
                                  <i class="fas fa-redo"></i> Try Again
                              </button>
                          </div>
                      `;
      }
      async function loadUserRatings() {
        try {
          const response = await fetch(
            "../php/feedback.php?action=get_user_ratings"
          );
          const result = await response.json();

          if (result.success && result.ratings) {
            // Merge ratings into product data
            result.ratings.forEach((rating) => {
              if (window.productData && window.productData[rating.ProductID]) {
                window.productData[rating.ProductID].user_feedback = {
                  UserRating: rating.UserRating,
                  RecommendationFeedback: rating.RecommendationFeedback,
                  CreatedAt: rating.CreatedAt,
                };
              }
            });

            // Refresh the display to show ratings
            if (window.currentPage) {
              showPage(window.currentPage);
            }
          }
        } catch (error) {
          console.error("Error loading user ratings:", error);
        }
      }

      // Update your existing displayRecommendations function
      function displayRecommendations(recommendations) {
        const container = document.getElementById("recommended-products");

        console.log(" Displaying recommendations:", recommendations?.length);

        if (
          !recommendations ||
          !Array.isArray(recommendations) ||
          recommendations.length === 0
        ) {
          container.innerHTML = `
                  <div class="no-results">
                      <i class="fas fa-search"></i>
                      <h3>No Perfect Matches Found</h3>
                      <p>We're still building our product database. Check back soon!</p>
                  </div>
              `;

          // // Update Add All count to 0
          // updateAddAllCount(0);
          return;
        }

        // Store all recommendations globally for pagination
        window.allRecommendations = recommendations;
        window.currentPage = 1;
        window.productsPerPage = 20;

        // Store product data for sorting
        if (!window.productData) window.productData = {};
        recommendations.forEach((product) => {
          window.productData[product.id] = product;
        });

        // // Initialize Add All to Cart
        // setupAddAllToCart();

        // Show first page
        showPage(1);

        // Set default sort to "relevance"
        const sortSelect = document.getElementById("sort-by-filter");
        if (sortSelect) {
          sortSelect.value = "relevance";
        }

        // Load categories and setup filters
        loadCategoriesIntoFilter().then(() => {
          setupFilters();
          updateResultsCount(recommendations.length);
        });
        loadUserRatings();
      }

      function showPage(page) {
        const container = document.getElementById("recommended-products");

        console.log(` Page ${page}: Showing filtered/sorted results`);

        // Use filtered results if available, otherwise use all recommendations
        const recommendationsToShow =
          window.filteredRecommendations || window.allRecommendations;

        console.log(
          ` Total products to paginate: ${recommendationsToShow.length}`
        );

        // Categorize products
        const allSpecific = recommendationsToShow.filter((product) => {
          const category = (product.Category || "").toLowerCase();
          return [
            "blush",
            "concealer",
            "foundation",
            "powder",
            "face care",
            "lipstick",
            "liptint",
            "serum",
            "moisturizer",
            "treatment",
            "cream",
            "lotion",
            "toner",
          ].some((cat) => category.includes(cat));
        });

        const allUniversal = recommendationsToShow.filter((product) => {
          const category = (product.Category || "").toLowerCase();
          return ![
            "blush",
            "concealer",
            "foundation",
            "powder",
            "face care",
            "lipstick",
            "liptint",
            "serum",
            "moisturizer",
            "treatment",
            "cream",
            "lotion",
            "toner",
          ].some((cat) => category.includes(cat));
        });

        const productsPerCategory = Math.floor(window.productsPerPage / 2);
        const specificStart = (page - 1) * productsPerCategory;
        const universalStart = (page - 1) * productsPerCategory;

        const specificProducts = allSpecific.slice(
          specificStart,
          specificStart + productsPerCategory
        );
        const universalProducts = allUniversal.slice(
          universalStart,
          universalStart + productsPerCategory
        );

        let html = "";

        // 1. SPECIFIC PRODUCTS SECTION (always expanded)
        if (specificProducts.length > 0) {
          html += `
                  <div class="recommendations-section specific-section">
                      <div class="section-divider">
                          <div class="section-divider-content" data-tooltip="Products specifically tailored to your skin type, tone, and concerns">
                              Specific Products
                          </div>
                      </div>
                      <div class="results-count-subtle">Showing ${
                        specificStart + 1
                      }-${specificStart + specificProducts.length} of ${
            allSpecific.length
          }</div>
                      <div class="recommendations-grid">
              `;
          specificProducts.forEach((product) => {
            html += generateProductCard(product);
          });
          html += `</div></div>`;
        }

        // 2. UNIVERSAL PRODUCTS SECTION (collapsible)
        if (allUniversal.length > 0) {
          const wasExpanded = window.universalSectionExpanded || false;
          const expandedClass = wasExpanded ? "expanded" : "";
          const displayStyle = wasExpanded ? "" : "display: none;";
          const universalText = wasExpanded
            ? `Showing ${universalStart + 1}-${
                universalStart + universalProducts.length
              } of ${allUniversal.length}`
            : "Click to view universal products";

          html += `
                  <div class="recommendations-section universal-section ${expandedClass}">
                      <div class="section-divider" onclick="toggleUniversalSection()">
                          <div class="section-divider-content" data-tooltip="Tools and products that work beautifully for everyone">
                              Universal Products
                              <span class="toggle-icon"></span>
                          </div>
                      </div>
                      ${
                        wasExpanded
                          ? `<div class="results-count-subtle">${universalText}</div>`
                          : ""
                      }
                      <div class="recommendations-grid" style="${displayStyle}">
              `;
          universalProducts.forEach((product) => {
            html += generateProductCard(product);
          });
          html += `</div></div>`;
        }

        html += createPaginationHTML(page);
        container.innerHTML = html;
        window.currentPage = page;
        setupPaginationEvents();
      }

      // Toggle function for Universal section - FIXED VERSION
      function toggleUniversalSection() {
        const universalSection = document.querySelector(".universal-section");
        if (universalSection) {
          universalSection.classList.toggle("expanded");

          // Store the state
          window.universalSectionExpanded =
            universalSection.classList.contains("expanded");

          // Get the recommendations grid
          const recommendationsGrid = universalSection.querySelector(
            ".recommendations-grid"
          );
          const resultsCount = universalSection.querySelector(
            ".results-count-subtle"
          );

          if (window.universalSectionExpanded) {
            // Show the grid
            recommendationsGrid.style.display = "grid";

            // Update the results count
            const recommendationsToShow =
              window.filteredRecommendations || window.allRecommendations;
            const allUniversal = recommendationsToShow.filter((product) => {
              const category = (product.Category || "").toLowerCase();
              return ![
                "blush",
                "concealer",
                "foundation",
                "powder",
                "face care",
                "lipstick",
                "liptint",
                "serum",
                "moisturizer",
                "treatment",
                "cream",
                "lotion",
                "toner",
              ].some((cat) => category.includes(cat));
            });

            const productsPerCategory = Math.floor(window.productsPerPage / 2);
            const universalStart =
              (window.currentPage - 1) * productsPerCategory;
            const universalProducts = allUniversal.slice(
              universalStart,
              universalStart + productsPerCategory
            );

            if (!resultsCount) {
              const divider =
                universalSection.querySelector(".section-divider");
              divider.insertAdjacentHTML(
                "afterend",
                `<div class="results-count-subtle">Showing ${
                  universalStart + 1
                }-${universalStart + universalProducts.length} of ${
                  allUniversal.length
                }</div>`
              );
            } else {
              resultsCount.textContent = `Showing ${universalStart + 1}-${
                universalStart + universalProducts.length
              } of ${allUniversal.length}`;
            }
          } else {
            // Hide the grid
            recommendationsGrid.style.display = "none";

            // Remove the results count
            if (resultsCount) {
              resultsCount.remove();
            }
          }
        }
      }

      // Initialize universal section state
      window.universalSectionExpanded = false;

      function createPaginationHTML(currentPage = window.currentPage) {
        // Use filtered results if available, otherwise use all recommendations
        const recommendationsToShow =
          window.filteredRecommendations || window.allRecommendations;

        // Calculate total pages based on the largest category
        const allPersonalized = recommendationsToShow.filter((product) => {
          const category = (product.Category || "").toLowerCase();
          return [
            "blush",
            "concealer",
            "foundation",
            "powder",
            "face care",
            "lipstick",
            "liptint",
            "serum",
            "moisturizer",
            "treatment",
            "cream",
            "lotion",
            "toner",
          ].some((cat) => category.includes(cat));
        });

        const allUniversal = recommendationsToShow.filter((product) => {
          const category = (product.Category || "").toLowerCase();
          return ![
            "blush",
            "concealer",
            "foundation",
            "powder",
            "face care",
            "lipstick",
            "liptint",
            "serum",
            "moisturizer",
            "treatment",
            "cream",
            "lotion",
            "toner",
          ].some((cat) => category.includes(cat));
        });

        const productsPerCategory = Math.floor(window.productsPerPage / 2);
        const personalizedPages = Math.ceil(
          allPersonalized.length / productsPerCategory
        );
        const universalPages = Math.ceil(
          allUniversal.length / productsPerCategory
        );
        const totalPages = Math.max(personalizedPages, universalPages);

        console.log(
          ` Pagination: ${currentPage}/${totalPages} pages (Personalized:${personalizedPages}, Universal:${universalPages})`
        );

        if (totalPages <= 1) {
          console.log(" Only one page - hiding pagination");
          return "";
        }

        return `
              <div class="pagination-controls">
                  <button id="prev-page" class="pagination-btn" ${
                    currentPage === 1 ? "disabled" : ""
                  }>
                       Previous
                  </button>
                  <span class="page-info">Page ${currentPage} of ${totalPages}</span>
                  <button id="next-page" class="pagination-btn" ${
                    currentPage === totalPages ? "disabled" : ""
                  }>
                      Next 
                  </button>
              </div>
          `;
      }

      // Setup pagination event listeners - FIXED: Use same calculation method
      function setupPaginationEvents() {
        const prevBtn = document.getElementById("prev-page");
        const nextBtn = document.getElementById("next-page");

        console.log(" Setting up pagination events...");

        if (prevBtn) {
          prevBtn.onclick = (e) => {
            e.preventDefault();
            console.log(" Previous page clicked");
            if (window.currentPage > 1) {
              showPage(window.currentPage - 1);
            }
          };
        }

        if (nextBtn) {
          nextBtn.onclick = (e) => {
            e.preventDefault();
            console.log(" Next page clicked");

            // Use the SAME calculation method as createPaginationHTML
            const allPersonalized = window.allRecommendations.filter(
              (product) => {
                const category = (product.Category || "").toLowerCase();
                return [
                  "blush",
                  "concealer",
                  "foundation",
                  "powder",
                  "face care",
                  "lipstick",
                  "liptint",
                  "serum",
                  "moisturizer",
                  "treatment",
                  "cream",
                  "lotion",
                  "toner",
                ].some((cat) => category.includes(cat));
              }
            );

            const allUniversal = window.allRecommendations.filter((product) => {
              const category = (product.Category || "").toLowerCase();
              return ![
                "blush",
                "concealer",
                "foundation",
                "powder",
                "face care",
                "lipstick",
                "liptint",
                "serum",
                "moisturizer",
                "treatment",
                "cream",
                "lotion",
                "toner",
              ].some((cat) => category.includes(cat));
            });

            const productsPerCategory = Math.floor(window.productsPerPage / 2);
            const personalizedPages = Math.ceil(
              allPersonalized.length / productsPerCategory
            );
            const universalPages = Math.ceil(
              allUniversal.length / productsPerCategory
            );
            const totalPages = Math.max(personalizedPages, universalPages);

            if (window.currentPage < totalPages) {
              showPage(window.currentPage + 1);
            }
          };
        }
      }
      function generateProductCard(product) {
        const cleanName = product.Name
          ? product.Name.replace(/Parent Record:/gi, "")
              .replace(/Product Record:/gi, "")
              .replace(/:/g, "")
              .trim()
          : "Unnamed Product";

        const matchType = product.Match_Type || " NORMAL MATCH";
        const ratingQuality = product.Rating_Quality || " UNRATED";
        const price = product.Price
          ? parseFloat(product.Price).toFixed(2)
          : "0.00";
        const category = product.Category || "Uncategorized";
        const attributeMatches = product.Attribute_Matches || {};

        // Get user rating
        const userRating =
          product.ProductRating ||
          product.productrating ||
          product.user_rating ||
          product.rating ||
          0;

        let imagePath = "/admin/uploads/product_images/no-image.png";
        if (product.image && product.image !== "null") {
          let cleanImagePath = product.image;
          cleanImagePath = cleanImagePath.replace(
            /^\.\.\\?\/uploads\\?\/product_images\\?\//,
            ""
          );
          cleanImagePath = cleanImagePath.replace(/\\\//g, "");
          imagePath = `/admin/uploads/product_images/${cleanImagePath}`;
        }

        const attributeHTML = generateAttributeMatchesHTML(
          attributeMatches,
          product.id
        );

        if (!window.productData) window.productData = {};
        window.productData[product.id] = product;

        // Build user rating HTML
        let userRatingHTML = "";
        if (userRating && userRating > 0) {
          const fullStars = Math.floor(userRating);
          const hasHalfStar = userRating % 1 >= 0.5;

          userRatingHTML = `
      <div class="user-rating">
          <div class="stars">
              ${Array.from({ length: 5 }, (_, i) => {
                if (i < fullStars) {
                  return '<i class="fas fa-star active"></i>';
                } else if (i === fullStars && hasHalfStar) {
                  return '<i class="fas fa-star-half-alt active"></i>';
                } else {
                  return '<i class="far fa-star"></i>';
                }
              }).join("")}
          </div>
          <span class="rating-text">${parseFloat(userRating).toFixed(1)}</span>
      </div>
    `;
        } else {
          userRatingHTML = `
      <div class="user-rating no-ratings">
          <div class="stars">
              <i class="far fa-star"></i>
              <i class="far fa-star"></i>
              <i class="far fa-star"></i>
              <i class="far fa-star"></i>
              <i class="far fa-star"></i>
          </div>
          <span class="rating-text">No ratings yet</span>
      </div>
    `;
        }

        // FIXED product indicator - Handle 3 ratings:
        const existingFeedback = product.user_feedback;
        const hasUserFeedback =
          existingFeedback &&
          existingFeedback.RecommendationFeedback !== undefined;

        let feedbackIndicator = "";
        if (hasUserFeedback) {
          const rating = existingFeedback.RecommendationFeedback;
          let icon, text, type;

          if (rating === 1) {
            icon = "thumbs-up";
            text = "Good match";
            type = "up";
          } else if (rating === 0.5) {
            icon = "meh-blank"; // FontAwesome meh icon
            text = "Okay match";
            type = "neutral";
          } else {
            icon = "thumbs-down";
            text = "Poor match";
            type = "down";
          }

          feedbackIndicator = `
    <div class="feedback-indicator ${type}">
      <i class="fas fa-${icon}"></i>
      <small>${text}</small>
    </div>
  `;
        }

        return `
    <div class="product-card" data-product-id="${product.id}">
        <!-- Match Quality Badge -->
        <div class="match-badge ${getMatchBadgeClass(
          matchType
        )}">${matchType}</div>
        
        <!-- Rating Quality Badge -->
        <div class="rating-badge ${getRatingBadgeClass(
          ratingQuality
        )}">${ratingQuality}</div>
        
        <div class="product-image-container">
            <img src="${imagePath}" alt="${cleanName}" class="product-image"
                 onerror="handleImageError(this)">
        </div>
        <div class="product-info">
            <h4 class="product-name">${cleanName}</h4>
            <p class="product-category">${category}</p>
            <p class="product-price">${price}</p>
            
            <!-- Attribute Matches Section -->
            ${attributeHTML}
            
            <!-- User Ratings Section -->
            ${userRatingHTML}
            
            <div class="product-actions">
                <button class="btn-primary add-to-cart-btn" onclick="addRecommendedToCart('${
                  product.id
                }')">
                    <i class="fas fa-shopping-cart"></i>
                </button>
                <button class="btn-secondary view-details-btn" onclick="viewProductDetails('${
                  product.id
                }')">
                    <i class="fas fa-eye"></i> Details
                </button>
            </div>
            ${feedbackIndicator}
        </div>
    </div>
  `;
      }

      function generateAttributeMatchesHTML(attributeMatches, productId) {
        if (!attributeMatches || Object.keys(attributeMatches).length === 0) {
          return "";
        }

        // FIXED: Count total attributes correctly (Skin Concerns counts as 1)
        const totalAttributes = 5; // skin_type, skin_tone, undertone, finish, concerns
        const matchCount = countMatches(attributeMatches);

        let html = `
                <div class="attribute-summary" data-product-id="${productId}">
                    <div class="attribute-header">
                        <span class="attribute-text">${matchCount}/${totalAttributes} Matches</span>
                        <span class="attribute-toggle"></span>
                    </div>
                </div>
              `;

        return html;
      }
      function createExternalFloatingCard(attributeMatches, productData) {
        if (!attributeMatches || Object.keys(attributeMatches).length === 0) {
          return "";
        }

        let html = "";

        const addAttribute = (label, productValue, userValue, match) => {
          // Use 'Don\'t Care' logic for the checkmark display
          let isMatch = match;
          if (
            userValue.toLowerCase().includes("don't care") ||
            userValue.toLowerCase().includes("none")
          ) {
            isMatch = true;
          }

          return `
      <div class="attribute-detail-clean ${isMatch ? "match" : "no-match"}">
          <div class="attribute-line">
              <span class="attribute-label-clean">${label}</span>
              <div class="attribute-values">
                  <span class="product-value-clean">${productValue}</span>
                  <span class="separator"></span>
                  <span class="user-value-clean">${userValue}</span>
              </div>
          </div>
          <span class="detail-status-clean">${isMatch ? "" : ""}</span>
      </div>
    `;
        };

        // --- Core Attributes ---
        if (attributeMatches.skin_type) {
          const match = attributeMatches.skin_type;
          html += addAttribute(
            "Skin Type",
            match.product_value,
            match.user_value,
            match.match
          );
        }

        if (attributeMatches.skin_tone) {
          const match = attributeMatches.skin_tone;
          html += addAttribute(
            "Skin Tone",
            match.product_value,
            match.user_value,
            match.match
          );
        }

        if (attributeMatches.undertone) {
          const match = attributeMatches.undertone;
          html += addAttribute(
            "Undertone",
            match.product_value,
            match.user_value,
            match.match
          );
        }

        if (attributeMatches.finish) {
          const match = attributeMatches.finish;
          html += addAttribute(
            "Finish",
            match.product_value,
            match.user_value,
            match.match
          );
        }

        // --- Skin Concerns ---
        if (
          attributeMatches.concerns &&
          attributeMatches.concerns["Skin Concerns"]
        ) {
          const match = attributeMatches.concerns["Skin Concerns"];
          html += addAttribute(
            "Skin Concerns",
            match.product_value,
            match.user_value,
            match.match
          );
        } else if (
          attributeMatches.concerns &&
          attributeMatches.concerns["No Concerns"]
        ) {
          const match = attributeMatches.concerns["No Concerns"];
          html += addAttribute(
            "Skin Concerns",
            match.product_value,
            match.user_value,
            match.match
          );
        }

        const existingFeedback = productData.user_feedback;
        // FIX: Check RecommendationFeedback consistently
        const hasExistingFeedback =
          existingFeedback &&
          existingFeedback.RecommendationFeedback !== undefined;

        // DETERMINE CURRENT RATING
        let currentThumbsRating = null;
        if (hasExistingFeedback) {
          currentThumbsRating = existingFeedback.RecommendationFeedback; // This should be 0 or 1
          console.log("Existing feedback thumbs rating:", currentThumbsRating);
        }

        // ADD FEEDBACK SECTION WITH DATA ATTRIBUTES
        // In createExternalFloatingCard function - ADD NEUTRAL OPTION:
        html += `
  <div class="feedback-section">
    <div class="feedback-label">
      ${hasExistingFeedback ? "Your rating:" : "How was this match?"}
      ${hasExistingFeedback ? "<small>Click to change</small>" : ""}
    </div>
    <div class="feedback-buttons">
      <button class="feedback-btn thumbs-up ${
        currentThumbsRating === 1 ? "active" : ""
      }" 
              data-feedback="1" data-product-id="${productData.id}">
         Good
      </button>
      <button class="feedback-btn thumbs-neutral ${
        currentThumbsRating === 0.5 ? "active" : ""
      }" 
              data-feedback="0.5" data-product-id="${productData.id}">
         Okay
      </button>
      <button class="feedback-btn thumbs-down ${
        currentThumbsRating === 0 ? "active" : ""
      }" 
              data-feedback="0" data-product-id="${productData.id}">
         Poor
      </button>
    </div>
    ${
      hasExistingFeedback
        ? `
      <div class="feedback-timestamp">
        <small>Rated on ${new Date(
          existingFeedback.CreatedAt
        ).toLocaleDateString()}</small>
      </div>
    `
        : ""
    }
  </div>
`;
        return html;
      }
      // Then add this function to handle the event listeners:
      function setupFeedbackButtons() {
        document.addEventListener("click", function (e) {
          if (e.target.closest(".feedback-btn")) {
            const button = e.target.closest(".feedback-btn");
            const productId = button.getAttribute("data-product-id");
            const rating = parseInt(button.getAttribute("data-rating"));
            const productName =
              window.productData && window.productData[productId]
                ? window.productData[productId].Name
                : "Unknown Product";

            submitProductFeedback(productId, rating, productName);
          }
        });
      }

      // Call this when the page loads
      document.addEventListener("DOMContentLoaded", function () {
        setupFeedbackButtons();
      });

      // Function to load categories dynamically
      async function loadCategoriesIntoFilter() {
        try {
          const response = await fetch("../php/categories.php");
          if (!response.ok)
            throw new Error(`HTTP error! status: ${response.status}`);

          const data = await response.json();
          const categoryFilter = document.getElementById("category-filter");

          if (data.success && categoryFilter) {
            // FIXED: Clear all options and rebuild properly
            categoryFilter.innerHTML =
              '<option value="all">All Categories</option>';

            // Add categories from database
            data.categories.forEach((category) => {
              // Skip if category is "All" to avoid duplicates
              if (category.toLowerCase() !== "all") {
                const option = document.createElement("option");
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
              }
            });

            console.log(" Categories loaded into filter:", data.categories);
          }
        } catch (error) {
          console.error(" Error loading categories:", error);
          // Keep the default categories if fetch fails
        }
      }

      function setupFilters() {
        console.log(" Setting up filters...");

        const categoryFilter = document.getElementById("category-filter");
        const matchTypeFilter = document.getElementById("match-type-filter");
        const sortByFilter = document.getElementById("sort-by-filter");

        console.log("Filters found:", {
          categoryFilter: !!categoryFilter,
          matchTypeFilter: !!matchTypeFilter,
          sortByFilter: !!sortByFilter,
        });

        if (categoryFilter) {
          categoryFilter.addEventListener("change", applyFilters);
        }
        if (matchTypeFilter) {
          matchTypeFilter.addEventListener("change", applyFilters);
        }
        if (sortByFilter) {
          sortByFilter.addEventListener("change", applyFilters);
        }

        // // Setup Add All to Cart
        // setupAddAllToCart();

        // Debug: Check if products exist
        const productCards = document.querySelectorAll(".product-card");
        console.log("Product cards found during setup:", productCards.length);
      }

      const filterDescriptions = {
        "match-type": {
          all: " Showing all products that match your preferences",
          "PERFECT MATCH":
            "Products that perfectly match your skin type, tone, and preferences",
          "CLOSE MATCH": "Products that closely match most of your preferences",
          "NORMAL MATCH": "Good products that match some of your preferences",
        },
        "sort-by": {
          relevance:
            "Products sorted by how well they match your specific needs",
          matches:
            "Products with the most matching attributes to your preferences",
          rating: "Products highly rated by users with similar preferences",
          "price-low": "Products sorted from lowest to highest price",
          "price-high": "Products sorted from highest to lowest price",
        },
        category: {
          all: "Showing products from all categories that match your preferences",
          default:
            "Showing products from this category that match your preferences",
        },
      };

      // Function to update description based on current filters
      function updateFilterDescription() {
        const matchType = document.getElementById("match-type-filter").value;
        const sortBy = document.getElementById("sort-by-filter").value;
        const category = document.getElementById("category-filter").value;

        let description = "";

        // Priority: Match Type > Sort By > Category
        if (
          matchType !== "all" &&
          filterDescriptions["match-type"][matchType]
        ) {
          description = filterDescriptions["match-type"][matchType];
        } else if (
          sortBy !== "relevance" &&
          filterDescriptions["sort-by"][sortBy]
        ) {
          description = filterDescriptions["sort-by"][sortBy];
        } else if (category !== "all") {
          description = filterDescriptions["category"]["default"];
        } else {
          description = filterDescriptions["match-type"]["all"];
        }

        document.getElementById("filter-description").innerHTML = description;
      }

      // Update the applyFilters function to refresh the add-all count
      function applyFilters() {
        console.log("Applying filters to ALL products...");

        const selectedCategory =
          document.getElementById("category-filter")?.value || "all";
        const selectedMatchType =
          document.getElementById("match-type-filter")?.value || "all";
        const selectedSort =
          document.getElementById("sort-by-filter")?.value || "relevance";

        console.log("Filter criteria:", {
          selectedCategory,
          selectedMatchType,
          selectedSort,
        });

        // Store filter state globally so pagination respects it
        window.currentFilters = {
          category: selectedCategory,
          matchType: selectedMatchType,
          sort: selectedSort,
        };

        // Apply filters to ALL recommendations and re-paginate
        const filteredRecommendations = window.allRecommendations.filter(
          (product) => {
            let shouldInclude = true;

            // Category filter
            if (selectedCategory !== "all" && selectedCategory !== "All") {
              const productCategory = product.Category || "";
              if (productCategory !== selectedCategory) {
                shouldInclude = false;
              }
            }

            // Match type filter
            if (selectedMatchType !== "all") {
              const productMatchType = product.Match_Type || "";
              if (!productMatchType.includes(selectedMatchType)) {
                shouldInclude = false;
              }
            }

            return shouldInclude;
          }
        );

        console.log(
          `Filtered from ${window.allRecommendations.length} to ${filteredRecommendations.length} products`
        );

        // Apply sorting to the filtered results
        const sortedRecommendations = sortAllProducts(
          filteredRecommendations,
          selectedSort
        );

        // Update the global recommendations with filtered+sorted results
        window.filteredRecommendations = sortedRecommendations;

        // // Update the Add All to Cart count
        // updateAddAllCount(sortedRecommendations.length);

        // Reset to page 1 with the new filtered results
        window.currentPage = 1;

        // Show the first page of filtered results
        showPage(1);

        // Update results count
        updateResultsCount(sortedRecommendations.length);
      }

      // Function to update the Add All to Cart count
      function updateAddAllCount(count) {
        const addAllCount = document.getElementById("add-all-count");
        const productCount = document.getElementById("product-count");
        const addAllBtn = document.getElementById("add-all-to-cart");

        if (productCount) {
          productCount.textContent = count;
        }

        if (addAllCount) {
          if (count > 0) {
            addAllCount.classList.add("highlight");
          } else {
            addAllCount.classList.remove("highlight");
          }
        }

        if (addAllBtn) {
          addAllBtn.disabled = count === 0;
        }
      }

      // Function to show add to cart confirmation modal
      function showAddToCartModal(productCount) {
        const modal = document.getElementById("add-to-cart-modal");
        const countElement = document.getElementById(
          "cart-modal-product-count"
        );

        // Update product count
        countElement.textContent = productCount;

        // Show modal using class
        modal.classList.add("active");

        // Return a promise that resolves when user makes a choice
        return new Promise((resolve) => {
          window.addToCartResolve = resolve;
        });
      }

      // Function to close add to cart modal
      function closeAddToCartModal() {
        const modal = document.getElementById("add-to-cart-modal");
        modal.classList.remove("active");

        if (window.addToCartResolve) {
          window.addToCartResolve(false);
          window.addToCartResolve = null;
        }
      }

      // Function when user confirms add to cart
      function confirmAddToCart() {
        const modal = document.getElementById("add-to-cart-modal");
        modal.classList.remove("active");

        if (window.addToCartResolve) {
          window.addToCartResolve(true);
          window.addToCartResolve = null;
        }
      }

      // Function to show success modal
      function showSuccessModal(successCount, errorCount = 0) {
        const modal = document.getElementById("success-modal");
        const title = document.getElementById("success-title");
        const message = document.getElementById("success-message");

        if (successCount > 0) {
          title.textContent = "Success!";
          if (errorCount > 0) {
            message.textContent = `Successfully added ${successCount} products to cart! (${errorCount} items were out of stock)`;
          } else {
            message.textContent = `Successfully added ${successCount} products to cart!`;
          }
        } else {
          title.textContent = "Notice";
          message.textContent =
            "No products were added to cart. Items may be out of stock.";
        }

        modal.classList.add("active");
      }

      // Function to close success modal
      function closeSuccessModal() {
        const modal = document.getElementById("success-modal");
        modal.classList.remove("active");
      }

      // Optional: Auto-close after 5 seconds
      function showSuccessModalAutoClose(successCount, errorCount = 0) {
        showSuccessModal(successCount, errorCount);
        setTimeout(closeSuccessModal, 5000);
      }

      // // Updated function to add all filtered products to cart
      // async function addAllToCart() {
      //   const currentRecommendations =
      //     window.filteredRecommendations || window.allRecommendations;
      //   const productCount = currentRecommendations.length;

      //   if (productCount === 0) {
      //     // Use alert if showNotification doesn't exist
      //     if (typeof showNotification === "function") {
      //       showNotification("No products to add to cart!", "error");
      //     } else {
      //       alert("No products to add to cart!");
      //     }
      //     return;
      //   }

      //   // Show beautiful modal instead of confirm()
      //   const confirmed = await showAddToCartModal(productCount);

      //   if (!confirmed) {
      //     return;
      //   }

      //   // Show loading state
      //   const addAllBtn = document.getElementById("add-all-to-cart");
      //   const originalText = addAllBtn.innerHTML;
      //   addAllBtn.innerHTML =
      //     '<i class="fas fa-spinner fa-spin"></i> Adding...';
      //   addAllBtn.disabled = true;

      //   try {
      //     let successCount = 0;
      //     let errorCount = 0;
      //     const outOfStockProducts = [];

      //     // Add each product to cart
      //     for (const product of currentRecommendations) {
      //       try {
      //         const productId = product.id;

      //         const response = await fetch("../php/cart.php", {
      //           method: "POST",
      //           headers: {
      //             "Content-Type": "application/x-www-form-urlencoded",
      //           },
      //           body: `action=add&product_id=${encodeURIComponent(
      //             productId
      //           )}&quantity=1`,
      //         });

      //         const result = await response.json();

      //         if (result.success) {
      //           successCount++;
      //         } else {
      //           errorCount++;
      //           console.warn(
      //             `Failed to add product ${product.Name}:`,
      //             result.message
      //           );

      //           // Track out of stock products
      //           if (result.message && result.message.includes("stock")) {
      //             outOfStockProducts.push(product.Name);
      //           }
      //         }

      //         // Small delay to avoid overwhelming the server
      //         await new Promise((resolve) => setTimeout(resolve, 100));
      //       } catch (error) {
      //         errorCount++;
      //         console.error(`Error adding product ${product.Name}:`, error);
      //       }
      //     }

      //     showSuccessModal(successCount, errorCount);

      //     // Update cart count if we have the function
      //     if (successCount > 0 && typeof updateCartCount === "function") {
      //       try {
      //         const countResponse = await fetch("../php/cart.php?action=count");
      //         const countResult = await countResponse.json();
      //         if (countResult.success) {
      //           updateCartCount(countResult.cartCount);
      //         }
      //       } catch (error) {
      //         console.error("Error updating cart count:", error);
      //       }
      //     }
      //   } catch (error) {
      //     console.error("Error in addAllToCart:", error);
      //     // Use available notification method
      //     if (typeof showNotification === "function") {
      //       showNotification(
      //         "Error adding products to cart. Please try again.",
      //         "error"
      //       );
      //     } else {
      //       alert("Error adding products to cart. Please try again.");
      //     }
      //   } finally {
      //     // Restore button state
      //     addAllBtn.innerHTML = originalText;
      //     addAllBtn.disabled = false;
      //   }
      // }

      // // Make sure to attach the event listener
      // document
      //   .getElementById("add-all-to-cart")
      //   .addEventListener("click", addAllToCart);

      // // Add keyboard support (ESC to close modal)
      // document.addEventListener("keydown", function (e) {
      //   if (e.key === "Escape") {
      //     closeAddToCartModal();
      //   }
      // });
      // Initialize the Add All to Cart functionality
      function setupAddAllToCart() {
        const addAllBtn = document.getElementById("add-all-to-cart");
        if (addAllBtn) {
          addAllBtn.addEventListener("click", addAllToCart);
        }

        // Initialize count on page load
        const initialCount = window.allRecommendations
          ? window.allRecommendations.length
          : 0;
        updateAddAllCount(initialCount);
      }

      // New function to sort ALL products (not just visible ones)
      function sortAllProducts(products, sortBy) {
        console.log(`Sorting ${products.length} products by:`, sortBy);

        return products.sort((a, b) => {
          try {
            switch (sortBy) {
              case "relevance":
                return (b.Composite_Score || 0) - (a.Composite_Score || 0);

              case "price-low":
                return (a.Price || 0) - (b.Price || 0);

              case "price-high":
                return (b.Price || 0) - (a.Price || 0);

              case "rating":
                return (b.final_rating || 0) - (a.final_rating || 0);

              case "matches":
                return (b.Initial_Fit_Score || 0) - (a.Initial_Fit_Score || 0);

              default:
                return 0;
            }
          } catch (error) {
            console.error(" Error sorting:", error);
            return 0;
          }
        });
      }

      function resetFilters() {
        const categoryFilter = document.getElementById("category-filter");
        const matchTypeFilter = document.getElementById("match-type-filter");
        const sortFilter = document.getElementById("sort-by-filter");

        if (categoryFilter) categoryFilter.value = "all";
        if (matchTypeFilter) matchTypeFilter.value = "all";
        if (sortFilter) sortFilter.value = "relevance";

        // Clear filters and show all original recommendations
        window.currentFilters = null;
        window.filteredRecommendations = null;

        // Reset to page 1 with original recommendations
        window.currentPage = 1;
        showPage(1);

        // Update results count
        updateResultsCount(window.allRecommendations.length);
        // updateFilterDescription();

        console.log(" Filters reset to show all products");
      }

      // Remove the old sorting functions since we're now sorting at the data level
      function sortProductsInSection() {
        console.warn(
          " sortProductsInSection() is deprecated - use sortAllProducts instead"
        );
      }
      // Update the original sortProducts to use the new section-based approach
      function sortProducts(products, sortBy) {
        // This is now handled by sortProductsInSection for each section
        console.warn(
          " sortProducts() is deprecated - use section-based sorting instead"
        );
      }

      function compareRelevance(a, b) {
        // Get the actual product data from our stored data
        const productIdA = a.getAttribute("data-product-id");
        const productIdB = b.getAttribute("data-product-id");

        const productA = window.productData[productIdA];
        const productB = window.productData[productIdB];

        if (!productA || !productB) {
          console.warn(" Missing product data for sorting, using fallback");
          return compareRelevanceFallback(a, b);
        }

        // 1. PRIMARY: Use Composite_Score from Python (most important!)
        // This already considers match quality, ratings, category priority, etc.
        const scoreA = productA.Composite_Score || 0;
        const scoreB = productB.Composite_Score || 0;

        if (scoreB !== scoreA) {
          return scoreB - scoreA; // Higher scores first
        }

        // 2. SECONDARY: Use Predicted_Score from ML model
        const predictedA = productA.Predicted_Score || 0;
        const predictedB = productB.Predicted_Score || 0;

        if (predictedB !== predictedA) {
          return predictedB - predictedA;
        }

        // 3. TERTIARY: Use Initial_Fit_Score (attribute matching)
        const fitA = productA.Initial_Fit_Score || 0;
        const fitB = productB.Initial_Fit_Score || 0;

        if (fitB !== fitA) {
          return fitB - fitA;
        }

        // 4. FINAL: Use actual ratings as tiebreaker
        const ratingA = productA.final_rating || productA.user_rating || 0;
        const ratingB = productB.final_rating || productB.user_rating || 0;

        return ratingB - ratingA;
      }

      // Fallback function if product data is missing
      function compareRelevanceFallback(a, b) {
        const matchPriority = {
          "PERFECT MATCH": 5,
          "CLOSE MATCH": 4,
          "NORMAL MATCH": 3,
          "LOW RATING MATCH": 2,
          "FALLBACK MATCH": 1,
        };

        const ratingPriority = {
          " TOP RATED": 6,
          "HIGHLY RATED": 5,
          "WELL RATED": 4,
          "GOOD RATING": 3,
          "AVERAGE RATING": 2,
          "LOW RATING": 1,
          " UNRATED": 0,
        };

        const matchBadgeA =
          a.querySelector(".match-badge")?.textContent.trim() || "";
        const matchBadgeB =
          b.querySelector(".match-badge")?.textContent.trim() || "";

        const ratingBadgeA =
          a.querySelector(".rating-badge")?.textContent.trim() || "";
        const ratingBadgeB =
          b.querySelector(".rating-badge")?.textContent.trim() || "";

        const matchScoreA = matchPriority[matchBadgeA] || 0;
        const matchScoreB = matchPriority[matchBadgeB] || 0;

        const ratingScoreA = ratingPriority[ratingBadgeA] || 0;
        const ratingScoreB = ratingPriority[ratingBadgeB] || 0;

        if (matchScoreB !== matchScoreA) {
          return matchScoreB - matchScoreA;
        }

        return ratingScoreB - ratingScoreA;
      }

      function comparePrice(a, b, ascending = true) {
        const priceTextA =
          a.querySelector(".product-price")?.textContent || "0";
        const priceTextB =
          b.querySelector(".product-price")?.textContent || "0";

        const priceA = parseFloat(priceTextA.replace("", "")) || 0;
        const priceB = parseFloat(priceTextB.replace("", "")) || 0;

        return ascending ? priceA - priceB : priceB - priceA;
      }

      function compareRating(a, b) {
        // Get rating from the rating-text element
        const ratingTextA = a.querySelector(".rating-text")?.textContent || "0";
        const ratingTextB = b.querySelector(".rating-text")?.textContent || "0";

        console.log(" Comparing ratings:", {
          productA: ratingTextA,
          productB: ratingTextB,
        });

        // Handle "No ratings yet" text
        const ratingA =
          ratingTextA === "No ratings yet" ? 0 : parseFloat(ratingTextA) || 0;
        const ratingB =
          ratingTextB === "No ratings yet" ? 0 : parseFloat(ratingTextB) || 0;

        console.log("Parsed ratings:", { ratingA, ratingB });

        // Sort highest to lowest
        return ratingB - ratingA;
      }
      function compareMatches(a, b) {
        // Get matches from attribute-text element
        const matchesTextA =
          a.querySelector(".attribute-text")?.textContent || "0/5";
        const matchesTextB =
          b.querySelector(".attribute-text")?.textContent || "0/5";

        console.log("Comparing matches:", {
          productA: matchesTextA,
          productB: matchesTextB,
        });

        const matchesA = parseInt(matchesTextA.split("/")[0]) || 0;
        const matchesB = parseInt(matchesTextB.split("/")[0]) || 0;

        console.log("Parsed matches:", { matchesA, matchesB });

        // Sort highest to lowest
        return matchesB - matchesA;
      }

      function updateResultsCount(count) {
        const countElement = document.getElementById("results-count");
        if (countElement) {
          countElement.textContent = `${count} products found`;
        }
      }

      // Keep your existing helper functions
      function countMatches(attributeMatches) {
        let count = 0;

        // Count main attributes
        if (attributeMatches.skin_type?.match) count++;
        if (attributeMatches.skin_tone?.match) count++;
        if (attributeMatches.undertone?.match) count++;
        if (attributeMatches.finish?.match) count++;

        // FIXED: Count Skin Concerns as ONE attribute (not individual concerns)
        if (attributeMatches.concerns) {
          // If user has no concerns and product matches "Any"
          if (attributeMatches.concerns["No Concerns"]?.match) {
            count++;
          }
          // If user has concerns, check if product addresses AT LEAST ONE concern
          else if (
            Object.values(attributeMatches.concerns).some(
              (concern) => concern.match
            )
          ) {
            count++;
          }
        }

        return count;
      }

      // SILENT image error handler - no console logs
      function handleImageError(img) {
        // Don't log anything to avoid spam
        img.src = "/admin/uploads/product_images/no-image.png";
        img.onerror = null; // Prevent infinite loop
      }

      function getMatchBadgeClass(matchType) {
        const matchClasses = {
          "PERFECT MATCH": "perfect-match",
          "CLOSE MATCH": "close-match",
          "NORMAL MATCH": "normal-match",
          "LOW RATING MATCH": "low-match",
          "FALLBACK MATCH": "fallback-match",
        };
        return matchClasses[matchType] || "normal-match";
      }

      function getRatingBadgeClass(ratingQuality) {
        const ratingClasses = {
          " TOP RATED": "top-rated",
          "HIGHLY RATED": "highly-rated",
          "WELL RATED": "well-rated",
          "GOOD RATING": "good-rating",
          "AVERAGE RATING": "average-rating",
          "LOW RATING": "low-rating",
          " UNRATED": "unrated",
        };
        return ratingClasses[ratingQuality] || "unrated";
      }

      // Add to cart function for recommended products
      async function addRecommendedToCart(productId) {
        try {
          const response = await fetch("../php/cart.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `action=add&product_id=${encodeURIComponent(
              productId
            )}&quantity=1`,
          });

          const result = await response.json();

          if (result.success) {
            // Update cart count
            updateCartCount(result.cartCount);

            // Show success notification
            showNotification("Product added to cart! ");

            // Visual feedback on the button
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i> Added!';
            button.style.background = "var(--success-color)";

            setTimeout(() => {
              button.innerHTML = originalText;
              button.style.background = "";
            }, 2000);
          } else {
            showNotification(
              result.message || "Failed to add to cart",
              "error"
            );
          }
        } catch (error) {
          console.error("Error adding to cart:", error);
          showNotification("Error adding to cart. Please try again.", "error");
        }
      }

      function viewProductDetails(productId) {
        window.location.href = `productdetail.html?productId=${productId}`;
      }
      function viewProductDetails(productId) {
        window.location.href = `productdetail.html?productId=${productId}`;
      }

      async function saveUserPreferences() {
        try {
          const response = await fetch("../php/save-user-preferences.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              skinType: quizData.skinType,
              skinTone: quizData.skinTone,
              undertone: quizData.undertone,
              concerns: quizData.concerns,
              finish: quizData.finish,
            }),
          });

          const text = await response.text();

          let data;
          try {
            data = JSON.parse(text);
          } catch (parseError) {
            console.error(" JSON parse error in save:", parseError);
            return false;
          }

          if (data.success) {
            // Update the global preferences state
            hasExistingPreferences = true;
            currentPreferences = {
              skin_type: quizData.skinType,
              skin_tone: quizData.skinTone,
              undertone: quizData.undertone,
              skin_concerns: JSON.stringify(quizData.concerns),
              preferred_finish: quizData.finish,
              updated_at: new Date().toISOString(),
            };
            console.log(" Preferences updated globally");
          }

          return data.success;
        } catch (error) {
          console.error(" Error saving preferences:", error);
          return false;
        }
      }

      // recommender.js
      let currentStep = 0;
      let quizData = {
        skinType: "",
        skinTone: "",
        undertone: "",
        concerns: [],
        finish: "",
      };

      function nextStep(step) {
        document
          .querySelectorAll(".quiz-step")
          .forEach((step) => step.classList.remove("active"));

        if (step === 0) {
          document.getElementById("step-intro").classList.add("active");
        } else {
          document.getElementById(`step-${step}`).classList.add("active");
        }
        currentStep = step;

        // Update progress bar based on current step
        updateProgressBar();
      }

      function prevStep() {
        if (currentStep > 1) {
          nextStep(currentStep - 1);
        } else {
          // Go back to intro when on step 1
          nextStep(0);
        }
      }

      function updateProgressBar() {
        const progressFill = document.querySelector(".progress-fill");
        if (!progressFill) return;

        const progressPercentages = {
          0: 0, // Intro
          1: 20, // Step 1
          2: 40, // Step 2
          3: 60, // Step 3
          4: 80, // Step 4
          5: 100, // Step 5
        };

        progressFill.style.width = `${progressPercentages[currentStep] || 0}%`;
      }

      function restartQuiz() {
        // Check if user has existing preferences
        if (hasExistingPreferences) {
          // Show the existing preferences modal instead of immediately restarting
          showExistingPrefsModal();
        } else {
          // If no existing preferences, restart normally
          resetQuizAndRestart();
        }
      }

      // New function to handle the actual quiz reset
      function resetQuizAndRestart() {
        quizData = {
          skinType: "",
          skinTone: "",
          undertone: "",
          concerns: [],
          finish: "",
        };

        // Reset all selections visually
        document.querySelectorAll(".option-card").forEach((card) => {
          card.classList.remove("selected");
        });

        document.querySelectorAll(".tone-option").forEach((option) => {
          option.classList.remove("selected");
        });

        document.querySelectorAll(".concern-checkbox").forEach((checkbox) => {
          checkbox.checked = false;
        });

        // Reset next buttons
        document.querySelectorAll(".nav-btn.primary").forEach((btn) => {
          btn.disabled = true;
        });

        nextStep(1);
      }

      // Option selection
      document.addEventListener("DOMContentLoaded", function () {
        // Single selection options
        document.querySelectorAll(".option-card").forEach((card) => {
          card.addEventListener("click", function () {
            const step = this.closest(".quiz-step").id.replace("step-", "");
            const value = this.getAttribute("data-value");

            // Clear other selections in this step
            this.closest(".options-grid")
              .querySelectorAll(".option-card")
              .forEach((c) => {
                c.classList.remove("selected");
              });

            // Select this card
            this.classList.add("selected");

            // Update data
            if (step === "1") quizData.skinType = value;
            if (step === "2") quizData.skinTone = value;
            if (step === "3") quizData.undertone = value;
            if (step === "5") quizData.finish = value;

            // Enable next button
            const nextBtn = document.getElementById(`step${step}-next`);
            if (nextBtn) nextBtn.disabled = false;
          });
        });

        // Skin tone selection
        document.querySelectorAll(".tone-option").forEach((option) => {
          option.addEventListener("click", function () {
            document.querySelectorAll(".tone-option").forEach((o) => {
              o.classList.remove("selected");
            });
            this.classList.add("selected");
            quizData.skinTone = this.getAttribute("data-value");
            document.getElementById("step2-next").disabled = false;
          });
        });

        // Concerns selection (multiple)
        document.querySelectorAll(".concern-checkbox").forEach((checkbox) => {
          checkbox.addEventListener("change", function () {
            const value =
              this.closest(".concern-option").getAttribute("data-value");

            if (value === "none") {
              // If "none" is selected, uncheck all others
              if (this.checked) {
                document.querySelectorAll(".concern-checkbox").forEach((cb) => {
                  if (cb !== this) cb.checked = false;
                });
                quizData.concerns = ["none"];
              } else {
                quizData.concerns = [];
              }
            } else {
              // If other concern is selected, uncheck "none"
              if (this.checked) {
                const noneCheckbox = document.querySelector(
                  '[data-value="none"] .concern-checkbox'
                );
                noneCheckbox.checked = false;
                quizData.concerns = quizData.concerns.filter(
                  (c) => c !== "none"
                );
                quizData.concerns.push(value);
              } else {
                quizData.concerns = quizData.concerns.filter(
                  (c) => c !== value
                );
              }
            }

            // Enable next button if at least one concern is selected
            document.getElementById("step4-next").disabled =
              quizData.concerns.length === 0;
          });
        });
      });

      // Exit confirmation
      function showExitModal() {
        document.getElementById("exit-modal").classList.add("active");
      }

      function closeExitModal() {
        document.getElementById("exit-modal").classList.remove("active");
      }

      function confirmExit() {
        window.location.href = "home.html";
      }

      // Navigation exit handlers
      document
        .querySelectorAll('.nav-item:not([data-page="recommender"])')
        .forEach((item) => {
          item.addEventListener("click", function (e) {
            if (currentStep > 0 && currentStep < 6) {
              e.preventDefault();
              showExitModal();
            }
          });
        });

      function showLoading() {
        nextStep("loading");

        // Simulate loading messages
        const messages = document.querySelectorAll(".loading-message");
        let currentMessage = 0;

        const messageInterval = setInterval(() => {
          messages.forEach((msg) => msg.classList.remove("active"));
          if (currentMessage < messages.length) {
            messages[currentMessage].classList.add("active");
            currentMessage++;
          } else {
            clearInterval(messageInterval);
            // Show results after loading
            setTimeout(async () => {
              await showResults(); // Add await here
            }, 1000);
          }
        }, 1500);
      }

      function initFloatingProduct() {
        const productImages = [
          "/admin/uploads/product_images/blush-nobg.png",
          "/admin/uploads/product_images/concealer-nobg.png",
          "/admin/uploads/product_images/blush-nobg.png",
          "/admin/uploads/product_images/blush-nobg.png",
          "/admin/uploads/product_images/blush-nobg.png",
          "/admin/uploads/product_images/blush-nobg.png",
        ];

        const productImg = document.getElementById("floating-product-img");

        let currentIndex = 0;

        function changeProduct() {
          currentIndex = (currentIndex + 1) % productImages.length;
          const newImagePath = productImages[currentIndex];

          productImg.style.opacity = "0";

          setTimeout(() => {
            productImg.src = newImagePath;

            productImg.onload = function () {
              productImg.style.opacity = "1";
            };

            productImg.onerror = function () {
              console.error(" Failed to load image:", this.src);
              productImg.style.opacity = "1";
              // If one image fails, just continue with others
            };
          }, 300);
        }

        // Set first image
        productImg.src = productImages[0];
        productImg.style.transition = "opacity 0.5s ease";

        productImg.onload = function () {};

        productImg.onerror = function () {};

        // Change image every 3 seconds
        setInterval(changeProduct, 3000);
      }

      async function updateCartCount() {
        try {
          const response = await fetch("../php/get-cart-count.php");
          const data = await response.json();

          if (data.success) {
            const cartCounts = document.querySelectorAll(".nav-cart-count");
            cartCounts.forEach((count) => {
              count.textContent = data.count;
              if (data.count > 0) {
                count.classList.add("show"); // Use class instead of inline style
              } else {
                count.classList.remove("show");
              }
            });
          }
        } catch (error) {
          console.log("Cart count update failed, setting to 0");
          const cartCounts = document.querySelectorAll(".nav-cart-count");
          cartCounts.forEach((count) => {
            count.textContent = "0";
            count.classList.remove("show");
          });
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        console.log(" DOM loaded, initializing carousel...");
        initFloatingProduct();
        updateCartCount();
      });
      async function submitProductFeedback(productId, rating, productName) {
  try {
    // FIX 1: Convert rating to number properly - use parseFloat for 0.5
    const numericRating = parseFloat(rating);
    console.log("Submitting feedback:", {
      productId,
      rating: numericRating,
      productName,
    });

    const buttons = document.querySelectorAll(
      `.feedback-btn[data-product-id="${productId}"]`
    );

    // Show loading state
    buttons.forEach((btn) => {
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      btn.disabled = true;
    });

    const response = await fetch("../php/feedback.php", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: `action=save_product_feedback&product_id=${productId}&user_rating=${numericRating}&product_name=${encodeURIComponent(
        productName
      )}`,
    });

    // First check if response is ok
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    // Check if response is JSON
    const text = await response.text();
    console.log("Raw response:", text);

    let result;
    try {
      result = JSON.parse(text);
    } catch (e) {
      console.error("Failed to parse JSON. Response was:", text);
      throw new Error("Server returned invalid JSON response");
    }

    console.log("Parsed response:", result);

    if (result.success) {
      // Update button states for 3 buttons
      buttons.forEach((btn) => {
        btn.disabled = false;
        const btnRating = parseFloat(btn.getAttribute("data-feedback"));

        // Remove active class from all buttons first
        btn.classList.remove("active");

        // Add active class only to the clicked button
        if (btnRating === numericRating) {
          btn.classList.add("active");
        }

        // Set correct text for each button type - CONSISTENT "Good/Okay/Poor"
        if (btn.classList.contains("thumbs-up")) {
          btn.innerHTML = " Good";
        } else if (btn.classList.contains("thumbs-neutral")) {
          btn.innerHTML = " Okay";
        } else if (btn.classList.contains("thumbs-down")) {
          btn.innerHTML = " Poor";
        }
      });

      // FIX 2: Use data from PHP response, not undefined variable
      if (window.productData && window.productData[productId]) {
        window.productData[productId].user_feedback = {
          UserRating: result.user_rating, // From PHP response
          RecommendationFeedback: numericRating,
          CreatedAt: new Date().toISOString(),
        };
      }
    } else {
      throw new Error(result.message || "Unknown error from server");
    }
  } catch (error) {
    console.error("Feedback submission error:", error);

    // Only show error notification, not success
    if (typeof showNotification === "function") {
      showNotification(
        "Failed to save rating: " + error.message,
        "error"
      );
    } else {
      alert("Failed to save rating: " + error.message); // Fallback
    }

    // FIX 3: Reset buttons with CONSISTENT text "Good/Okay/Poor"
    const buttons = document.querySelectorAll(
      `.feedback-btn[data-product-id="${productId}"]`
    );
    buttons.forEach((btn) => {
      btn.disabled = false;
      // Use consistent text for all buttons
      if (btn.classList.contains("thumbs-up")) {
        btn.innerHTML = " Good";
      } else if (btn.classList.contains("thumbs-neutral")) {
        btn.innerHTML = " Okay";
      } else if (btn.classList.contains("thumbs-down")) {
        btn.innerHTML = " Poor";
      }
    });
  }
}
document.addEventListener("click", function (e) {
  const feedbackBtn = e.target.closest(".feedback-btn");
  if (feedbackBtn) {
    e.preventDefault();
    e.stopPropagation();

    const productId = feedbackBtn.getAttribute("data-product-id");
    const rating = parseFloat(feedbackBtn.getAttribute("data-feedback")); // Use parseFloat for 0.5
    const productData = window.productData && window.productData[productId];

    if (productData) {
      submitProductFeedback(productId, rating, productData.Name);
    } else {
      console.error("Product data not found for ID:", productId);
    }
  }
});

// FIX 4: Remove or update the old resetFeedbackButtons function since it uses old logic
// This function is causing the text inconsistency - either remove it or update it:
function resetFeedbackButtons(productId) {
  const buttons = document.querySelectorAll(
    `.feedback-btn[data-product-id="${productId}"]`
  );
  const product = window.productData && window.productData[productId];
  const existingFeedback = product && product.user_feedback;

  buttons.forEach((btn) => {
    btn.disabled = false;
    btn.classList.remove("active");

    if (existingFeedback) {
      const currentRating = existingFeedback.RecommendationFeedback;
      
      // Set active state based on actual rating
      if (parseFloat(btn.getAttribute("data-feedback")) === currentRating) {
        btn.classList.add("active");
      }
      
      // Set consistent text
      if (btn.classList.contains("thumbs-up")) {
        btn.innerHTML = " Good";
      } else if (btn.classList.contains("thumbs-neutral")) {
        btn.innerHTML = " Okay";
      } else if (btn.classList.contains("thumbs-down")) {
        btn.innerHTML = " Poor";
      }
    } else {
      // Default text
      if (btn.classList.contains("thumbs-up")) {
        btn.innerHTML = " Good";
      } else if (btn.classList.contains("thumbs-neutral")) {
        btn.innerHTML = " Okay";
      } else if (btn.classList.contains("thumbs-down")) {
        btn.innerHTML = " Poor";
      }
    }
  });
}

      // Add event listeners for external floating card - NO BACKDROP
      document.addEventListener("DOMContentLoaded", function () {
        let externalCard = document.getElementById("external-attribute-card");
        if (!externalCard) {
          externalCard = document.createElement("div");
          externalCard.id = "external-attribute-card";
          document.body.appendChild(externalCard);
        }

        let currentProductId = null;
        let isCardOpen = false;

        // Close card when clicking outside
        document.addEventListener("click", function (e) {
          if (
            !e.target.closest(".attribute-header") &&
            !e.target.closest("#external-attribute-card")
          ) {
            closeCard();
          }
        });

        // Close card on escape key
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") {
            closeCard();
          }
        });

        // Show card on click
        document.addEventListener("click", function (e) {
          const attributeHeader = e.target.closest(".attribute-header");
          if (attributeHeader) {
            e.stopPropagation();

            const attributeSummary =
              attributeHeader.closest(".attribute-summary");
            const productId = attributeSummary.getAttribute("data-product-id");

            if (productId === currentProductId && isCardOpen) {
              closeCard();
            } else {
              openCard(productId, attributeSummary);
            }
          }
        });

        // HIDE CARD WHEN SCROLLING
        window.addEventListener("scroll", function () {
          if (isCardOpen) {
            closeCard();
          }
        });

        function openCard(productId, attributeSummary) {
          currentProductId = productId;
          const productData =
            window.productData && window.productData[productId];
          if (productData && productData.Attribute_Matches) {
            externalCard.innerHTML = createExternalFloatingCard(
              productData.Attribute_Matches,
              productData
            );
            positionExternalCard(externalCard, attributeSummary);
            externalCard.style.display = "block";
            isCardOpen = true;
          }
        }

        function closeCard() {
          externalCard.style.display = "none";
          currentProductId = null;
          isCardOpen = false;
        }
      });

      // Position external card ABOVE the attribute header
      function positionExternalCard(card, attributeSummary) {
        const rect = attributeSummary.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const cardWidth = 280;
        const cardHeight = card.offsetHeight;

        // For mobile, center the card
        if (window.innerWidth <= 768) {
          card.style.left = "50%";
          card.style.top = "50%";
          card.style.transform = "translate(-50%, -50%)";
          return;
        }

        // For desktop: Position ABOVE the attribute header
        let left = rect.left + (rect.width - cardWidth) / 2;
        let top = rect.top - cardHeight - 8;

        // Adjust if going off left edge
        if (left < 10) {
          left = 10;
        }

        // Adjust if going off right edge
        if (left + cardWidth > viewportWidth - 10) {
          left = viewportWidth - cardWidth - 10;
        }

        // Adjust if going off top edge - show below instead
        if (top < 10) {
          top = rect.bottom + 8;
        }

        // Adjust if going off bottom edge when showing below
        if (top + cardHeight > viewportHeight - 10) {
          top = viewportHeight - cardHeight - 10;
        }

        card.style.left = left + "px";
        card.style.top = top + "px";
        card.style.transform = "none";
      }
    </script>
  </body>
</html>
