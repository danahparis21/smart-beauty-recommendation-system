<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Recommender | Blessence</title>
    <link rel="icon" href="../../admin/images/mainlogo1.png" type="image/png" />
    <link rel="stylesheet" href="../styles/styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <!-- Add this BEFORE your page-specific scripts -->
    <script src="../js/user-session.js"></script>
    <script src="../js/notifications.js"></script>
    <script src="../js/user-profile-picture.js"></script>
    <script src="../js/load-profile-notification.js"></script>

    <style>
      /* ===== CRITICAL: QUIZ STEP MANAGEMENT ===== */
      .quiz-step {
        display: none !important;
      }

      .quiz-step.active {
        display: block !important;
      }

      /* Ensure floating product only appears in intro step */
      #step-intro .floating-product {
        display: flex !important;
      }

      #step-1 .floating-product,
      #step-2 .floating-product,
      #step-3 .floating-product,
      #step-4 .floating-product,
      #step-5 .floating-product,
      #step-results .floating-product {
        display: none !important;
      }

      /* ===== NAVIGATION STYLES ===== */
      .nav-item {
        position: relative;
      }

      .nav-cart-count {
        position: absolute;
        top: -5px;
        right: -5px;
        background: var(--primary-pink);
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
      }
      .nav-cart-count.show {
        display: flex;
        animation: bounce 0.3s ease;
      }

      @keyframes bounce {
        0% {
          transform: scale(0.5);
        }
        50% {
          transform: scale(1.2);
        }
        100% {
          transform: scale(1);
        }
      }

      /* ===== MAIN QUIZ CONTAINER ===== */
      .recommender-main {
        padding: 40px 20px;
        max-width: 1000px; /* Increased from 800px */
        margin: 0 auto;
        min-height: calc(100vh - 200px);
      }

      .quiz-container {
        background: var(--gradient-card);
        border-radius: 24px; /* Slightly larger radius */
        box-shadow: var(--card-shadow);
        border: 1px solid rgba(255, 182, 193, 0.2);
        overflow: hidden;
        max-width: 100%; /* Allow it to use full available space */
      }

      .quiz-step {
        padding: 50px 40px; /* Increased padding for more spacious feel */
      }

      /* ===== QUIZ INTRO STEP ===== */
      .quiz-hero {
        text-align: center;
        padding: 40px 20px;
      }

      .hero-icon {
        width: 100px;
        height: 100px;
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 30px;
        color: white;
        font-size: 40px;
        box-shadow: 0 10px 30px rgba(255, 105, 180, 0.3);
      }

      .quiz-hero h1 {
        font-size: 2.5rem;
        color: var(--dark-gray);
        margin-bottom: 20px;
        font-family: "Cormorant Garamond", serif;
      }

      .quiz-hero p {
        font-size: 1.1rem;
        color: var(--text-gray);
        margin-bottom: 40px;
        line-height: 1.6;
      }

      .quiz-start-btn {
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        color: white;
        border: none;
        border-radius: 25px;
        padding: 15px 40px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 5px 15px rgba(255, 105, 180, 0.3);
      }

      .quiz-start-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(255, 105, 180, 0.4);
      }

      /* ===== FLOATING PRODUCT STYLES ===== */
      .floating-product {
        margin: 50px 0;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
      }

      .floating-product .product-image {
        width: 250px !important;
        height: 250px !important;
        object-fit: contain !important;
        position: relative !important;
        z-index: 10 !important;
        filter: drop-shadow(0 15px 30px rgba(255, 105, 180, 0.4))
          drop-shadow(0 5px 15px rgba(255, 20, 147, 0.3)) !important;
        animation: float 3s ease-in-out infinite !important;
        background: transparent !important;
        border: none !important;
        border-radius: 0 !important;
        padding: 0 !important;
        margin: 0 auto !important;
      }

      .floating-product::before {
        content: "";
        position: absolute;
        width: 260px;
        height: 260px;
        background: radial-gradient(
          circle at center,
          rgba(255, 182, 193, 0.25) 0%,
          rgba(255, 105, 180, 0.15) 40%,
          rgba(255, 20, 147, 0.08) 70%,
          transparent 85%
        );
        border-radius: 50%;
        filter: blur(20px);
        z-index: 1;
        animation: glow 4s ease-in-out infinite;
        opacity: 0.5;
      }

      .floating-product::after {
        content: "";
        position: absolute;
        width: 300px;
        height: 300px;
        background: radial-gradient(
          circle at center,
          rgba(255, 182, 193, 0.15) 0%,
          rgba(255, 105, 180, 0.08) 25%,
          rgba(255, 20, 147, 0.05) 50%,
          transparent 70%
        );
        border-radius: 50%;
        z-index: 0;
        animation: pulse 8s ease-in-out infinite;
        opacity: 0.3;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px) scale(1) rotate(0deg);
        }
        33% {
          transform: translateY(-15px) scale(1.08) rotate(2deg);
        }
        66% {
          transform: translateY(-8px) scale(1.04) rotate(-1deg);
        }
      }

      @keyframes glow {
        0%,
        100% {
          opacity: 0.4;
          transform: scale(1) rotate(0deg);
        }
        50% {
          opacity: 0.6;
          transform: scale(1.05) rotate(3deg);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 0.2;
          transform: scale(1);
        }
        50% {
          opacity: 0.4;
          transform: scale(1.03);
        }
      }

      /* ===== QUIZ HEADER & PROGRESS ===== */
      .quiz-header {
        text-align: center;
        margin-bottom: 40px;
      }

      .progress-bar {
        width: 100%;
        height: 6px;
        background: var(--light-gray);
        border-radius: 3px;
        margin-bottom: 30px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(
          to right,
          var(--primary-pink),
          var(--dark-pink)
        );
        border-radius: 3px;
        transition: width 0.3s ease;
      }

      .quiz-header h2 {
        font-size: 2rem;
        color: var(--dark-gray);
        margin-bottom: 10px;
        font-family: "Cormorant Garamond", serif;
      }

      .quiz-header p {
        color: var(--text-gray);
        font-size: 1rem;
      }

      /* ===== QUIZ OPTIONS ===== */
      .options-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }

      .option-card {
        background: white;
        border: 2px solid var(--light-gray);
        border-radius: 15px;
        padding: 25px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .option-card:hover {
        transform: translateY(-5px);
        border-color: var(--primary-pink);
        box-shadow: 0 10px 25px rgba(255, 105, 180, 0.1);
      }

      .option-card.selected {
        border-color: var(--primary-pink);
        background: linear-gradient(135deg, #fff5f9, #ffe6f2);
        box-shadow: 0 5px 15px rgba(255, 105, 180, 0.2);
      }

      .option-icon {
        width: 60px;
        height: 60px;
        background: var(--light-gray);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        color: var(--primary-pink);
        font-size: 24px;
        transition: all 0.3s ease;
      }

      .option-card.selected .option-icon {
        background: var(--primary-pink);
        color: white;
      }

      .option-card h3 {
        font-size: 1.2rem;
        color: var(--dark-gray);
        margin-bottom: 8px;
      }

      .option-card p {
        font-size: 0.9rem;
        color: var(--text-gray);
        line-height: 1.4;
      }

      /* ===== SKIN TONE OPTIONS ===== */
      .skin-tone-options {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 40px;
        flex-wrap: wrap;
      }

      .tone-option {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .tone-option:hover {
        transform: scale(1.05);
      }

      .tone-option.selected .tone-swatch {
        transform: scale(1.1);
        box-shadow: 0 0 0 3px var(--primary-pink);
      }

      .tone-swatch {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .tone-option span {
        font-size: 0.9rem;
        color: var(--dark-gray);
        font-weight: 500;
      }

      /* ===== CONCERNS GRID ===== */
      .concerns-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 40px;
      }

      .concern-option {
        position: relative;
      }

      .concern-checkbox {
        display: none;
      }

      .concern-label {
        display: block;
        background: white;
        border: 2px solid var(--light-gray);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .concern-checkbox:checked + .concern-label {
        border-color: var(--primary-pink);
        background: linear-gradient(135deg, #fff5f9, #ffe6f2);
        box-shadow: 0 5px 15px rgba(255, 105, 180, 0.2);
      }

      .concern-label:hover {
        transform: translateY(-3px);
        border-color: var(--primary-pink);
        box-shadow: 0 8px 20px rgba(255, 105, 180, 0.1);
      }

      .concern-icon {
        width: 50px;
        height: 50px;
        background: var(--light-gray);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 12px;
        color: var(--primary-pink);
        font-size: 20px;
        transition: all 0.3s ease;
      }

      .concern-checkbox:checked + .concern-label .concern-icon {
        background: var(--primary-pink);
        color: white;
      }

      .concern-label h3 {
        font-size: 1.1rem;
        color: var(--dark-gray);
        margin-bottom: 5px;
      }

      .concern-label p {
        font-size: 0.8rem;
        color: var(--text-gray);
        line-height: 1.3;
      }

      /* ===== QUIZ NAVIGATION ===== */
      .quiz-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 40px;
      }

      .nav-btn {
        padding: 12px 25px;
        border: none;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .nav-btn.primary {
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        color: white;
        box-shadow: 0 4px 15px rgba(255, 105, 180, 0.3);
      }

      .nav-btn.primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 105, 180, 0.4);
      }

      .nav-btn.primary:disabled {
        background: var(--medium-gray);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .nav-btn.secondary {
        background: transparent;
        color: var(--text-gray);
        border: 2px solid var(--medium-gray);
      }

      .nav-btn.secondary:hover {
        border-color: var(--primary-pink);
        color: var(--primary-pink);
      }

      /* ===== LOADING STEP ===== */
      .loading-container {
        text-align: center;
        padding: 60px 20px;
      }

      .loading-spinner {
        font-size: 4rem;
        color: var(--primary-pink);
        margin-bottom: 30px;
      }

      .loading-container h2 {
        font-size: 2.2rem;
        color: var(--dark-gray);
        margin-bottom: 40px;
        font-family: "Cormorant Garamond", serif;
      }

      .loading-messages {
        display: flex;
        flex-direction: column;
        gap: 20px;
        max-width: 400px;
        margin: 0 auto;
      }

      .loading-message {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px 20px;
        background: white;
        border-radius: 12px;
        border: 2px solid var(--light-gray);
        transition: all 0.3s ease;
        opacity: 0.5;
      }

      .loading-message.active {
        border-color: var(--primary-pink);
        background: linear-gradient(135deg, #fff5f9, #ffe6f2);
        opacity: 1;
        transform: translateX(10px);
      }

      .loading-message i {
        color: var(--primary-pink);
        font-size: 1.2rem;
      }

      .loading-message span {
        color: var(--dark-gray);
        font-weight: 500;
      }

      /* ===== RESULTS STEP ===== */
      #step-results.quiz-step {
        max-width: none !important;
        padding: 40px 20px !important;
      }

      #step-results .quiz-header {
        text-align: center;
        margin-bottom: 30px;
      }

      #step-results .quiz-header h2 {
        font-size: 2.2rem;
        color: var(--dark-gray);
        margin-bottom: 10px;
        font-family: "Cormorant Garamond", serif;
      }

      #step-results .quiz-header p {
        color: var(--text-gray);
        font-size: 1.1rem;
        max-width: 600px;
        margin: 0 auto;
      }

      /* ===== RECOMMENDATIONS GRID ===== */
      .recommendations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 25px;
        margin: 30px auto;
        max-width: 1400px;
        padding: 0 10px;
      }

      .recommendations-grid .product-card {
        background: white;
        border-radius: 16px;
        padding: 0;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        position: relative;
        transition: all 0.3s ease;
        overflow: hidden;
        border: 1px solid #f8f8f8;
        /* Flexible but constrained height */
        height: auto;
        display: flex;
        flex-direction: column;
        height: 500px;
      }
      .recommendations-grid .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
      }

      .recommendations-grid .product-image-container {
        width: 100%;
        height: 200px;
        overflow: hidden;
        position: relative;
        background: #fafafa;
      }

      .recommendations-grid .product-image {
        width: 100% !important;
        height: 100% !important;
        object-fit: cover !important;
        border-radius: 0 !important;
        margin-bottom: 0 !important;
        filter: none !important;
        animation: none !important;
        background: white !important;
        border: none !important;
        transition: transform 0.3s ease !important;
      }

      .recommendations-grid .product-card:hover .product-image {
        transform: scale(1.05) !important;
      }

      .recommendations-grid .product-info {
        padding: 15px;
        display: flex;
        flex-direction: column;
        flex: 1; /* Take up all available space */
      }

      .recommendations-grid .product-name {
        font-size: 1.1em;
        font-weight: 600;
        margin: 0 0 8px 0;
        color: #2d3748;
        line-height: 1.3;
        /* Remove fixed height and use flexible approach */
        min-height: 2.6em;
        max-height: 3.9em; /* Allow up to 3 lines if needed */
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 3; /* Allow 3 lines instead of 2 */
        -webkit-box-orient: vertical;
        flex-shrink: 0; /* Don't shrink the name */
      }
      .recommendations-grid .product-category {
        color: #718096;
        font-size: 0.8em;
        margin: 0 0 8px 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
      }

      .recommendations-grid .product-price {
        font-weight: bold;
        color: var(--primary-pink);
        font-size: 1.2em;
        margin: 0 0 12px 0;
      }

      .recommendations-grid .match-info {
        margin: 12px 0;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .recommendations-grid .match-score {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
        font-size: 0.85em;
      }

      .recommendations-grid .match-score .score {
        font-weight: bold;
        color: var(--primary-pink);
        font-size: 1em;
      }

      .recommendations-grid .match-bar {
        width: 100%;
        height: 6px;
        background: #e2e8f0;
        border-radius: 3px;
        overflow: hidden;
      }

      .recommendations-grid .match-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-pink), #ff6b6b);
        border-radius: 3px;
        transition: width 1s ease;
      }

      .recommendations-grid .product-actions {
        display: flex;
        gap: 8px;
        margin-top: auto; /* This pushes it to the bottom! */
        padding-top: 10px; /* Add some spacing from content above */
      }
      .recommendations-grid .btn-primary,
      .recommendations-grid .btn-secondary {
        flex: 1;
        padding: 10px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85em;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
      }

      .recommendations-grid .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        color: white;
        box-shadow: 0 2px 8px rgba(255, 105, 180, 0.3);
      }

      .recommendations-grid .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 105, 180, 0.4);
      }

      .recommendations-grid .btn-secondary {
        background: white;
        color: #4a5568;
        border: 1px solid #e2e8f0;
        font-size: 0.8em;
      }

      .recommendations-grid .btn-secondary:hover {
        background: #f7fafc;
        border-color: var(--primary-pink);
        color: var(--primary-pink);
        transform: translateY(-2px);
      }

      /* ===== MATCH BADGES ===== */
      .recommendations-grid .match-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.7em;
        font-weight: 700;
        color: white;
        z-index: 20;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      /* ===== MATCH BADGES ===== */
      .recommendations-grid .match-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.7em;
        font-weight: 700;
        color: white;
        z-index: 20;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      /* ===== RATING BADGES ===== */
      .recommendations-grid .rating-badge {
        position: absolute;
        top: 35px; /* Position below match badge */
        right: 10px;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.7em;
        font-weight: 700;
        color: white;
        z-index: 20;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      @media (max-width: 768px) {
        .recommendations-grid .match-badge,
        .recommendations-grid .rating-badge {
          padding: 3px 6px;
          font-size: 0.5em;
        }

        .recommendations-grid .match-badge {
          top: 8px;
          right: 8px;
        }

        .recommendations-grid .rating-badge {
          top: 25px; /* Adjusted for mobile */
          right: 8px;
        }
      }

      /* Match Quality Badge Styles */
      .perfect-match {
        background: linear-gradient(135deg, #667eea, #764ba2);
        animation: glow-pulse 2s ease-in-out infinite;
      }

      .close-match {
        background: linear-gradient(135deg, #f093fb, #f5576c);
      }

      .normal-match {
        background: linear-gradient(135deg, #4facfe, #00f2fe);
      }

      .low-match {
        background: linear-gradient(135deg, #fda085, #f6d365);
      }

      .fallback-match {
        background: linear-gradient(135deg, #a8edea, #fed6e3);
        color: #2d3748;
      }

      /* Rating Quality Badge Styles */
      .top-rated {
        background: linear-gradient(135deg, #ff9a9e, #fecfef);
        animation: glow-pulse 2s ease-in-out infinite;
      }

      .highly-rated {
        background: linear-gradient(135deg, #a8edea, #fed6e3);
        color: #2d3748;
      }

      .well-rated {
        background: linear-gradient(135deg, #d4fc79, #96e6a1);
        color: #2d3748;
      }

      .good-rating {
        background: linear-gradient(135deg, #84fab0, #8fd3f4);
        color: #2d3748;
      }

      .average-rating {
        background: linear-gradient(135deg, #a3bded, #6991c7);
      }

      .low-rating {
        background: linear-gradient(135deg, #fad0c4, #ffd1ff);
        color: #2d3748;
      }

      .unrated {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        color: #6c757d !important; /* Darker gray for better contrast */
        border: 1px solid #dee2e6;
        font-weight: 600;
      }
      @keyframes glow-pulse {
        0%,
        100% {
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        50% {
          box-shadow: 0 4px 20px rgba(102, 126, 234, 0.8);
        }
      }

      /* Make sure product cards can accommodate two badges */
      .product-card {
        position: relative;
        padding-top: 50px; /* Extra space for badges */
      }

      @media (max-width: 768px) {
        .product-card {
          padding-top: 45px;
        }
      }

      /* ===== NO RESULTS STATE ===== */
      .no-results {
        text-align: center;
        padding: 40px 20px;
        color: #666;
      }

      .no-results i {
        font-size: 3em;
        color: #ddd;
        margin-bottom: 20px;
      }

      /* ===== RESPONSIVE DESIGN ===== */

      /* Very small mobile devices - under 360px */
      @media (max-width: 359px) {
        .recommendations-grid {
          grid-template-columns: 1fr;
          gap: 12px;
          padding: 0 5px;
        }
        .recommendations-grid .product-card {
          height: 380px; /* Even shorter for tiny screens */
        }

        .recommendations-grid .product-image-container {
          height: 150px;
        }

        .recommendations-grid .product-name {
          font-size: 0.85em;
        }
      }

      /* Small mobile devices - 360px to 399px */
      @media (min-width: 360px) and (max-width: 399px) {
        .recommendations-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 10px;
          padding: 0 5px;
        }

        .recommendations-grid .product-image-container {
          height: 140px;
        }
      }

      @media (min-width: 360px) and (max-width: 768px) {
        .recommender-main {
          padding: 20px 15px;
          min-height: calc(100vh - 150px);
        }

        .quiz-container {
          border-radius: 20px;
        }

        .quiz-step {
          padding: 30px 20px !important;
        }

        #step-results.quiz-step {
          padding: 30px 15px !important;
        }

        .recommendations-grid {
          grid-template-columns: repeat(2, 1fr); /* 2 columns */
          gap: 12px;
          padding: 0 1px;
          max-width: 100%;
        }

        .recommendations-grid .product-card {
          max-height: 420px;
          min-height: 350px;
        }

        .recommendations-grid .product-image-container {
          height: 120px; /* Adjust image height accordingly */
        }

        .recommendations-grid .product-info {
          padding: 12px 10px;
        }

        .recommendations-grid .product-name {
          font-size: 0.9em;
          height: 2.6em;
          line-height: 1.3;
          margin-bottom: 6px;
        }

        .recommendations-grid .product-category {
          font-size: 0.7em;
          margin-bottom: 6px;
        }

        .recommendations-grid .product-price {
          font-size: 1em;
          margin-bottom: 8px;
        }

        .recommendations-grid .match-info {
          padding: 6px;
          margin: 8px 0;
          font-size: 0.75em;
        }

        .recommendations-grid .match-score {
          font-size: 0.75em;
        }

        .recommendations-grid .match-bar {
          height: 4px;
        }

        .recommendations-grid .product-actions {
          flex-direction: column;
          gap: 5px;
        }

        .recommendations-grid .btn-primary,
        .recommendations-grid .btn-secondary {
          padding: 7px 8px;
          font-size: 0.75em;
          min-height: 32px;
        }

        .recommendations-grid .match-badge {
          padding: 2px 6px;
          font-size: 0.6em;
          top: 6px;
          right: 6px;
        }

        .attribute-header {
          padding: 8px 10px;
          font-size: 0.8em;
        }
      }

      @media (max-width: 380px) {
        .recommendations-grid .product-actions {
          flex-direction: column;
        }

        .recommendations-grid .btn-primary,
        .recommendations-grid .btn-secondary {
          width: 100%;
          text-align: center;
        }

        .recommendations-grid .attribute-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 3px;
        }
      }

      /* Tablet */
      @media (min-width: 769px) and (max-width: 1024px) {
        .recommendations-grid {
          grid-template-columns: repeat(3, 1fr);
          gap: 20px;
          padding: 0 20px;
        }

        .recommendations-grid .product-image-container {
          height: 180px;
        }
        .recommendations-grid .product-card {
          height: 460px; /* Slightly shorter than desktop */
        }
      }

      /* Desktop */
      @media (min-width: 1025px) {
        .recommendations-grid {
          grid-template-columns: repeat(4, 1fr);
          gap: 25px;
          padding: 0 30px;
          max-width: 1400px;
        }

        .recommendations-grid .product-image-container {
          height: 200px;
        }
      }

      /* Large Desktop */
      @media (min-width: 1440px) {
        .recommender-main {
          max-width: 1200px;
        }

        .recommendations-grid {
          grid-template-columns: repeat(4, 1fr);
          gap: 30px;
          max-width: 1600px;
        }

        .recommendations-grid .product-image-container {
          height: 220px;
        }
      }
      /* Hide all modals by default */
      #existing-prefs-modal,
      #current-prefs-modal,
      #add-to-cart-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
      }

      /* Show modals when active */
      #existing-prefs-modal.active,
      #current-prefs-modal.active,
      #add-to-cart-modal.active {
        display: flex;
      }

      /* Modal content styling */
      #existing-prefs-modal .modal-content,
      #current-prefs-modal .modal-content,
      #add-to-cart-modal .modal-content {
        background: white;
        border-radius: 20px;
        padding: 30px;
        text-align: center;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 182, 193, 0.2);
      }

      /* Success Modal Styles */
      #success-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
      }

      #success-modal.active {
        display: flex;
      }

      #success-modal .modal-content {
        background: white;
        border-radius: 20px;
        padding: 40px 30px;
        text-align: center;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 182, 193, 0.2);
      }

      .success-icon {
        font-size: 64px;
        color: #10b981;
        margin-bottom: 20px;
        animation: bounceIn 0.6s ease;
      }

      .success-title {
        font-size: 1.5em;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 10px;
      }

      .success-message {
        color: #6b7280;
        line-height: 1.5;
        margin-bottom: 25px;
      }

      .success-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
      }

      @keyframes bounceIn {
        0% {
          transform: scale(0.3);
          opacity: 0;
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      /* Modal buttons */
      .modal-buttons {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 20px;
      }
      .modal-btn {
        padding: 12px 20px;
        border: none;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .modal-btn.primary {
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        color: white;
        box-shadow: 0 4px 15px rgba(255, 105, 180, 0.3);
      }

      .modal-btn.secondary {
        background: var(--light-gray);
        color: var(--dark-gray);
        border: 2px solid var(--medium-gray);
      }

      .modal-btn.cancel-btn {
        background: transparent;
        color: var(--text-gray);
        border: 2px solid var(--medium-gray);
      }

      .modal-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .modal-btn.primary:hover {
        box-shadow: 0 6px 20px rgba(255, 105, 180, 0.4);
      }

      /* Modal headers */
      #existing-prefs-modal h3,
      #current-prefs-modal h3 {
        font-size: 1.5rem;
        color: var(--dark-gray);
        margin-bottom: 15px;
        font-family: "Cormorant Garamond", serif;
      }

      #existing-prefs-modal p,
      #current-prefs-modal p {
        color: var(--text-gray);
        margin-bottom: 25px;
        line-height: 1.5;
      }
      /* ===== MODAL STYLES ===== */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        backdrop-filter: blur(5px);
      }

      .modal-overlay.active {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .exit-modal {
        background: white;
        border-radius: 20px;
        padding: 30px;
        text-align: center;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 182, 193, 0.2);
      }

      .modal-icon {
        font-size: 3rem;
        color: var(--gold);
        margin-bottom: 20px;
      }

      .exit-modal h3 {
        font-size: 1.5rem;
        color: var(--dark-gray);
        margin-bottom: 10px;
        font-family: "Cormorant Garamond", serif;
      }

      .exit-modal p {
        color: var(--text-gray);
        margin-bottom: 25px;
      }

      .modal-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .modal-btn {
        padding: 12px 20px;
        border: none;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
      }

      .modal-btn.primary {
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        color: white;
      }

      .modal-btn.secondary {
        background: var(--light-gray);
        color: var(--dark-gray);
      }

      .modal-btn.tertiary {
        background: transparent;
        color: var(--text-gray);
        border: 2px solid var(--medium-gray);
      }

      .modal-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      /* ===== RESULTS HERO STYLES ===== */
      .results-hero {
        text-align: center;
        margin-bottom: 40px;
        padding: 2px 2px;
      }

      .results-hero i {
        font-size: 4rem;
        color: var(--primary-pink);
        margin-bottom: 20px;
        display: block;
      }

      .results-hero h2 {
        font-size: 2.2rem;
        color: var(--dark-gray);
        margin-bottom: 15px;
        font-family: "Cormorant Garamond", serif;
      }

      .results-hero p {
        font-size: 14px;
        color: var(--text-gray);
        line-height: 1.6;
        max-width: 600px;
        margin: 0 auto;
      }

      /* ===== RESULTS ACTIONS BUTTONS ===== */
      .results-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 40px;
      }

      .retake-btn,
      .shop-all-btn {
        padding: 12px 25px;
        border: none;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 1rem;
      }

      .retake-btn {
        background: transparent;
        color: var(--text-gray);
        border: 2px solid var(--medium-gray);
      }

      .retake-btn:hover {
        border-color: var(--primary-pink);
        color: var(--primary-pink);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 105, 180, 0.1);
      }

      .shop-all-btn {
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        color: white;
        box-shadow: 0 4px 15px rgba(255, 105, 180, 0.3);
      }

      .shop-all-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 105, 180, 0.4);
      }

      /* ===== RESULTS CONTAINER ===== */
      .results-container {
        text-align: center;
        padding: 20px 0;
      }

      /* ===== PREFERENCES MODALS ===== */
      #current-preferences-display {
        background: var(--light-gray);
        padding: 20px;
        border-radius: 12px;
        margin: 15px 0;
        text-align: left;
      }

      .preference-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--medium-gray);
      }

      .preference-item:last-child {
        margin-bottom: 0;
        border-bottom: none;
      }

      .preference-label {
        font-weight: 600;
        color: var(--dark-gray);
      }

      .preference-value {
        color: var(--primary-pink);
        text-transform: capitalize;
      }

      .concerns-list {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
      }

      .concern-tag {
        background: var(--primary-pink);
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        text-transform: capitalize;
      }

      /* ===== RESPONSIVE DESIGN FOR MISSING STYLES ===== */
      @media (max-width: 768px) {
        /* Modal Mobile */
        .exit-modal {
          padding: 25px 20px;
          margin: 20px;
          border-radius: 16px;
        }

        .modal-icon {
          font-size: 2.5rem;
          margin-bottom: 15px;
        }

        .exit-modal h3 {
          font-size: 1.3rem;
          margin-bottom: 8px;
        }

        .exit-modal p {
          font-size: 0.9rem;
          margin-bottom: 20px;
        }

        .modal-actions {
          gap: 8px;
        }

        .modal-btn {
          padding: 14px 20px;
          font-size: 1rem;
          border-radius: 20px;
        }

        /* Results Hero Mobile */
        .results-hero {
          padding: 30px 15px;
          margin-bottom: 15px;
        }

        .results-hero i {
          font-size: 3rem;
          margin-bottom: 15px;
        }

        .results-hero h2 {
          font-size: 1.8rem;
          margin-bottom: 12px;
        }

        .results-hero p {
          font-size: 1rem;
        }

        /* Results Actions Mobile */
        .results-actions {
          flex-direction: column;
          gap: 12px;
          margin-top: 30px;
        }

        .retake-btn,
        .shop-all-btn {
          padding: 14px 20px;
          width: 100%;
          justify-content: center;
          font-size: 1rem;
          border-radius: 20px;
        }
      }

      /* Tablet Optimization */
      @media (min-width: 769px) and (max-width: 1024px) {
        .results-hero {
          padding: 40px 30px;
        }

        .results-actions {
          gap: 20px;
        }
      }
      /* ===== SAVED PREFERENCES INDICATOR ===== */
      .saved-preferences-indicator {
        color: var(--text-gray);
        font-size: 0.8em;
        font-weight: 400;
        display: block;
        text-align: center;
        margin-top: 8px;
        opacity: 0.8;
      }

      .saved-preferences-indicator i {
        font-size: 0.8em;
        margin-right: 4px;
      }

   /* ===== ATTRIBUTE MATCHES STYLES - ULTRA COMPACT ===== */
.attribute-summary {
  margin: 10px 0;
  position: relative;
}

.attribute-header {
  display: flex;
  align-items: center;
  padding: 10px 14px;
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.2);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.85em;
  font-weight: 600;
  color: #1e40af;
  text-align: left;
  justify-content: space-between;
  -webkit-tap-highlight-color: transparent;
  user-select: none;
  
  /* ULTRA AGGRESSIVE: Prevent wrapping at all costs */
  flex-wrap: nowrap !important;
  white-space: nowrap !important;
  overflow: hidden !important;
  min-width: 0 !important;
  width: 100% !important;
  box-sizing: border-box !important;
}

.attribute-text {
  flex: 1;
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  min-width: 0 !important;
  /* Force text to stay on one line */
  display: inline-block !important;
  max-width: calc(100% - 30px) !important; /* Reserve space for toggle */
}

.attribute-toggle {
  font-weight: bold;
  opacity: 0.7;
  font-size: 1em;
  flex-shrink: 0 !important;
  margin-left: 4px;
  min-width: 16px !important; /* Fixed width for icon */
}

/* MOBILE OPTIMIZATION - EXTREME COMPACT */
@media (max-width: 768px) {
  .attribute-summary {
    margin: 6px 0;
  }
  
  .attribute-header {
    padding: 6px 8px !important;
    font-size: 0.7em !important;
    min-height: 28px;
    gap: 0 !important; /* Remove gap completely */
  }
  
  .attribute-text {
    font-size: 0.75em;
    letter-spacing: -0.1px;
    max-width: calc(100% - 20px) !important; /* Less space for smaller toggle */
  }
  
  .attribute-toggle {
    font-size: 0.8em !important;
    margin-left: 2px;
    min-width: 14px !important;
  }
}

/* EXTRA SMALL MOBILE - ULTRA COMPACT */
@media (max-width: 400px) {
  .attribute-header {
    padding: 4px 6px !important;
    font-size: 0.65em !important;
    min-height: 24px;
  }
  
  .attribute-text {
    font-size: 0.7em;
    max-width: calc(100% - 18px) !important;
  }
  
  .attribute-toggle {
    font-size: 0.75em !important;
    min-width: 12px !important;
  }
}

/* EMERGENCY FIX FOR VERY NARROW CONTAINERS */
@media (max-width: 350px) {
  .attribute-header {
    padding: 3px 4px !important;
    font-size: 0.6em !important;
  }
  
  .attribute-text {
    font-size: 0.65em;
    max-width: calc(100% - 16px) !important;
  }
  
  .attribute-toggle {
    font-size: 0.7em !important;
    min-width: 10px !important;
  }
}

/* NUCLEAR OPTION - FORCE SINGLE LINE NO MATTER WHAT */
.attribute-header.force-single-line,
.attribute-header * {
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  display: inline !important;
  line-height: 1.2 !important;
}

/* DESKTOP HOVER EFFECTS */
@media (min-width: 769px) {
  .attribute-header:hover {
    background: rgba(59, 130, 246, 0.15);
    transform: translateY(-1px);
  }
}

.attribute-header:active {
  transform: translateY(0);
  background: rgba(59, 246, 0.2);
}

      /* EXTERNAL FLOATING CARD - SINGLE SOURCE OF TRUTH */
      #external-attribute-card {
        display: none;
        position: fixed;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 14px;
        box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.15);
        z-index: 10000;
        width: 300px;
        max-height: 350px;
        overflow-y: auto;
        text-align: left;
        font-size: 0.85em;
      }

      /* MOBILE: Centered with smooth animation */
      @media (max-width: 768px) {
        #external-attribute-card {
          width: 280px !important; /* Force mobile width */
          max-height: 320px !important;
          padding: 12px !important;
          top: 50% !important;
          left: 50% !important;
          transform: translate(-50%, -50%) !important; /* Force centering */
          animation: modalSlideUp 0.3s ease-out !important; /* Force mobile animation */
        }
      }

      /* DESKTOP: Positioned above with different animation */
      @media (min-width: 769px) {
        #external-attribute-card {
          width: 320px;
          max-height: 380px;
          padding: 16px;
          font-size: 0.9em;
          transform: none;
          animation: slideUp 0.2s ease-out;
          /* Remove top/left positioning - let JavaScript handle it */
        }

        .attribute-header {
          padding: 8px 12px;
          font-size: 0.8em;
        }
      }

      /* Mobile animation - smooth center slide */
      @keyframes modalSlideUp {
        from {
          opacity: 0;
          transform: translate(-50%, -45%) !important;
        }
        to {
          opacity: 1;
          transform: translate(-50%, -50%) !important;
        }
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* CLEAN MINIMALIST STYLES */
      .attribute-detail-clean {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        padding: 8px 10px;
        border-radius: 6px;
        margin-bottom: 4px;
        min-height: 36px;
      }

      .attribute-detail-clean.match {
        background: rgba(34, 197, 94, 0.08);
        border: 1px solid rgba(34, 197, 94, 0.12);
      }

      .attribute-detail-clean.no-match {
        background: rgba(239, 68, 68, 0.08);
        border: 1px solid rgba(239, 68, 68, 0.12);
      }

      .attribute-line {
        flex: 1;
        display: flex;
        align-items: flex-start;
        gap: 10px;
        min-width: 0;
      }

      .attribute-label-clean {
        font-weight: 600;
        color: #374151;
        font-size: 0.8em;
        min-width: 70px;
        flex-shrink: 0;
        margin-top: 1px;
      }

      .attribute-values {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 6px;
        font-size: 0.8em;
        flex: 1;
        min-width: 0;
      }

      .product-value-clean {
        color: #1e40af;
        font-weight: 500;
        word-break: break-word;
        flex-shrink: 1;
        min-width: 0;
      }

      .user-value-clean {
        color: #7c3aed;
        font-weight: 500;
        word-break: break-word;
        flex-shrink: 1;
        min-width: 0;
      }

      .separator {
        color: #9ca3af;
        font-size: 0.75em;
        flex-shrink: 0;
      }

      .detail-status-clean {
        font-weight: bold;
        font-size: 0.85em;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        flex-shrink: 0;
        margin-top: 1px;
      }

      .attribute-detail-clean.match .detail-status-clean {
        background: rgba(34, 197, 94, 0.15);
        color: #16a34a;
      }

      .attribute-detail-clean.no-match .detail-status-clean {
        background: rgba(239, 68, 68, 0.15);
        color: #dc2626;
      }

      /* Mobile optimization for content */
      @media (max-width: 768px) {
        .attribute-detail-clean {
          padding: 6px 8px;
          min-height: 32px;
          margin-bottom: 3px;
        }

        .attribute-line {
          gap: 6px;
        }

        .attribute-label-clean {
          min-width: 65px;
          font-size: 0.75em;
        }

        .attribute-values {
          gap: 4px;
          font-size: 0.75em;
        }

        .detail-status-clean {
          width: 16px;
          height: 16px;
          font-size: 0.8em;
        }
      }

      /* Extra small mobile optimization */
      @media (max-width: 400px) {
        #external-attribute-card {
          width: 260px !important;
          max-height: 300px !important;
          padding: 10px !important;
        }

        .attribute-detail-clean {
          padding: 5px 6px;
          min-height: 30px;
        }

        .attribute-label-clean {
          min-width: 60px;
          font-size: 0.7em;
        }

        .attribute-values {
          font-size: 0.7em;
        }
      }

      /* Better scrollbar */
      #external-attribute-card::-webkit-scrollbar {
        width: 4px;
      }

      #external-attribute-card::-webkit-scrollbar-track {
        background: #f8fafc;
        border-radius: 2px;
      }

      #external-attribute-card::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 2px;
      }

      #external-attribute-card::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }
      /* ===== ELEGANT COMPACT FILTERS ===== */
      .filters-section {
        margin: 20px auto 30px auto;
        padding: 0;
        background: transparent;
        border: none;
        max-width: 900px;
      }

      .filters-container {
        display: flex;
        gap: 16px;
        margin-bottom: 12px;
        flex-wrap: wrap;
        align-items: end;
        justify-content: center;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex: 0 1 auto;
      }

      .filter-group label {
        font-weight: 500;
        font-size: 11px;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        font-family: "Inter", sans-serif;
      }

      .filter-group select {
        padding: 10px 14px;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        background: white;
        font-size: 13px;
        color: #374151;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        appearance: none;
        background-position: right 12px center;
        background-size: 14px;
        padding-right: 36px;
        min-width: 140px;
        font-family: "Inter", sans-serif;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      .filter-group select:hover {
        border-color: #d1d5db;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transform: translateY(-1px);
      }

      .filter-group select:focus {
        outline: none;
        border-color: var(--primary-pink);
        box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
      }

      .results-count {
        font-weight: 500;
        color: #6b7280;
        font-size: 12px;
        text-align: center;
        margin-top: 8px;
        font-family: "Inter", sans-serif;
        letter-spacing: 0.3px;
      }

      /* ===== REDUCE SPACING IN RESULTS CONTAINER ===== */
      .results-container {
        text-align: center;
        padding: 10px 0 0 0;
      }

      .results-hero {
        margin-bottom: 25px;
      }

      .results-hero h2 {
        margin-bottom: 8px;
      }

      .results-hero p {
        margin-bottom: 0;
        line-height: 1.5;
      }
      /* ===== FILTER DESCRIPTION ===== */
      .filter-description {
        color: var(--primary-pink);
        font-size: 12px;
        text-align: center;
        margin-top: 8px;
        padding: 8px 12px;
        background: rgba(236, 72, 153, 0.05);
        border-radius: 8px;
        border: 1px solid rgba(236, 72, 153, 0.1);
        line-height: 1.4;
        transition: all 0.3s ease;
      }

      .filter-description strong {
        color: var(--primary-pink);
        font-weight: 600;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .filter-description {
          font-size: 11px;
          padding: 6px 10px;
          margin-top: 6px;
        }
      }

      /* ===== RESPONSIVE DESIGN ===== */
      @media (max-width: 1024px) {
        .filters-container {
          gap: 12px;
        }

        .filter-group select {
          min-width: 130px;
          padding: 9px 12px;
          font-size: 12.5px;
        }
      }

      @media (max-width: 768px) {
        .filters-section {
          margin: 15px auto 25px auto;
          padding: 0 16px;
        }

        .filters-container {
          gap: 10px;
          flex-direction: row;
          justify-content: space-between;
          flex-wrap: nowrap;
          overflow-x: auto;
          padding-bottom: 8px;
          margin-bottom: 15px;
        }

        .filter-group {
          flex: 0 0 auto;
          min-width: 120px;
        }

        .filter-group select {
          min-width: 120px;
          padding: 8px 12px;
          font-size: 12px;
          padding-right: 32px;
          background-position: right 10px center;
        }

        .results-hero {
          margin-bottom: 20px;
        }

        .results-hero h2 {
          font-size: 1.8rem;
        }

        .results-hero p {
          font-size: 1rem;
        }
      }

      @media (max-width: 640px) {
        .filters-container {
          gap: 8px;
        }

        .filter-group {
          min-width: 110px;
        }

        .filter-group select {
          min-width: 110px;
          padding: 7px 10px;
          font-size: 11.5px;
        }

        .filter-group label {
          font-size: 10px;
        }

        .results-count {
          font-size: 11px;
        }
      }

      @media (max-width: 480px) {
        .filters-section {
          margin: 12px auto 20px auto;
          padding: 0 12px;
        }

        .filters-container {
          gap: 6px;
        }

        .filter-group {
          min-width: 100px;
        }

        .filter-group select {
          min-width: 100px;
          padding: 6px 8px;
          font-size: 11px;
          padding-right: 28px;
          background-size: 12px;
        }

        .results-hero h2 {
          font-size: 1.6rem;
        }

        .results-hero p {
          font-size: 0.9rem;
        }
      }
      /* ===== USER RATINGS ===== */
      .user-rating {
        display: flex;
        align-items: center; /* Vertical center */
        justify-content: center; /* Horizontal center */
        gap: 4px;
        margin: 4px 0;
        padding: 2px 0;
        min-height: 16px;
        width: auto;
        text-align: center; /* Extra assurance for text */
      }

      .stars {
        display: flex;
        gap: 2px;
        flex-shrink: 0;
      }

      .rating-text {
        font-size: 11px; /* Slightly smaller */
        font-weight: 500; /* Lighter weight */
        color: #6b7280;
        min-width: auto; /* Remove fixed width */
      }

      .stars i {
        font-size: 12px;
        color: #e5e7eb; /* Empty star color */
        transition: color 0.2s ease;
      }

      .stars i.active {
        color: #fbbf24; /* Gold color for filled stars */
      }

      .user-rating.no-ratings .stars i {
        color: #d1d5db;
      }

      .user-rating.no-ratings .rating-text {
        color: #9ca3af;
        font-weight: normal;
      }

      /* Hover effects */
      .user-rating:not(.no-ratings):hover .stars i.active {
        color: #f59e0b; /* Slightly darker gold on hover */
      }

      /* Responsive */
      @media (max-width: 768px) {
        .user-rating {
          margin: 1px 0;
          gap: 2px;
        }

        .stars i {
          font-size: 8px;
        }

        .rating-text {
          font-size: 9px;
        }
      }
      /* Discreet pink scrollbar that appears on hover */
      body::-webkit-scrollbar {
        width: 6px !important;
        display: block !important;
      }

      body::-webkit-scrollbar-track {
        background: transparent !important;
      }

      body::-webkit-scrollbar-thumb {
        background: rgba(255, 105, 180, 0.1) !important; /* Very subtle pink */
        border-radius: 3px !important;
        transition: all 0.3s ease !important;
      }

      body:hover::-webkit-scrollbar-thumb {
        background: rgba(
          255,
          105,
          180,
          0.4
        ) !important; /* Medium pink on hover */
      }

      body::-webkit-scrollbar-thumb:hover {
        background: rgba(
          255,
          105,
          180,
          0.7
        ) !important; /* Bright pink when active */
      }

      body {
        overflow-y: auto !important;
        overflow-x: hidden !important;
      }
      .recommendations-section {
        margin-bottom: 30px;
        padding: 0 15px;
      }

      /* Elegant Pink Divider Headers */
      .section-divider {
        display: flex;
        align-items: center;
        margin: 25px 0 15px 0;
        cursor: pointer;
        padding: 6px 0;
        transition: all 0.3s ease;
      }

      .section-divider:hover {
        opacity: 0.8;
      }

      .section-divider::before,
      .section-divider::after {
        content: "";
        flex: 1;
        height: 1px;
        background: linear-gradient(90deg, transparent, #f9a8d4, transparent);
      }

      .section-divider-content {
        padding: 0 12px;
        display: flex;
        align-items: center;
        gap: 6px;
        color: #ec4899;
        font-size: 1em;
        font-weight: 500;
        font-family: "Inter", sans-serif;
        white-space: nowrap;
      }

      .section-divider .toggle-icon {
        font-size: 0.7em;
        color: #9ca3af;
        transition: transform 0.3s ease;
        margin-left: 3px;
      }

      .universal-section.expanded .section-divider .toggle-icon {
        transform: rotate(180deg);
        color: #ec4899;
      }

      /* Specific Products */
      .specific-section .section-divider-content {
        color: #ec4899;
      }

      /* Universal Products */
      .universal-section .section-divider-content {
        color: #9ca3af;
      }

      .universal-section.expanded .section-divider-content {
        color: #ec4899;
      }

      /* Tooltip for descriptions */
      .section-divider-content {
        position: relative;
      }

      .section-divider-content:hover::before {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(236, 72, 153, 0.9);
        color: white;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 0.75em;
        white-space: nowrap;
        z-index: 1000;
        margin-bottom: 6px;
        font-family: "Inter", sans-serif;
      }

      .section-divider-content:hover::after {
        content: "";
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 4px solid transparent;
        border-top-color: rgba(236, 72, 153, 0.9);
        margin-bottom: 0;
      }

      /* Results count - very subtle light gray */
      .results-count-subtle {
        color: #9ca3af;
        font-size: 0.7em;
        font-family: "Inter", sans-serif;
        text-align: center;
        margin: -12px 0 15px 0;
        font-style: italic;
      }

      /* Universal products grid - initially hidden */
      .universal-section .recommendations-grid {
        display: none;
        animation: fadeIn 0.3s ease;
      }

      .universal-section.expanded .recommendations-grid {
        display: grid;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .pagination-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        margin: 20px 0;
        padding: 15px;
      }

      .pagination-btn {
        padding: 8px 16px;
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        min-width: 80px;
        transition: all 0.2s ease;
      }

      .pagination-btn:disabled {
        background: #d1d5db;
        cursor: not-allowed;
        transform: none;
      }

      .pagination-btn:not(:disabled):hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .page-info {
        font-weight: 500;
        color: #666;
        font-size: 14px;
        min-width: 100px;
        text-align: center;
      }

      /* Mobile-specific styles */
      @media (max-width: 768px) {
        .pagination-controls {
          gap: 8px;
          margin: 15px 0;
          padding: 12px 10px;
        }

        .pagination-btn {
          padding: 6px 12px;
          font-size: 13px;
          min-width: 70px;
          border-radius: 5px;
        }

        .page-info {
          font-size: 13px;
          min-width: 90px;
        }
      }

      /* Extra small devices */
      @media (max-width: 480px) {
        .pagination-controls {
          gap: 6px;
          margin: 12px 0;
          padding: 10px 5px;
        }

        .pagination-btn {
          padding: 5px 10px;
          font-size: 12px;
          min-width: 65px;
        }

        .page-info {
          font-size: 12px;
          min-width: 80px;
        }

        /* Optional: Stack layout for very small screens */
        @media (max-width: 360px) {
          .pagination-controls {
            flex-direction: column;
            gap: 8px;
          }

          .pagination-btn {
            width: 100%;
            max-width: 200px;
          }
        }
      }
      /* Results Actions Styling */
      .results-actions {
        text-align: center;
        margin-top: 40px;
        padding-top: 30px;
        border-top: 1px solid #f1f5f9;
        display: block;
      }

      .quiz-info {
        text-align: center;
        margin-bottom: 20px;
        color: #9ca3af;
        font-size: 0.85em;
        font-style: italic;
        display: block;
        width: 100%;
      }

      .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        align-items: center;
        width: 100%;
      }

      .retake-btn,
      .shop-all-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 0.95em;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        min-width: 140px;
        flex: 1;
        max-width: 200px;
        text-align: center;
      }

      .retake-btn {
        background: #f8fafc;
        color: #6b7280;
        border: 1px solid #e5e7eb;
      }

      .retake-btn:hover {
        background: #f1f5f9;
        border-color: #d1d5db;
      }

      .shop-all-btn {
        background: var(--primary-pink);
        color: white;
      }

      .shop-all-btn:hover {
        background: #be185d;
      }

      /* Mobile-specific styles */
      @media (max-width: 768px) {
        .action-buttons {
          gap: 12px;
          padding: 0 10px;
        }

        .retake-btn,
        .shop-all-btn {
          padding: 10px 16px;
          font-size: 0.9em;
          min-width: 120px;
          max-width: 160px;
          flex: 1;
        }
      }

      /* Extra small devices */
      @media (max-width: 480px) {
        .action-buttons {
          gap: 10px;
          flex-wrap: wrap;
        }

        .retake-btn,
        .shop-all-btn {
          padding: 8px 14px;
          font-size: 0.85em;
          min-width: 110px;
          max-width: 140px;
          flex: 1 1 calc(50% - 10px);
        }
      }

      /* Very small screens - stack vertically */
      @media (max-width: 360px) {
        .action-buttons {
          flex-direction: column;
          gap: 8px;
        }

        .retake-btn,
        .shop-all-btn {
          min-width: 100%;
          max-width: 100%;
          width: 100%;
          flex: none;
        }
      }
      /* Add All to Cart Styles - Optimized */
      .add-all-container {
        text-align: center;
        margin-top: 2px; /* Reduced from 20px */
        padding-top: 2px; /* Reduced from 20px */
      }

      .add-all-btn {
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 1em;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        position: relative;
        overflow: hidden;
      }

      /* Enhanced hover effects */
      .add-all-btn:hover {
        background: linear-gradient(135deg, var(--dark-pink), #be185d);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(236, 72, 153, 0.4),
          0 0 0 1px rgba(255, 255, 255, 0.1) inset;
      }

      /* Active/click effect */
      .add-all-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(236, 72, 153, 0.3),
          0 0 0 1px rgba(255, 255, 255, 0.1) inset;
      }

      /* Ripple effect on click */
      .add-all-btn::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.3s ease, height 0.3s ease;
      }

      .add-all-btn:active::after {
        width: 100px;
        height: 100px;
      }

      /* Loading state */
      .add-all-btn.loading {
        pointer-events: none;
        opacity: 0.8;
      }

      .add-all-btn.loading::before {
        content: "";
        border: 2px solid transparent;
        border-top: 2px solid white;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .add-all-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .add-all-count {
        color: #6b7280;
        font-size: 0.9em;
        margin-top: 8px;
        font-style: italic;
        transition: color 0.3s ease;
      }

      .add-all-count.highlight {
        color: #6b7280;
        font-weight: 400;
        font-size: 14px;
      }

      /* Success state after adding to cart */
      .add-all-btn.success {
        background: linear-gradient(135deg, #b91091, #96056f);
      }

      .add-all-btn.success:hover {
        background: linear-gradient(135deg, #960580, #780469);
      }
      /* Feedback Section Styles */
      .feedback-section {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #f1f5f9;
      }

      .feedback-label {
        font-size: 0.85em;
        color: #6b7280;
        margin-bottom: 8px;
        text-align: center;
        font-weight: 500;
      }

      .feedback-label small {
        display: block;
        font-size: 0.7em;
        color: #9ca3af;
        margin-top: 2px;
        font-weight: 400;
      }

      .feedback-buttons {
        display: flex;
        gap: 6px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .feedback-btn {
        padding: 6px 12px;
        border: 1.5px solid #e5e7eb;
        border-radius: 20px;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.8em;
        display: flex;
        align-items: center;
        gap: 4px;
        font-weight: 500;
      }

      .feedback-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .feedback-btn.thumbs-up:hover {
        background: #dcfce7;
        border-color: #22c55e;
        color: #166534;
      }

      .feedback-btn.thumbs-neutral:hover {
        background: #fef3c7;
        border-color: #f59e0b;
        color: #92400e;
      }

      .feedback-btn.thumbs-down:hover {
        background: #fee2e2;
        border-color: #ef4444;
        color: #991b1b;
      }

      .feedback-btn.active {
        font-weight: 600;
        transform: scale(1.05);
      }

      .feedback-btn.thumbs-up.active {
        background: #dcfce7;
        border-color: #16a34a;
        color: #166534;
        box-shadow: 0 2px 8px rgba(34, 197, 94, 0.2);
      }

      .feedback-btn.thumbs-neutral.active {
        background: #fef3c7;
        border-color: #d97706;
        color: #92400e;
        box-shadow: 0 2px 8px rgba(245, 158, 11, 0.2);
      }

      .feedback-btn.thumbs-down.active {
        background: #fee2e2;
        border-color: #dc2626;
        color: #991b1b;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
      }

      .feedback-timestamp {
        text-align: center;
        margin-top: 8px;
        color: #9ca3af;
        font-size: 0.75em;
        font-style: italic;
      }

      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .feedback-buttons {
          gap: 4px;
        }

        .feedback-btn {
          padding: 5px 10px;
          font-size: 0.75em;
          flex: 1;
          min-width: 0;
          justify-content: center;
        }
      }

      /* Feedback indicators in product cards */
      /* Feedback indicators in product cards */
      .feedback-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 8px;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.7em;
        width: fit-content;
        font-weight: 500;
      }

      /* Pink for personal "You liked this" */
      .feedback-indicator.personal {
        background: #fdf2f8; /* Soft pink background */
        color: var(--primary-pink); /* Dark pink text */
        border: 1px solid #fbcfe8; /* Pink border */
      }

      /* Blue for collaborative filtering */
      .feedback-indicator.similar-users {
        background: #eff6ff; /* Soft blue background */
        color: #1e40af; /* Dark blue text */
        border: 1px solid #bfdbfe; /* Blue border */
      }

      /* Gold for global popularity */
      .feedback-indicator.global-popular {
        background: #fffbeb; /* Soft gold background */
        color: #d97706; /* Amber text */
        border: 1px solid #fcd34d; /* Gold border */
      }

      .feedback-indicator.up {
        background: #dcfce7;
        color: #166534;
      }

      .feedback-indicator.neutral {
        background: #fef3c7;
        color: #92400e;
      }

      .feedback-indicator.down {
        background: #fee2e2;
        color: #991b1b;
      }
      .feedback-btn.active {
        font-weight: 700;
        transform: scale(1.08);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border-width: 2px;
      }

      .feedback-btn.thumbs-up.active {
        background: #dcfce7;
        border-color: #16a34a;
        color: #166534;
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
      }

      .feedback-btn.thumbs-neutral.active {
        background: #fef3c7;
        border-color: #d97706;
        color: #92400e;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
      }

      .feedback-btn.thumbs-down.active {
        background: #fee2e2;
        border-color: #dc2626;
        color: #991b1b;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
      }

      .cart-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border-left: 4px solid var(--primary-pink);
        border-radius: 8px;
        padding: 15px 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transform: translateX(400px);
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 10000;
        max-width: 300px;
      }

      .cart-notification.show {
        transform: translateX(0);
        opacity: 1;
      }

      .cart-notification.success {
        border-left-color: var(--primary-pink);
      }

      .cart-notification.error {
        border-left-color: #ef4444;
      }

      .notification-content {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #1f2937;
      }

      .notification-content i {
        font-size: 18px;
      }

      .cart-notification.success .notification-content i {
        color: var(--primary-pink);
      }

      .cart-notification.error .notification-content i {
        color: #ef4444;
      }
      .notification-box {
        position: fixed;
        top: 80px;
        right: 20px;
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(255, 105, 180, 0.4);
        z-index: 9999;
        font-weight: 500;
        transform: translateX(400px);
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        max-width: 300px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .notification-box.show {
        transform: translateX(0);
        opacity: 1;
      }

      .notification-box.success {
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--dark-pink)
        );
      }

      .notification-box.error {
        background: linear-gradient(135deg, #ef4444, #dc2626);
      }

      .notification-box.info {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      }

      .notification-box.warning {
        background: linear-gradient(135deg, #f59e0b, #d97706);
      }

      @media (max-width: 480px) {
        .notification-box {
          right: 10px;
          left: 10px;
          max-width: none;
          top: 70px;
        }
      }

      /* Cart total popup - Compact & Elegant */
      .cart-total-popup {
        position: absolute;
        background: white;
        border-radius: 12px;
        padding: 12px 16px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        min-width: 160px;
        max-width: 180px;
        transform: translateY(-8px) scale(0.95);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1000;
        border: 1px solid #f3f4f6;
        text-align: center;
      }

      /* Desktop positioning */
      .desktop-nav .cart-total-popup {
        top: calc(100% + 8px);
        right: 50%;
        transform: translateX(50%) translateY(-8px) scale(0.95);
      }

      .desktop-nav .cart-total-popup::before {
        content: "";
        position: absolute;
        top: -6px;
        left: 50%;
        transform: translateX(-50%) rotate(45deg);
        width: 12px;
        height: 12px;
        background: white;
        border-left: 1px solid #f3f4f6;
        border-top: 1px solid #f3f4f6;
      }

      /* Mobile positioning */
      .mobile-nav .cart-total-popup {
        bottom: calc(100% + 8px);
        right: 50%;
        transform: translateX(50%) translateY(8px) scale(0.95);
      }

      .mobile-nav .cart-total-popup::before {
        content: "";
        position: absolute;
        bottom: -6px;
        left: 50%;
        transform: translateX(-50%) rotate(45deg);
        width: 12px;
        height: 12px;
        background: white;
        border-right: 1px solid #f3f4f6;
        border-bottom: 1px solid #f3f4f6;
      }

      .cart-total-popup.show {
        transform: translateX(50%) translateY(0) scale(1);
        opacity: 1;
        visibility: visible;
      }

      .cart-total-amount {
        font-size: 16px;
        font-weight: 700;
        color: var(--primary-pink);
        margin: 3px 0;
        line-height: 1.2;
      }

      .cart-total-label {
        font-size: 11px;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
      }

      .cart-total-popup small {
        font-size: 10px;
        color: #9ca3af;
        display: block;
        margin-top: 2px;
        line-height: 1.3;
      }

      .user-rating.no-ratings {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
      }

      .user-rating.no-ratings .stars {
        display: flex;
        gap: 2px;
      }

      .user-rating.no-ratings .rating-text {
        font-size: 12px;
        color: #6b7280;
        text-align: center;
        white-space: nowrap;
      }

      /* Mobile-specific styles */
      @media (max-width: 768px) {
        .user-rating.no-ratings {
          gap: 2px;
        }

        .user-rating.no-ratings .stars {
          gap: 1px;
        }

        .user-rating.no-ratings .stars i {
          font-size: 12px;
        }

        .user-rating.no-ratings .rating-text {
          font-size: 11px;
          white-space: normal;
          line-height: 1.2;
        }
      }

      /* Extra small devices */
      @media (max-width: 480px) {
        .user-rating.no-ratings .stars i {
          font-size: 11px;
        }

        .user-rating.no-ratings .rating-text {
          font-size: 10px;
          max-width: 80px;
          word-wrap: break-word;
        }
      }
      .feedback-indicator.global-popular {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fcd34d;
      }
      /* For separate shade line */
      .product-shade {
        font-size: 0.85em;
        color: #6b7280;
        margin: 2px 0;
        font-style: italic;
      }

      /* For color dots */
      .shade-dot {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 6px;
        border: 1px solid #e5e7eb;
      }

      /* For subtle shade text */
      .shade-subtle {
        font-size: 0.9em;
        color: #6b7280;
        font-weight: normal;
      }

      /* ===== INTRO ACTIONS ===== */
      .intro-actions {
        margin: 2rem 0;
      }

      /* ===== QUICK SCAN STYLES ===== */
      .quick-scan-section {
        margin: 30px 0;
        text-align: center;
      }

      .scan-option {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 20px;
        margin-bottom: 20px;
      }

      .scan-icon {
        font-size: 3em;
        margin-bottom: 15px;
      }

      .scan-option h3 {
        margin: 0 0 10px 0;
        font-size: 1.5em;
      }

      .scan-option p {
        margin: 0 0 20px 0;
        opacity: 0.9;
      }

      .scan-divider {
        position: relative;
        margin: 20px 0;
      }

      .scan-divider::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: #e0e0e0;
      }

      .scan-divider span {
        background: white;
        padding: 0 15px;
        color: #666;
        font-weight: 500;
      }

      /* ===== MODAL OVERLAY ===== */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal-content {
        background: white; /*  ADD THIS LINE */
        border-radius: 12px;
        overflow-y: auto;
        position: relative;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); /* Optional: Add shadow for better appearance */
      }

      /* Camera Modal */
      .camera-modal {
        max-width: 500px;
        padding: 0;
        overflow: hidden;
        background: white; /*  ADD THIS TOO FOR EXTRA SAFETY */
      }

      .camera-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white; /*  Ensure header has white background */
      }

      .camera-header h3 {
        margin: 0;
      }

      .camera-container {
        position: relative;
        width: 100%;
        height: 400px;
        background: #000; /* Camera area stays black */
      }

      .camera-controls {
        padding: 20px;
        display: flex;
        gap: 10px;
        border-top: 1px solid #eee;
        background: white; /*  Ensure controls have white background */
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 1.2em;
        cursor: pointer;
        color: #666;
      }

      .camera-container {
        position: relative;
        width: 100%;
        height: 400px;
        background: #000;
      }

      #camera-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .face-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .face-guide {
        width: 200px;
        height: 250px;
        border: 3px solid rgba(255, 255, 255, 0.8);
        border-radius: 40%;
        background: transparent;
      }

      .camera-controls {
        padding: 20px;
        display: flex;
        gap: 10px;
        border-top: 1px solid #eee;
      }

      .scan-tips {
        padding: 20px;
        background: #f8f9fa;
        border-top: 1px solid #eee;
      }

      .scan-tips h4 {
        margin: 0 0 10px 0;
        color: #333;
      }

      .scan-tips ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .scan-tips li {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9em;
        color: #666;
      }

      .scan-tips i {
        color: var(--primary-pink);
      }

      /* Scan Results Modal */
      .scan-results-modal {
        max-width: 500px;
      }

      .scan-header {
        text-align: center;
        padding: 20px;
        border-bottom: 1px solid #eee;
      }

      .scan-header .success {
        font-size: 3em;
        color: #4caf50;
        margin-bottom: 10px;
      }

      .scan-results {
        padding: 20px;
      }

      .result-item {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #f0f0f0;
      }

      .result-label {
        font-weight: 600;
        color: #333;
      }

      .result-value {
        text-align: right;
        color: #666;
      }

      .concern-tag {
        display: inline-block;
        background: var(--primary-light);
        color: var(--primary-color);
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        margin: 0.1rem;
      }

      .scan-actions {
        padding: 20px;
        display: flex;
        gap: 10px;
        border-top: 1px solid #eee;
      }

      .scan-note {
        padding: 0 20px 20px;
        text-align: center;
        color: #666;
      }
      /* ===== HORIZONTAL INTRO ACTIONS ===== */
      .intro-actions-horizontal {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin: 2rem 0;
        flex-wrap: wrap;
      }

      /* Start Quiz Button Styles */
      .nav-btn.primary {
        background: linear-gradient(135deg, #ff6b9d 0%, #ff4b8b 100%);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 15px rgba(255, 107, 157, 0.3);
      }

      .nav-btn.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 107, 157, 0.4);
      }

      /* Quick Scan Compact Button */
      .scan-btn-compact {
        background: linear-gradient(135deg, #ff9ac8 0%, #ff7eb3 100%);
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 25px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 15px rgba(255, 154, 200, 0.3);
      }

      .scan-btn-compact:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 154, 200, 0.4);
        background: linear-gradient(135deg, #ff8abf 0%, #ff6ba8 100%);
      }

      /* Divider */
      .scan-divider {
        position: relative;
        margin: 0 1rem;
      }

      .scan-divider::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: #e0e0e0;
      }

      .scan-divider span {
        background: white;
        padding: 0 15px;
        color: #666;
        font-weight: 500;
        font-size: 0.9rem;
      }

      /* Remove the old quick scan section styles */
      .quick-scan-section {
        display: none;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .intro-actions-horizontal {
          flex-direction: column;
          gap: 1rem;
        }

        .scan-divider {
          margin: 0.5rem 0;
        }

        .scan-divider::before {
          left: 20%;
          right: 20%;
        }
      }

      /* Quiz Privacy Section Styles */
.quiz-privacy-section {
  margin-top: 40px;
  padding-top: 30px;
  border-top: 1px solid rgba(255, 182, 193, 0.3);
}

.privacy-info-card {
  background: linear-gradient(135deg, rgba(255, 182, 193, 0.05), rgba(255, 126, 185, 0.05));
  border: 1px solid rgba(255, 126, 185, 0.2);
  border-radius: 15px;
  padding: 25px;
  backdrop-filter: blur(10px);
}

.privacy-info-header {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 25px;
}

.privacy-info-header i {
  color: var(--primary-pink);
  font-size: 28px;
}

.privacy-info-header h4 {
  margin: 0;
  color: var(--dark-pink);
  font-family: "Cormorant Garamond", serif;
  font-size: 22px;
  font-weight: 600;
}

.privacy-info-points {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 25px;
}

.privacy-info-point {
  display: flex;
  gap: 15px;
  align-items: flex-start;
}

.privacy-info-point i {
  color: var(--primary-pink);
  font-size: 18px;
  margin-top: 3px;
  flex-shrink: 0;
}

.privacy-info-point strong {
  color: #333;
  display: block;
  margin-bottom: 5px;
  font-size: 14px;
  font-weight: 600;
}

.privacy-info-point p {
  color: #666;
  font-size: 13px;
  line-height: 1.4;
  margin: 0;
}

.privacy-info-footer {
  text-align: center;
  padding-top: 20px;
  border-top: 1px solid rgba(255, 126, 185, 0.1);
}

.privacy-learn-more-btn {
  background: transparent;
  border: none;
  color: var(--primary-pink);
  font-size: 14px;
  cursor: pointer;
  padding: 10px 20px;
  border-radius: 20px;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.privacy-learn-more-btn:hover {
  background: rgba(255, 126, 185, 0.1);
  transform: translateY(-2px);
}

/* Mobile adjustments */
@media (max-width: 768px) {
  .quiz-privacy-section {
    margin-top: 30px;
    padding-top: 25px;
  }
  
  .privacy-info-card {
    padding: 20px;
  }
  
  .privacy-info-points {
    grid-template-columns: 1fr;
    gap: 15px;
  }
  
  .privacy-info-point {
    flex-direction: column;
    text-align: center;
  }
  
  .privacy-info-point i {
    align-self: center;
  }
}
    </style>
  </head>

  <body>
    <!-- Header -->
    <header class="header">
      <div class="brand-header">
        <h1 class="brand-name">Blessence</h1>
        <p class="brand-tagline">Beauty & Blessed Online Makeup Store</p>
      </div>

      <div class="user-section">
        <span class="user-greeting" id="user-greeting">Hi, User!</span>

        <!-- NOTIFICATION SECTION START -->
        <div class="notification-container">
          <button class="notif-btn" id="notif-btn">
            <i class="fas fa-bell"></i>
            <span class="notif-badge" id="notif-badge">0</span>
          </button>

          <div class="notif-dropdown" id="notif-dropdown">
            <div class="notif-header">
              <span>Notifications</span>
              <i
                class="fas fa-check-double"
                style="font-size: 12px; cursor: pointer; color: #999"
                title="Mark all as read"
              ></i>
            </div>
            <div class="notif-list" id="notif-list">
              <!-- Notifications will be injected here -->
              <div class="notif-empty">Loading...</div>
            </div>
          </div>
        </div>
        <!-- NOTIFICATION SECTION END -->

        <button
          class="profile-btn"
          onclick="window.location.href='user_profile.html'"
        >
          <i class="fas fa-user"></i>
        </button>
      </div>

      <button
        class="mobile-profile-btn"
        onclick="window.location.href='user_profile.html'"
      >
        <i class="fas fa-user"></i>
      </button>
    </header>

    <!-- Desktop Navigation -->
    <nav class="desktop-nav">
      <a href="home.html" class="nav-item" data-page="home">
        <i class="fas fa-home"></i>
        <span>Home</span>
      </a>
      <a href="favorites.html" class="nav-item" data-page="favorites">
        <i class="fas fa-heart"></i>
        <span>Favorites</span>
      </a>
      <a
        href="recommender.html"
        class="nav-item active"
        data-page="recommender"
      >
        <i class="fas fa-star"></i>
        <!-- Keep this as star -->
        <span>Recommender</span>
        <span class="tooltip">Smart Recommender</span>
      </a>
      <a href="cart.html" class="nav-item" data-page="cart">
        <i class="fas fa-shopping-cart"></i>
        <span>Cart</span>
        <div class="nav-cart-count">0</div>
        <!-- ADD THIS -->
      </a>
      <a href="try-on.html" class="nav-item" data-page="tryon">
        <i class="fas fa-camera"></i>
        <span>Virtual Try-On</span>
      </a>
    </nav>

    <!-- Exit Confirmation Modal -->
    <div class="modal-overlay" id="exit-modal">
      <div class="modal-content exit-modal">
        <div class="modal-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3>Are you sure you want to exit?</h3>
        <p>Your quiz progress will not be saved.</p>
        <div class="modal-actions">
          <button class="modal-btn primary" onclick="confirmExit()">
            Yes, Exit
          </button>
          <button class="modal-btn tertiary" onclick="closeExitModal()">
            No, Continue
          </button>
        </div>
      </div>
    </div>

    <main class="recommender-main">
      <div class="quiz-container">
        <div class="quiz-step active" id="step-intro">
          <div class="quiz-hero">
            <h1>Find Your Perfect Beauty Match!</h1>
            <p>
              Take our quick 5-step quiz to discover personalized product
              recommendations tailored to your unique skin needs and
              preferences.
            </p>

            <!-- Simple Floating Product Display -->
            <div class="floating-product">
              <img
                src=""
                alt="Beauty Product"
                class="product-image"
                id="floating-product-img"
              />
            </div>

            <div class="intro-actions-horizontal">
              <button class="nav-btn primary" onclick="startQuizWithCheck()">
                Start Quiz
              </button>

              <div class="scan-divider">
                <span>or</span>
              </div>

              <div class="quick-scan-compact">
                <button
                  class="nav-btn secondary scan-btn-compact"
                  onclick="startFaceScan()"
                >
                  <i class="fas fa-camera"></i> Quick Face Scan
                </button>
              </div>
            </div>
          </div>
          <div class="quiz-privacy-notice">
            <button class="privacy-info-btn" onclick="showPrivacyNotice()">
              <i class="fas fa-shield-alt"></i> Privacy Notice
            </button>
          </div>
        </div>

        <!-- Camera Modal -->
        <div class="modal-overlay" id="camera-modal">
          <div class="modal-content camera-modal">
            <div class="camera-header">
              <h3>Face Scan</h3>
              <button class="close-btn" onclick="closeCamera()">
                <i class="fas fa-times"></i>
              </button>
            </div>

            <div class="camera-container">
              <video id="camera-video" autoplay playsinline></video>
              <canvas id="camera-canvas" style="display: none"></canvas>
              <div class="face-overlay" id="face-overlay">
                <div class="face-guide"></div>
              </div>
            </div>

            <div class="camera-controls">
              <button class="nav-btn secondary" onclick="closeCamera()">
                Cancel
              </button>
              <button
                class="nav-btn primary"
                id="capture-btn"
                onclick="captureFace()"
              >
                <i class="fas fa-camera"></i> Capture
              </button>
            </div>

            <div class="scan-tips">
              <h4>Tips for best results:</h4>
              <ul>
                <li><i class="fas fa-check"></i> Good lighting</li>
                <li><i class="fas fa-check"></i> Front-facing camera</li>
                <li><i class="fas fa-check"></i> Remove glasses</li>
                <li><i class="fas fa-check"></i> Neutral expression</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Scan Results Modal -->
        <div class="modal-overlay" id="scan-results-modal">
          <div class="modal-content scan-results-modal">
            <div class="scan-header">
              <i class="fas fa-check-circle success"></i>
              <h3>Scan Complete!</h3>
            </div>

            <div class="scan-results" id="scan-results">
              <div class="result-item">
                <span class="result-label">Skin Type:</span>
                <span class="result-value" id="scan-skin-type"
                  >Detecting...</span
                >
              </div>
              <div class="result-item">
                <span class="result-label">Skin Tone:</span>
                <span class="result-value" id="scan-skin-tone"
                  >Detecting...</span
                >
              </div>
              <div class="result-item">
                <span class="result-label">Undertone:</span>
                <span class="result-value" id="scan-undertone"
                  >Detecting...</span
                >
              </div>
              <div class="result-item">
                <span class="result-label">Concerns:</span>
                <div class="result-value" id="scan-concerns">Detecting...</div>
              </div>
            </div>

            <div class="scan-actions">
              <button class="nav-btn secondary" onclick="editScanResults()">
                <i class="fas fa-edit"></i> Edit Results
              </button>
              <button class="nav-btn primary" onclick="useScanResults()">
                <i class="fas fa-check"></i> Use These Preferences
              </button>
            </div>

            <div class="scan-note">
              <small>You can always edit these preferences in the quiz</small>
            </div>
          </div>
        </div>

        <!-- Step 1: Skin Type -->
        <div class="quiz-step" id="step-1">
          <div class="quiz-header">
            <div class="progress-bar">
              <div class="progress-fill" style="width: 20%"></div>
            </div>
            <h2>What's Your Skin Type?</h2>
            <p>This helps us recommend products that work best for your skin</p>
          </div>

          <div class="options-grid">
            <div class="option-card" data-value="normal">
              <div class="option-icon">
                <i class="fas fa-check-circle"></i>
              </div>
              <h3>Normal</h3>
              <p>Balanced, not too oily or dry, few imperfections</p>
            </div>

            <div class="option-card" data-value="oily">
              <div class="option-icon">
                <i class="fas fa-tint"></i>
              </div>
              <h3>Oily</h3>
              <p>Shiny appearance, large pores, prone to breakouts</p>
            </div>

            <div class="option-card" data-value="dry">
              <div class="option-icon">
                <i class="fas fa-leaf"></i>
              </div>
              <h3>Dry</h3>
              <p>Flaky, rough texture, feels tight after washing</p>
            </div>

            <div class="option-card" data-value="combination">
              <div class="option-icon">
                <i class="fas fa-balance-scale"></i>
              </div>
              <h3>Combination</h3>
              <p>Oily T-zone, dry cheeks, mixed characteristics</p>
            </div>

            <div class="option-card" data-value="sensitive">
              <div class="option-icon">
                <i class="fas fa-heartbeat"></i>
              </div>
              <h3>Sensitive</h3>
              <p>Easily irritated, prone to redness and reactions</p>
            </div>
          </div>

          <div class="quiz-nav">
            <button class="nav-btn secondary" onclick="prevStep()">
              <i class="fas fa-arrow-left"></i>
              Back
            </button>
            <button
              class="nav-btn primary"
              id="step1-next"
              onclick="nextStep(2)"
              disabled
            >
              Next
              <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>

        <!-- Step 2: Skin Tone -->
        <div class="quiz-step" id="step-2">
          <div class="quiz-header">
            <div class="progress-bar">
              <div class="progress-fill" style="width: 40%"></div>
            </div>
            <h2>What's Your Skin Tone?</h2>
            <p>Choose the shade that most closely matches your complexion</p>
          </div>

          <div class="skin-tone-options">
            <div class="tone-option" data-value="fair">
              <div class="tone-swatch" style="background: #f8e0c8"></div>
              <span>Fair</span>
            </div>
            <div class="tone-option" data-value="medium">
              <div class="tone-swatch" style="background: #d2a679"></div>
              <span>Medium</span>
            </div>
            <div class="tone-option" data-value="tan">
              <div class="tone-swatch" style="background: #b88c67"></div>
              <span>Tan</span>
            </div>
            <div class="tone-option" data-value="deep">
              <div class="tone-swatch" style="background: #8c6b4f"></div>
              <span>Deep</span>
            </div>
          </div>

          <div class="quiz-nav">
            <button class="nav-btn secondary" onclick="prevStep()">
              <i class="fas fa-arrow-left"></i>
              Back
            </button>
            <button
              class="nav-btn primary"
              id="step2-next"
              onclick="nextStep(3)"
              disabled
            >
              Next
              <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>

        <!-- Step 3: Undertone -->
        <div class="quiz-step" id="step-3">
          <div class="quiz-header">
            <div class="progress-bar">
              <div class="progress-fill" style="width: 60%"></div>
            </div>
            <h2>What's Your Undertone?</h2>
            <p>This helps match foundations and concealers perfectly</p>
          </div>

          <div class="options-grid">
            <div class="option-card" data-value="warm">
              <div class="option-icon">
                <i class="fas fa-sun"></i>
              </div>
              <h3>Warm</h3>
              <p>Yellow, golden, or peachy undertones</p>
            </div>

            <div class="option-card" data-value="cool">
              <div class="option-icon">
                <i class="fas fa-snowflake"></i>
              </div>
              <h3>Cool</h3>
              <p>Pink, red, or bluish undertones</p>
            </div>

            <div class="option-card" data-value="neutral">
              <div class="option-icon">
                <i class="fas fa-adjust"></i>
              </div>
              <h3>Neutral</h3>
              <p>Balance of warm and cool undertones</p>
            </div>

            <div class="option-card" data-value="not-sure">
              <div class="option-icon">
                <i class="fas fa-question"></i>
              </div>
              <h3>Not Sure</h3>
              <p>I'm not sure about my undertone</p>
            </div>
          </div>

          <div class="quiz-nav">
            <button class="nav-btn secondary" onclick="prevStep()">
              <i class="fas fa-arrow-left"></i>
              Back
            </button>
            <button
              class="nav-btn primary"
              id="step3-next"
              onclick="nextStep(4)"
              disabled
            >
              Next
              <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>

        <!-- Step 4: Skin Concerns -->
        <div class="quiz-step" id="step-4">
          <div class="quiz-header">
            <div class="progress-bar">
              <div class="progress-fill" style="width: 80%"></div>
            </div>
            <h2>What Are Your Skin Concerns?</h2>
            <p>Select all that apply (multiple choices allowed)</p>
          </div>

          <div class="concerns-grid">
            <div class="concern-option" data-value="acne">
              <input
                type="checkbox"
                id="concern-acne"
                class="concern-checkbox"
              />
              <label for="concern-acne" class="concern-label">
                <div class="concern-icon">
                  <i class="fas fa-dot-circle"></i>
                </div>
                <h3>Acne & Breakouts</h3>
                <p>Pimples, blackheads, and blemishes</p>
              </label>
            </div>

            <div class="concern-option" data-value="dryness">
              <input
                type="checkbox"
                id="concern-dryness"
                class="concern-checkbox"
              />
              <label for="concern-dryness" class="concern-label">
                <div class="concern-icon">
                  <i class="fas fa-wind"></i>
                </div>
                <h3>Dryness</h3>
                <p>Flaky, dehydrated, or tight skin</p>
              </label>
            </div>

            <div class="concern-option" data-value="dark-spots">
              <input
                type="checkbox"
                id="concern-dark-spots"
                class="concern-checkbox"
              />
              <label for="concern-dark-spots" class="concern-label">
                <div class="concern-icon">
                  <i class="fas fa-circle"></i>
                </div>
                <h3>Dark Spots</h3>
                <p>Hyperpigmentation and uneven tone</p>
              </label>
            </div>

            <div class="concern-option" data-value="aging">
              <input
                type="checkbox"
                id="concern-aging"
                class="concern-checkbox"
              />
              <label for="concern-aging" class="concern-label">
                <div class="concern-icon">
                  <i class="fas fa-clock"></i>
                </div>
                <h3>Aging</h3>
                <p>Fine lines, wrinkles, and firmness</p>
              </label>
            </div>

            <div class="concern-option" data-value="none">
              <input
                type="checkbox"
                id="concern-none"
                class="concern-checkbox"
              />
              <label for="concern-none" class="concern-label">
                <div class="concern-icon">
                  <i class="fas fa-times"></i>
                </div>
                <h3>None</h3>
                <p>No specific concerns</p>
              </label>
            </div>
          </div>

          <div class="quiz-nav">
            <button class="nav-btn secondary" onclick="prevStep()">
              <i class="fas fa-arrow-left"></i>
              Back
            </button>
            <button
              class="nav-btn primary"
              id="step4-next"
              onclick="nextStep(5)"
              disabled
            >
              Next
              <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>

        <!-- Step 5: Product Finish -->
        <div class="quiz-step" id="step-5">
          <div class="quiz-header">
            <div class="progress-bar">
              <div class="progress-fill" style="width: 100%"></div>
            </div>
            <h2>What Product Finish Do You Prefer?</h2>
            <p>Choose your desired makeup finish</p>
          </div>

          <div class="options-grid">
            <div class="option-card" data-value="matte">
              <div class="option-icon">
                <i class="fas fa-circle"></i>
              </div>
              <h3>Matte</h3>
              <p>Flat, shine-free finish</p>
            </div>

            <div class="option-card" data-value="dewy">
              <div class="option-icon">
                <i class="fas fa-circle"></i>
              </div>
              <h3>Dewy</h3>
              <p>Luminous, glowing finish</p>
            </div>

            <div class="option-card" data-value="long-lasting">
              <div class="option-icon">
                <i class="fas fa-shield-alt"></i>
              </div>
              <h3>Long-lasting</h3>
              <p>Stays put all day</p>
            </div>

            <div class="option-card" data-value="dont-care">
              <div class="option-icon">
                <i class="fas fa-infinity"></i>
              </div>
              <h3>Don't Care</h3>
              <p>Any finish is fine</p>
            </div>
          </div>

          <div class="quiz-nav">
            <button class="nav-btn secondary" onclick="prevStep()">
              <i class="fas fa-arrow-left"></i>
              Back
            </button>
            <button
              class="nav-btn primary"
              id="step5-next"
              onclick="showLoading()"
            >
              Get Results
              <i class="fas fa-sparkles"></i>
            </button>
          </div>
        </div>

        <!-- Loading Step -->
        <div class="quiz-step" id="step-loading">
          <div class="loading-container">
            <div class="loading-spinner">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
            <h2>Quiz Complete!</h2>
            <div class="loading-messages">
              <div class="loading-message active">
                <i class="fas fa-check-circle"></i>
                <span>Preparing your product matches...</span>
              </div>
              <div class="loading-message">
                <i class="fas fa-gem"></i>
                <span>Polishing your personalized recommendations...</span>
              </div>
              <div class="loading-message">
                <i class="fas fa-rocket"></i>
                <span>Almost there...</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Results Step -->
        <div class="quiz-step" id="step-results">
          <div class="results-container">
            <div class="results-hero">
              <i class="fas fa-sparkles"></i>
              <h2>Your Personalized Recommendations</h2>
            </div>

            <!-- Filters Section -->
            <div class="filters-section">
              <div class="filters-container">
                <div class="filter-group">
                  <label for="category-filter">Category</label>
                  <select id="category-filter">
                    <option value="all">All Categories</option>
                  </select>
                </div>

                <div class="filter-group">
                  <label for="match-type-filter">Match Type</label>
                  <select id="match-type-filter">
                    <option value="all">All Matches</option>
                    <option value="PERFECT MATCH">Perfect Matches</option>
                    <option value="CLOSE MATCH">Close Matches</option>
                    <option value="NORMAL MATCH">Normal Matches</option>
                  </select>
                </div>

                <div class="filter-group">
                  <label for="sort-by-filter">Sort By</label>
                  <select id="sort-by-filter">
                    <option value="relevance">Relevance</option>
                    <option value="matches">Most Matches</option>
                    <option value="rating">Highest Rated</option>
                    <option value="price-low">Price: Low to High</option>
                    <option value="price-high">Price: High to Low</option>
                  </select>
                </div>
              </div>
            </div>
            <!-- <div id="results-count" class="results-count">
              ... total products found
            </div> -->
            <!-- ADD ALL TO CART BUTTON
            <div class="add-all-container">
              <button id="add-all-to-cart" class="add-all-btn">
                <i class="fas fa-cart-plus"></i>
                Add All to Cart
              </button>
              <div id="add-all-count" class="add-all-count">
                You will add <span id="product-count">0</span> products to your
                cart!
              </div>
            </div> -->

            <div class="recommended-products" id="recommended-products">
              <!-- Products will be dynamically inserted here -->
            </div>

            <div class="results-actions">
              <!-- Quiz date centered above buttons -->
              <div class="quiz-info">
                Based on your quiz from <span id="quiz-date">11/11/2025</span>
              </div>

              <!-- Buttons side by side -->
              <div class="action-buttons">
                <button class="retake-btn" onclick="restartQuiz()">
                  <i class="fas fa-redo"></i>
                  Retake Quiz
                </button>
                <button
                  class="shop-all-btn"
                  onclick="window.location.href='home.html'"
                >
                  Shop All Products
                  <i class="fas fa-shopping-bag"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
        <!-- Camera Modal -->
        <div class="modal-overlay" id="camera-modal">
          <div class="modal-content camera-modal">
            <div class="camera-header">
              <h3>Face Scan</h3>
              <button class="close-btn" onclick="closeCamera()">
                <i class="fas fa-times"></i>
              </button>
            </div>

            <div class="camera-container">
              <video id="camera-video" autoplay playsinline></video>
              <canvas id="camera-canvas" style="display: none"></canvas>
              <div class="face-overlay" id="face-overlay">
                <div class="face-guide"></div>
              </div>
            </div>

            <div class="camera-controls">
              <button class="nav-btn secondary" onclick="closeCamera()">
                Cancel
              </button>
              <button
                class="nav-btn primary"
                id="capture-btn"
                onclick="captureFace()"
              >
                <i class="fas fa-camera"></i> Capture
              </button>
            </div>

            <div class="scan-tips">
              <h4>Tips for best results:</h4>
              <ul>
                <li><i class="fas fa-check"></i> Good lighting</li>
                <li><i class="fas fa-check"></i> Front-facing camera</li>
                <li><i class="fas fa-check"></i> Remove glasses</li>
                <li><i class="fas fa-check"></i> Neutral expression</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Scan Results Modal -->
        <div class="modal-overlay" id="scan-results-modal">
          <div class="modal-content scan-results-modal">
            <div class="scan-header">
              <i class="fas fa-check-circle success"></i>
              <h3>Scan Complete!</h3>
            </div>

            <div class="scan-results" id="scan-results">
              <div class="result-item">
                <span class="result-label">Skin Type:</span>
                <span class="result-value" id="scan-skin-type"
                  >Detecting...</span
                >
              </div>
              <div class="result-item">
                <span class="result-label">Skin Tone:</span>
                <span class="result-value" id="scan-skin-tone"
                  >Detecting...</span
                >
              </div>
              <div class="result-item">
                <span class="result-label">Undertone:</span>
                <span class="result-value" id="scan-undertone"
                  >Detecting...</span
                >
              </div>
              <div class="result-item">
                <span class="result-label">Concerns:</span>
                <div class="result-value" id="scan-concerns">Detecting...</div>
              </div>
            </div>

            <div class="scan-actions">
              <button class="nav-btn secondary" onclick="editScanResults()">
                <i class="fas fa-edit"></i> Edit Results
              </button>
              <button class="nav-btn primary" onclick="useScanResults()">
                <i class="fas fa-check"></i> Use These Preferences
              </button>
            </div>

            <div class="scan-note">
              <small>You can always edit these preferences in the quiz</small>
            </div>
          </div>
        </div>
      </div>

      <div class="quiz-privacy-section">
        <div class="privacy-info-card">
          <div class="privacy-info-header">
            <i class="fas fa-shield-alt"></i>
            <h4>Your Privacy is Protected</h4>
          </div>
          
          <div class="privacy-info-points">
            <div class="privacy-info-point">
              <i class="fas fa-user-check"></i>
              <div>
                <strong>Personalized Recommendations</strong>
                <p>Your preferences help us suggest products that match your unique needs.</p>
              </div>
            </div>
            
            <div class="privacy-info-point">
              <i class="fas fa-database"></i>
              <div>
                <strong>Safe & Secure</strong>
                <p>Skin details are stored securely and used only for your product matches.</p>
              </div>
            </div>
            
            <div class="privacy-info-point">
              <i class="fas fa-video-slash"></i>
              <div>
                <strong>Camera Privacy</strong>
                <p>Face scan runs locally - we never see or store your camera feed.</p>
              </div>
            </div>
            
            <div class="privacy-info-point">
              <i class="fas fa-chart-line"></i>
              <div>
                <strong>No Hidden Tracking</strong>
                <p>We don't share or sell your personal information to third parties.</p>
              </div>
            </div>
          </div>
          
          <div class="privacy-info-footer">
            <button class="privacy-learn-more-btn" onclick="showPrivacyNotice()">
              Learn More About Our Privacy Policy
            </button>
          </div>
        </div>
      </div>
    </div>
    </main>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
      <div class="mobile-nav-items">
        <a href="home.html" class="nav-item" data-page="home">
          <i class="fas fa-home"></i>
          <span>Home</span>
        </a>
        <a href="favorites.html" class="nav-item" data-page="favorites">
          <i class="fas fa-heart"></i>
          <span>Favorites</span>
        </a>
        <a
          href="recommender.html"
          class="nav-item active"
          data-page="recommender"
        >
          <i class="fas fa-star"></i>
          <span>Recommender</span>
        </a>
        <a href="cart.html" class="nav-item" data-page="cart">
          <i class="fas fa-shopping-cart"></i>
          <span>Cart</span>
          <div class="nav-cart-count">0</div>
          <!-- ADD THIS -->
        </a>
        <a href="try-on.html" class="nav-item" data-page="tryon">
          <i class="fas fa-camera"></i>
          <span>Try-On</span>
        </a>
      </div>
    </nav>

    <!-- Add to Cart Confirmation Modal -->
    <div id="add-to-cart-modal" class="modal">
      <div class="modal-content">
        <h3>Add to Cart</h3>
        <p>
          You will add <span id="cart-modal-product-count">0</span> products to
          your cart!
        </p>
        <div class="modal-buttons">
          <button class="modal-btn primary" onclick="confirmAddToCart()">
            <i class="fas fa-cart-plus"></i> Add to Cart
          </button>
          <button class="modal-btn secondary" onclick="closeAddToCartModal()">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="modal">
      <div class="modal-content">
        <div class="success-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <h3 class="success-title" id="success-title">Success!</h3>
        <p class="success-message" id="success-message">
          Products have been added to your cart.
        </p>
        <div class="success-actions">
          <a href="cart.html" class="modal-btn primary">
            <i class="fas fa-shopping-cart"></i> View Cart
          </a>
          <button class="modal-btn secondary" onclick="closeSuccessModal()">
            <i class="fas fa-shopping-bag"></i> Continue Shopping
          </button>
        </div>
      </div>
    </div>

    <!-- Remove style="display: none" from both modals -->
    <div id="existing-prefs-modal" class="modal">
      <div class="modal-content">
        <h3>Existing Preferences Found</h3>
        <p>
          You already have beauty preferences saved from
          <span id="preferences-date">a previous quiz</span>. Would you like to:
        </p>
        <div class="modal-buttons">
          <button
            class="modal-btn secondary"
            onclick="viewCurrentPreferences()"
          >
            <i class="fas fa-eye"></i> View Current Preferences
          </button>
          <button class="modal-btn primary" onclick="replacePreferences()">
            <i class="fas fa-sync"></i> Retake Quiz & Replace
          </button>
          <button
            class="modal-btn cancel-btn"
            onclick="closeExistingPrefsModal()"
          >
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </div>
    </div>

    <div id="current-prefs-modal" class="modal">
      <div class="modal-content">
        <h3>Your Current Preferences</h3>
        <div id="current-preferences-display">
          <!-- Preferences will be loaded here -->
        </div>
        <div class="modal-buttons">
          <button class="modal-btn primary" onclick="closeCurrentPrefsModal()">
            <i class="fas fa-check"></i> Keep Current Preferences
          </button>
          <button
            class="modal-btn secondary"
            onclick="showReplaceConfirmation()"
          >
            <i class="fas fa-sync"></i> Back
          </button>
        </div>
      </div>
    </div>

    <script>
function showPrivacyNotice() {
  const modal = document.getElementById('privacy-modal');
  if (modal) {
    modal.style.display = 'flex';
    
    // Add blur to appropriate container
    const container = document.querySelector('.quiz-container') || 
                      document.querySelector('.photobooth-container');
    if (container) {
      container.style.filter = 'blur(3px)';
      container.style.pointerEvents = 'none';
    }
  }
}

function hidePrivacyNotice() {
  const modal = document.getElementById('privacy-modal');
  if (modal) {
    modal.style.display = 'none';
    
    // Remove blur from all possible containers
    const containers = document.querySelectorAll('.quiz-container, .photobooth-container');
    containers.forEach(container => {
      container.style.filter = 'none';
      container.style.pointerEvents = 'auto';
    });
  }
}

// Make sure this function is also defined
function acceptPrivacy() {
  const dontShowAuto = document.getElementById('privacy-dont-show-auto');
  
  if (dontShowAuto) {
    const dontShow = dontShowAuto.checked;
    
    localStorage.setItem('privacyAccepted', 'true');
    if (dontShow) {
      localStorage.setItem('privacyDontShowAuto', 'true');
    }
  } else {
    // Fallback if checkbox doesn't exist
    localStorage.setItem('privacyAccepted', 'true');
  }
  
  hidePrivacyNotice();
}

      document.addEventListener("DOMContentLoaded", async function () {
        // Add page protection FIRST
        if (typeof setupPageProtection === "function") {
          setupPageProtection();
        }

        // Initialize user session
        await updateUserGreeting();

        if (!currentUser) return;

        // Check if user already has preferences
        await checkExistingPreferences();
        const isRetakingQuiz =
          sessionStorage.getItem("retakingQuiz") === "true";

        // If user has existing preferences, automatically load their results
        if (hasExistingPreferences && currentPreferences && !isRetakingQuiz) {
          await loadExistingUserResults();
        } else {
          // Clear the retake flag and show intro
          sessionStorage.removeItem("retakingQuiz");
          resetToIntro();
        }

        // Continue with other initializations
        updateCartCount();
        initFloatingProduct();
      });

      const understandBtn = document.getElementById('privacy-understand');
  if (understandBtn) {
    understandBtn.addEventListener('click', acceptPrivacy);
  }
  
  // Close modal when clicking outside
  const privacyModal = document.getElementById('privacy-modal');
  if (privacyModal) {
    privacyModal.addEventListener('click', function(e) {
      if (e.target === this) {
        acceptPrivacy(); // Accept privacy if they click outside
      }
    });
  }
  
  // Optional: Show automatically on first visit
  const privacyAccepted = localStorage.getItem("privacyAccepted");
  const dontShowAuto = localStorage.getItem("privacyDontShowAuto");
  
  if (privacyAccepted !== "true" && dontShowAuto !== "true") {
    // Show after a short delay on first visit
    setTimeout(() => {
      showPrivacyNotice();
    }, 1000);
  }
  

      // NEW FUNCTION: Auto-load results for returning users
      async function loadExistingUserResults() {
        try {
          // Show loading state immediately
          nextStep("results");

          const container = document.getElementById("recommended-products");
          container.innerHTML = `
            <div class="loading">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
          `;

          // Use the existing preferences to get recommendations
          const response = await fetch("../php/recommend-products.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              skinType: currentPreferences.skin_type,
              skinTone: currentPreferences.skin_tone,
              undertone: currentPreferences.undertone,
              concerns: JSON.parse(currentPreferences.skin_concerns || "[]"),
              finish: currentPreferences.preferred_finish,
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const text = await response.text();
          let result;

          try {
            result = JSON.parse(text);
          } catch (parseError) {
            throw new Error("Invalid JSON response from server");
          }

          if (result.success && result.recommendations) {
            displayRecommendations(result.recommendations);

            // Update the quiz date at the bottom
            const quizDateElement = document.getElementById("quiz-date");
            if (quizDateElement) {
              quizDateElement.textContent = new Date(
                currentPreferences.updated_at
              ).toLocaleDateString();
            }

            // Keep the header clean and simple
            const resultsHero = document.querySelector(".results-hero");
            if (resultsHero) {
              const existingTitle = resultsHero.querySelector("h2");
              if (existingTitle) {
                existingTitle.textContent = "Your Personalized Recommendations";
              }

              // Remove any existing subtitle
              const existingSubtitle = resultsHero.querySelector("p");
              if (existingSubtitle) {
                existingSubtitle.remove();
              }
            }
          } else {
            showErrorState(
              "No recommendations available for your saved preferences"
            );
          }
        } catch (error) {
          console.error("Error loading existing results:", error);
          showErrorState("Error loading your saved recommendations");
        }
      }

      // Global variable to track if user has existing preferences
      let hasExistingPreferences = false;
      let currentPreferences = null;

      // Check if user already has preferences
      async function checkExistingPreferences() {
        try {
          const response = await fetch("../php/check-user-preferences.php");
          const data = await response.json();

          if (data.success && data.hasPreferences) {
            hasExistingPreferences = true;
            currentPreferences = data.preferences;

            // Return true to indicate preferences exist
            return true;
          }
          return false;
        } catch (error) {
          console.error("Error checking preferences:", error);
          return false;
        }
      }
      function showExistingPrefsModal() {
        // Update the date in the modal if we have currentPreferences
        if (currentPreferences && currentPreferences.updated_at) {
          const dateElement = document.getElementById("preferences-date");
          if (dateElement) {
            const lastUpdated = new Date(
              currentPreferences.updated_at
            ).toLocaleDateString();
            dateElement.textContent = lastUpdated;
          }
        }

        document.getElementById("existing-prefs-modal").classList.add("active");
      }

      let cameraStream = null;

      function cleanupScanSummaries() {
        // Remove any existing scan summaries from ALL possible locations
        const existingSummaries = document.querySelectorAll(".scan-summary");
        existingSummaries.forEach((summary) => {
          summary.remove();
        });

        // Also clean up any summaries that might be in step 5
        const step5 = document.getElementById("step-5");
        if (step5) {
          const step5Summaries = step5.querySelectorAll(".scan-summary");
          step5Summaries.forEach((summary) => summary.remove());
        }
      }

      function startFaceScan() {
        console.log("Starting face scan...");

        // Clean up ANY existing scan summaries before starting new scan
        cleanupScanSummaries();

        // Open camera modal directly
        document.getElementById("camera-modal").classList.add("active");
        initializeCamera();
      }

      function skipToProductFinishStep(scanResults) {
        // Clean up again to be safe
        cleanupScanSummaries();

        // Hide all steps
        document.querySelectorAll(".quiz-step").forEach((step) => {
          step.classList.remove("active");
        });

        // Show Step 5 directly
        document.getElementById("step-5").classList.add("active");

        // Update the progress bar to show all previous steps are completed
        const progressFill = document.querySelector("#step-5 .progress-fill");
        if (progressFill) {
          progressFill.style.width = "100%";
        }

        // Update the header to indicate we're using scan results
        const header = document.querySelector("#step-5 .quiz-header h2");
        if (header) {
          header.innerHTML = "Almost Done! Choose Your Preferred Finish";
        }

        const subheader = document.querySelector("#step-5 .quiz-header p");
        if (subheader) {
          subheader.innerHTML =
            "Your skin analysis is complete. Just tell us your preferred product finish.";
        }

        // Add a small summary of scan results
        addScanSummaryToStep5(scanResults);
      }
      function addScanSummaryToStep5() {
        // Remove any existing scan summaries first
        const existingSummaries = document.querySelectorAll(".scan-summary");
        existingSummaries.forEach((summary) => summary.remove());

        // Create a summary element showing the scan results
        const summaryHtml = `
        <div class="scan-summary" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--primary-pink);">
            <h4 style="margin: 0 0 10px 0; color: var(--text-dark); font-size: 0.9rem;">Your Scan Results:</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.8rem;">
                <div><strong>Skin Type:</strong> ${quizData.skinType}</div>
                <div><strong>Skin Tone:</strong> ${quizData.skinTone}</div>
                <div><strong>Undertone:</strong> ${quizData.undertone}</div>
                <div><strong>Concerns:</strong> ${
                  quizData.concerns && quizData.concerns.length > 0
                    ? quizData.concerns
                        .map((c) => c.replace("-", " "))
                        .join(", ")
                    : "None"
                }</div>
            </div>
        </div>
    `;

        // Insert the summary before the options grid
        const optionsGrid = document.querySelector("#step-5 .options-grid");
        if (optionsGrid) {
          optionsGrid.insertAdjacentHTML("beforebegin", summaryHtml);
        }
      }

      function startFaceScan() {
        cleanupScanSummaries();

        document.getElementById("camera-modal").classList.add("active");
        initializeCamera();
      }
      async function initializeCamera() {
        try {
          console.log("Requesting camera access...");

          cameraStream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: "user",
              width: { ideal: 1280 },
              height: { ideal: 720 },
            },
          });

          const video = document.getElementById("camera-video");
          video.srcObject = cameraStream;

          // Wait for video to be ready
          video.onloadedmetadata = () => {
            document.getElementById("capture-btn").disabled = false;
          };

          video.onerror = (error) => {
            console.error("Video error:", error);
          };
        } catch (error) {
          console.error("Camera error:", error);
          alert("Unable to access camera. Please check permissions.");
          closeCamera();
        }
      }

      function closeCamera() {
        // Stop camera stream
        if (cameraStream) {
          cameraStream.getTracks().forEach((track) => track.stop());
          cameraStream = null;
        }

        // Close modal
        document.getElementById("camera-modal").classList.remove("active");
      }

      function captureFace() {
        const video = document.getElementById("camera-video");
        const canvas = document.getElementById("camera-canvas");
        const context = canvas.getContext("2d");

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = canvas.toDataURL("image/jpeg");
        closeCamera();

        // Show loading in results modal
        document.getElementById("scan-results-modal").classList.add("active");
        showScanLoadingState();

        // Send to backend for analysis
        analyzeFace(imageData);
      }
      function showScanLoadingState() {
        document.getElementById("scan-skin-type").textContent = "Analyzing...";
        document.getElementById("scan-skin-tone").textContent = "Analyzing...";
        document.getElementById("scan-undertone").textContent = "Analyzing...";
        document.getElementById("scan-concerns").innerHTML =
          '<span style="color: #666;">Analyzing...</span>';
      }

      async function analyzeFace(imageData) {
        try {
          const response = await fetch(
            "http://localhost:5000/analyze-skin-complete",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                image: imageData,
              }),
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const text = await response.text();

          let result;
          try {
            result = JSON.parse(text);
          } catch (parseError) {
            console.error("JSON parse error:", parseError);
            throw new Error("Invalid response from Python server");
          }

          if (result.success) {
            // Map Python response to your expected format
            const mappedResults = {
              skinType: result.skin_analysis.skin_type,
              skinTone: result.skin_analysis.tone,
              undertone: result.skin_analysis.undertone,
              concerns: result.skin_analysis.concerns,
            };

            displayScanResults(mappedResults);
          } else {
            console.error("Python analysis failed:", result.error);
            throw new Error(result.error || "Skin analysis failed");
          }
        } catch (error) {
          console.error("Python analysis error:", error);

          analyzeFaceWithPHP(imageData);
        }
      }

      // Keep your existing PHP fallback
      async function analyzeFaceWithPHP(imageData) {
        try {
          const response = await fetch("../php/analyze-face.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              image: imageData,
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const text = await response.text();

          let result;
          try {
            result = JSON.parse(text);
          } catch (parseError) {
            console.error("JSON parse error:", parseError);
            throw new Error("Invalid response from server");
          }

          if (result.success) {
            displayScanResults(result.analysis);
          } else {
            console.error("PHP analysis failed:", result.error);
            throw new Error(result.error || "Face analysis failed");
          }
        } catch (error) {
          console.error("PHP analysis error:", error);
          // Final fallback to default values
          displayScanResults(getDefaultScanResults());
        }
      }
      function getDefaultScanResults() {
        return {
          skinType: "Normal",
          skinTone: "Medium",
          undertone: "Neutral",
          concerns: [],
        };
      }

      function displayScanResults(analysis) {
        // Validate and map the results to our allowed values
        const validatedResults = validateScanResults(analysis);

        document.getElementById("scan-skin-type").textContent =
          validatedResults.skinType;
        document.getElementById("scan-skin-tone").textContent =
          validatedResults.skinTone;
        document.getElementById("scan-undertone").textContent =
          validatedResults.undertone;

        const concernsElement = document.getElementById("scan-concerns");
        if (validatedResults.concerns && validatedResults.concerns.length > 0) {
          concernsElement.innerHTML = validatedResults.concerns
            .map((concern) => `<span class="concern-tag">${concern}</span>`)
            .join("");
        } else {
          concernsElement.innerHTML =
            '<span style="color: #666;">None detected</span>';
        }
      }
      function validateScanResults(analysis) {
        // Allowed values for each category
        const allowedSkinTypes = [
          "Normal",
          "Oily",
          "Dry",
          "Combination",
          "Sensitive",
        ];
        const allowedSkinTones = ["Fair", "Medium", "Tan", "Deep"];
        const allowedUndertones = ["Warm", "Cool", "Neutral"];
        const allowedConcerns = ["acne", "dryness", "dark-spots", "aging"];

        // Validate and correct skin type
        let skinType = analysis.skinType || "Normal";
        if (!allowedSkinTypes.includes(skinType)) {
          skinType = "Normal"; // Default fallback
        }

        // Validate and correct skin tone
        let skinTone = analysis.skinTone || "Medium";
        if (!allowedSkinTones.includes(skinTone)) {
          if (skinTone === "Light") skinTone = "Fair";
          else if (skinTone === "Olive") skinTone = "Medium";
          else skinTone = "Medium";
        }

        // Validate and correct undertone
        let undertone = analysis.undertone || "Neutral";
        if (!allowedUndertones.includes(undertone)) {
          undertone = "Neutral";
        }

        // Validate concerns
        let concerns = analysis.concerns || [];
        concerns = concerns.filter((concern) =>
          allowedConcerns.includes(concern)
        );

        return {
          skinType,
          skinTone,
          undertone,
          concerns,
        };
      }

      function useScanResults() {
        try {
          closeCamera();

          // Get the validated scan results and update quizData
          quizData.skinType = document
            .getElementById("scan-skin-type")
            .textContent.trim();
          quizData.skinTone = document
            .getElementById("scan-skin-tone")
            .textContent.trim();
          quizData.undertone = document
            .getElementById("scan-undertone")
            .textContent.trim();
          quizData.concerns = Array.from(
            document.querySelectorAll("#scan-concerns .concern-tag")
          ).map((tag) =>
            tag.textContent.trim().toLowerCase().replace(" ", "-")
          );
          quizData.finish = ""; // Will be set in step 5

          document
            .getElementById("scan-results-modal")
            .classList.remove("active");
          skipToProductFinishStep();
        } catch (error) {
          console.error("Error in useScanResults:", error);
          // Proceed silently since data will save anyway
          document
            .getElementById("scan-results-modal")
            .classList.remove("active");
          skipToProductFinishStep();
        }
      }
      function closeCamera() {
        // Stop camera stream
        if (cameraStream) {
          cameraStream.getTracks().forEach((track) => {
            console.log("Stopping track:", track.kind);
            track.stop();
          });
          cameraStream = null;
        }

        // Clear video source
        const video = document.getElementById("camera-video");
        if (video) {
          video.srcObject = null;
        }

        // Close modal
        document.getElementById("camera-modal").classList.remove("active");
      }
      // Close camera when page is unloaded (user leaves)
      window.addEventListener("beforeunload", function () {
        closeCamera();
      });

      function skipToProductFinishStep() {
        // Hide all steps
        document.querySelectorAll(".quiz-step").forEach((step) => {
          step.classList.remove("active");
        });

        // Show Step 5 directly
        document.getElementById("step-5").classList.add("active");

        // Update the progress bar to show all previous steps are completed
        const progressFill = document.querySelector("#step-5 .progress-fill");
        if (progressFill) {
          progressFill.style.width = "100%";
        }

        // Update the header to indicate we're using scan results
        const header = document.querySelector("#step-5 .quiz-header h2");
        if (header) {
          header.innerHTML = "Almost Done! Choose Your Preferred Finish";
        }

        const subheader = document.querySelector("#step-5 .quiz-header p");
        if (subheader) {
          subheader.innerHTML =
            "Your skin analysis is complete. Just tell us your preferred product finish.";
        }

        // Add a small summary of scan results
        addScanSummaryToStep5();
      }

      function addScanSummaryToStep5(scanResults) {
        // Final cleanup check
        cleanupScanSummaries();

        // Create a summary element showing the scan results
        const summaryHtml = `
        <div class="scan-summary" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--primary-pink);">
            <h4 style="margin: 0 0 10px 0; color: var(--text-dark); font-size: 0.9rem;">Your Scan Results:</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.8rem;">
                <div><strong>Skin Type:</strong> ${scanResults.skinType}</div>
                <div><strong>Skin Tone:</strong> ${scanResults.skinTone}</div>
                <div><strong>Undertone:</strong> ${scanResults.undertone}</div>
                <div><strong>Concerns:</strong> ${
                  scanResults.concerns.length > 0
                    ? scanResults.concerns
                        .map((c) => c.replace("-", " "))
                        .join(", ")
                    : "None"
                }</div>
            </div>
        </div>
    `;

        // Insert the summary before the options grid
        const optionsGrid = document.querySelector("#step-5 .options-grid");
        if (optionsGrid) {
          optionsGrid.insertAdjacentHTML("beforebegin", summaryHtml);
        }
      }

      function editScanResults() {
        // Make sure camera is turned off
        closeCamera();

        // Close scan results and start manual quiz without pre-filling
        document
          .getElementById("scan-results-modal")
          .classList.remove("active");
        startQuizWithCheck();
      }

      function startQuizWithCheck() {
        // Check both possible flags
        const bypassCheck =
          sessionStorage.getItem("bypassPreferencesCheck") === "true" ||
          sessionStorage.getItem("retakingQuiz") === "true";

        if (hasExistingPreferences && !bypassCheck) {
          showExistingPrefsModal();
        } else {
          // Clear both flags
          sessionStorage.removeItem("bypassPreferencesCheck");
          sessionStorage.removeItem("retakingQuiz");
          nextStep(1); // Start quiz normally
        }
      }
      function showStep(stepId) {
        // Hide all steps
        document.querySelectorAll(".quiz-step").forEach((step) => {
          step.classList.remove("active");
        });

        // Show current step
        document.getElementById(stepId).classList.add("active");

        // Add scrollable class to body when on results page
        if (stepId === "step-results") {
          document.body.classList.add("step-results-active");
        } else {
          document.body.classList.remove("step-results-active");
        }
      }

      function showExistingPrefsModal() {
        const modal = document.getElementById("existing-prefs-modal");
        const startOverBtn = document.getElementById("start-over-btn");

        // Set up the start over button
        if (startOverBtn) {
          startOverBtn.onclick = function () {
            resetQuizAndRestart();
            closeModal();
          };
        }

        modal.classList.add("active");
      }

      function closeExistingPrefsModal() {
        document
          .getElementById("existing-prefs-modal")
          .classList.remove("active");
      }

      function viewCurrentPreferences() {
        closeExistingPrefsModal();
        showCurrentPreferences();
      }

      function showCurrentPreferences() {
        const display = document.getElementById("current-preferences-display");

        if (currentPreferences) {
          display.innerHTML = `
                        <div class="preference-item">
                          <span class="preference-label">Skin Type:</span>
                          <span class="preference-value">${
                            currentPreferences.skin_type
                          }</span>
                        </div>
                        <div class="preference-item">
                          <span class="preference-label">Skin Tone:</span>
                          <span class="preference-value">${
                            currentPreferences.skin_tone
                          }</span>
                        </div>
                        <div class="preference-item">
                          <span class="preference-label">Undertone:</span>
                          <span class="preference-value">${
                            currentPreferences.undertone
                          }</span>
                        </div>
                        <div class="preference-item">
                          <span class="preference-label">Preferred Finish:</span>
                          <span class="preference-value">${
                            currentPreferences.preferred_finish
                          }</span>
                        </div>
                        <div class="preference-item">
                          <span class="preference-label">Skin Concerns:</span>
                          <div class="concerns-list">
                            ${JSON.parse(
                              currentPreferences.skin_concerns || "[]"
                            )
                              .map(
                                (concern) =>
                                  `<span class="concern-tag">${concern}</span>`
                              )
                              .join("")}
                          </div>
                        </div>
                        <div class="preference-item">
                          <span class="preference-label">Last Updated:</span>
                          <span class="preference-value">${new Date(
                            currentPreferences.updated_at
                          ).toLocaleDateString()}</span>
                        </div>
                      `;
        }

        document.getElementById("current-prefs-modal").classList.add("active");
      }

      function closeCurrentPrefsModal() {
        document
          .getElementById("current-prefs-modal")
          .classList.remove("active");
        // Make sure we're showing results, not quiz
        if (hasExistingPreferences && currentPreferences) {
          loadExistingUserResults();
        }
      }

      function showReplaceConfirmation() {
        closeCurrentPrefsModal();
        showExistingPrefsModal();
      }

      function replacePreferences() {
        closeExistingPrefsModal();
        resetQuizAndRestart();
      }

      async function showResults() {
        nextStep("results");

        // Show loading state
        const container = document.getElementById("recommended-products");
        container.innerHTML = `
                      <div class="loading">
                          <i class="fas fa-spinner fa-spin"></i>
                          <h3>Finding your perfect matches...</h3>
                          <p>Analyzing ${quizData.concerns.length} concerns across our product database</p>
                      </div>
                      `;

        try {
          const saveSuccess = await saveUserPreferences();

          if (!saveSuccess) {
            console.warn(
              " Failed to save preferences, but continuing with recommendations"
            );
          } else {
            console.log(" Preferences saved successfully");
          }

          // THEN: Get recommendations
          const response = await fetch("../php/recommend-products.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              skinType: quizData.skinType,
              skinTone: quizData.skinTone,
              undertone: quizData.undertone,
              concerns: quizData.concerns,
              finish: quizData.finish,
            }),
          });

          // Check if response is OK before parsing JSON
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const text = await response.text();

          let result;
          try {
            result = JSON.parse(text);
          } catch (parseError) {
            console.error(" JSON parse error:", parseError);
            throw new Error("Invalid JSON response from server");
          }

          if (result.error) {
            console.warn(" ML system error, using fallback:", result.error);
          }

          if (result.success && result.recommendations) {
            displayRecommendations(result.recommendations);
          } else {
            showErrorState("No recommendations available");
          }
        } catch (error) {
          console.error("Error getting recommendations:", error);
          showErrorState("Connection error - please try again");
        }
      }

      function showErrorState(
        message = "We're still building our product database. Check back soon!"
      ) {
        const container = document.getElementById("recommended-products");
        container.innerHTML = `
                          <div class="no-results">
                              <i class="fas fa-search"></i>
                              <h3>No Perfect Matches Found</h3>
                              <p>${message}</p>
                              <button class="btn-primary" onclick="showResults()">
                                  <i class="fas fa-redo"></i> Try Again
                              </button>
                          </div>
                      `;
      }
      async function loadUserRatings() {
        try {
          const response = await fetch(
            "../php/feedback.php?action=get_user_ratings"
          );
          const result = await response.json();

          if (result.success && result.ratings) {
            // Merge ratings into product data - KEEP AS TEXT
            result.ratings.forEach((rating) => {
              const productId = rating.ProductID;

              if (window.productData && window.productData[productId]) {
                // CRITICAL FIX: Store RecommendationFeedback as TEXT, not numeric
                window.productData[productId].user_feedback = {
                  UserRating: rating.UserRating,
                  RecommendationFeedback: rating.RecommendationFeedback, // Keep as TEXT "Good"/"Okay"/"Poor"
                  CreatedAt: rating.CreatedAt,
                };

                console.log(
                  ` Set feedback for ${productId}:`,
                  rating.RecommendationFeedback
                );
              }
            });

            // Refresh ALL feedback buttons after loading ratings
            refreshAllFeedbackButtons();

            debugFeedbackState();

            // Also refresh the display if needed
            if (window.currentPage) {
              showPage(window.currentPage);
            }
          }
        } catch (error) {
          console.error("Error loading user ratings:", error);
        }
      }

      // FIXED: Refresh all buttons with TEXT feedback
      function refreshAllFeedbackButtons() {
        if (!window.productData) return;

        Object.keys(window.productData).forEach((productId) => {
          const product = window.productData[productId];
          if (product.user_feedback) {
            updateFeedbackButtons(
              productId,
              product.user_feedback.RecommendationFeedback
            );
          }
        });
      }
      function debugFeedbackState() {
        if (!window.productData) return;

        Object.keys(window.productData).forEach((productId) => {
          const product = window.productData[productId];
          if (product.user_feedback) {
          }
        });
      }

      // Update your existing displayRecommendations function
      function displayRecommendations(recommendations) {
        const container = document.getElementById("recommended-products");

        if (
          !recommendations ||
          !Array.isArray(recommendations) ||
          recommendations.length === 0
        ) {
          container.innerHTML = `
            <div class="no-results">
                <i class="fas fa-search"></i>
                <h3>No Perfect Matches Found</h3>
                <p>We're still building our product database. Check back soon!</p>
            </div>
        `;
          return;
        }

        // Store all recommendations globally for pagination
        window.allRecommendations = recommendations;

        //  STORE ORIGINAL PYTHON-SORTED RECOMMENDATIONS
        window.originalPythonSorted = [...recommendations]; // Keep the original order from Python

        window.currentPage = 1;
        window.productsPerPage = 20;

        // Store product data for sorting
        if (!window.productData) window.productData = {};
        recommendations.forEach((product) => {
          window.productData[product.id] = product;
        });

        // Show first page
        showPage(1);

        // Set default sort to "relevance"
        const sortSelect = document.getElementById("sort-by-filter");
        if (sortSelect) {
          sortSelect.value = "relevance";
        }

        // Load categories and setup filters
        loadCategoriesIntoFilter().then(() => {
          setupFilters();
          updateResultsCount(recommendations.length);
        });
        loadUserRatings();
      }

      function showPage(page) {
        const container = document.getElementById("recommended-products");

        // Use filtered results if available, otherwise use all recommendations
        const recommendationsToShow =
          window.filteredRecommendations || window.allRecommendations;

        // Categorize products
        const allSpecific = recommendationsToShow.filter((product) => {
          const category = (product.Category || "").toLowerCase();
          return [
            "blush",
            "concealer",
            "foundation",
            "powder",
            "face care",
            "lipstick",
            "liptint",
            "serum",
            "moisturizer",
            "treatment",
            "cream",
            "lotion",
            "toner",
          ].some((cat) => category.includes(cat));
        });

        const allUniversal = recommendationsToShow.filter((product) => {
          const category = (product.Category || "").toLowerCase();
          return ![
            "blush",
            "concealer",
            "foundation",
            "powder",
            "face care",
            "lipstick",
            "liptint",
            "serum",
            "moisturizer",
            "treatment",
            "cream",
            "lotion",
            "toner",
          ].some((cat) => category.includes(cat));
        });

        const productsPerCategory = Math.floor(window.productsPerPage / 2);
        const specificStart = (page - 1) * productsPerCategory;
        const universalStart = (page - 1) * productsPerCategory;

        const specificProducts = allSpecific.slice(
          specificStart,
          specificStart + productsPerCategory
        );
        const universalProducts = allUniversal.slice(
          universalStart,
          universalStart + productsPerCategory
        );

        let html = "";

        // 1. SPECIFIC PRODUCTS SECTION (always expanded)
        if (specificProducts.length > 0) {
          html += `
                  <div class="recommendations-section specific-section">
                      <div class="section-divider">
                          <div class="section-divider-content" data-tooltip="Products specifically tailored to your skin type, tone, and concerns">
                              Specific Products
                          </div>
                      </div>
                      <div class="results-count-subtle">Showing ${
                        specificStart + 1
                      }-${specificStart + specificProducts.length} of ${
            allSpecific.length
          }</div>
                      <div class="recommendations-grid">
              `;
          specificProducts.forEach((product) => {
            html += generateProductCard(product);
          });
          html += `</div></div>`;
        }

        // 2. UNIVERSAL PRODUCTS SECTION (collapsible)
        if (allUniversal.length > 0) {
          const wasExpanded = window.universalSectionExpanded || false;
          const expandedClass = wasExpanded ? "expanded" : "";
          const displayStyle = wasExpanded ? "" : "display: none;";
          const universalText = wasExpanded
            ? `Showing ${universalStart + 1}-${
                universalStart + universalProducts.length
              } of ${allUniversal.length}`
            : "Click to view universal products";

          html += `
                  <div class="recommendations-section universal-section ${expandedClass}">
                      <div class="section-divider" onclick="toggleUniversalSection()">
                          <div class="section-divider-content" data-tooltip="Tools and products that work beautifully for everyone">
                              Universal Products
                              <span class="toggle-icon"></span>
                          </div>
                      </div>
                      ${
                        wasExpanded
                          ? `<div class="results-count-subtle">${universalText}</div>`
                          : ""
                      }
                      <div class="recommendations-grid" style="${displayStyle}">
              `;
          universalProducts.forEach((product) => {
            html += generateProductCard(product);
          });
          html += `</div></div>`;
        }

        html += createPaginationHTML(page);
        container.innerHTML = html;
        window.currentPage = page;
        setupPaginationEvents();
      }

      // Toggle function for Universal section - FIXED VERSION
      function toggleUniversalSection() {
        const universalSection = document.querySelector(".universal-section");
        if (universalSection) {
          universalSection.classList.toggle("expanded");

          // Store the state
          window.universalSectionExpanded =
            universalSection.classList.contains("expanded");

          // Get the recommendations grid
          const recommendationsGrid = universalSection.querySelector(
            ".recommendations-grid"
          );
          const resultsCount = universalSection.querySelector(
            ".results-count-subtle"
          );

          if (window.universalSectionExpanded) {
            // Show the grid
            recommendationsGrid.style.display = "grid";

            // Update the results count
            const recommendationsToShow =
              window.filteredRecommendations || window.allRecommendations;
            const allUniversal = recommendationsToShow.filter((product) => {
              const category = (product.Category || "").toLowerCase();
              return ![
                "blush",
                "concealer",
                "foundation",
                "powder",
                "face care",
                "lipstick",
                "liptint",
                "serum",
                "moisturizer",
                "treatment",
                "cream",
                "lotion",
                "toner",
              ].some((cat) => category.includes(cat));
            });

            const productsPerCategory = Math.floor(window.productsPerPage / 2);
            const universalStart =
              (window.currentPage - 1) * productsPerCategory;
            const universalProducts = allUniversal.slice(
              universalStart,
              universalStart + productsPerCategory
            );

            if (!resultsCount) {
              const divider =
                universalSection.querySelector(".section-divider");
              divider.insertAdjacentHTML(
                "afterend",
                `<div class="results-count-subtle">Showing ${
                  universalStart + 1
                }-${universalStart + universalProducts.length} of ${
                  allUniversal.length
                }</div>`
              );
            } else {
              resultsCount.textContent = `Showing ${universalStart + 1}-${
                universalStart + universalProducts.length
              } of ${allUniversal.length}`;
            }
          } else {
            // Hide the grid
            recommendationsGrid.style.display = "none";

            // Remove the results count
            if (resultsCount) {
              resultsCount.remove();
            }
          }
        }
      }

      // Initialize universal section state
      window.universalSectionExpanded = false;

      function createPaginationHTML(currentPage = window.currentPage) {
        // Use filtered results if available, otherwise use all recommendations
        const recommendationsToShow =
          window.filteredRecommendations || window.allRecommendations;

        // Calculate total pages based on the largest category
        const allPersonalized = recommendationsToShow.filter((product) => {
          const category = (product.Category || "").toLowerCase();
          return [
            "blush",
            "concealer",
            "foundation",
            "powder",
            "face care",
            "lipstick",
            "liptint",
            "serum",
            "moisturizer",
            "treatment",
            "cream",
            "lotion",
            "toner",
          ].some((cat) => category.includes(cat));
        });

        const allUniversal = recommendationsToShow.filter((product) => {
          const category = (product.Category || "").toLowerCase();
          return ![
            "blush",
            "concealer",
            "foundation",
            "powder",
            "face care",
            "lipstick",
            "liptint",
            "serum",
            "moisturizer",
            "treatment",
            "cream",
            "lotion",
            "toner",
          ].some((cat) => category.includes(cat));
        });

        const productsPerCategory = Math.floor(window.productsPerPage / 2);
        const personalizedPages = Math.ceil(
          allPersonalized.length / productsPerCategory
        );
        const universalPages = Math.ceil(
          allUniversal.length / productsPerCategory
        );
        const totalPages = Math.max(personalizedPages, universalPages);

        if (totalPages <= 1) {
          return "";
        }

        return `
              <div class="pagination-controls">
                  <button id="prev-page" class="pagination-btn" ${
                    currentPage === 1 ? "disabled" : ""
                  }>
                       Previous
                  </button>
                  <span class="page-info">Page ${currentPage} of ${totalPages}</span>
                  <button id="next-page" class="pagination-btn" ${
                    currentPage === totalPages ? "disabled" : ""
                  }>
                      Next 
                  </button>
              </div>
          `;
      }

      // Setup pagination event listeners - FIXED: Use same calculation method
      function setupPaginationEvents() {
        const prevBtn = document.getElementById("prev-page");
        const nextBtn = document.getElementById("next-page");

        if (prevBtn) {
          prevBtn.onclick = (e) => {
            e.preventDefault();

            if (window.currentPage > 1) {
              showPage(window.currentPage - 1);
            }
          };
        }

        if (nextBtn) {
          nextBtn.onclick = (e) => {
            e.preventDefault();

            // Use the SAME calculation method as createPaginationHTML
            const allPersonalized = window.allRecommendations.filter(
              (product) => {
                const category = (product.Category || "").toLowerCase();
                return [
                  "blush",
                  "concealer",
                  "foundation",
                  "powder",
                  "face care",
                  "lipstick",
                  "liptint",
                  "serum",
                  "moisturizer",
                  "treatment",
                  "cream",
                  "lotion",
                  "toner",
                ].some((cat) => category.includes(cat));
              }
            );

            const allUniversal = window.allRecommendations.filter((product) => {
              const category = (product.Category || "").toLowerCase();
              return ![
                "blush",
                "concealer",
                "foundation",
                "powder",
                "face care",
                "lipstick",
                "liptint",
                "serum",
                "moisturizer",
                "treatment",
                "cream",
                "lotion",
                "toner",
              ].some((cat) => category.includes(cat));
            });

            const productsPerCategory = Math.floor(window.productsPerPage / 2);
            const personalizedPages = Math.ceil(
              allPersonalized.length / productsPerCategory
            );
            const universalPages = Math.ceil(
              allUniversal.length / productsPerCategory
            );
            const totalPages = Math.max(personalizedPages, universalPages);

            if (window.currentPage < totalPages) {
              showPage(window.currentPage + 1);
            }
          };
        }
      }
      function generateProductCard(product) {
        const cleanName = product.Name
          ? product.Name.replace(/Parent Record:/gi, "")
              .replace(/Product Record:/gi, "")
              .replace(/:/g, "")
              .trim()
          : "Unnamed Product";

        // NEW: Get shade/variant name
        const shadeName = product.ShadeOrVariant
          ? product.ShadeOrVariant.trim()
          : "";

        // NEW: Combine product name and shade (if available)
        const displayName = shadeName
          ? `${cleanName}  ${shadeName}`
          : cleanName;

        const matchType = product.Match_Type || "NORMAL MATCH";
        const ratingQuality = product.Rating_Quality || "UNRATED";
        const price = product.Price
          ? parseFloat(product.Price).toFixed(2)
          : "0.00";
        const category = product.Category || "Uncategorized";
        const attributeMatches = product.Attribute_Matches || {};

        // Get PRODUCT rating (from products table), not recommendation rating
        const productRating =
          product.productrating || product.ProductRating || 0;

        let imagePath =
          product.image && product.image !== "null"
            ? product.image
            : "/admin/uploads/product_images/no-image.png";

        const attributeHTML = generateAttributeMatchesHTML(
          attributeMatches,
          product.id
        );

        if (!window.productData) window.productData = {};
        window.productData[product.id] = product;

        // Build PRODUCT rating HTML (from products table)
        let productRatingHTML = "";
        if (productRating && productRating > 0) {
          const fullStars = Math.floor(productRating);
          const hasHalfStar = productRating % 1 >= 0.5;

          productRatingHTML = `
        <div class="user-rating">
            <div class="stars">
                ${Array.from({ length: 5 }, (_, i) => {
                  if (i < fullStars) {
                    return '<i class="fas fa-star active"></i>';
                  } else if (i === fullStars && hasHalfStar) {
                    return '<i class="fas fa-star-half-alt active"></i>';
                  } else {
                    return '<i class="far fa-star"></i>';
                  }
                }).join("")}
            </div>
            <span class="rating-text">${parseFloat(productRating).toFixed(
              1
            )}</span>
        </div>
    `;
        } else {
          productRatingHTML = `
        <div class="user-rating no-ratings">
            <div class="stars">
                <i class="far fa-star"></i>
                <i class="far fa-star"></i>
                <i class="far fa-star"></i>
                <i class="far fa-star"></i>
                <i class="far fa-star"></i>
            </div>
            <span class="rating-text">No ratings</span> 
        </div>
    `;
        }
        // SIMPLIFIED: Only show "You liked this" for good recommendation matches
        const existingFeedback = product.user_feedback;
        const hasUserFeedback =
          existingFeedback &&
          existingFeedback.RecommendationFeedback !== undefined;

        // In generateProductCard function
        let feedbackIndicator = "";

        // Get collaborative data - handle different formats
        let collaborativeData = product.collaborative_data || {};
        if (
          Array.isArray(collaborativeData) &&
          collaborativeData.length === 0
        ) {
          collaborativeData = {};
        } else if (
          Array.isArray(collaborativeData) &&
          collaborativeData.length > 0
        ) {
          collaborativeData = collaborativeData[0];
        }

        // 1. Personal feedback (highest priority) - ONLY show for "Good" ratings
        if (hasUserFeedback) {
          const userRating = existingFeedback.RecommendationFeedback;

          // ONLY show for "Good" ratings (remove okay/poor indicators)
          if (userRating === "Good" || userRating === 1) {
            feedbackIndicator = `
                <div class="feedback-indicator personal">
                    <i class="fas fa-heart"></i>
                    <small>You liked this</small>
                </div>
            `;
          }
          // Remove the else-if for "Okay" and "Poor" ratings
        }

        // 2. Similar users liked it (medium priority) - ONLY if no personal rating
        else if (
          collaborativeData.similar_users_liked &&
          collaborativeData.similar_users_liked >= 70
        ) {
          feedbackIndicator = `
            <div class="feedback-indicator similar-users">
                <i class="fas fa-users"></i>
                <small>${collaborativeData.similar_users_liked}% of users like you loved this!</small>
            </div>
        `;
        } else if (
          collaborativeData.similar_users_liked &&
          collaborativeData.similar_users_liked >= 50
        ) {
          feedbackIndicator = `
            <div class="feedback-indicator similar-users">
                <i class="fas fa-users"></i>
                <small>${collaborativeData.similar_users_liked}% of similar users liked this</small>
            </div>
        `;
        }
        // 3. Global popularity (fallback when no similar users) - ONLY if no personal rating
        else if (
          collaborativeData.global_popularity &&
          collaborativeData.global_popularity >= 80
        ) {
          feedbackIndicator = `
            <div class="feedback-indicator global-popular">
                <i class="fas fa-star"></i>
                <small>${collaborativeData.global_popularity}% of all users loved this</small>
            </div>
        `;
        } else if (
          collaborativeData.global_popularity &&
          collaborativeData.global_popularity >= 60
        ) {
          feedbackIndicator = `
            <div class="feedback-indicator global-popular">
                <i class="fas fa-star"></i>
                <small>Popular choice (${collaborativeData.global_popularity}% liked)</small>
            </div>
        `;
        }

        return `
        <div class="product-card" data-product-id="${product.id}">
            <!-- Match Quality Badge -->
            <div class="match-badge ${getMatchBadgeClass(
              matchType
            )}">${matchType}</div>
            
            <!-- Rating Quality Badge -->
            <div class="rating-badge ${getRatingBadgeClass(
              ratingQuality
            )}">${ratingQuality}</div>
            
            <div class="product-image-container">
                <img src="${imagePath}" alt="${displayName}" class="product-image"
                     onerror="handleImageError(this)">
            </div>
            
            <div class="product-info">
                <!-- CHANGED: Use displayName instead of cleanName -->
                <h4 class="product-name">${displayName}</h4>
                <p class="product-category">${category}  ${price}</p>
                
                <!-- Subtle "You liked this" indicator (recommendation feedback) -->
                ${feedbackIndicator}
                
                <!-- Attribute Matches Section -->
                ${attributeHTML}
                
                <!-- PRODUCT Ratings Section (from products table) -->
                ${productRatingHTML}
                
                <div class="product-actions">
                    <button class="btn-primary add-to-cart-btn" onclick="addRecommendedToCart('${
                      product.id
                    }', event)">
                        <i class="fas fa-shopping-cart"></i>
                    </button>
                    <button class="btn-secondary view-details-btn" onclick="viewProductDetails('${
                      product.id
                    }')">
                        <i class="fas fa-eye"></i> Details
                    </button>
                </div>
            </div>
        </div>
    `;
      }
      function generateAttributeMatchesHTML(attributeMatches, productId) {
        if (!attributeMatches || Object.keys(attributeMatches).length === 0) {
          return "";
        }

        // FIXED: Count total attributes correctly (Skin Concerns counts as 1)
        const totalAttributes = 5; // skin_type, skin_tone, undertone, finish, concerns
        const matchCount = countMatches(attributeMatches);

        let html = `
                <div class="attribute-summary" data-product-id="${productId}">
                    <div class="attribute-header">
                        <span class="attribute-text">${matchCount}/${totalAttributes} Matches</span>
                        <span class="attribute-toggle"></span>
                    </div>
                </div>
              `;

        return html;
      }
      function createExternalFloatingCard(attributeMatches, productData) {
        if (!attributeMatches || Object.keys(attributeMatches).length === 0) {
          return "";
        }

        let html = "";

        const addAttribute = (label, productValue, userValue, match) => {
          let isMatch = match;
          if (
            userValue.toLowerCase().includes("don't care") ||
            userValue.toLowerCase().includes("none")
          ) {
            isMatch = true;
          }

          return `
            <div class="attribute-detail-clean ${
              isMatch ? "match" : "no-match"
            }">
                <div class="attribute-line">
                    <span class="attribute-label-clean">${label}</span>
                    <div class="attribute-values">
                        <span class="product-value-clean">${productValue}</span>
                        <span class="separator"></span>
                        <span class="user-value-clean">${userValue}</span>
                    </div>
                </div>
                <span class="detail-status-clean">${isMatch ? "" : ""}</span>
            </div>
        `;
        };

        // --- Core Attributes ---
        if (attributeMatches.skin_type) {
          const match = attributeMatches.skin_type;
          html += addAttribute(
            "Skin Type",
            match.product_value,
            match.user_value,
            match.match
          );
        }

        if (attributeMatches.skin_tone) {
          const match = attributeMatches.skin_tone;
          html += addAttribute(
            "Skin Tone",
            match.product_value,
            match.user_value,
            match.match
          );
        }

        if (attributeMatches.undertone) {
          const match = attributeMatches.undertone;
          html += addAttribute(
            "Undertone",
            match.product_value,
            match.user_value,
            match.match
          );
        }

        if (attributeMatches.finish) {
          const match = attributeMatches.finish;
          html += addAttribute(
            "Finish",
            match.product_value,
            match.user_value,
            match.match
          );
        }

        // --- Skin Concerns ---
        if (
          attributeMatches.concerns &&
          attributeMatches.concerns["Skin Concerns"]
        ) {
          const match = attributeMatches.concerns["Skin Concerns"];
          html += addAttribute(
            "Skin Concerns",
            match.product_value,
            match.user_value,
            match.match
          );
        } else if (
          attributeMatches.concerns &&
          attributeMatches.concerns["No Concerns"]
        ) {
          const match = attributeMatches.concerns["No Concerns"];
          html += addAttribute(
            "Skin Concerns",
            match.product_value,
            match.user_value,
            match.match
          );
        }

        // --- FEEDBACK SECTION ---
        const existingFeedback = productData.user_feedback;
        const hasExistingFeedback =
          existingFeedback &&
          existingFeedback.RecommendationFeedback !== undefined;

        // Get current rating and format date
        let currentThumbsRating = null;
        let formattedDate = "";

        if (hasExistingFeedback) {
          currentThumbsRating = existingFeedback.RecommendationFeedback;

          // Format the date nicely
          if (existingFeedback.CreatedAt) {
            const ratedDate = new Date(existingFeedback.CreatedAt);
            formattedDate = ratedDate.toLocaleDateString("en-US", {
              year: "numeric",
              month: "short",
              day: "numeric",
            });
          }
        }

        html += `
        <div class="feedback-section">
            <div class="feedback-label">
                ${hasExistingFeedback ? "Your rating:" : "How was this match:"}
                ${
                  hasExistingFeedback
                    ? "<small>Click any button to change</small>"
                    : ""
                }
            </div>
            <div class="feedback-buttons">
                <button class="feedback-btn thumbs-up ${
                  currentThumbsRating === 1 ? "active" : ""
                }" 
                        data-feedback="1" data-product-id="${productData.id}">
                     Good
                </button>
                <button class="feedback-btn thumbs-neutral ${
                  currentThumbsRating === 0.5 ? "active" : ""
                }" 
                        data-feedback="0.5" data-product-id="${productData.id}">
                     Okay
                </button>
                <button class="feedback-btn thumbs-down ${
                  currentThumbsRating === 0 ? "active" : ""
                }" 
                        data-feedback="0" data-product-id="${productData.id}">
                     Poor
                </button>
            </div>
            ${
              hasExistingFeedback
                ? `
                <div class="feedback-timestamp">
                    <small>Rated on ${formattedDate}</small>
                </div>
            `
                : ""
            }
        </div>
    `;

        setTimeout(() => {
          refreshFeedbackButtons(productData.id);
        }, 0);

        return html;
      }
      // Then add this function to handle the event listeners:
      function setupFeedbackButtons() {
        document.addEventListener("click", function (e) {
          if (e.target.closest(".feedback-btn")) {
            const button = e.target.closest(".feedback-btn");
            const productId = button.getAttribute("data-product-id");
            const rating = button.getAttribute("data-feedback"); // CHANGED: data-feedback instead of data-rating
            const productName =
              window.productData && window.productData[productId]
                ? window.productData[productId].Name
                : "Unknown Product";

            submitProductFeedback(productId, rating, productName);
          }
        });
      }

      // Call this when the page loads
      document.addEventListener("DOMContentLoaded", function () {
        setupFeedbackButtons();
      });

      // Function to load categories dynamically
      async function loadCategoriesIntoFilter() {
        try {
          const response = await fetch("../php/categories.php");
          if (!response.ok)
            throw new Error(`HTTP error! status: ${response.status}`);

          const data = await response.json();
          const categoryFilter = document.getElementById("category-filter");

          if (data.success && categoryFilter) {
            // FIXED: Clear all options and rebuild properly
            categoryFilter.innerHTML =
              '<option value="all">All Categories</option>';

            // Add categories from database
            data.categories.forEach((category) => {
              // Skip if category is "All" to avoid duplicates
              if (category.toLowerCase() !== "all") {
                const option = document.createElement("option");
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
              }
            });
          }
        } catch (error) {
          console.error(" Error loading categories:", error);
          // Keep the default categories if fetch fails
        }
      }

      function setupFilters() {
        const categoryFilter = document.getElementById("category-filter");
        const matchTypeFilter = document.getElementById("match-type-filter");
        const sortByFilter = document.getElementById("sort-by-filter");

        if (categoryFilter) {
          categoryFilter.addEventListener("change", applyFilters);
        }
        if (matchTypeFilter) {
          matchTypeFilter.addEventListener("change", applyFilters);
        }
        if (sortByFilter) {
          sortByFilter.addEventListener("change", applyFilters);
        }

        // // Setup Add All to Cart
        // setupAddAllToCart();

        // Debug: Check if products exist
        const productCards = document.querySelectorAll(".product-card");
      }

      const filterDescriptions = {
        "match-type": {
          all: " Showing all products that match your preferences",
          "PERFECT MATCH":
            "Products that perfectly match your skin type, tone, and preferences",
          "CLOSE MATCH": "Products that closely match most of your preferences",
          "NORMAL MATCH": "Good products that match some of your preferences",
        },
        "sort-by": {
          relevance:
            "Products sorted by how well they match your specific needs",
          matches:
            "Products with the most matching attributes to your preferences",
          rating: "Products highly rated by users with similar preferences",
          "price-low": "Products sorted from lowest to highest price",
          "price-high": "Products sorted from highest to lowest price",
        },
        category: {
          all: "Showing products from all categories that match your preferences",
          default:
            "Showing products from this category that match your preferences",
        },
      };

      // Function to update description based on current filters
      function updateFilterDescription() {
        const matchType = document.getElementById("match-type-filter").value;
        const sortBy = document.getElementById("sort-by-filter").value;
        const category = document.getElementById("category-filter").value;

        let description = "";

        // Priority: Match Type > Sort By > Category
        if (
          matchType !== "all" &&
          filterDescriptions["match-type"][matchType]
        ) {
          description = filterDescriptions["match-type"][matchType];
        } else if (
          sortBy !== "relevance" &&
          filterDescriptions["sort-by"][sortBy]
        ) {
          description = filterDescriptions["sort-by"][sortBy];
        } else if (category !== "all") {
          description = filterDescriptions["category"]["default"];
        } else {
          description = filterDescriptions["match-type"]["all"];
        }

        document.getElementById("filter-description").innerHTML = description;
      }

      function applyFilters() {
        const selectedCategory =
          document.getElementById("category-filter")?.value || "all";
        const selectedMatchType =
          document.getElementById("match-type-filter")?.value || "all";
        const selectedSort =
          document.getElementById("sort-by-filter")?.value || "relevance";

        // Store filter state globally so pagination respects it
        window.currentFilters = {
          category: selectedCategory,
          matchType: selectedMatchType,
          sort: selectedSort,
        };

        // Apply filters to ALL recommendations
        const filteredRecommendations = window.allRecommendations.filter(
          (product) => {
            let shouldInclude = true;

            // Category filter
            if (selectedCategory !== "all" && selectedCategory !== "All") {
              const productCategory = product.Category || "";
              if (productCategory !== selectedCategory) {
                shouldInclude = false;
              }
            }

            // Match type filter
            if (selectedMatchType !== "all") {
              const productMatchType = product.Match_Type || "";
              if (!productMatchType.includes(selectedMatchType)) {
                shouldInclude = false;
              }
            }

            return shouldInclude;
          }
        );

        // Apply sorting to the filtered results
        let sortedRecommendations;

        if (selectedSort === "relevance") {
          //  RESTORE ORIGINAL PYTHON SORTING for "Relevance"
          // First, filter the original Python-sorted array to maintain order
          const originalProductIds = window.originalPythonSorted.map(
            (p) => p.id
          );
          const idToProductMap = {};
          filteredRecommendations.forEach((product) => {
            idToProductMap[product.id] = product;
          });

          // Recreate the original order with filtered products
          sortedRecommendations = [];
          originalProductIds.forEach((id) => {
            if (idToProductMap[id]) {
              sortedRecommendations.push(idToProductMap[id]);
            }
          });
        } else {
          // Use JavaScript sorting for other options
          sortedRecommendations = sortAllProducts(
            filteredRecommendations,
            selectedSort
          );
        }

        // Update the global recommendations with filtered+sorted results
        window.filteredRecommendations = sortedRecommendations;

        // Reset to page 1 with the new filtered results
        window.currentPage = 1;

        // Show the first page of filtered results
        showPage(1);

        // Update results count
        updateResultsCount(sortedRecommendations.length);
      }
      // Function to update the Add All to Cart count
      function updateAddAllCount(count) {
        const addAllCount = document.getElementById("add-all-count");
        const productCount = document.getElementById("product-count");
        const addAllBtn = document.getElementById("add-all-to-cart");

        if (productCount) {
          productCount.textContent = count;
        }

        if (addAllCount) {
          if (count > 0) {
            addAllCount.classList.add("highlight");
          } else {
            addAllCount.classList.remove("highlight");
          }
        }

        if (addAllBtn) {
          addAllBtn.disabled = count === 0;
        }
      }

      // Function to show add to cart confirmation modal
      function showAddToCartModal(productCount) {
        const modal = document.getElementById("add-to-cart-modal");
        const countElement = document.getElementById(
          "cart-modal-product-count"
        );

        // Update product count
        countElement.textContent = productCount;

        // Show modal using class
        modal.classList.add("active");

        // Return a promise that resolves when user makes a choice
        return new Promise((resolve) => {
          window.addToCartResolve = resolve;
        });
      }

      // Function to close add to cart modal
      function closeAddToCartModal() {
        const modal = document.getElementById("add-to-cart-modal");
        modal.classList.remove("active");

        if (window.addToCartResolve) {
          window.addToCartResolve(false);
          window.addToCartResolve = null;
        }
      }

      // Function when user confirms add to cart
      function confirmAddToCart() {
        const modal = document.getElementById("add-to-cart-modal");
        modal.classList.remove("active");

        if (window.addToCartResolve) {
          window.addToCartResolve(true);
          window.addToCartResolve = null;
        }
      }

      // Function to show success modal
      function showSuccessModal(successCount, errorCount = 0) {
        const modal = document.getElementById("success-modal");
        const title = document.getElementById("success-title");
        const message = document.getElementById("success-message");

        if (successCount > 0) {
          title.textContent = "Success!";
          if (errorCount > 0) {
            message.textContent = `Successfully added ${successCount} products to cart! (${errorCount} items were out of stock)`;
          } else {
            message.textContent = `Successfully added ${successCount} products to cart!`;
          }
        } else {
          title.textContent = "Notice";
          message.textContent =
            "No products were added to cart. Items may be out of stock.";
        }

        modal.classList.add("active");
      }

      // Function to close success modal
      function closeSuccessModal() {
        const modal = document.getElementById("success-modal");
        modal.classList.remove("active");
      }

      // Optional: Auto-close after 5 seconds
      function showSuccessModalAutoClose(successCount, errorCount = 0) {
        showSuccessModal(successCount, errorCount);
        setTimeout(closeSuccessModal, 5000);
      }

      // // Updated function to add all filtered products to cart
      // async function addAllToCart() {
      //   const currentRecommendations =
      //     window.filteredRecommendations || window.allRecommendations;
      //   const productCount = currentRecommendations.length;

      //   if (productCount === 0) {
      //     // Use alert if showNotification doesn't exist
      //     if (typeof showNotification === "function") {
      //       showNotification("No products to add to cart!", "error");
      //     } else {
      //       alert("No products to add to cart!");
      //     }
      //     return;
      //   }

      //   // Show beautiful modal instead of confirm()
      //   const confirmed = await showAddToCartModal(productCount);

      //   if (!confirmed) {
      //     return;
      //   }

      //   // Show loading state
      //   const addAllBtn = document.getElementById("add-all-to-cart");
      //   const originalText = addAllBtn.innerHTML;
      //   addAllBtn.innerHTML =
      //     '<i class="fas fa-spinner fa-spin"></i> Adding...';
      //   addAllBtn.disabled = true;

      //   try {
      //     let successCount = 0;
      //     let errorCount = 0;
      //     const outOfStockProducts = [];

      //     // Add each product to cart
      //     for (const product of currentRecommendations) {
      //       try {
      //         const productId = product.id;

      //         const response = await fetch("../php/cart.php", {
      //           method: "POST",
      //           headers: {
      //             "Content-Type": "application/x-www-form-urlencoded",
      //           },
      //           body: `action=add&product_id=${encodeURIComponent(
      //             productId
      //           )}&quantity=1`,
      //         });

      //         const result = await response.json();

      //         if (result.success) {
      //           successCount++;
      //         } else {
      //           errorCount++;
      //           console.warn(
      //             `Failed to add product ${product.Name}:`,
      //             result.message
      //           );

      //           // Track out of stock products
      //           if (result.message && result.message.includes("stock")) {
      //             outOfStockProducts.push(product.Name);
      //           }
      //         }

      //         // Small delay to avoid overwhelming the server
      //         await new Promise((resolve) => setTimeout(resolve, 100));
      //       } catch (error) {
      //         errorCount++;
      //         console.error(`Error adding product ${product.Name}:`, error);
      //       }
      //     }

      //     showSuccessModal(successCount, errorCount);

      //     // Update cart count if we have the function
      //     if (successCount > 0 && typeof updateCartCount === "function") {
      //       try {
      //         const countResponse = await fetch("../php/cart.php?action=count");
      //         const countResult = await countResponse.json();
      //         if (countResult.success) {
      //           updateCartCount(countResult.cartCount);
      //         }
      //       } catch (error) {
      //         console.error("Error updating cart count:", error);
      //       }
      //     }
      //   } catch (error) {
      //     console.error("Error in addAllToCart:", error);
      //     // Use available notification method
      //     if (typeof showNotification === "function") {
      //       showNotification(
      //         "Error adding products to cart. Please try again.",
      //         "error"
      //       );
      //     } else {
      //       alert("Error adding products to cart. Please try again.");
      //     }
      //   } finally {
      //     // Restore button state
      //     addAllBtn.innerHTML = originalText;
      //     addAllBtn.disabled = false;
      //   }
      // }

      // // Make sure to attach the event listener
      // document
      //   .getElementById("add-all-to-cart")
      //   .addEventListener("click", addAllToCart);

      // // Add keyboard support (ESC to close modal)
      // document.addEventListener("keydown", function (e) {
      //   if (e.key === "Escape") {
      //     closeAddToCartModal();
      //   }
      // });
      // Initialize the Add All to Cart functionality
      function setupAddAllToCart() {
        const addAllBtn = document.getElementById("add-all-to-cart");
        if (addAllBtn) {
          addAllBtn.addEventListener("click", addAllToCart);
        }

        // Initialize count on page load
        const initialCount = window.allRecommendations
          ? window.allRecommendations.length
          : 0;
        updateAddAllCount(initialCount);
      }

      // New function to sort ALL products (not just visible ones)
      function sortAllProducts(products, sortBy) {
        return products.sort((a, b) => {
          try {
            switch (sortBy) {
              case "relevance":
                return sortByRelevance(a, b);

              case "price-low":
                return (a.Price || 0) - (b.Price || 0);

              case "price-high":
                return (b.Price || 0) - (a.Price || 0);

              case "rating":
                return sortByRating(a, b);

              case "matches":
                return (b.Initial_Fit_Score || 0) - (a.Initial_Fit_Score || 0);

              default:
                return 0;
            }
          } catch (error) {
            console.error(" Error sorting:", error);
            return 0;
          }
        });
      }

      // FIXED: Smart relevance sorting that properly demotes Poor ratings
      function sortByRelevance(a, b) {
        // 0. PRIORITY: HEAVY PENALTY for Poor ratings (they should go to bottom)
        const feedbackPriority = {
          Good: 100, // Highest priority - user liked it
          None: 50, // No feedback yet - neutral
          Okay: 25, // User was meh about it
          Poor: 0, // User disliked it - HEAVY PENALTY
        };

        const feedbackA = a.user_feedback?.RecommendationFeedback || "None";
        const feedbackB = b.user_feedback?.RecommendationFeedback || "None";

        const feedbackScoreA = feedbackPriority[feedbackA] || 50;
        const feedbackScoreB = feedbackPriority[feedbackB] || 50;

        // If one is Poor and the other isn't, Poor always loses
        if (feedbackA === "Poor" && feedbackB !== "Poor") return 1;
        if (feedbackB === "Poor" && feedbackA !== "Poor") return -1;

        // If both are Poor, use other factors
        if (feedbackA === "Poor" && feedbackB === "Poor") {
          // Among Poor products, still sort by quality
          const compositeA = a.Composite_Score || 0;
          const compositeB = b.Composite_Score || 0;
          return compositeB - compositeA;
        }

        // For non-Poor products, use the normal scoring
        if (feedbackScoreB !== feedbackScoreA) {
          return feedbackScoreB - feedbackScoreA;
        }

        // 2. Match quality (Perfect > Close > Normal > Low)
        const matchPriority = {
          "PERFECT MATCH": 4,
          "CLOSE MATCH": 3,
          "NORMAL MATCH": 2,
          "LOW RATING MATCH": 1,
        };

        const matchScoreA = matchPriority[a.Match_Type] || 0;
        const matchScoreB = matchPriority[b.Match_Type] || 0;

        if (matchScoreB !== matchScoreA) {
          return matchScoreB - matchScoreA;
        }

        // 3. Composite score from ML (main relevance metric)
        const compositeA = a.Composite_Score || 0;
        const compositeB = b.Composite_Score || 0;

        if (compositeB !== compositeA) {
          return compositeB - compositeA;
        }

        // 4. Actual product ratings (rated products over unrated)
        const ratingA = a.product_rating || 0;
        const ratingB = b.product_rating || 0;

        // Bonus for products with actual ratings vs unrated
        const hasRatingA = ratingA > 0 ? 1 : 0;
        const hasRatingB = ratingB > 0 ? 1 : 0;

        if (hasRatingB !== hasRatingA) {
          return hasRatingB - hasRatingA;
        }

        return ratingB - ratingA;
      }

      function handleRecommendations(recommendations) {
        // Store ALL recommendations
        window.allRecommendations = recommendations;

        // Store ORIGINAL relevance-sorted recommendations (for "back to relevance")
        window.originalRelevanceSorted = [...recommendations].sort(
          sortByRelevance
        );

        // Apply initial sorting (relevance by default)
        window.filteredRecommendations = [...window.originalRelevanceSorted];

        showPage(1);
      }

      // FIXED: Use ONLY product_rating for rating sorting
      function sortByRating(a, b) {
        // 1. ACTUAL PRODUCT RATINGS (Most Important - use product_rating ONLY)
        const ratingA = a.product_rating || 0; // Use the new product_rating field
        const ratingB = b.product_rating || 0;

        // Prioritize products with ANY rating over completely unrated products
        const hasRatingA = ratingA > 0 ? 1 : 0;
        const hasRatingB = ratingB > 0 ? 1 : 0;

        if (hasRatingB !== hasRatingA) {
          return hasRatingB - hasRatingA; // Rated products first
        }

        // If both have ratings, sort by rating value
        if (ratingB !== ratingA) {
          return ratingB - ratingA; // Higher ratings first
        }

        // 2. User feedback as secondary (Good > None > Okay > Poor)
        const feedbackPriority = {
          Good: 4,
          None: 3,
          Okay: 2,
          Poor: 1,
        };

        const feedbackA = a.user_feedback?.RecommendationFeedback || "None";
        const feedbackB = b.user_feedback?.RecommendationFeedback || "None";

        const feedbackScoreA = feedbackPriority[feedbackA] || 3;
        const feedbackScoreB = feedbackPriority[feedbackB] || 3;

        if (feedbackScoreB !== feedbackScoreA) {
          return feedbackScoreB - feedbackScoreA;
        }

        // 3. Match quality as final tiebreaker
        const matchPriority = {
          "PERFECT MATCH": 4,
          "CLOSE MATCH": 3,
          "NORMAL MATCH": 2,
          "LOW RATING MATCH": 1,
        };

        const matchScoreA = matchPriority[a.Match_Type] || 0;
        const matchScoreB = matchPriority[b.Match_Type] || 0;

        return matchScoreB - matchScoreA;
      }

      function resetFilters() {
        const categoryFilter = document.getElementById("category-filter");
        const matchTypeFilter = document.getElementById("match-type-filter");
        const sortFilter = document.getElementById("sort-by-filter");

        if (categoryFilter) categoryFilter.value = "all";
        if (matchTypeFilter) matchTypeFilter.value = "all";
        if (sortFilter) sortFilter.value = "relevance";

        // Clear filters and show all original recommendations
        window.currentFilters = null;
        window.filteredRecommendations = null;

        // Reset to page 1 with original recommendations
        window.currentPage = 1;
        showPage(1);

        // Update results count
        updateResultsCount(window.allRecommendations.length);
        // updateFilterDescription();
      }

      // Remove the old sorting functions since we're now sorting at the data level
      function sortProductsInSection() {
        console.warn(
          " sortProductsInSection() is deprecated - use sortAllProducts instead"
        );
      }
      // Update the original sortProducts to use the new section-based approach
      function sortProducts(products, sortBy) {
        // This is now handled by sortProductsInSection for each section
        console.warn(
          " sortProducts() is deprecated - use section-based sorting instead"
        );
      }

      function compareRelevance(a, b) {
        // Get the actual product data from our stored data
        const productIdA = a.getAttribute("data-product-id");
        const productIdB = b.getAttribute("data-product-id");

        const productA = window.productData[productIdA];
        const productB = window.productData[productIdB];

        if (!productA || !productB) {
          console.warn(" Missing product data for sorting, using fallback");
          return compareRelevanceFallback(a, b);
        }

        // 1. PRIMARY: Use Composite_Score from Python (most important!)
        // This already considers match quality, ratings, category priority, etc.
        const scoreA = productA.Composite_Score || 0;
        const scoreB = productB.Composite_Score || 0;

        if (scoreB !== scoreA) {
          return scoreB - scoreA; // Higher scores first
        }

        // 2. SECONDARY: Use Predicted_Score from ML model
        const predictedA = productA.Predicted_Score || 0;
        const predictedB = productB.Predicted_Score || 0;

        if (predictedB !== predictedA) {
          return predictedB - predictedA;
        }

        // 3. TERTIARY: Use Initial_Fit_Score (attribute matching)
        const fitA = productA.Initial_Fit_Score || 0;
        const fitB = productB.Initial_Fit_Score || 0;

        if (fitB !== fitA) {
          return fitB - fitA;
        }

        // 4. FINAL: Use actual ratings as tiebreaker
        const ratingA = productA.final_rating || productA.user_rating || 0;
        const ratingB = productB.final_rating || productB.user_rating || 0;

        return ratingB - ratingA;
      }

      // Fallback function if product data is missing
      function compareRelevanceFallback(a, b) {
        const matchPriority = {
          "PERFECT MATCH": 5,
          "CLOSE MATCH": 4,
          "NORMAL MATCH": 3,
          "LOW RATING MATCH": 2,
          "FALLBACK MATCH": 1,
        };

        const ratingPriority = {
          " TOP RATED": 6,
          "HIGHLY RATED": 5,
          "WELL RATED": 4,
          "GOOD RATING": 3,
          "AVERAGE RATING": 2,
          "LOW RATING": 1,
          " UNRATED": 0,
        };

        const matchBadgeA =
          a.querySelector(".match-badge")?.textContent.trim() || "";
        const matchBadgeB =
          b.querySelector(".match-badge")?.textContent.trim() || "";

        const ratingBadgeA =
          a.querySelector(".rating-badge")?.textContent.trim() || "";
        const ratingBadgeB =
          b.querySelector(".rating-badge")?.textContent.trim() || "";

        const matchScoreA = matchPriority[matchBadgeA] || 0;
        const matchScoreB = matchPriority[matchBadgeB] || 0;

        const ratingScoreA = ratingPriority[ratingBadgeA] || 0;
        const ratingScoreB = ratingPriority[ratingBadgeB] || 0;

        if (matchScoreB !== matchScoreA) {
          return matchScoreB - matchScoreA;
        }

        return ratingScoreB - ratingScoreA;
      }

      function comparePrice(a, b, ascending = true) {
        const priceTextA =
          a.querySelector(".product-price")?.textContent || "0";
        const priceTextB =
          b.querySelector(".product-price")?.textContent || "0";

        const priceA = parseFloat(priceTextA.replace("", "")) || 0;
        const priceB = parseFloat(priceTextB.replace("", "")) || 0;

        return ascending ? priceA - priceB : priceB - priceA;
      }

      function compareRating(a, b) {
        // Get rating from the rating-text element
        const ratingTextA = a.querySelector(".rating-text")?.textContent || "0";
        const ratingTextB = b.querySelector(".rating-text")?.textContent || "0";

        // Handle "No ratings yet" text
        const ratingA =
          ratingTextA === "No ratings yet" ? 0 : parseFloat(ratingTextA) || 0;
        const ratingB =
          ratingTextB === "No ratings yet" ? 0 : parseFloat(ratingTextB) || 0;

        // Sort highest to lowest
        return ratingB - ratingA;
      }
      function compareMatches(a, b) {
        // Get matches from attribute-text element
        const matchesTextA =
          a.querySelector(".attribute-text")?.textContent || "0/5";
        const matchesTextB =
          b.querySelector(".attribute-text")?.textContent || "0/5";

        const matchesA = parseInt(matchesTextA.split("/")[0]) || 0;
        const matchesB = parseInt(matchesTextB.split("/")[0]) || 0;

        // Sort highest to lowest
        return matchesB - matchesA;
      }

      function updateResultsCount(count) {
        const countElement = document.getElementById("results-count");
        if (countElement) {
          countElement.textContent = `${count} products found`;
        }
      }

      // Keep your existing helper functions
      function countMatches(attributeMatches) {
        let count = 0;

        // Count main attributes
        if (attributeMatches.skin_type?.match) count++;
        if (attributeMatches.skin_tone?.match) count++;
        if (attributeMatches.undertone?.match) count++;
        if (attributeMatches.finish?.match) count++;

        // FIXED: Count Skin Concerns as ONE attribute (not individual concerns)
        if (attributeMatches.concerns) {
          // If user has no concerns and product matches "Any"
          if (attributeMatches.concerns["No Concerns"]?.match) {
            count++;
          }
          // If user has concerns, check if product addresses AT LEAST ONE concern
          else if (
            Object.values(attributeMatches.concerns).some(
              (concern) => concern.match
            )
          ) {
            count++;
          }
        }

        return count;
      }

      // SILENT image error handler - no console logs
      function handleImageError(img) {
        // Don't log anything to avoid spam
        img.src = "/admin/uploads/product_images/no-image.png";
        img.onerror = null; // Prevent infinite loop
      }

      // Update badge styling functions (remove emojis)
      function getMatchBadgeClass(matchType) {
        const classMap = {
          "PERFECT MATCH": "perfect-match",
          "CLOSE MATCH": "close-match",
          "NORMAL MATCH": "normal-match",
          "LOW RATING MATCH": "low-match",
        };
        return classMap[matchType] || "normal-match";
      }

      function getRatingBadgeClass(ratingQuality) {
        const classMap = {
          "TOP RATED": "top-rated",
          "HIGHLY RATED": "high-rated",
          "WELL RATED": "well-rated",
          "GOOD RATING": "good-rating",
          "AVERAGE RATING": "average-rating",
          "LOW RATING": "low-rating",
          UNRATED: "unrated",
        };
        return classMap[ratingQuality] || "unrated";
      }

      async function addRecommendedToCart(productId, event = null) {
        try {
          const response = await fetch("../php/cart.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `action=add&product_id=${encodeURIComponent(
              productId
            )}&quantity=1`,
          });

          const result = await response.json();

          if (result.success) {
            // Use your existing updateCartCount function
            await updateCartCount();

            // Show success notification with the message from PHP
            showNotification(result.message || "Product added to cart! ");

            // Show cart total popup - using totalAmount from your PHP response
            showCartTotal(result.totalAmount || 0);

            // Visual feedback on the button - only if event is available
            if (event) {
              const button = event.target.closest(".add-to-cart-btn");
              if (button) {
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Added!';
                button.style.background = "#ff69b4";

                setTimeout(() => {
                  button.innerHTML = originalHTML;
                  button.style.background = "";
                }, 2000);
              }
            }
          } else {
            showNotification(
              result.message || "Failed to add to cart",
              "error"
            );
          }
        } catch (error) {
          console.error("Error adding to cart:", error);
          showNotification("Error adding to cart. Please try again.", "error");
        }
      }

      // Unified Notification Function - Use this on ALL pages
      function showNotification(message, type = "success") {
        // Check if notification box exists, if not create it
        let notificationBox = document.getElementById("notification-box");

        if (!notificationBox) {
          // Create the notification box if it doesn't exist
          notificationBox = document.createElement("div");
          notificationBox.id = "notification-box";
          notificationBox.className = "notification-box";
          document.body.appendChild(notificationBox);
        }

        // Set message and icon based on type
        let iconClass, background;

        switch (type) {
          case "success":
            iconClass = "fas fa-check-circle";
            background =
              "linear-gradient(135deg, var(--primary-pink), var(--dark-pink))";
            break;
          case "error":
            iconClass = "fas fa-exclamation-circle";
            background = "linear-gradient(135deg, #ef4444, #dc2626)";
            break;
          case "info":
            iconClass = "fas fa-info-circle";
            background = "linear-gradient(135deg, #3b82f6, #1d4ed8)";
            break;
          case "warning":
            iconClass = "fas fa-exclamation-triangle";
            background = "linear-gradient(135deg, #f59e0b, #d97706)";
            break;
          default:
            iconClass = "fas fa-check-circle";
            background =
              "linear-gradient(135deg, var(--primary-pink), var(--dark-pink))";
        }

        notificationBox.innerHTML = `<i class="${iconClass}"></i> ${message}`;
        notificationBox.style.background = background;

        // Show notification
        notificationBox.classList.add("show");

        // Hide after 3 seconds
        setTimeout(() => {
          notificationBox.classList.remove("show");
        }, 3000);
      }

      function showCartTotal(totalAmount) {
        // Remove existing popups if any
        const existingPopups = document.querySelectorAll(".cart-total-popup");
        existingPopups.forEach((popup) => popup.remove());

        // Get both desktop and mobile cart nav items
        const desktopCartNav = document.querySelector(
          '.desktop-nav .nav-item[data-page="cart"]'
        );
        const mobileCartNav = document.querySelector(
          '.mobile-nav .nav-item[data-page="cart"]'
        );

        // Create popup for desktop
        if (desktopCartNav) {
          const desktopPopup = document.createElement("div");
          desktopPopup.className = "cart-total-popup";
          desktopPopup.innerHTML = `
            <div class="cart-total-label">Cart Total</div>
            <div class="cart-total-amount">${formatNumberWithCommas(
              parseFloat(totalAmount).toFixed(2)
            )}</div>
            <small>Click cart to view items</small>
        `;

          desktopCartNav.style.position = "relative";
          desktopCartNav.appendChild(desktopPopup);

          setTimeout(() => {
            desktopPopup.classList.add("show");
          }, 10);
        }

        // Create popup for mobile
        if (mobileCartNav) {
          const mobilePopup = document.createElement("div");
          mobilePopup.className = "cart-total-popup";
          mobilePopup.innerHTML = `
            <div class="cart-total-label">Cart Total</div>
            <div class="cart-total-amount">${formatNumberWithCommas(
              parseFloat(totalAmount).toFixed(2)
            )}</div>
            <small>Tap cart to view items</small>
        `;

          mobileCartNav.style.position = "relative";
          mobileCartNav.appendChild(mobilePopup);

          setTimeout(() => {
            mobilePopup.classList.add("show");
          }, 10);
        }

        // Auto hide after 3 seconds
        setTimeout(() => {
          const allPopups = document.querySelectorAll(".cart-total-popup");
          allPopups.forEach((popup) => {
            popup.classList.remove("show");
            setTimeout(() => {
              if (popup.parentNode) {
                popup.remove();
              }
            }, 300);
          });
        }, 3000);
      }

      function viewProductDetails(productId) {
        window.location.href = `productdetail.html?productId=${productId}`;
      }
      function viewProductDetails(productId) {
        window.location.href = `productdetail.html?productId=${productId}`;
      }

      async function saveUserPreferences() {
        try {
          const response = await fetch("../php/save-user-preferences.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              skinType: quizData.skinType,
              skinTone: quizData.skinTone,
              undertone: quizData.undertone,
              concerns: quizData.concerns,
              finish: quizData.finish,
            }),
          });

          const text = await response.text();

          let data;
          try {
            data = JSON.parse(text);
          } catch (parseError) {
            console.error(" JSON parse error in save:", parseError);
            return false;
          }

          if (data.success) {
            // Update the global preferences state
            hasExistingPreferences = true;
            currentPreferences = {
              skin_type: quizData.skinType,
              skin_tone: quizData.skinTone,
              undertone: quizData.undertone,
              skin_concerns: JSON.stringify(quizData.concerns),
              preferred_finish: quizData.finish,
              updated_at: new Date().toISOString(),
            };
          }

          return data.success;
        } catch (error) {
          console.error(" Error saving preferences:", error);
          return false;
        }
      }

      // recommender.js
      let currentStep = 0;
      let quizData = {
        skinType: "",
        skinTone: "",
        undertone: "",
        concerns: [],
        finish: "",
      };

      function nextStep(step) {
        document
          .querySelectorAll(".quiz-step")
          .forEach((step) => step.classList.remove("active"));

        if (step === 0) {
          document.getElementById("step-intro").classList.add("active");
        } else {
          document.getElementById(`step-${step}`).classList.add("active");
        }
        currentStep = step;

        // Update progress bar based on current step
        updateProgressBar();
      }

      function prevStep() {
        if (currentStep > 1) {
          nextStep(currentStep - 1);
        } else if (currentStep === 1) {
          // Show exit confirmation modal instead of going directly to intro
          showExitModal();
        }
      }

      function updateProgressBar() {
        const progressFill = document.querySelector(".progress-fill");
        if (!progressFill) return;

        const progressPercentages = {
          0: 0, // Intro
          1: 20, // Step 1
          2: 40, // Step 2
          3: 60, // Step 3
          4: 80, // Step 4
          5: 100, // Step 5
        };

        progressFill.style.width = `${progressPercentages[currentStep] || 0}%`;
      }
      function resetToIntro() {
        // Show intro step regardless of existing preferences
        document.querySelectorAll(".quiz-step").forEach((step) => {
          step.classList.remove("active");
        });
        document.getElementById("step-intro").classList.add("active");
        currentStep = 0;
      }

      function restartQuiz() {
        // Check if user has existing preferences
        if (hasExistingPreferences) {
          // Show the existing preferences modal instead of immediately restarting
          showExistingPrefsModal();
        } else {
          // If no existing preferences, restart normally
          resetQuizAndRestart();
        }
      }
      function resetQuizAndRestart() {
        // Set a flag to indicate we're in retake quiz mode
        sessionStorage.setItem("retakingQuiz", "true");

        quizData = {
          skinType: "",
          skinTone: "",
          undertone: "",
          concerns: [],
          finish: "",
        };

        // Reset all selections visually
        document.querySelectorAll(".option-card").forEach((card) => {
          card.classList.remove("selected");
        });

        document.querySelectorAll(".tone-option").forEach((option) => {
          option.classList.remove("selected");
        });

        document.querySelectorAll(".concern-checkbox").forEach((checkbox) => {
          checkbox.checked = false;
        });

        console.log(
          "Start Quiz button disabled:",
          document.querySelector(
            '.nav-btn.primary[onclick*="startQuizWithCheck"]'
          ).disabled
        );
        // // Reset next buttons
        // document.querySelectorAll(".nav-btn.primary").forEach((btn) => {
        //   btn.disabled = true;
        // });

        resetToIntro(); // Go to intro step
      }

      // Option selection
      document.addEventListener("DOMContentLoaded", function () {
        // Single selection options
        document.querySelectorAll(".option-card").forEach((card) => {
          card.addEventListener("click", function () {
            const step = this.closest(".quiz-step").id.replace("step-", "");
            const value = this.getAttribute("data-value");

            // Clear other selections in this step
            this.closest(".options-grid")
              .querySelectorAll(".option-card")
              .forEach((c) => {
                c.classList.remove("selected");
              });

            // Select this card
            this.classList.add("selected");

            // Update data
            if (step === "1") quizData.skinType = value;
            if (step === "2") quizData.skinTone = value;
            if (step === "3") quizData.undertone = value;
            if (step === "5") quizData.finish = value;

            // Enable next button
            const nextBtn = document.getElementById(`step${step}-next`);
            if (nextBtn) nextBtn.disabled = false;
          });
        });

        // Skin tone selection
        document.querySelectorAll(".tone-option").forEach((option) => {
          option.addEventListener("click", function () {
            document.querySelectorAll(".tone-option").forEach((o) => {
              o.classList.remove("selected");
            });
            this.classList.add("selected");
            quizData.skinTone = this.getAttribute("data-value");
            document.getElementById("step2-next").disabled = false;
          });
        });

        // Concerns selection (multiple)
        document.querySelectorAll(".concern-checkbox").forEach((checkbox) => {
          checkbox.addEventListener("change", function () {
            const value =
              this.closest(".concern-option").getAttribute("data-value");

            if (value === "none") {
              // If "none" is selected, uncheck all others
              if (this.checked) {
                document.querySelectorAll(".concern-checkbox").forEach((cb) => {
                  if (cb !== this) cb.checked = false;
                });
                quizData.concerns = ["none"];
              } else {
                quizData.concerns = [];
              }
            } else {
              // If other concern is selected, uncheck "none"
              if (this.checked) {
                const noneCheckbox = document.querySelector(
                  '[data-value="none"] .concern-checkbox'
                );
                noneCheckbox.checked = false;
                quizData.concerns = quizData.concerns.filter(
                  (c) => c !== "none"
                );
                quizData.concerns.push(value);
              } else {
                quizData.concerns = quizData.concerns.filter(
                  (c) => c !== value
                );
              }
            }

            // Enable next button if at least one concern is selected
            document.getElementById("step4-next").disabled =
              quizData.concerns.length === 0;
          });
        });
      });

      function showExitModal() {
        const modal = document.getElementById("exit-modal");
        const modalTitle = modal.querySelector("h3");
        const modalMessage = modal.querySelector("p");
        const confirmBtn = modal.querySelector(".modal-btn.primary");

        if (currentStep === 1) {
          // Custom message for going back to intro from Step 1
          modalTitle.textContent = "Start Over?";
          modalMessage.textContent =
            "Do you want to go back to the beginning and retake the quiz?";
          confirmBtn.textContent = "Yes, Start Over";
          confirmBtn.onclick = confirmStartOver;
        } else {
          // Default message for exiting quiz via navigation
          modalTitle.textContent = "Are you sure you want to exit?";
          modalMessage.textContent = "Your quiz progress will not be saved.";
          confirmBtn.textContent = "Yes, Exit";
          confirmBtn.onclick = confirmExit;
        }

        modal.classList.add("active");
      }
      function confirmStartOver() {
        // Temporarily bypass the existing preferences check for this session
        sessionStorage.setItem("bypassPreferencesCheck", "true");

        // Go back to intro page and allow quiz to start
        nextStep(0);
        closeExitModal();
      }
      function closeExitModal() {
        document.getElementById("exit-modal").classList.remove("active");
      }

      function confirmExit() {
        window.location.href = "home.html";
      }

      // Navigation exit handlers
      document
        .querySelectorAll('.nav-item:not([data-page="recommender"])')
        .forEach((item) => {
          item.addEventListener("click", function (e) {
            if (currentStep > 0 && currentStep < 6) {
              e.preventDefault();
              showExitModal();
            }
          });
        });

      function showLoading() {
        nextStep("loading");

        // Simulate loading messages
        const messages = document.querySelectorAll(".loading-message");
        let currentMessage = 0;

        const messageInterval = setInterval(() => {
          messages.forEach((msg) => msg.classList.remove("active"));
          if (currentMessage < messages.length) {
            messages[currentMessage].classList.add("active");
            currentMessage++;
          } else {
            clearInterval(messageInterval);
            // Show results after loading
            setTimeout(async () => {
              await showResults(); // Add await here
            }, 1000);
          }
        }, 1500);
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Product finish selection (Step 5) - update quizData instead of quizState
        document
          .querySelectorAll("#step-5 .option-card[data-value]")
          .forEach((card) => {
            card.addEventListener("click", function () {
              // Remove active class from all cards in step 5
              document.querySelectorAll("#step-5 .option-card").forEach((c) => {
                c.classList.remove("active");
              });

              // Add active class to clicked card
              this.classList.add("active");

              // Update quizData.finish (your existing data structure)
              quizData.finish = this.getAttribute("data-value");

              // Enable the Get Results button
              const step5Next = document.getElementById("step5-next");
              if (step5Next) {
                step5Next.disabled = false;
              }
            });
          });
      });

      function initFloatingProduct() {
        const productImages = [
          "/admin/uploads/product_images/blush-nobg.png",
          "/admin/uploads/product_images/concealer-nobg.png",
          "/admin/uploads/product_images/lipstick-nobg.png",
          "/admin/uploads/product_images/foundation-nobg.png",
          "/admin/uploads/product_images/facecare-nobg.png",
          "/admin/uploads/product_images/blush-nobg.png",
        ];

        const productImg = document.getElementById("floating-product-img");

        let currentIndex = 0;

        function changeProduct() {
          currentIndex = (currentIndex + 1) % productImages.length;
          const newImagePath = productImages[currentIndex];

          productImg.style.opacity = "0";

          setTimeout(() => {
            productImg.src = newImagePath;

            productImg.onload = function () {
              productImg.style.opacity = "1";
            };

            productImg.onerror = function () {
              console.error(" Failed to load image:", this.src);
              productImg.style.opacity = "1";
              // If one image fails, just continue with others
            };
          }, 300);
        }

        // Set first image
        productImg.src = productImages[0];
        productImg.style.transition = "opacity 0.5s ease";

        productImg.onload = function () {};

        productImg.onerror = function () {};

        // Change image every 3 seconds
        setInterval(changeProduct, 3000);
      }

      async function updateCartCount() {
        try {
          const response = await fetch("../php/get-cart-count.php");
          const data = await response.json();

          if (data.success) {
            const cartCounts = document.querySelectorAll(".nav-cart-count");
            cartCounts.forEach((count) => {
              count.textContent = data.count;
              if (data.count > 0) {
                count.classList.add("show"); // Use class instead of inline style
              } else {
                count.classList.remove("show");
              }
            });
          }
        } catch (error) {
          const cartCounts = document.querySelectorAll(".nav-cart-count");
          cartCounts.forEach((count) => {
            count.textContent = "0";
            count.classList.remove("show");
          });
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        initFloatingProduct();
        updateCartCount();
      });

      document.addEventListener("DOMContentLoaded", function () {
        const desktopCartNav = document.querySelector(
          '.desktop-nav .nav-item[data-page="cart"]'
        );
        const mobileCartNav = document.querySelector(
          '.mobile-nav .nav-item[data-page="cart"]'
        );

        // Desktop hover
        if (desktopCartNav) {
          desktopCartNav.addEventListener("mouseenter", function () {
            showCartTotalOnHover();
          });
        }

        // Mobile touch (for better mobile experience)
        if (mobileCartNav) {
          let touchTimer;

          mobileCartNav.addEventListener("touchstart", function () {
            touchTimer = setTimeout(() => {
              showCartTotalOnHover();
            }, 500); // Show after 500ms long press
          });

          mobileCartNav.addEventListener("touchend", function () {
            clearTimeout(touchTimer);
          });

          // Also show on click for mobile
          mobileCartNav.addEventListener("click", function (e) {
            // Only show if it's not navigating (prevent double trigger)
            if (!e.target.closest("a")) {
              showCartTotalOnHover();
            }
          });
        }
      });

      async function showCartTotalOnHover() {
        try {
          const response = await fetch("../php/cart.php?action=get");
          const result = await response.json();

          if (result.success && result.cartCount > 0) {
            const existingPopups =
              document.querySelectorAll(".cart-total-popup");

            // Don't show if there's already a popup
            if (existingPopups.length > 0) return;

            const desktopCartNav = document.querySelector(
              '.desktop-nav .nav-item[data-page="cart"]'
            );
            const mobileCartNav = document.querySelector(
              '.mobile-nav .nav-item[data-page="cart"]'
            );

            // Create popup for desktop
            if (desktopCartNav) {
              const desktopPopup = document.createElement("div");
              desktopPopup.className = "cart-total-popup";
              desktopPopup.innerHTML = `
                    <div class="cart-total-label">Cart Total</div>
                    <div class="cart-total-amount">${formatNumberWithCommas(
                      parseFloat(result.totalAmount).toFixed(2)
                    )}</div>
                    
                `;

              desktopCartNav.appendChild(desktopPopup);
              setTimeout(() => desktopPopup.classList.add("show"), 10);

              // Remove on mouse leave (desktop only)
              desktopCartNav.addEventListener(
                "mouseleave",
                function () {
                  desktopPopup.classList.remove("show");
                  setTimeout(() => {
                    if (desktopPopup.parentNode) desktopPopup.remove();
                  }, 300);
                },
                { once: true }
              );
            }

            // Create popup for mobile
            if (mobileCartNav) {
              const mobilePopup = document.createElement("div");
              mobilePopup.className = "cart-total-popup";
              mobilePopup.innerHTML = `
                    <div class="cart-total-label">Cart Total</div>
                    <div class="cart-total-amount">${formatNumberWithCommas(
                      parseFloat(result.totalAmount).toFixed(2)
                    )}</div>
                    
                `;

              mobileCartNav.appendChild(mobilePopup);
              setTimeout(() => mobilePopup.classList.add("show"), 10);

              // Auto-remove after 3 seconds on mobile
              setTimeout(() => {
                mobilePopup.classList.remove("show");
                setTimeout(() => {
                  if (mobilePopup.parentNode) mobilePopup.remove();
                }, 300);
              }, 3000);
            }
          }
        } catch (error) {
          console.error("Error fetching cart total:", error);
        }
      }

      async function submitProductFeedback(productId, rating, productName) {
        try {
          // FIXED: Consistent rating conversion
          let numericRating;
          let feedbackText;

          // Handle both string and number inputs consistently
          if (rating === "good" || rating === 1 || rating === "1") {
            numericRating = 1;
            feedbackText = "Good";
          } else if (rating === "okay" || rating === 0.5 || rating === "0.5") {
            numericRating = 0.5;
            feedbackText = "Okay";
          } else if (rating === "poor" || rating === 0 || rating === "0") {
            numericRating = 0;
            feedbackText = "Poor";
          } else {
            // Fallback - parse as number
            numericRating = parseFloat(rating);
            if (isNaN(numericRating)) {
              numericRating = 0.5; // Default to Okay
            }
            feedbackText =
              numericRating >= 0.7
                ? "Good"
                : numericRating >= 0.3
                ? "Okay"
                : "Poor";
          }

          console.log(" Submitting feedback:", {
            productId,
            numericRating,
            feedbackText,
            productName,
          });

          const buttons = document.querySelectorAll(
            `.feedback-btn[data-product-id="${productId}"]`
          );

          // Show loading state
          buttons.forEach((btn) => {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;
          });

          // FIXED: Send consistent data to PHP
          const response = await fetch("../php/feedback.php", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `action=save_product_feedback&product_id=${productId}&user_rating=${numericRating}&product_name=${encodeURIComponent(
              productName
            )}`,
            // REMOVED: recommendation_feedback parameter - let PHP handle the conversion
          });

          if (!response.ok)
            throw new Error(`HTTP error! status: ${response.status}`);

          const text = await response.text();

          let result;
          try {
            result = JSON.parse(text);
          } catch (e) {
            console.error("Failed to parse JSON. Response was:", text);
            throw new Error("Server returned invalid JSON response");
          }

          if (result.success) {
            // Store the feedback as TEXT (consistent with database)
            if (window.productData && window.productData[productId]) {
              window.productData[productId].user_feedback = {
                UserRating: result.user_rating,
                RecommendationFeedback: result.recommendation_feedback, // Store as TEXT
                CreatedAt: new Date().toISOString(),
              };
            }

            // Update UI with TEXT feedback
            updateFeedbackButtons(productId, result.recommendation_feedback);

            // REMOVED: Auto-refresh - keep logs visible
            showNotification("Rating saved successfully! ", "success");

            debugFeedbackState();

            // Optional: Re-sort without refresh for immediate UI update
            if (window.currentSort === "relevance") {
              sortAllProducts("relevance");
              showPage(window.currentPage);
            }
          } else {
            throw new Error(result.message || "Unknown error from server");
          }
        } catch (error) {
          console.error("Feedback submission error:", error);
          showNotification("Failed to save rating: " + error.message, "error");
          resetFeedbackButtonsToDefault(productId);
        }
      }

      // FIXED: Update the mapping in updateFeedbackButtons function
      function updateFeedbackButtons(productId, activeFeedback) {
        const buttons = document.querySelectorAll(
          `.feedback-btn[data-product-id="${productId}"]`
        );

        buttons.forEach((btn) => {
          btn.disabled = false;
          const btnFeedback = btn.getAttribute("data-feedback");

          // Remove active class from all buttons first
          btn.classList.remove("active");

          // FIXED: Map numeric data attributes to text feedback
          const buttonToFeedbackMap = {
            1: "Good", // data-feedback="1"  "Good"
            0.5: "Okay", // data-feedback="0.5"  "Okay"
            0: "Poor", // data-feedback="0"  "Poor"
          };

          const buttonFeedbackText = buttonToFeedbackMap[btnFeedback];

          console.log(
            ` Button: ${btnFeedback} -> ${buttonFeedbackText}, Active: ${activeFeedback}`
          );

          // Add active class only to the button matching the active feedback
          if (buttonFeedbackText === activeFeedback) {
            btn.classList.add("active");
          }

          updateButtonContent(btn);
        });
      }

      function resortAndDisplayProducts() {
        if (!window.allRecommendations || !window.productData) return;

        // Get current sort method
        const sortSelect = document.getElementById("sort-by-filter");
        const currentSort = sortSelect ? sortSelect.value : "relevance";

        // Apply the current sort method
        sortAllProducts(currentSort);

        // Re-display current page
        showPage(window.currentPage);
      }

      // NEW: Function to update button content consistently
      function updateButtonContent(button) {
        if (button.classList.contains("thumbs-up")) {
          button.innerHTML = " Good";
        } else if (button.classList.contains("thumbs-neutral")) {
          button.innerHTML = " Okay";
        } else if (button.classList.contains("thumbs-down")) {
          button.innerHTML = " Poor";
        }
      }

      // NEW: Improved reset function that reads from current product data
      function resetFeedbackButtonsToDefault(productId) {
        const buttons = document.querySelectorAll(
          `.feedback-btn[data-product-id="${productId}"]`
        );
        const product = window.productData && window.productData[productId];
        const existingFeedback = product && product.user_feedback;

        buttons.forEach((btn) => {
          btn.disabled = false;
          btn.classList.remove("active");

          // If there's existing feedback, set the active state
          if (existingFeedback) {
            const currentRating = existingFeedback.RecommendationFeedback;
            const btnRating = parseFloat(btn.getAttribute("data-feedback"));

            if (btnRating === currentRating) {
              btn.classList.add("active");
            }
          }

          // Always set consistent text
          updateButtonContent(btn);
        });
      }
      document.addEventListener("click", function (e) {
        const feedbackBtn = e.target.closest(".feedback-btn");
        if (feedbackBtn) {
          e.preventDefault();
          e.stopPropagation();

          const productId = feedbackBtn.getAttribute("data-product-id");
          const rating = parseFloat(feedbackBtn.getAttribute("data-feedback"));
          const productData =
            window.productData && window.productData[productId];

          if (productData) {
            // Immediately update the UI for better UX (optimistic update)
            const buttons = document.querySelectorAll(
              `.feedback-btn[data-product-id="${productId}"]`
            );
            buttons.forEach((btn) => {
              btn.classList.remove("active");
              if (parseFloat(btn.getAttribute("data-feedback")) === rating) {
                btn.classList.add("active");
              }
            });

            submitProductFeedback(productId, rating, productData.Name);
          } else {
            console.error("Product data not found for ID:", productId);
          }
        }
      });

      function refreshFeedbackButtons(productId) {
        if (!productId) return;

        const product = window.productData && window.productData[productId];
        if (!product) return;

        const existingFeedback = product.user_feedback;
        const currentRating = existingFeedback
          ? existingFeedback.RecommendationFeedback
          : null;

        // Update all buttons for this product
        const buttons = document.querySelectorAll(
          `.feedback-btn[data-product-id="${productId}"]`
        );

        buttons.forEach((btn) => {
          btn.classList.remove("active");
          const btnRating = parseFloat(btn.getAttribute("data-feedback"));

          if (currentRating !== null && btnRating === currentRating) {
            btn.classList.add("active");
          }

          updateButtonContent(btn);
        });
      }

      // Add event listeners for external floating card - NO BACKDROP
      document.addEventListener("DOMContentLoaded", function () {
        let externalCard = document.getElementById("external-attribute-card");
        if (!externalCard) {
          externalCard = document.createElement("div");
          externalCard.id = "external-attribute-card";
          document.body.appendChild(externalCard);
        }

        let currentProductId = null;
        let isCardOpen = false;

        // Close card when clicking outside
        document.addEventListener("click", function (e) {
          if (
            !e.target.closest(".attribute-header") &&
            !e.target.closest("#external-attribute-card")
          ) {
            closeCard();
          }
        });

        // Close card on escape key
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") {
            closeCard();
          }
        });

        // Show card on click
        document.addEventListener("click", function (e) {
          const attributeHeader = e.target.closest(".attribute-header");
          if (attributeHeader) {
            e.stopPropagation();

            const attributeSummary =
              attributeHeader.closest(".attribute-summary");
            const productId = attributeSummary.getAttribute("data-product-id");

            if (productId === currentProductId && isCardOpen) {
              closeCard();
            } else {
              openCard(productId, attributeSummary);
            }
          }
        });

        // HIDE CARD WHEN SCROLLING
        window.addEventListener("scroll", function () {
          if (isCardOpen) {
            closeCard();
          }
        });

        function openCard(productId, attributeSummary) {
          currentProductId = productId;
          const productData =
            window.productData && window.productData[productId];
          if (productData && productData.Attribute_Matches) {
            externalCard.innerHTML = createExternalFloatingCard(
              productData.Attribute_Matches,
              productData
            );
            positionExternalCard(externalCard, attributeSummary);
            externalCard.style.display = "block";
            isCardOpen = true;
          }
        }

        function closeCard() {
          externalCard.style.display = "none";
          currentProductId = null;
          isCardOpen = false;
        }
      });

      // Position external card ABOVE the attribute header
      function positionExternalCard(card, attributeSummary) {
        const rect = attributeSummary.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const cardWidth = 280;
        const cardHeight = card.offsetHeight;

        // For mobile, center the card
        if (window.innerWidth <= 768) {
          card.style.left = "50%";
          card.style.top = "50%";
          card.style.transform = "translate(-50%, -50%)";
          return;
        }

        // For desktop: Position ABOVE the attribute header
        let left = rect.left + (rect.width - cardWidth) / 2;
        let top = rect.top - cardHeight - 8;

        // Adjust if going off left edge
        if (left < 10) {
          left = 10;
        }

        // Adjust if going off right edge
        if (left + cardWidth > viewportWidth - 10) {
          left = viewportWidth - cardWidth - 10;
        }

        // Adjust if going off top edge - show below instead
        if (top < 10) {
          top = rect.bottom + 8;
        }

        // Adjust if going off bottom edge when showing below
        if (top + cardHeight > viewportHeight - 10) {
          top = viewportHeight - cardHeight - 10;
        }

        card.style.left = left + "px";
        card.style.top = top + "px";
        card.style.transform = "none";
      }
    </script>
  </body>
</html>
