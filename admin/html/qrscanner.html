<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR Code Scanner - Blessence</title>
  <link rel="icon" href="../images/mainlogo.png" type="image/png">

  <link rel="stylesheet" href="../styles/styles.css">

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- SweetAlert2 CSS & JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

  <style>

    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
    }

    /* Page header */
    .page-header {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid rgba(228, 151, 170, 0.15);
      text-align: center;
    }

    .page-title {
      color: var(--dark-pink);
      font-weight: 700;
      font-size: 2rem;
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }

    .page-header p {
      color: #6c757d;
      font-size: 1rem;
      margin: 0;
    }

    /* Main content container */
    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 15px;
    }

    /* QR Scanner Container - CENTERED */
    .qr-scanner-container {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
      transition: all 0.4s ease;
      border: 1px solid rgba(228, 151, 170, 0.1);
      margin-bottom: 25px;
      height: 100%;
    }

    .qr-scanner-container:hover {
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1);
    }

    .scanner-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .scanner-header h5 {
      color: var(--dark-pink);
      font-weight: 700;
      font-size: 1.3rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Camera Container */
    .camera-container {
      position: relative;
      width: 100%;
      height: 400px;
      border-radius: 16px;
      overflow: hidden;
      background: #000;
      margin-bottom: 20px;
    }

    #qr-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .camera-placeholder {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      color: #6c757d;
      text-align: center;
    }

    .camera-placeholder i {
      font-size: 4rem;
      margin-bottom: 15px;
      color: var(--primary-pink);
    }

    .camera-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .scanner-frame {
      width: 250px;
      height: 250px;
      border: 2px solid var(--primary-pink);
      border-radius: 12px;
      position: relative;
      box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.4);
    }

    .scanner-frame::before,
    .scanner-frame::after {
      content: '';
      position: absolute;
      width: 30px;
      height: 30px;
      border: 3px solid var(--primary-pink);
    }

    .scanner-frame::before {
      top: -3px;
      left: -3px;
      border-right: none;
      border-bottom: none;
    }

    .scanner-frame::after {
      bottom: -3px;
      right: -3px;
      border-left: none;
      border-top: none;
    }

    /* Cancel Button - Circle with X */
    .cancel-scan-btn {
      position: absolute;
      top: 15px;
      left: 15px;
      background: rgba(220, 53, 69, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 20;
      transition: all 0.3s ease;
      font-size: 1.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .cancel-scan-btn:hover {
      background: #dc3545;
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }

    /* Camera Controls */
    .camera-controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }

    .camera-btn {
      background: var(--primary-pink);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 12px 25px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(228, 151, 170, 0.3);
    }

    .camera-btn:hover {
      background: var(--secondary-pink);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(228, 151, 170, 0.4);
    }

    .camera-btn:active {
      transform: translateY(0);
    }

    .camera-btn.off {
      background: #dc3545;
    }

    .camera-btn.off:hover {
      background: #c82333;
    }

    /* Order Details - EXPANDED AND CENTERED */
    .order-details {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
      transition: all 0.4s ease;
      border: 1px solid rgba(228, 151, 170, 0.1);
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .order-details:hover {
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1);
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid rgba(228, 151, 170, 0.15);
    }

    .order-header h5 {
      color: var(--dark-pink);
      font-weight: 700;
      font-size: 1.3rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .order-status {
      background: #6c757d;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .order-status.pending {
      background: #ffc107;
    }

    .order-status.ready {
      background: #17a2b8;
    }

    .order-status.completed {
      background: #28a745;
    }

    .order-status.cancelled {
      background: #dc3545;
    }

    /* IMPROVED Order Content */
    .order-content {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .order-info {
      margin-bottom: 25px;
      background: #f9f9f9;
      border-radius: 12px;
      padding: 20px;
    }

    .order-info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #f0f0f0;
    }

    .order-info-label {
      color: #6c757d;
      font-weight: 500;
    }

    .order-info-value {
      color: #333;
      font-weight: 600;
    }

    .order-items {
      margin-bottom: 25px;
    }

    .order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .order-item:last-child {
      border-bottom: none;
    }

    .item-details {
      flex: 1;
    }

    .item-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .item-meta {
      display: flex;
      gap: 15px;
      color: #6c757d;
      font-size: 0.9rem;
    }

    .item-price {
      font-weight: 600;
      color: var(--dark-pink);
    }

    /* IMPROVED Total and Button */
    .order-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      border-top: 2px solid rgba(228, 151, 170, 0.15);
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--dark-pink);
      background: white;
    }

    .order-actions {
      margin-top: 20px;
      background: white;
      padding-top: 10px;
    }

    .order-done-btn {
      background: var(--primary-pink);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 15px 25px;
      font-weight: 600;
      font-size: 1rem;
      width: 100%;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(228, 151, 170, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .order-done-btn:hover {
      background: var(--secondary-pink);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(228, 151, 170, 0.4);
    }

    .order-done-btn:active {
      transform: translateY(0);
    }

    .no-order {
      text-align: center;
      padding: 40px 20px;
      color: #6c757d;
    }

    .no-order i {
      font-size: 3rem;
      margin-bottom: 15px;
      color: var(--primary-pink);
    }

    /* Scanner Results */
    .scanner-results {
      margin-top: 20px;
      padding: 15px;
      border-radius: 12px;
      background: #f8f9fa;
      display: none;
    }

    .scanner-results.success {
      display: block;
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .scanner-results.error {
      display: block;
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .scanner-results.info {
      display: block;
      background: #cce7ff;
      color: #004085;
      border: 1px solid #b3d7ff;
    }

    /* Confirmation Modal */
    .confirmation-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .confirmation-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }

    .confirmation-content h4 {
      color: var(--dark-pink);
      margin-bottom: 15px;
    }

    .confirmation-content p {
      color: #6c757d;
      margin-bottom: 25px;
    }

    .confirmation-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .confirm-btn {
      background: var(--primary-pink);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 25px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
    }

    .confirm-btn:hover {
      background: var(--secondary-pink);
      transform: translateY(-2px);
    }

    .cancel-confirm-btn {
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 25px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
    }

    .cancel-confirm-btn:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    /* NEW: Order Summary Card */
    .order-summary-card {
      background: #f9f9f9;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .order-summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .order-summary-title {
      font-weight: 600;
      color: var(--dark-pink);
      font-size: 1.1rem;
    }

    .order-summary-items {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .order-summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    .order-summary-item:last-child {
      border-bottom: none;
    }

    .item-quantity {
      background: var(--primary-pink);
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 600;
    }

    /* NEW: Customer Info Card */
    .customer-info-card {
      background: #f9f9f9;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .customer-info-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .customer-info-title {
      font-weight: 600;
      color: var(--dark-pink);
      font-size: 1.1rem;
    }

    .customer-details {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .customer-detail {
      display: flex;
      justify-content: space-between;
    }

    .customer-label {
      color: #6c757d;
      font-weight: 500;
    }

    .customer-value {
      color: #333;
      font-weight: 600;
    }

    /* NEW: Scan Instructions */
    .scan-instructions {
      background: #e9f7fe;
      border-radius: 12px;
      padding: 15px;
      margin-top: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .scan-instructions i {
      color: #17a2b8;
      font-size: 1.2rem;
    }

    .scan-instructions p {
      margin: 0;
      color: #0c5460;
      font-size: 0.9rem;
    }

    /* Responsive Design */

    /* Large Screens (1200px - 1399px) */
    @media (min-width: 1200px) and (max-width: 1399px) {
      .page-title {
        font-size: 1.8rem;
      }
    }

    /* Medium Screens (992px - 1199px) */
    @media (min-width: 992px) and (max-width: 1199px) {
      .page-title {
        font-size: 1.6rem;
      }

      .camera-container {
        height: 350px;
      }
    }

    /* Tablets (768px - 991px) */
    @media (min-width: 768px) and (max-width: 991px) {
      .page-title {
        font-size: 1.5rem;
      }

      .camera-container {
        height: 350px;
      }
    }

    /* Mobile Landscape (576px - 767px) */
    @media (min-width: 576px) and (max-width: 767px) {
      .page-title {
        font-size: 1.4rem;
      }

      .page-header {
        margin-bottom: 20px;
        padding-bottom: 15px;
      }

      .page-header p {
        font-size: 0.85rem;
      }

      .camera-container {
        height: 300px;
      }

      .scanner-frame {
        width: 200px;
        height: 200px;
      }

      .camera-controls {
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .camera-btn {
        width: 100%;
        justify-content: center;
      }

      .order-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .item-price {
        align-self: flex-end;
      }
    }

    /* Mobile Portrait (up to 575px) */
    @media (max-width: 575px) {
      .page-title {
        font-size: 1.3rem;
      }

      .page-header {
        margin-bottom: 20px;
        padding-bottom: 15px;
      }

      .page-header p {
        font-size: 0.85rem;
      }

      .qr-scanner-container,
      .order-details {
        padding: 16px;
        border-radius: 16px;
      }

      .scanner-header,
      .order-header {
        margin-bottom: 20px;
      }

      .scanner-header h5,
      .order-header h5 {
        font-size: 1.1rem;
      }

      .camera-container {
        height: 250px;
      }

      .scanner-frame {
        width: 180px;
        height: 180px;
      }

      .camera-controls {
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .camera-btn {
        width: 100%;
        justify-content: center;
      }

      .order-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .item-price {
        align-self: flex-end;
      }
    }

    /* Animation for page load */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .qr-scanner-container,
    .order-details {
      animation: fadeInUp 0.6s ease forwards;
    }

    .qr-scanner-container {
      animation-delay: 0.1s;
    }

    .order-details {
      animation-delay: 0.2s;
    }
  </style>
</head>

<body>

  <!-- Confirmation Modal -->
  <div class="confirmation-modal" id="confirmationModal">
    <div class="confirmation-content">
      <h4><i class="fas fa-question-circle"></i> Confirm Order Completion</h4>
      <p>Are you sure the order has been paid?</p>
      <div class="confirmation-buttons">
        <button class="cancel-confirm-btn" id="cancelConfirmBtn">No</button>
        <button class="confirm-btn" id="confirmOrderBtn">Yes, Order Paid</button>
      </div>
    </div>
  </div>

  <div class="main-container">

    <div class="row justify-content-center">
      <!-- QR Scanner Section - CENTERED -->
      <div class="col-lg-7 mb-4">
        <div class="qr-scanner-container">
          <div class="scanner-header">
            <h5><i class="fas fa-qrcode"></i> Scanner</h5>
            <div class="scan-instructions">
              <i class="fas fa-info-circle"></i>
              <p>Point the camera at the QR code to scan automatically</p>
            </div>
          </div>

          <div class="camera-container">
            <!-- ADDED: Cancel Scan Button (Circle with X) -->
            <button class="cancel-scan-btn" id="cancelScanBtn">
              <i class="fas fa-times"></i>
            </button>

            <div class="camera-placeholder" id="cameraPlaceholder">
              <i class="fas fa-camera"></i>
              <div>Camera will appear here when started</div>
            </div>
            <video id="qr-video" autoplay muted playsinline style="display: none;"></video>
            <div class="camera-overlay">
              <div class="scanner-frame"></div>
            </div>
          </div>

          <div class="scanner-results" id="scannerResults"></div>

          <div class="camera-controls">
            <button class="camera-btn" id="startCamera">
              <i class="fas fa-camera"></i> Start Camera
            </button>
            <button class="camera-btn off" id="stopCamera" disabled>
              <i class="fas fa-stop"></i> Stop Camera
            </button>
          </div>
        </div>
      </div>

      <!-- Order Details Section - EXPANDED AND CENTERED -->
      <div class="col-lg-5 mb-4">
        <div class="order-details">
          <div class="order-header">
            <h5><i class="fas fa-receipt"></i> Order Details</h5>
            <span class="order-status" id="orderStatus">No Order</span>
          </div>

          <!-- IMPROVED Order Content -->
          <div class="order-content" id="orderContent">
            <div class="no-order">
              <i class="fas fa-qrcode"></i>
              <h5>No Order Scanned</h5>
              <p>Scan a QR code to view order details</p>
            </div>
          </div>

          <!-- IMPROVED Total -->
          <div class="order-total" id="orderTotal" style="display: none;">
            <span>Total:</span>
            <span id="totalAmount">$0.00</span>
          </div>

          <!-- IMPROVED Order Done Button -->
          <div class="order-actions" id="orderActions" style="display: none;">
            <button class="order-done-btn" id="orderDoneBtn">
              <i class="fas fa-check-circle"></i> Order Done
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // QR Scanner JavaScript

    // QR Scanner Elements
    const video = document.getElementById('qr-video');
    const cameraPlaceholder = document.getElementById('cameraPlaceholder');
    const startCameraBtn = document.getElementById('startCamera');
    const stopCameraBtn = document.getElementById('stopCamera');
    const cancelScanBtn = document.getElementById('cancelScanBtn');
    const scannerResults = document.getElementById('scannerResults');
    const orderContent = document.getElementById('orderContent');
    const orderStatus = document.getElementById('orderStatus');
    const orderTotal = document.getElementById('orderTotal');
    const totalAmount = document.getElementById('totalAmount');
    const orderActions = document.getElementById('orderActions');
    const orderDoneBtn = document.getElementById('orderDoneBtn');
    const confirmationModal = document.getElementById('confirmationModal');
    const confirmOrderBtn = document.getElementById('confirmOrderBtn');
    const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');

    let stream = null;
    let scanning = false;
    let currentOrderId = null;
    let scanInterval = null;
    let lastScannedQR = null;
    let lastScanTime = 0;
    const SCAN_COOLDOWN = 3000; // 3 seconds cooldown between scans

    // Load jsQR library from CDN
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js';
    script.onload = function() {
      console.log('jsQR library loaded successfully');
    };
    script.onerror = function() {
      console.error('Failed to load jsQR library');
      scannerResults.textContent = 'Error: Failed to load QR scanner library';
      scannerResults.className = 'scanner-results error';
    };
    document.head.appendChild(script);

    // Start camera function
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        });

        video.srcObject = stream;
        video.style.display = 'block';
        cameraPlaceholder.style.display = 'none';

        startCameraBtn.disabled = true;
        stopCameraBtn.disabled = false;
        cancelScanBtn.style.display = 'flex';

        scanning = true;
        lastScannedQR = null; // Reset last scanned QR
        lastScanTime = 0; // Reset scan time
        startScanning();

      } catch (err) {
        console.error('Error accessing camera:', err);
        scannerResults.textContent = 'Error: ' + err.message + '. Please allow camera access.';
        scannerResults.className = 'scanner-results error';
      }
    }

    // Stop camera function
    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
        video.style.display = 'none';
        cameraPlaceholder.style.display = 'flex';
        stream = null;
      }

      scanning = false;
      if (scanInterval) {
        clearInterval(scanInterval);
        scanInterval = null;
      }

      startCameraBtn.disabled = false;
      stopCameraBtn.disabled = true;
      cancelScanBtn.style.display = 'none';

      scannerResults.textContent = 'Camera stopped.';
      scannerResults.className = 'scanner-results';
    }

    // Cancel scan process (only stops camera, doesn't clear order)
    function cancelScanProcess() {
      stopCamera();
      scannerResults.textContent = 'Camera stopped. Order details remain on screen.';
      scannerResults.className = 'scanner-results info';
    }

    // Start scanning for QR codes
    function startScanning() {
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');

      scanInterval = setInterval(() => {
        if (!scanning || !video.videoWidth) return;

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        
        if (typeof jsQR !== 'undefined') {
          const code = jsQR(imageData.data, imageData.width, imageData.height);
          
          if (code && code.data) {
            const currentTime = Date.now();
            
            // Prevent scanning the same QR code within cooldown period
            if (code.data !== lastScannedQR || (currentTime - lastScanTime) > SCAN_COOLDOWN) {
              lastScannedQR = code.data;
              lastScanTime = currentTime;
              handleQRCode(code.data);
            }
          }
        }
      }, 300); // Scan every 300ms
    }

    // Handle detected QR code (camera stays on)
    function handleQRCode(qrData) {
      if (!scanning) return;
      
      console.log('QR Code detected:', qrData);
      
      // DON'T stop scanning - keep camera running
      scannerResults.textContent = 'QR Code detected! Loading order... (Camera stays on)';
      scannerResults.className = 'scanner-results info';
      
      // Fetch order details
      fetchOrderDetails(qrData);
    }

    // Fetch order details from server
    async function fetchOrderDetails(qrCode) {
      try {
        console.log('Fetching order for QR:', qrCode);
        
        // This is a mock function - replace with actual API call
        const mockOrder = {
          success: true,
          order: {
            order_id: "ORD-12345",
            customer_name: "John Smith",
            order_date: "2023-11-15",
            qr_code: qrCode,
            status: "ready",
            items_count: 3,
            total_price: "85.50",
            items: [
              {
                product_name: "Lipstick - Ruby Red",
                shade: "Ruby Red",
                category: "Lipstick",
                quantity: 1,
                subtotal: "25.50"
              },
              {
                product_name: "Foundation - Medium Beige",
                shade: "Medium Beige",
                category: "Foundation",
                quantity: 1,
                subtotal: "35.00"
              },
              {
                product_name: "Mascara - Black",
                shade: "Black",
                category: "Mascara",
                quantity: 1,
                subtotal: "25.00"
              }
            ]
          }
        };
        
        // Simulate API delay
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        if (mockOrder.success) {
          displayOrderDetails(mockOrder.order);
          scannerResults.textContent = 'Order loaded successfully! ✅';
          scannerResults.className = 'scanner-results success';
        } else {
          scannerResults.textContent = 'Order not found';
          scannerResults.className = 'scanner-results error';
        }
      } catch (error) {
        console.error('Error fetching order:', error);
        scannerResults.textContent = 'Error loading order: ' + error.message;
        scannerResults.className = 'scanner-results error';
      }
    }

    // IMPROVED: Display order details with better organization
    function displayOrderDetails(order) {
      currentOrderId = order.order_id;
      
      console.log('Displaying order:', order);
      
      // Update order status
      orderStatus.textContent = order.status.charAt(0).toUpperCase() + order.status.slice(1);
      orderStatus.className = `order-status ${order.status}`;
      
      // Build order content HTML with improved layout
      const orderHTML = `
        <!-- Customer Information Card -->
        <div class="customer-info-card">
          <div class="customer-info-header">
            <i class="fas fa-user"></i>
            <div class="customer-info-title">Customer Information</div>
          </div>
          <div class="customer-details">
            <div class="customer-detail">
              <span class="customer-label">Name:</span>
              <span class="customer-value">${order.customer_name}</span>
            </div>
            <div class="customer-detail">
              <span class="customer-label">Order Date:</span>
              <span class="customer-value">${order.order_date}</span>
            </div>
            <div class="customer-detail">
              <span class="customer-label">QR Code:</span>
              <span class="customer-value">${order.qr_code}</span>
            </div>
          </div>
        </div>
        
        <!-- Order Summary Card -->
        <div class="order-summary-card">
          <div class="order-summary-header">
            <div class="order-summary-title">Order Items (${order.items_count})</div>
            <div class="order-id">#${order.order_id}</div>
          </div>
          <div class="order-summary-items">
            ${order.items.map(item => `
              <div class="order-summary-item">
                <div class="item-details">
                  <div class="item-name">${item.product_name}</div>
                  <div class="item-meta">
                    <span><i class="fas fa-palette"></i> ${item.shade}</span>
                    <span><i class="fas fa-tag"></i> ${item.category}</span>
                  </div>
                </div>
                <div class="item-price">
                  <div class="item-quantity">${item.quantity}</div>
                  ₱${item.subtotal}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
      
      orderContent.innerHTML = orderHTML;
      
      // Show total and actions
      totalAmount.textContent = `₱${order.total_price}`;
      orderTotal.style.display = 'flex';
      orderActions.style.display = 'block';
    }

    // Reset order display
    function resetOrderDisplay() {
      currentOrderId = null;
      orderContent.innerHTML = `
        <div class="no-order">
          <i class="fas fa-qrcode"></i>
          <h5>No Order Scanned</h5>
          <p>Scan a QR code to view order details</p>
        </div>
      `;
      orderStatus.textContent = 'No Order';
      orderStatus.className = 'order-status';
      orderTotal.style.display = 'none';
      orderActions.style.display = 'none';
    }

    // Show confirmation modal
    function showConfirmationModal() {
      confirmationModal.style.display = 'flex';
    }

    // Hide confirmation modal
    function hideConfirmationModal() {
      confirmationModal.style.display = 'none';
    }

    // Complete order (stays on page, resets order display, keeps camera on)
    async function completeOrder() {
      if (!currentOrderId) {
        alert('No order to complete');
        return;
      }
      
      console.log('Completing order:', currentOrderId);
      
      try {
        // This is a mock function - replace with actual API call
        const mockResponse = {
          success: true,
          message: 'Order marked as completed successfully!'
        };
        
        // Simulate API delay
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        if (mockResponse.success) {
          scannerResults.textContent = mockResponse.message + ' Ready to scan next order!';
          scannerResults.className = 'scanner-results success';
          
          hideConfirmationModal();
          resetOrderDisplay();
          
          // Reset last scanned QR so we can scan a new one immediately
          lastScannedQR = null;
          lastScanTime = 0;
          
          // NO REDIRECT - stays on page, camera keeps running if it was on
          
        } else {
          scannerResults.textContent = mockResponse.message || 'Error completing order';
          scannerResults.className = 'scanner-results error';
          hideConfirmationModal();
        }
      } catch (error) {
        console.error('Error completing order:', error);
        scannerResults.textContent = 'Error completing order: ' + error.message;
        scannerResults.className = 'scanner-results error';
        hideConfirmationModal();
      }
    }

    // Event Listeners
    startCameraBtn.addEventListener('click', startCamera);
    stopCameraBtn.addEventListener('click', stopCamera);
    cancelScanBtn.addEventListener('click', cancelScanProcess);
    orderDoneBtn.addEventListener('click', showConfirmationModal);
    confirmOrderBtn.addEventListener('click', completeOrder);
    cancelConfirmBtn.addEventListener('click', hideConfirmationModal);

    // Close modal when clicking outside
    confirmationModal.addEventListener('click', function (e) {
      if (e.target === confirmationModal) {
        hideConfirmationModal();
      }
    });
  </script>
</body>

</html>