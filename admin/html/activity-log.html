<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cashier Mode - Blessence</title>
  <link rel="icon" href="../images/mainlogo.png" type="image/png">

  <link rel="stylesheet" href="../styles/styles.css">

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    crossorigin="anonymous" referrerpolicy="no-referrer" />

  <script src="../../admin/styles/logout.js"></script>

  <!-- SweetAlert2 CSS & JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

  <style>
    /* Page header */
    .page-header {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid rgba(228, 151, 170, 0.15);
    }

    .page-title {
      color: var(--dark-pink);
      font-weight: 700;
      font-size: 2rem;
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }

    .page-header p {
      color: #6c757d;
      font-size: 1rem;
      margin: 0;
    }

    /* Main content padding */
    main {
      padding: 35px !important;
      margin-left: 16.666667%;
      width: calc(100% - 16.666667%);
      transition: margin-left 0.3s ease;
    }

    /* Product Grid Container */
    .product-grid-container {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
      transition: all 0.4s ease;
      border: 1px solid rgba(228, 151, 170, 0.1);
      margin-bottom: 25px;
    }

    .product-grid-container:hover {
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1);
    }

    .product-grid-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .product-grid-header h5 {
      color: var(--dark-pink);
      font-weight: 700;
      font-size: 1.3rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Product Grid */
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      max-height: 500px;
      overflow-y: auto;
      padding: 10px;
    }

    .product-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      transition: all 0.3s ease;
      cursor: pointer;
      border: 1px solid rgba(228, 151, 170, 0.1);
    }

    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
      border-color: var(--primary-pink);
    }

    .product-card.selected {
      border-color: var(--primary-pink);
      box-shadow: 0 0 0 2px var(--primary-pink);
    }

    .product-image {
      width: 100%;
      height: 150px;
      object-fit: cover;
    }

    .product-info {
      padding: 15px;
    }

    .product-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
      font-size: 0.95rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .product-details {
      color: #6c757d;
      font-size: 0.85rem;
      margin-bottom: 8px;
    }

    .product-price {
      font-weight: 700;
      color: var(--dark-pink);
      font-size: 1rem;
      margin-bottom: 10px;
    }

    .product-stock {
      font-size: 0.8rem;
      color: #6c757d;
    }

    .stock-low {
      color: #ff9800;
    }

    .stock-out {
      color: #f44336;
    }

    /* Order Summary Section */
    .order-summary {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
      transition: all 0.4s ease;
      border: 1px solid rgba(228, 151, 170, 0.1);
      height: calc(100vh - 110px);
      display: flex;
      flex-direction: column;
      position: sticky;
      top: 35px;
    }

    .order-summary:hover {
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1);
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid rgba(228, 151, 170, 0.15);
    }

    .order-header h5 {
      color: var(--dark-pink);
      font-weight: 700;
      font-size: 1.3rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .clear-order-btn {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 15px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .clear-order-btn:hover {
      background: #c82333;
      transform: translateY(-2px);
    }

    /* Order Items List */
    .order-items-list {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .order-item {
      display: flex;
      align-items: center;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 12px;
      margin-bottom: 10px;
      position: relative;
    }

    .order-item img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 8px;
      margin-right: 15px;
    }

    .order-item-info {
      flex: 1;
    }

    .order-item-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .order-item-shade {
      color: #6c757d;
      font-size: 0.9rem;
    }

    .order-item-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .qty-control {
      display: flex;
      align-items: center;
      gap: 10px;
      background: white;
      border-radius: 8px;
      padding: 5px 10px;
    }

    .qty-btn {
      background: var(--primary-pink);
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .qty-btn:hover {
      background: var(--secondary-pink);
      transform: scale(1.1);
    }

    .qty-display {
      font-weight: 600;
      color: #333;
      min-width: 30px;
      text-align: center;
    }

    .order-item-price {
      font-weight: 700;
      color: var(--dark-pink);
      font-size: 1.1rem;
      margin-left: 15px;
    }

    .remove-item-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }

    .remove-item-btn:hover {
      background: #c82333;
      transform: scale(1.1);
    }

    /* Empty Order State */
    .empty-order {
      text-align: center;
      padding: 40px 20px;
      color: #6c757d;
    }

    .empty-order i {
      font-size: 3rem;
      margin-bottom: 15px;
      color: var(--primary-pink);
    }

    /* Order Total */
    .order-total-section {
      background: #f9f9f9;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .order-total-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    .order-total-row:last-child {
      border-bottom: none;
      padding-top: 15px;
      margin-top: 10px;
      border-top: 2px solid rgba(228, 151, 170, 0.3);
    }

    .total-label {
      font-weight: 600;
      color: #333;
    }

    .total-value {
      font-weight: 700;
      color: var(--dark-pink);
      font-size: 1.3rem;
    }

    /* Checkout Button */
    .checkout-btn {
      background: var(--primary-pink);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 15px 25px;
      font-weight: 600;
      font-size: 1rem;
      width: 100%;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(228, 151, 170, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .checkout-btn:hover {
      background: var(--secondary-pink);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(228, 151, 170, 0.4);
    }

    .checkout-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    /* Customer Info Input */
    .customer-info-section {
      background: #f9f9f9;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .customer-info-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      color: var(--dark-pink);
      font-weight: 600;
    }

    .customer-input {
      width: 100%;
      padding: 12px;
      border: 2px solid rgba(228, 151, 170, 0.3);
      border-radius: 8px;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      margin-bottom: 10px;
    }

    .customer-input:focus {
      outline: none;
      border-color: var(--primary-pink);
    }

    /* Search Box */
    .search-box {
      position: relative;
      margin-bottom: 20px;
    }

    .search-input {
      width: 100%;
      padding: 15px 50px 15px 20px;
      border: 2px solid rgba(228, 151, 170, 0.3);
      border-radius: 12px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary-pink);
      box-shadow: 0 0 0 3px rgba(228, 151, 170, 0.1);
    }

    .search-icon {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--primary-pink);
      font-size: 1.2rem;
    }

    /* Category Filter */
    .category-filter {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .category-btn {
      background: white;
      border: 1px solid rgba(228, 151, 170, 0.3);
      border-radius: 20px;
      padding: 8px 15px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .category-btn:hover {
      border-color: var(--primary-pink);
      color: var(--primary-pink);
    }

    .category-btn.active {
      background: var(--primary-pink);
      color: white;
      border-color: var(--primary-pink);
    }

    /* Animation */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .product-grid-container,
    .order-summary {
      animation: fadeInUp 0.6s ease forwards;
    }

    .product-grid-container {
      animation-delay: 0.1s;
    }

    .order-summary {
      animation-delay: 0.2s;
    }

    /* Responsive Design */
    @media (max-width: 991px) {
      .mobile-header {
        display: block;
      }

      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100%;
        width: 280px;
        transform: translateX(-100%);
        z-index: 100;
        margin-top: 60px;
      }

      .sidebar.mobile-open {
        transform: translateX(0);
      }

      main {
        margin-top: 70px;
        margin-left: 0 !important;
        width: 100% !important;
        padding: 25px !important;
      }

      .product-grid-container,
      .order-summary {
        position: relative;
        top: 0;
        height: auto;
      }

      .order-summary {
        max-height: 600px;
      }
    }

    @media (max-width: 575px) {
      main {
        padding: 15px !important;
      }

      .page-title {
        font-size: 1.3rem;
      }

      .product-grid-container,
      .order-summary {
        padding: 20px;
        border-radius: 16px;
      }

      .product-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
      }

      .order-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .order-item-controls {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>

<body>

  <!-- Mobile Header -->
  <div class="mobile-header">
    <div class="mobile-header-content">
      <button class="hamburger-btn" id="hamburgerBtn">
        <i class="fas fa-bars"></i>
      </button>
      <div class="mobile-logo">
        <img src="../images/mainlogo.png" alt="Store Logo">
      </div>
    </div>
  </div>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar Overlay -->
      <div class="sidebar-overlay" id="sidebarOverlay"></div>

      <!-- Sidebar -->
      <nav class="col-md-2 d-md-block sidebar" id="sidebar">
        <div class="logo-container">
          <a href="admin.html">
            <img src="../images/mainlogo.png" alt="Store Logo" class="logo" />
          </a>
          <div class="store-name">Beauty & Blessed</div>
        </div>
        <div class="nav flex-column">
          <a href="admin.html" class="nav-link">
            <i class="fa-solid fa-tachometer-alt"></i>
            <span>Dashboard</span>
          </a>
          <a href="product-management.html" class="nav-link">
            <i class="fa-solid fa-box"></i>
            <span>Product Management</span>
          </a>
          <a href="recommendation-insights.html" class="nav-link">
            <i class="fa-solid fa-lightbulb"></i>
            <span>Recommendation Insights</span>
          </a>
          <a href="customer-managemnet.html" class="nav-link">
            <i class="fa-solid fa-users"></i>
            <span>Customer Management</span>
          </a>
          <a href="order-transactions.html" class="nav-link">
            <i class="fa-solid fa-credit-card"></i>
            <span>Order Transaction</span>
          </a>
          <a href="activity-log.html" class="nav-link">
            <i class="fa-solid fa-clock-rotate-left"></i>
            <span>Activity Log</span>
          </a>
          <a id="logoutBtn" href="javascript:void(0)" class="nav-link">
            <i class="fa-solid fa-right-from-bracket"></i>
            <span>Log Out</span>
          </a>
        </div>
      </nav>

      <!-- Main content -->
      <main class="col-md-10">
        <div class="page-header">
          <h1 class="page-title">Cashier Mode</h1>
          <p>Select products and add quantities to create orders</p>
        </div>

        <div class="row">
          <!-- Product Grid Section -->
          <div class="col-lg-8">
            <div class="product-grid-container">
              <div class="product-grid-header">
                <h5><i class="fas fa-boxes"></i> Product Catalog</h5>
              </div>

              <div class="search-box">
                <input type="text" class="search-input" id="productSearch"
                  placeholder="Search by product name, category, or shade..." autocomplete="off">
                <i class="fas fa-search search-icon"></i>
              </div>

              <div class="category-filter" id="categoryFilter">
                <!-- Categories will be inserted here -->
              </div>

              <div class="product-grid" id="productGrid">
                <!-- Product cards will be inserted here -->
              </div>
            </div>
          </div>

          <!-- Order Summary Section -->
          <div class="col-lg-4">
            <div class="order-summary">
              <div class="order-header">
                <h5><i class="fas fa-shopping-cart"></i> Current Order</h5>
                <button class="clear-order-btn" id="clearOrderBtn" style="display: none;">
                  <i class="fas fa-trash"></i> Clear
                </button>
              </div>

              <!-- Customer Info -->
              <div class="customer-info-section" id="customerInfoSection" style="display: none;">
                <div class="customer-info-header">
                  <i class="fas fa-user"></i>
                  <span>Customer Information</span>
                </div>
                <input type="text" class="customer-input" id="customerName" placeholder="Customer Name (Optional)">
              </div>

              <!-- Order Items List -->
              <div class="order-items-list" id="orderItemsList">
                <div class="empty-order">
                  <i class="fas fa-shopping-basket"></i>
                  <h5>No Items Added</h5>
                  <p>Select products to start an order</p>
                </div>
              </div>

              <!-- Order Total -->
              <div class="order-total-section" id="orderTotalSection" style="display: none;">
                <div class="order-total-row">
                  <span class="total-label">Subtotal:</span>
                  <span id="subtotalAmount">₱0.00</span>
                </div>
                <div class="order-total-row">
                  <span class="total-label">Items:</span>
                  <span id="itemCount">0</span>
                </div>
                <div class="order-total-row">
                  <span class="total-label">Total:</span>
                  <span class="total-value" id="totalAmount">₱0.00</span>
                </div>
              </div>

              <!-- Checkout Button -->
              <button class="checkout-btn" id="checkoutBtn" disabled>
                <i class="fas fa-check-circle"></i> Complete Order
              </button>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Mobile menu functionality
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');

    if (hamburgerBtn) {
      hamburgerBtn.addEventListener('click', function () {
        sidebar.classList.toggle('mobile-open');
        sidebarOverlay.classList.toggle('active');
      });
    }

    if (sidebarOverlay) {
      sidebarOverlay.addEventListener('click', function () {
        sidebar.classList.remove('mobile-open');
        sidebarOverlay.classList.remove('active');
      });
    }

    // Cashier Mode Logic
    const productSearch = document.getElementById('productSearch');
    const productGrid = document.getElementById('productGrid');
    const categoryFilter = document.getElementById('categoryFilter');
    const orderItemsList = document.getElementById('orderItemsList');
    const customerInfoSection = document.getElementById('customerInfoSection');
    const orderTotalSection = document.getElementById('orderTotalSection');
    const clearOrderBtn = document.getElementById('clearOrderBtn');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const customerName = document.getElementById('customerName');

    let currentOrder = [];
    let allProducts = [];
    let categories = [];
    let selectedCategory = 'All';
    let searchTimeout;

    // Fetch all products on page load
    async function fetchProducts() {
      try {
        const response = await fetch('../php/cashier-mode.php?action=get_products');
        const data = await response.json();

        if (data.success) {
          allProducts = data.products;
          extractCategories();
          displayProducts(allProducts);
          displayCategoryFilter();
        } else {
          console.error('Error fetching products:', data.message);
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // Extract unique categories from products
    function extractCategories() {
      const categorySet = new Set();
      allProducts.forEach(product => {
        if (product.category) {
          categorySet.add(product.category);
        }
      });
      categories = ['All', ...Array.from(categorySet).sort()];
    }

    // Display category filter buttons
    function displayCategoryFilter() {
      const html = categories.map(category => `
        <button class="category-btn ${category === 'All' ? 'active' : ''}" 
                onclick="filterByCategory('${category}')">
          ${category}
        </button>
      `).join('');
      
      categoryFilter.innerHTML = html;
    }

    // Filter products by category
    window.filterByCategory = function(category) {
      selectedCategory = category;
      
      // Update active category button
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Filter and display products
      const filtered = category === 'All' 
        ? allProducts 
        : allProducts.filter(product => product.category === category);
      
      displayProducts(filtered);
    };

    // Search products
    productSearch.addEventListener('input', function () {
      clearTimeout(searchTimeout);
      const query = this.value.trim().toLowerCase();

      if (query.length === 0) {
        displayProducts(allProducts);
        return;
      }

      searchTimeout = setTimeout(() => {
        const filtered = allProducts.filter(product =>
          product.name.toLowerCase().includes(query) ||
          product.category.toLowerCase().includes(query) ||
          (product.shade && product.shade.toLowerCase().includes(query))
        );

        displayProducts(filtered);
      }, 300);
    });

    // Display products in grid
    function displayProducts(products) {
      if (products.length === 0) {
        productGrid.innerHTML = `
          <div class="col-12 text-center py-5">
            <i class="fas fa-search" style="font-size: 3rem; color: #ccc; margin-bottom: 15px;"></i>
            <p style="color: #6c757d;">No products found</p>
          </div>
        `;
        return;
      }

      const html = products.map(product => {
        const stockClass = product.stocks <= 0 ? 'stock-out' : 
                          product.stocks <= 5 ? 'stock-low' : '';
        
        return `
          <div class="product-card" onclick="selectProduct('${product.product_id}')">
            <img src="${product.image || '../images/placeholder.png'}" alt="${product.name}" class="product-image">
            <div class="product-info">
              <div class="product-name">${product.name}</div>
              <div class="product-details">
                <div>${product.category}</div>
                ${product.shade ? `<div>${product.shade}</div>` : ''}
              </div>
              <div class="product-price">₱${parseFloat(product.price).toFixed(2)}</div>
              <div class="product-stock ${stockClass}">
                ${product.stocks <= 0 ? 'Out of Stock' : 
                  product.stocks <= 5 ? `Low Stock: ${product.stocks}` : 
                  `In Stock: ${product.stocks}`}
              </div>
            </div>
          </div>
        `;
      }).join('');

      productGrid.innerHTML = html;
    }

    // Select product for order
    window.selectProduct = function (productId) {
      const product = allProducts.find(p => p.product_id === productId);
      if (!product) return;

      if (product.stocks <= 0) {
        Swal.fire({
          icon: 'error',
          title: 'Out of Stock',
          text: 'This product is currently out of stock.'
        });
        return;
      }

      // Check if product is already in order
      const existingItem = currentOrder.find(item => item.product_id === productId);

      if (existingItem) {
        // If already in order, increase quantity
        if (existingItem.quantity >= product.stocks) {
          Swal.fire({
            icon: 'warning',
            title: 'Stock Limit',
            text: `Only ${product.stocks} units available.`
          });
          return;
        }
        existingItem.quantity++;
      } else {
        // Add new item to order
        currentOrder.push({
          product_id: productId,
          name: product.name,
          shade: product.shade,
          price: parseFloat(product.price),
          quantity: 1,
          image: product.image,
          max_stock: product.stocks
        });
      }

      updateOrderDisplay();
    };

    // Update order display
    function updateOrderDisplay() {
      if (currentOrder.length === 0) {
        orderItemsList.innerHTML = `
          <div class="empty-order">
            <i class="fas fa-shopping-basket"></i>
            <h5>No Items Added</h5>
            <p>Select products to start an order</p>
          </div>
        `;
        customerInfoSection.style.display = 'none';
        orderTotalSection.style.display = 'none';
        clearOrderBtn.style.display = 'none';
        checkoutBtn.disabled = true;
        return;
      }

      customerInfoSection.style.display = 'block';
      orderTotalSection.style.display = 'block';
      clearOrderBtn.style.display = 'block';
      checkoutBtn.disabled = false;

      const itemsHtml = currentOrder.map((item, index) => `
        <div class="order-item">
          <button class="remove-item-btn" onclick="removeFromOrder(${index})">
            <i class="fas fa-times"></i>
          </button>
          <img src="${item.image || '../images/placeholder.png'}" alt="${item.name}">
          <div class="order-item-info">
            <div class="order-item-name">${item.name}</div>
            ${item.shade ? `<div class="order-item-shade">${item.shade}</div>` : ''}
          </div>
          <div class="order-item-controls">
            <div class="qty-control">
              <button class="qty-btn" onclick="updateQuantity(${index}, -1)">
                <i class="fas fa-minus"></i>
              </button>
              <span class="qty-display">${item.quantity}</span>
              <button class="qty-btn" onclick="updateQuantity(${index}, 1)">
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <div class="order-item-price">₱${(item.price * item.quantity).toFixed(2)}</div>
          </div>
        </div>
      `).join('');

      orderItemsList.innerHTML = itemsHtml;

      const subtotal = currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const itemCount = currentOrder.reduce((sum, item) => sum + item.quantity, 0);

      document.getElementById('subtotalAmount').textContent = `₱${subtotal.toFixed(2)}`;
      document.getElementById('itemCount').textContent = itemCount;
      document.getElementById('totalAmount').textContent = `₱${subtotal.toFixed(2)}`;
    }

    // Update quantity
    window.updateQuantity = function (index, change) {
      const item = currentOrder[index];
      const newQty = item.quantity + change;

      if (newQty <= 0) {
        removeFromOrder(index);
        return;
      }

      if (newQty > item.max_stock) {
        Swal.fire({
          icon: 'warning',
          title: 'Stock Limit',
          text: `Only ${item.max_stock} units available.`
        });
        return;
      }

      item.quantity = newQty;
      updateOrderDisplay();
    };

    // Remove from order
    window.removeFromOrder = function (index) {
      currentOrder.splice(index, 1);
      updateOrderDisplay();
    };

    // Clear order
    clearOrderBtn.addEventListener('click', function () {
      Swal.fire({
        title: 'Clear Order?',
        text: 'This will remove all items from the current order.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, clear it',
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          currentOrder = [];
          customerName.value = '';
          updateOrderDisplay();
          Swal.fire('Cleared!', 'Order has been cleared.', 'success');
        }
      });
    });

    /**
     * Print receipt function
     */
    function printReceipt(data, customerNameValue) {
      console.log("Printing receipt for:", data, "Customer:", customerNameValue);
      // Example of opening a new window to print (customize the content)
      const receiptWindow = window.open('', 'PRINT', 'height=600,width=800');
      receiptWindow.document.write('<html><head><title>Receipt</title>');
      // Add styles for your receipt here
      receiptWindow.document.write('</head><body>');
      receiptWindow.document.write(`<h1>Receipt for Order #${data.order_id}</h1>`);
      receiptWindow.document.write(`<p>Customer: ${customerNameValue}</p>`);
      receiptWindow.document.write(`<p>Total: ₱${data.total_price}</p>`);
      receiptWindow.document.write(`<p>QR Code: ${data.qr_code}</p>`);
      // You would loop through order items here to display them
      receiptWindow.document.write('</body></html>');
      receiptWindow.document.close();
      receiptWindow.focus();
      receiptWindow.print();
      // receiptWindow.close(); // Optional: close window after printing
    }

    // Checkout
    checkoutBtn.addEventListener('click', async function () {
      if (currentOrder.length === 0) return;

      const customerNameValue = customerName.value.trim() || 'Walk-in Customer';

      const result = await Swal.fire({
        title: 'Complete Order?',
        html: `
          <p><strong>Customer:</strong> ${customerNameValue}</p>
          <p><strong>Items:</strong> ${currentOrder.reduce((sum, item) => sum + item.quantity, 0)}</p>
          <p><strong>Total:</strong> ₱${currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2)}</p>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Complete Order',
        cancelButtonText: 'Cancel'
      });

      if (!result.isConfirmed) return;

      Swal.fire({
        title: 'Processing...',
        text: 'Creating order...',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      try {
        const response = await fetch('../php/cashier-mode.php?action=create_order', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            customer_name: customerNameValue,
            items: currentOrder
          })
        });

        const data = await response.json();

        if (data.success) {
          Swal.fire({
            icon: 'success',
            title: 'Order Complete!',
            html: `
              <p>Order #${data.order_id} has been created successfully.</p>
              <p><strong>Total:</strong> ₱${data.total_price}</p>
              <p style="margin-top: 15px; color: #6c757d; font-size: 0.9rem;">
                <i class="fas fa-qrcode"></i> QR Code: ${data.qr_code || 'N/A'}
              </p>
            `,
            showCancelButton: true,
            confirmButtonText: 'New Order',
            cancelButtonText: '<i class="fas fa-print"></i> Print Receipt',
            confirmButtonColor: '#e497aa',
            cancelButtonColor: '#6c757d'
          }).then((result) => {
            if (result.dismiss === Swal.DismissReason.cancel) {
              // Print receipt if the cancel button (print) is clicked
              printReceipt(data, customerNameValue);
            }
            // Reset order for the next transaction, regardless of which button was clicked
            currentOrder = [];
            customerName.value = '';
            updateOrderDisplay();
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: data.message || 'Failed to create order'
          });
        }
      } catch (error) {
        console.error('Error:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to create order. Please try again.'
        });
      }
    });

    // Highlight active sidebar link
    document.addEventListener('DOMContentLoaded', () => {
      const navLinks = document.querySelectorAll('.sidebar .nav-link');
      const currentPath = window.location.pathname.split('/').pop();

      navLinks.forEach(link => {
        const linkPath = link.getAttribute('href');
        if (linkPath === currentPath) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      });

      fetchProducts();
    });

    function adjustContentForMobileHeader() {
      const mobileHeader = document.querySelector('.mobile-header');
      const mainContent = document.querySelector('main');

      if (window.innerWidth < 992 && mobileHeader && mainContent) {
        const headerHeight = mobileHeader.offsetHeight;
        mainContent.style.marginTop = `${headerHeight}px`;
      } else if (mainContent) {
        mainContent.style.marginTop = '';
      }
    }

    window.addEventListener('load', adjustContentForMobileHeader);
    window.addEventListener('resize', adjustContentForMobileHeader);

    const navLinks = document.querySelectorAll('.sidebar .nav-link');
    navLinks.forEach(link => {
      link.addEventListener('click', function () {
        if (window.innerWidth < 992) {
          sidebar.classList.remove('mobile-open');
          sidebarOverlay.classList.remove('active');
        }
      });
    });

    productSearch.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
      }
    });

    customerName.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
      }
    });
  </script>
</body>

</html>