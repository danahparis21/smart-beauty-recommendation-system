<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard - Blessence</title>
    <link rel="icon" href="../images/mainlogo.png" type="image/png" />

    <!-- External Stylesheets -->
    <link rel="stylesheet" href="../styles/styles.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../../admin/styles/logout.js"></script>

    <!-- SweetAlert2 CSS & JS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

    <script src="../js/admin-session.js"></script>

    <style>
      /* --- EXISTING STYLES RETAINED --- */
      .fullscreen-reveal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          #ffffff 0%,
          #fff5f9 30%,
          #ffe6f2 70%,
          #ffd1dc 100%
        );
        z-index: 9999;
        display: none;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        box-shadow: 0 0 0 0 rgba(255, 229, 236, 0.7);
        transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        transform-origin: center center;
      }

      .reveal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: transparent;
        z-index: 9998;
        display: none;
        opacity: 0;
        transition: opacity 0.5s ease;
      }

      .fullscreen-reveal.active {
        display: flex;
      }

      .fullscreen-reveal.expanding {
        transform: translate(-50%, -50%) scale(20);
        transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .fullscreen-reveal-content {
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 20px;
        color: white;
        opacity: 0;
        text-align: center;
        pointer-events: none;
        transition: opacity 0.5s ease;
      }

      .fullscreen-reveal.expanding .fullscreen-reveal-content {
        opacity: 1;
        transform: scale(1);
      }

      .reveal-progress {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: conic-gradient(rgb(172, 163, 163) 0%, transparent 0%);
        mask: radial-gradient(transparent 65%, black 66%);
        -webkit-mask: radial-gradient(transparent 65%, black 66%);
        z-index: 1;
      }

      .cashier-mode-entry {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #e497aa 0%, #db8299 100%);
        z-index: 10000;
        display: none;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        opacity: 0;
        transition: opacity 0.5s ease;
      }

      .cashier-mode-entry.active {
        display: flex;
        opacity: 1;
      }

      .cashier-logo-container {
        text-align: center;
        margin-bottom: 30px;
        animation: pulse 2s infinite;
      }

      .cashier-logo {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: white;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0 auto 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .cashier-logo img {
        max-width: 80px;
        max-height: 80px;
      }

      .cashier-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: white;
        margin-bottom: 10px;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }

      .cashier-subtitle {
        font-size: 1.2rem;
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 30px;
      }

      .cashier-loading {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .cashier-loading-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: white;
        opacity: 0.6;
        animation: loadingDots 1.4s infinite ease-in-out;
      }

      .cashier-loading-dot:nth-child(1) {
        animation-delay: -0.32s;
      }

      .cashier-loading-dot:nth-child(2) {
        animation-delay: -0.16s;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }

        50% {
          transform: scale(1.05);
        }

        100% {
          transform: scale(1);
        }
      }

      @keyframes loadingDots {
        0%,
        80%,
        100% {
          transform: scale(0.8);
          opacity: 0.5;
        }

        40% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .stats-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 35px;
      }

      .stat-btn {
        border: none;
        border-radius: 16px;
        padding: 28px 24px;
        color: white;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        text-align: left;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
        background: var(--primary-pink);
      }

      .stat-btn::before {
        content: "";
        position: absolute;
        top: 0;
        right: -50%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transform: skewX(-20deg);
        transition: right 0.6s ease;
      }

      .stat-btn:hover::before {
        right: 150%;
      }

      .stat-btn:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 16px 32px rgba(0, 0, 0, 0.15);
      }

      .stat-btn i {
        font-size: 2.5rem;
        margin-bottom: 15px;
        opacity: 0.95;
        position: relative;
        z-index: 1;
      }

      .stat-value {
        font-size: 2.2rem;
        margin: 10px 0 5px 0;
        display: block;
        position: relative;
        z-index: 1;
        font-weight: 700;
        letter-spacing: -0.5px;
      }

      .stat-label {
        position: relative;
        z-index: 1;
        font-size: 0.9rem;
        opacity: 0.9;
        font-weight: 500;
      }

      .orders-today {
        background: linear-gradient(135deg, #e497aa 0%, #db8299 100%);
      }

      .this-week {
        background: linear-gradient(135deg, #db8299 0%, #c36c82 100%);
      }

      .total-sales {
        background: linear-gradient(135deg, #c36c82 0%, #b05a70 100%);
      }

      .favorites-count {
        background: linear-gradient(135deg, #b05a70 0%, #9d4e5f 100%);
      }

      .chart-container {
        background: white;
        border-radius: 20px;
        padding: 20px 30px 30px 30px;
        margin-bottom: 25px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
        border: 1px solid rgba(228, 151, 170, 0.1);
        height: 530px;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .chart-container canvas {
        flex: 1 1 auto;
        width: 100% !important;
        height: 75% !important;
        display: block;
      }

      .chart-container:hover {
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1);
        transform: translateY(-4px);
      }

      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        flex-wrap: wrap;
        gap: 15px;
      }

      .chart-header h5 {
        color: var(--dark-pink);
        font-weight: 700;
        font-size: 1.3rem;
        margin: 0;
      }

      .right-panel {
        background: white;
        border-radius: 20px;
        padding: 30px;
        height: 100%;
        overflow-y: auto;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
        transition: all 0.4s ease;
        border: 1px solid rgba(228, 151, 170, 0.1);
      }

      .right-panel:hover {
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1);
      }

      .panel-section {
        margin-bottom: 30px;
      }

      .panel-section:last-child {
        margin-bottom: 0;
      }

      .panel-section h6 {
        color: var(--dark-pink);
        font-weight: 700;
        margin-bottom: 18px;
        padding-bottom: 12px;
        border-bottom: 2px solid #f0f0f0;
        font-size: 1.05rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .panel-section h6 i {
        font-size: 1.1rem;
      }

      .placeholder-box {
        border: 2px dashed #ffffff;
        border-radius: 12px;
        padding: 32px 24px;
        text-align: center;
        color: #ffffff;
        background: white;
        font-style: italic;
        transition: all 0.4s ease;
        position: relative;
        overflow: hidden;
      }

      .placeholder-box::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(228, 151, 170, 0.1);
        transform: translate(-50%, -50%);
        transition: all 0.5s ease;
      }

      .placeholder-box:hover::before {
        width: 200%;
        height: 200%;
      }

      .placeholder-box:hover {
        border-color: var(--primary-pink);
        background: white;
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(228, 151, 170, 0.15);
      }

      .btn-group {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }

      .btn-group .btn {
        border-radius: 10px !important;
        font-size: 0.85rem;
        padding: 8px 16px;
        border: 2px solid #e0e0e0;
        background: white;
        color: #666;
        font-weight: 500;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .btn-group .btn::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(228, 151, 170, 0.1);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.3s ease, height 0.3s ease;
      }

      .btn-group .btn:active::before {
        width: 100px;
        height: 100px;
      }

      .btn-group .btn:hover {
        border-color: var(--primary-pink);
        color: var(--dark-pink);
        background: rgba(228, 151, 170, 0.05);
        transform: translateY(-2px);
      }

      .btn-group .btn.active {
        background: linear-gradient(
          135deg,
          var(--primary-pink),
          var(--secondary-pink)
        );
        border-color: var(--primary-pink);
        color: white;
        box-shadow: 0 4px 12px rgba(228, 151, 170, 0.3);
      }

      .page-header {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid rgba(228, 151, 170, 0.15);
      }

      .page-title {
        color: var(--dark-pink);
        font-weight: 700;
        font-size: 2rem;
        margin-bottom: 8px;
        letter-spacing: -0.5px;
      }

      .page-header p {
        color: #6c757d;
        font-size: 1rem;
        margin: 0;
      }

      main {
        padding: 35px !important;
        margin-left: 16.666667%;
        width: calc(100% - 16.666667%);
        transition: margin-left 0.3s ease;
      }

      .right-panel::-webkit-scrollbar {
        width: 6px;
      }

      .right-panel::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }

      .right-panel::-webkit-scrollbar-thumb {
        background: var(--primary-pink);
        border-radius: 10px;
      }

      .right-panel::-webkit-scrollbar-thumb:hover {
        background: var(--secondary-pink);
      }

      .product-item {
        transition: all 0.3s ease;
        border: 1px solid rgba(228, 151, 170, 0.1);
        background: rgb(242, 226, 230) !important;
        border-radius: 10px;
        margin-bottom: 12px;
        padding: 16px !important;
      }

      .customer-item,
      .insight-item {
        transition: all 0.3s ease;
        border: 1px solid rgba(228, 151, 170, 0.1);
        background: white !important;
        border-radius: 10px;
        margin-bottom: 12px;
        padding: 16px !important;
      }

      .product-item:hover,
      .customer-item:hover,
      .insight-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(228, 151, 170, 0.15);
        border-color: var(--primary-pink);
      }

      .rating-bar-item .progress {
        background-color: #e9ecef;
        border-radius: 4px;
      }

      .rating-bar-item .progress-bar {
        border-radius: 4px;
        transition: width 0.8s ease;
      }

      .customer-avatar {
        transition: all 0.3s ease;
      }

      .customer-item:hover .customer-avatar {
        transform: scale(1.1);
        background: var(--secondary-pink) !important;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .stat-btn,
      .chart-container,
      .right-panel {
        animation: fadeInUp 0.6s ease forwards;
      }

      .stat-btn:nth-child(1) {
        animation-delay: 0.1s;
      }

      .stat-btn:nth-child(2) {
        animation-delay: 0.2s;
      }

      .stat-btn:nth-child(3) {
        animation-delay: 0.3s;
      }

      .stat-btn:nth-child(4) {
        animation-delay: 0.4s;
      }

      .chart-container {
        animation-delay: 0.5s;
      }

      .right-panel {
        animation-delay: 0.6s;
      }

      .product-item,
      .customer-item,
      .insight-item,
      .rating-bar-item {
        animation: fadeIn 0.5s ease forwards;
      }

      .cashier-tap-counter {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(228, 151, 170, 0.9);
        color: white;
        padding: 10px 15px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
        display: none;
      }

      .cashier-tap-counter.show {
        display: block;
        animation: fadeIn 0.3s ease;
      }

      .cashier-mode-link {
        color: inherit !important;
      }

      .analytics-card {
        background: white;
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
        border: 1px solid rgba(228, 151, 170, 0.1);
        height: 100%;
        transition: transform 0.3s ease;
      }

      .analytics-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1);
      }

      .small-chart-container {
        height: 300px;
        position: relative;
        width: 100%;
      }

      /* --- NEW STYLES FOR PROFILE PICS & REVIEWS --- */
      .view-all-link {
        font-size: 0.85rem;
        color: var(--primary-pink);
        text-decoration: none;
        font-weight: 600;
        cursor: pointer;
        transition: color 0.3s;
      }

      .view-all-link:hover {
        color: var(--dark-pink);
        text-decoration: underline;
      }

      .customer-img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--primary-pink);
        margin-right: 1rem;
      }

      /* --- MODAL & DROPDOWN STYLES (PRIORITIZED) --- */
      .modal-dialog-scrollable .modal-content {
        overflow: visible !important;
      }

      .modal-header {
        border-bottom: 1px solid rgba(228, 151, 170, 0.2);
        background-color: #fff5f9;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        flex-wrap: wrap;
        padding: 1rem 1.5rem;
        position: relative;
        overflow: visible !important;
        z-index: 1056;
      }

      .modal-title {
        color: var(--dark-pink);
        font-weight: 700;
        margin-right: auto;
      }

      .modal-header .btn-close {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        z-index: 10;
      }

      .filter-controls {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
      }

      .custom-dropdown-btn {
        background-color: white;
        border: 1px solid rgba(228, 151, 170, 0.5);
        border-radius: 50px;
        padding: 8px 20px;
        font-size: 0.85rem;
        color: var(--dark-pink);
        font-weight: 600;
        min-width: 160px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
        position: relative;
      }

      .custom-dropdown-btn:hover,
      .custom-dropdown-btn[aria-expanded="true"] {
        background-color: #fff0f5;
        border-color: var(--primary-pink);
        color: var(--dark-pink);
        box-shadow: 0 4px 12px rgba(228, 151, 170, 0.2);
      }

      .custom-dropdown-btn::after {
        margin-left: 10px;
        color: var(--primary-pink);
      }

      .custom-dropdown-menu {
        border: none;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        padding: 8px;
        background: white;
        min-width: 180px;
        margin-top: 10px !important;
        animation: fadeIn 0.2s ease;
        z-index: 9999 !important;
        max-height: 300px;
        overflow-y: auto;
      }

      .custom-dropdown-menu::-webkit-scrollbar {
        width: 6px;
      }

      .custom-dropdown-menu::-webkit-scrollbar-thumb {
        background-color: #e497aa;
        border-radius: 10px;
      }

      .custom-dropdown-item {
        border-radius: 10px;
        padding: 10px 15px;
        font-size: 0.9rem;
        color: #666;
        font-weight: 500;
        transition: all 0.2s;
        cursor: pointer;
      }

      .custom-dropdown-item:hover {
        background-color: #fff0f5;
        color: var(--dark-pink);
        transform: translateX(5px);
      }

      .custom-dropdown-item.active {
        background-color: var(--primary-pink);
        color: white;
      }

      /* --- RESPONSIVE STYLES (PRIORITIZED) --- */
      @media (max-width: 991px) {
        .stats-buttons {
          grid-template-columns: repeat(2, 1fr); /* Force 2 columns */
          gap: 15px;
        }
        main {
          margin-left: 0 !important;
          width: 100% !important;
        }

        .mobile-header {
          display: block;
          z-index: 101;
        }

        .sidebar {
          position: fixed;
          top: 0;
          left: 0;
          height: 100%;
          width: 280px;
          padding-top: 60px;
          transform: translateX(-100%);
          z-index: 100;
          transition: transform 0.3s ease;
        }

        .sidebar.mobile-open {
          transform: translateX(0);
        }

        .sidebar-overlay {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 99;
        }

        .sidebar-overlay.active {
          display: block;
        }

        .cashier-mode-link {
          position: relative;
          cursor: pointer;
          transition: all 0.3s ease;
          border-radius: 8px;
        }

        .cashier-mode-link.pressing {
          background: rgba(228, 151, 170, 0.15) !important;
          transform: scale(0.95);
        }
      }

      @media (max-width: 768px) {
        .modal-header {
          padding: 15px;
          padding-right: 40px;
        }

        .filter-controls {
          width: 100%;
          flex-direction: column;
          gap: 10px;
          margin-top: 15px;
        }

        .dropdown,
        .custom-dropdown-btn {
          width: 100%;
        }

        .custom-dropdown-menu {
          width: 100%;
        }
      }

      .animation-fix {
        position: relative;
        min-height: 200px;
      }

      .small-chart-container {
        min-height: 250px;
      }

      @media (max-width: 768px) {
        .chart-container {
          min-height: 300px;
        }

        .small-chart-container {
          min-height: 200px;
        }
      }
    </style>
  </head>

  <body>
    <!-- Mobile Header -->
    <div class="mobile-header">
      <div class="mobile-header-content">
        <button class="hamburger-btn" id="hamburgerBtn">
          <i class="fas fa-bars"></i>
        </button>
        <a href="admin.html" class="mobile-logo"
          ><img src="../images/mainlogo.png" alt="Store Logo"
        /></a>
      </div>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-2 d-md-block sidebar" id="sidebar">
          <div class="logo-container">
            <a href="admin.html"
              ><img src="../images/mainlogo.png" alt="Store Logo" class="logo"
            /></a>
            <div class="store-name">Blessence</div>
          </div>
          <div class="nav flex-column">
            <a href="admin.html" class="nav-link active">
              <i class="fa-solid fa-tachometer-alt"></i><span>Dashboard</span>
            </a>
            <a href="product-management.html" class="nav-link">
              <i class="fa-solid fa-box"></i><span>Product Management</span>
            </a>
            <a href="recommendation-insights.html" class="nav-link">
              <i class="fa-solid fa-lightbulb"></i
              ><span>Recommendation Insights</span>
            </a>
            <a href="customer-managemnet.html" class="nav-link">
              <i class="fa-solid fa-users"></i><span>Customer Management</span>
            </a>
            <a href="order-transactions.html" class="nav-link">
              <i class="fa-solid fa-credit-card"></i
              ><span>Order Transaction</span>
            </a>
            <a href="activity-log.html" class="nav-link">
              <i class="fa-solid fa-clock-rotate-left"></i
              ><span>Activity Log</span>
            </a>
            <a
              href="javascript:void(0)"
              class="nav-link cashier-mode-link"
              id="cashierModeLink"
            >
              <i class="fa-solid fa-cash-register"></i><span>Cashier Mode</span>
            </a>
            <a id="logoutBtn" href="javascript:void(0)" class="nav-link">
              <i class="fa-solid fa-right-from-bracket"></i><span>Log Out</span>
            </a>
          </div>
        </nav>

        <!-- Main content -->
        <main class="col-md-10">
          <!-- Stats Cards -->
          <div class="stats-buttons">
            <button class="stat-btn orders-today">
              <i class="fa-solid fa-cart-shopping"></i>
              <div class="stat-content">
                <span class="stat-value">--</span>
                <span class="stat-label">Orders</span>
              </div>
            </button>

            <button class="stat-btn this-week">
              <i class="fa-solid fa-calendar-week"></i>
              <div class="stat-content">
                <span class="stat-value">--</span>
                <span class="stat-label">Sales Volume</span>
              </div>
            </button>

            <button class="stat-btn total-sales">
              <i class="fa-solid fa-coins"></i>
              <div class="stat-content">
                <span class="stat-value">--</span>
                <span class="stat-label">Revenue</span>
              </div>
            </button>

            <button class="stat-btn favorites-count">
              <i class="fa-solid fa-heart"></i>
              <div class="stat-content">
                <span class="stat-value" id="totalFavorites">0</span>
                <span class="stat-label">Total Favorites</span>
              </div>
            </button>
          </div>

          <div class="row">
            <!-- Main Graph Section & New Analytics -->
            <div class="col-md-8">
              <!-- Sales Chart -->
              <div class="chart-container">
                <div class="chart-header">
                  <h5><i class="fas fa-chart-line"></i> Sales Overview</h5>
                  <div class="btn-group" role="group">
                    <button
                      class="btn btn-outline-secondary btn-sm active"
                      data-period="All Time"
                    >
                      All Time
                    </button>
                    <button
                      class="btn btn-outline-secondary btn-sm"
                      data-period="Daily"
                    >
                      Daily
                    </button>
                    <button
                      class="btn btn-outline-secondary btn-sm"
                      data-period="Weekly"
                    >
                      Weekly
                    </button>
                    <button
                      class="btn btn-outline-secondary btn-sm"
                      data-period="Monthly"
                    >
                      Monthly
                    </button>
                    <button
                      class="btn btn-outline-secondary btn-sm"
                      data-period="Annually"
                    >
                      Annually
                    </button>
                  </div>
                </div>
                <canvas id="salesChart"></canvas>
              </div>

              <!-- Analytics Charts -->
              <div class="row mt-4 mb-4">
                <div class="col-md-6 mb-3">
                  <div class="analytics-card">
                    <div class="panel-section mb-0">
                      <h6>
                        <i class="fas fa-chart-pie"></i> Sales by Category
                      </h6>
                      <div class="small-chart-container">
                        <canvas id="categoryChart"></canvas>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <div class="analytics-card">
                    <div class="panel-section mb-0">
                      <h6>
                        <i class="fas fa-venus-mars"></i> Customer Demographics
                        (Skin)
                      </h6>
                      <div class="small-chart-container">
                        <canvas id="demographicsChart"></canvas>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- AI Insights and Top Customers -->
              <div class="row mt-4">
                <div class="col-md-6">
                  <div class="panel-section">
                    <h6><i class="fas fa-brain"></i> Smart AI Insights</h6>
                    <div class="ai-insights-container">
                      <div class="placeholder-box">
                        <i
                          class="fas fa-robot fa-2x mb-3"
                          style="color: var(--primary-pink)"
                        ></i>
                        <div style="font-size: 1rem; margin-bottom: 6px">
                          AI-Powered Recommendations
                        </div>
                        <small class="text-muted"
                          >Insights and suggestions will appear here</small
                        >
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="panel-section">
                    <h6><i class="fas fa-crown"></i> Top Customers</h6>
                    <div class="top-customers-container">
                      <div class="placeholder-box">
                        <i
                          class="fas fa-users fa-2x mb-3"
                          style="color: var(--primary-pink)"
                        ></i>
                        <div style="font-size: 1rem; margin-bottom: 6px">
                          Customer Performance Data
                        </div>
                        <small class="text-muted"
                          >Top customers will be listed here</small
                        >
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Right Panel -->
            <div class="col-md-4">
              <div class="right-panel">
                <div class="panel-section">
                  <h6><i class="fas fa-fire"></i> Best Selling Products</h6>
                  <div class="best-sellers-container">
                    <div class="placeholder-box">
                      <i
                        class="fas fa-cube fa-2x mb-3"
                        style="color: var(--primary-pink)"
                      ></i>
                      <div style="font-size: 1rem; margin-bottom: 6px">
                        Product Performance Data
                      </div>
                      <small class="text-muted"
                        >Top products will be listed here</small
                      >
                    </div>
                  </div>
                </div>

                <div class="panel-section mt-4">
                  <h6><i class="fas fa-clipboard-list"></i> Order Status</h6>
                  <div class="small-chart-container" style="height: 200px">
                    <canvas id="orderStatusChart"></canvas>
                  </div>
                </div>

                <div class="panel-section">
                  <!-- Updated Header with View All -->
                  <div
                    class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3"
                    style="border-color: #f0f0f0 !important"
                  >
                    <h6 style="border: none; margin: 0; padding: 0">
                      <i class="fas fa-star"></i> Store Ratings
                    </h6>
                    <span class="view-all-link" id="viewAllReviewsBtn"
                      >View All</span
                    >
                  </div>

                  <div class="ratings-container">
                    <div class="placeholder-box">
                      <i
                        class="fas fa-star fa-2x mb-3"
                        style="color: var(--primary-pink)"
                      ></i>
                      <div style="font-size: 1rem; margin-bottom: 6px">
                        Customer Feedback & Ratings
                      </div>
                      <small class="text-muted"
                        >Rating statistics will appear here</small
                      >
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Reviews Modal -->
    <div class="modal fade" id="reviewsModal" tabindex="-1" aria-hidden="true">
      <div
        class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg"
      >
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-comments me-2"></i>All Store Reviews
            </h5>

            <div class="filter-controls">
              <!-- Rating Filter Dropdown -->
              <div class="dropdown">
                <!-- ADDED data-bs-boundary="viewport" HERE -->
                <button
                  class="btn custom-dropdown-btn dropdown-toggle"
                  type="button"
                  id="ratingDropdownBtn"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                  data-bs-boundary="viewport"
                >
                  All Ratings
                </button>
                <ul
                  class="dropdown-menu custom-dropdown-menu"
                  aria-labelledby="ratingDropdownBtn"
                >
                  <li>
                    <a
                      class="dropdown-item custom-dropdown-item active"
                      data-value="all"
                      onclick="selectFilter('rating', 'all', 'All Ratings', this)"
                      >All Ratings</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item custom-dropdown-item"
                      data-value="5"
                      onclick="selectFilter('rating', '5', '★★★★★ (5 Stars)', this)"
                      >★★★★★ (5 Stars)</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item custom-dropdown-item"
                      data-value="4"
                      onclick="selectFilter('rating', '4', '★★★★☆ (4 Stars)', this)"
                      >★★★★☆ (4 Stars)</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item custom-dropdown-item"
                      data-value="3"
                      onclick="selectFilter('rating', '3', '★★★☆☆ (3 Stars)', this)"
                      >★★★☆☆ (3 Stars)</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item custom-dropdown-item"
                      data-value="2"
                      onclick="selectFilter('rating', '2', '★★☆☆☆ (2 Stars)', this)"
                      >★★☆☆☆ (2 Stars)</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item custom-dropdown-item"
                      data-value="1"
                      onclick="selectFilter('rating', '1', '★☆☆☆☆ (1 Star)', this)"
                      >★☆☆☆☆ (1 Star)</a
                    >
                  </li>
                </ul>
                <input type="hidden" id="reviewFilter" value="all" />
              </div>

              <!-- Sort Filter Dropdown -->
              <div class="dropdown">
                <!-- ADDED data-bs-boundary="viewport" HERE -->
                <button
                  class="btn custom-dropdown-btn dropdown-toggle"
                  type="button"
                  id="sortDropdownBtn"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                  data-bs-boundary="viewport"
                >
                  Newest First
                </button>
                <ul
                  class="dropdown-menu custom-dropdown-menu"
                  aria-labelledby="sortDropdownBtn"
                >
                  <li>
                    <a
                      class="dropdown-item custom-dropdown-item active"
                      data-value="newest"
                      onclick="selectFilter('sort', 'newest', 'Newest First', this)"
                      >Newest First</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item custom-dropdown-item"
                      data-value="oldest"
                      onclick="selectFilter('sort', 'oldest', 'Oldest First', this)"
                      >Oldest First</a
                    >
                  </li>
                </ul>
                <input type="hidden" id="reviewSort" value="newest" />
              </div>
            </div>
          </div>

          <div class="modal-body" id="modalReviewsBody">
            <div class="text-center py-5">
              <div class="spinner-border text-pink" role="status"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Reveal Overlay & Cashier Mode Elements -->
    <div class="reveal-overlay" id="revealOverlay"></div>
    <div class="fullscreen-reveal" id="fullscreenReveal">
      <div class="reveal-progress" id="revealProgress"></div>
      <div class="fullscreen-reveal-content">Entering Cashier Mode…</div>
    </div>

    <div class="cashier-mode-entry" id="cashierModeEntry">
      <div class="cashier-logo-container">
        <div class="cashier-logo">
          <img src="../images/mainlogo.png" alt="Store Logo" />
        </div>
        <div class="cashier-title">Entering Cashier Mode</div>
        <div class="cashier-subtitle">Blessence Point of Sale</div>
      </div>
      <div class="cashier-loading">
        <div class="cashier-loading-dot"></div>
        <div class="cashier-loading-dot"></div>
        <div class="cashier-loading-dot"></div>
      </div>
    </div>
    <div class="cashier-tap-counter" id="cashierTapCounter"></div>

 

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        // First, verify admin session
        setupAdminPageProtection();
        currentAdmin = await fetchAdminSession();
        if (!currentAdmin) return;

        await updateAdminGreeting();

        // ... [Previous sidebar and mobile logic kept the same] ...
        const hamburgerBtn = document.getElementById("hamburgerBtn");
        const sidebar = document.getElementById("sidebar");
        const sidebarOverlay = document.getElementById("sidebarOverlay");
        const mainContent = document.querySelector("main");
        const mobileHeader = document.querySelector(".mobile-header");

        const toggleSidebar = () => {
          sidebar.classList.toggle("mobile-open");
          sidebarOverlay.classList.toggle("active");
        };

        if (hamburgerBtn) hamburgerBtn.addEventListener("click", toggleSidebar);
        if (sidebarOverlay)
          sidebarOverlay.addEventListener("click", toggleSidebar);
        document.querySelectorAll(".sidebar .nav-link").forEach((link) => {
          link.addEventListener("click", () => {
            if (
              window.innerWidth < 992 &&
              sidebar.classList.contains("mobile-open")
            ) {
              toggleSidebar();
            }
          });
        });

        const adjustContentForMobileHeader = () => {
          if (window.innerWidth < 992 && mobileHeader && mainContent) {
            mainContent.style.paddingTop =
              mobileHeader.offsetHeight + 20 + "px";
          } else if (mainContent) {
            mainContent.style.paddingTop = "35px";
          }
        };
        window.addEventListener("load", adjustContentForMobileHeader);
        window.addEventListener("resize", adjustContentForMobileHeader);

        // --- Chart Instances ---
        let categoryChartInstance = null;
        let demographicsChartInstance = null;
        let orderStatusChartInstance = null;
        let salesChartInstance = null;

        // --- MODAL LOGIC FOR VIEW ALL REVIEWS ---
        const viewAllBtn = document.getElementById("viewAllReviewsBtn");
        const reviewsModal = new bootstrap.Modal(
          document.getElementById("reviewsModal")
        );
        const reviewFilter = document.getElementById("reviewFilter");
        const reviewSort = document.getElementById("reviewSort");
        const modalBody = document.getElementById("modalReviewsBody");

        const fetchReviews = async () => {
          const filter = reviewFilter.value;
          const sort = reviewSort.value;

          modalBody.innerHTML =
            '<div class="text-center py-4"><div class="spinner-border text-secondary" role="status"></div><p class="mt-2 text-muted">Loading reviews...</p></div>';
          // --- NEW: Handle Custom Dropdown Selection ---
          window.selectFilter = function (type, value, text, element) {
            // 1. Update the hidden input value
            const inputId = type === "rating" ? "reviewFilter" : "reviewSort";
            const input = document.getElementById(inputId);
            if (input) input.value = value;

            // 2. Update the Button Text
            const btnId =
              type === "rating" ? "ratingDropdownBtn" : "sortDropdownBtn";
            const btn = document.getElementById(btnId);
            if (btn) btn.textContent = text;

            // 3. Update Active State styling
            const menu = element.closest(".dropdown-menu");
            menu
              .querySelectorAll(".custom-dropdown-item")
              .forEach((item) => item.classList.remove("active"));
            element.classList.add("active");

            // 4. Trigger Fetch
            fetchReviews();
          };
          try {
            // Fetch just the reviews, not the whole dashboard
            const response = await fetch(
              `../php/admin.php?action=get_reviews&rating=${filter}&sort=${sort}`
            );
            const result = await response.json();

            if (result.success && result.reviews.length > 0) {
              let html = "";
              result.reviews.forEach((review) => {
                const date = new Date(review.created_at).toLocaleDateString(
                  "en-US",
                  { month: "short", day: "numeric", year: "numeric" }
                );
                const stars =
                  '<i class="fas fa-star text-warning"></i>'.repeat(
                    review.rating
                  ) +
                  '<i class="far fa-star text-warning"></i>'.repeat(
                    5 - review.rating
                  );
                const name = review.username || "Anonymous";
                const imgSrc =
                  review.user_image && review.user_image !== ""
                    ? `../images/${review.user_image}`
                    : null;

                // Image or Initial
                let avatarHtml = "";
                if (imgSrc) {
                  avatarHtml = `<img src="${imgSrc}" alt="User" style="width:40px; height:40px; border-radius:50%; object-fit:cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">`;
                }
                // Fallback initial
                avatarHtml += `<div class="rounded-circle d-flex align-items-center justify-content-center bg-secondary text-white fw-bold ${
                  imgSrc ? "d-none" : ""
                }" style="width:40px; height:40px; min-width:40px;">${name
                  .charAt(0)
                  .toUpperCase()}</div>`;

                html += `
                    <div class="customer-item p-3 mb-3 border-bottom">
                        <div class="d-flex align-items-start">
                            <div class="me-3">
                                ${avatarHtml}
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0 text-dark fw-bold">${name}</h6>
                                    <small class="text-muted">${date}</small>
                                </div>
                                <div class="mb-2 mt-1 small">${stars}</div>
                                <p class="mb-0 text-secondary" style="font-size:0.9rem;">${
                                  review.comment ||
                                  "<i>No comment provided.</i>"
                                }</p>
                            </div>
                        </div>
                    </div>`;
              });
              modalBody.innerHTML = html;
            } else {
              modalBody.innerHTML = `<div class="text-center py-5"><i class="far fa-comment-dots fa-3x text-muted mb-3"></i><p class="text-muted">No reviews found for this filter.</p></div>`;
            }
          } catch (error) {
            console.error("Error fetching reviews:", error);
            modalBody.innerHTML =
              '<div class="text-center text-danger py-4">Failed to load reviews.</div>';
          }
        };

        if (viewAllBtn) {
          viewAllBtn.addEventListener("click", () => {
            reviewsModal.show();
            fetchReviews();
          });
        }

        if (reviewFilter) reviewFilter.addEventListener("change", fetchReviews);
        if (reviewSort) reviewSort.addEventListener("change", fetchReviews);

        // --- Update Functions ---

        const updateStats = (stats) => {
          // ... [Kept same] ...
          const els = {
            orders_today: document.querySelector(".orders-today .stat-value"),
            orders_week: document.querySelector(".this-week .stat-value"),
            total_sales: document.querySelector(".total-sales .stat-value"),
            total_favorites: document.querySelector(
              ".favorites-count .stat-value"
            ),
          };
          for (let k in els) {
            if (els[k]) {
              if (k === "total_sales") {
                els[k].textContent =
                  "₱" +
                  parseFloat(stats[k] || 0).toLocaleString(undefined, {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2,
                  });
              } else {
                els[k].textContent = stats[k] || 0;
              }
            }
          }
        };

        const updateBestSellers = (products) => {
          const container = document.querySelector(".best-sellers-container");
          if (!products || !products.length) {
            container.innerHTML = `<div class="placeholder-box"><i class="fas fa-cube fa-2x mb-3" style="color:var(--primary-pink)"></i><div>No sales data</div></div>`;
            return;
          }
          container.innerHTML = products
            .map(
              (p) => `
      <div class="product-item d-flex align-items-center justify-content-between p-3 mb-2" style="background:#f8f9fa; border-radius:10px;">
        <div><div class="fw-bold" style="color:var(--dark-pink)">${p.product_name}</div><small class="text-muted">${p.Category} • ${p.total_quantity} sold</small></div>
      </div>`
            )
            .join("");
        };

        const updateStoreRatings = (ratings) => {
          const container = document.querySelector(".ratings-container");
          if (!ratings) {
            container.innerHTML = `<div class="placeholder-box"><i class="fas fa-star fa-2x mb-3" style="color:var(--primary-pink)"></i><div>No ratings available</div></div>`;
            return;
          }
          const avg = parseFloat(ratings.average_rating || 0).toFixed(1);
          const total = ratings.total_reviews || 0;
          if (total === 0) {
            container.innerHTML = `<div class="placeholder-box"><i class="fas fa-star fa-2x mb-3" style="color:var(--primary-pink)"></i><div>No ratings yet</div></div>`;
            return;
          }

          let starsHTML = "";
          for (let i = 0; i < Math.floor(avg); i++)
            starsHTML += '<i class="fas fa-star text-warning"></i>';
          if (avg % 1 >= 0.5)
            starsHTML += '<i class="fas fa-star-half-alt text-warning"></i>';

          let barsHTML = [5, 4, 3, 2, 1]
            .map((s) => {
              const c = ratings[`${s}_star`] || 0;
              const pct = total > 0 ? (c / total) * 100 : 0;
              return `<div class="d-flex align-items-center mb-2"><span style="width:20px">${s}</span><i class="fas fa-star text-warning me-2" style="font-size:0.8rem"></i><div class="progress flex-grow-1 me-2" style="height:8px"><div class="progress-bar" style="width:${pct}%; background-color:var(--primary-pink)"></div></div><small class="text-muted" style="width:30px">${c}</small></div>`;
            })
            .join("");

          let recentReviewsHTML = "";
          if (ratings.recent_reviews && ratings.recent_reviews.length > 0) {
            recentReviewsHTML =
              '<div class="mt-4"><h6 class="mb-3" style="font-size:0.95rem; color:var(--dark-pink); font-weight:600;">Recent Reviews</h6>';
            ratings.recent_reviews.forEach((review) => {
              const reviewDate = new Date(review.created_at).toLocaleDateString(
                "en-US",
                { month: "short", day: "numeric", year: "numeric" }
              );
              const reviewStars =
                "★".repeat(review.rating) + "☆".repeat(5 - review.rating);
              const userName = review.username || "Anonymous";

              recentReviewsHTML += `
          <div class="customer-item p-3 mb-2" style="background:white; border-radius:10px;">
            <div class="d-flex align-items-start mb-2">
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <span class="fw-bold" style="color:var(--dark-pink); font-size:0.9rem">${userName}</span>
                  <small class="text-muted" style="font-size:0.75rem">${reviewDate}</small>
                </div>
                <div class="mb-2" style="color:#FFC107; font-size:0.85rem">${reviewStars}</div>
                ${
                  review.comment
                    ? `<p class="mb-0" style="font-size:0.85rem; color:#666; line-height:1.4">${review.comment}</p>`
                    : ""
                }
              </div>
            </div>
          </div>
        `;
            });
            recentReviewsHTML += "</div>";
          }

          container.innerHTML = `<div class="text-center mb-3"><div style="font-size:2.5rem; font-weight:bold; color:var(--dark-pink)">${avg}</div><div class="mb-2">${starsHTML}</div><small class="text-muted">${total} reviews</small></div><div>${barsHTML}</div>${recentReviewsHTML}`;
        };

        const updateAIInsights = (insights) => {
          // ... [Kept same] ...
          const container = document.querySelector(".ai-insights-container");
          if (!insights || !insights.length) {
            container.innerHTML = `<div class="placeholder-box"><i class="fas fa-robot fa-2x mb-3" style="color:var(--primary-pink)"></i><div>No insights yet</div></div>`;
            return;
          }
          container.innerHTML = insights
            .map(
              (i) =>
                `<div class="insight-item p-3 mb-2" style="background:white; border-radius:10px; border-left:4px solid var(--primary-pink)"><div class="d-flex align-items-start"><i class="fas fa-lightbulb mt-1 me-2" style="color:var(--primary-pink)"></i><small style="color:#333">${i}</small></div></div>`
            )
            .join("");
        };

        // --- UPDATED: Display Profile Picture ---
        const updateTopCustomers = (customers) => {
          const container = document.querySelector(".top-customers-container");
          if (!customers || !customers.length) {
            container.innerHTML = `<div class="placeholder-box"><i class="fas fa-users fa-2x mb-3" style="color:var(--primary-pink)"></i><div>No data</div></div>`;
            return;
          }

          container.innerHTML = customers
            .map((c) => {
              const name =
                c.first_name && c.last_name
                  ? `${c.first_name} ${c.last_name}`
                  : c.username || "Unknown";

              let imageHtml = "";
              // Check for profile_photo (not user_image)
              if (
                c.profile_photo &&
                c.profile_photo.trim() !== "" &&
                c.profile_photo !== "default.png"
              ) {
                imageHtml = `<img src="../../uploads/profiles/${c.profile_photo}" alt="${name}" style="width:40px; height:40px; border-radius:50%; object-fit:cover; margin-right:1rem;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`;
                imageHtml += `<div class="me-3" style="width:40px; height:40px; background:var(--primary-pink); border-radius:50%; display:none; align-items:center; justify-content:center; color:white; font-weight:bold">${name
                  .charAt(0)
                  .toUpperCase()}</div>`;
              } else {
                imageHtml = `<div class="me-3" style="width:40px; height:40px; background:var(--primary-pink); border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold">${name
                  .charAt(0)
                  .toUpperCase()}</div>`;
              }

              return `<div class="customer-item d-flex align-items-center justify-content-between p-3 mb-2" style="background:white; border-radius:10px;">
              <div class="d-flex align-items-center">
                  ${imageHtml}
                  <div><div class="fw-bold" style="color:var(--dark-pink)">${name}</div><small class="text-muted">${
                c.total_orders
              } orders</small></div>
              </div>
              <div class="text-end"><div class="fw-bold" style="color:var(--dark-pink)">₱${parseFloat(
                c.total_spent || 0
              ).toFixed(2)}</div></div>
          </div>`;
            })
            .join("");
        };

        // --- Render Charts Functions (Kept same as optimized versions in previous step) ---
        const renderCategoryChart = (data) => {
          const ctx = document.getElementById("categoryChart").getContext("2d");
          if (categoryChartInstance) categoryChartInstance.destroy();
          let labels =
            data && data.length ? data.map((d) => d.Category) : ["No Data"];
          let values =
            data && data.length ? data.map((d) => d.total_items_sold) : [1];
          const colors = [
            "#e497aa",
            "#db8299",
            "#c36c82",
            "#b05a70",
            "#9d4e5f",
            "#8a4250",
          ];
          categoryChartInstance = new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: labels,
              datasets: [
                {
                  data: values,
                  backgroundColor: data && data.length ? colors : ["#f0f0f0"],
                  borderWidth: 2,
                  borderColor: "#ffffff",
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: window.innerWidth < 768 ? "bottom" : "right",
                },
              },
            },
          });
        };

        const renderDemographicsChart = (data) => {
          const ctx = document
            .getElementById("demographicsChart")
            .getContext("2d");
          if (demographicsChartInstance) demographicsChartInstance.destroy();
          let labels =
            data && data.length
              ? data.map(
                  (d) =>
                    d.skin_type.charAt(0).toUpperCase() + d.skin_type.slice(1)
                )
              : ["No Data"];
          let values = data && data.length ? data.map((d) => d.count) : [1];
          demographicsChartInstance = new Chart(ctx, {
            type: "polarArea",
            data: {
              labels: labels,
              datasets: [
                {
                  data: values,
                  backgroundColor: [
                    "rgba(228, 151, 170, 0.8)",
                    "rgba(219, 130, 153, 0.8)",
                    "rgba(195, 108, 130, 0.8)",
                    "rgba(176, 90, 112, 0.8)",
                    "rgba(157, 78, 95, 0.8)",
                  ],
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: { r: { ticks: { backdropColor: "transparent" } } },
              plugins: { legend: { position: "bottom" } },
            },
          });
        };

        const renderOrderStatusChart = (data) => {
          const ctx = document
            .getElementById("orderStatusChart")
            .getContext("2d");
          if (orderStatusChartInstance) orderStatusChartInstance.destroy();
          let labels = [],
            values = [],
            bgColors = [];
          if (data && data.length > 0) {
            labels = data.map((d) => d.status.toUpperCase());
            values = data.map((d) => d.count);
            const statusColors = {
              COMPLETED: "#28a745",
              PENDING: "#ffc107",
              CANCELLED: "#dc3545",
              PROCESSING: "#17a2b8",
            };
            bgColors = labels.map((l) => statusColors[l] || "#6c757d");
          } else {
            labels = ["No Data"];
            values = [1];
            bgColors = ["#f0f0f0"];
          }
          orderStatusChartInstance = new Chart(ctx, {
            type: "bar",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Orders",
                  data: values,
                  backgroundColor: bgColors,
                  borderRadius: 5,
                },
              ],
            },
            options: {
              indexAxis: "y",
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: { x: { grid: { display: false }, beginAtZero: true } },
            },
          });
        };

        const renderSalesChart = (chartData) => {
          const ctx = document.getElementById("salesChart").getContext("2d");
          if (salesChartInstance) salesChartInstance.destroy();
          let labels = [],
            salesData = [],
            ordersData = [];
          if (chartData && chartData.length > 0) {
            labels = chartData.map((item) => item.display_date || item.date);
            salesData = chartData.map((item) => parseFloat(item.sales) || 0);
            ordersData = chartData.map((item) => parseInt(item.orders) || 0);
          } else {
            labels = ["No Data"];
            salesData = [0];
            ordersData = [0];
          }
          const gradient = ctx.createLinearGradient(0, 0, 0, 400);
          gradient.addColorStop(0, "rgba(228, 151, 170, 0.3)");
          gradient.addColorStop(1, "rgba(228, 151, 170, 0.05)");
          salesChartInstance = new Chart(ctx, {
            type: "line",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Sales (₱)",
                  data: salesData,
                  borderColor: "#e497aa",
                  backgroundColor: gradient,
                  tension: 0.4,
                  fill: true,
                  yAxisID: "y",
                  borderWidth: 3,
                  pointRadius: 3,
                  pointHoverRadius: 6,
                },
                {
                  label: "Orders",
                  data: ordersData,
                  borderColor: "#db8299",
                  backgroundColor: "rgba(219, 130, 153, 0.1)",
                  tension: 0.4,
                  fill: false,
                  yAxisID: "y1",
                  borderWidth: 2,
                  borderDash: [5, 5],
                  pointRadius: 2,
                  pointHoverRadius: 5,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: { mode: "index", intersect: false },
              scales: {
                y: {
                  position: "left",
                  beginAtZero: true,
                  ticks: { callback: (val) => "₱" + val.toLocaleString() },
                },
                y1: {
                  position: "right",
                  beginAtZero: true,
                  grid: { drawOnChartArea: false },
                },
                x: { grid: { display: false } },
              },
              plugins: { legend: { position: "top" } },
            },
          });
        };

        const animationFixCSS = `.chart-container { position: relative; min-height: 200px; } .small-chart-container { min-height: 250px; } @media (max-width: 768px) { .chart-container { min-height: 300px; } .small-chart-container { min-height: 200px; } }`;
        const style = document.createElement("style");
        style.textContent = animationFixCSS;
        document.head.appendChild(style);

        class DashboardManager {
          constructor() {
            this.currentPeriod = "All Time";
            this.isLoading = false;
            this.init();
          }
          init() {
            this.bindEvents();
            this.fetchAndRefreshDashboard(this.currentPeriod);
          }
          bindEvents() {
            document.querySelectorAll(".btn-group .btn").forEach((btn) => {
              btn.addEventListener("click", (e) => {
                const period = e.target.dataset.period;
                if (period !== this.currentPeriod && !this.isLoading) {
                  this.currentPeriod = period;
                  document
                    .querySelectorAll(".btn-group .btn")
                    .forEach((b) =>
                      b.classList.toggle("active", b.dataset.period === period)
                    );
                  this.fetchAndRefreshDashboard(period);
                }
              });
            });
            let resizeTimeout;
            window.addEventListener("resize", () => {
              clearTimeout(resizeTimeout);
              resizeTimeout = setTimeout(() => {
                this.handleResize();
              }, 250);
            });
          }
          handleResize() {
            if (
              salesChartInstance ||
              categoryChartInstance ||
              demographicsChartInstance ||
              orderStatusChartInstance
            ) {
              this.fetchAndRefreshDashboard(this.currentPeriod, true);
            }
          }
          async fetchAndRefreshDashboard(period, isResize = false) {
            if (this.isLoading) return;
            this.isLoading = true;
            try {
              const response = await fetch(
                `../php/admin.php?period=${encodeURIComponent(period)}`
              );
              const result = await response.json();
              if (result.success) {
                setTimeout(
                  () => {
                    this.refreshAllComponents(result.data);
                  },
                  isResize ? 100 : 50
                );
              }
            } catch (error) {
              console.error("Error fetching dashboard data:", error);
            } finally {
              this.isLoading = false;
            }
          }
          refreshAllComponents(data) {
            this.ensureChartContainers();
            renderSalesChart(data.chart_data);
            renderCategoryChart(data.category_sales);
            renderDemographicsChart(data.customer_demographics);
            renderOrderStatusChart(data.order_status_dist);
            updateStats(data.stats);
            updateBestSellers(data.best_sellers);
            updateStoreRatings(data.ratings);
            updateAIInsights(data.ai_insights);
            updateTopCustomers(data.top_customers);
          }
          ensureChartContainers() {
            const chartContainers = document.querySelectorAll(
              ".chart-container, .small-chart-container"
            );
            chartContainers.forEach((container) => {
              if (container.offsetHeight === 0) {
                container.style.minHeight = "200px";
              }
            });
          }
        }

        const dashboardManager = new DashboardManager();
        window.dashboardManager = dashboardManager;
        setInterval(() => {
          const activeBtn = document.querySelector(".btn-group .btn.active");
        }, 300000);
      });
    </script>
  </body>
</html>
