<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Product Management - Beauty & Blessed</title>

  <link rel="stylesheet" href="../styles/styles.css">

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    /* Page header */
    .page-header {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid rgba(228, 151, 170, 0.15);
    }

    .page-title {
      color: var(--dark-pink);
      font-weight: 700;
      font-size: 2rem;
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }

    .page-header p {
      color: #6c757d;
      font-size: 1rem;
      margin: 0;
    }

    /* Main content padding */
    main {
      padding: 35px !important;
      margin-left: 16.666667%;
      width: calc(100% - 16.666667%);
      transition: margin-left 0.3s ease;
    }

    /* Product Management Section */
    .product-management-container {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
      transition: all 0.4s ease;
      border: 1px solid rgba(228, 151, 170, 0.1);
      margin-bottom: 25px;
    }

    .product-management-container:hover {
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1);
    }

    .section-title {
      color: var(--dark-pink);
      font-weight: 700;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title i {
      font-size: 1.2rem;
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      font-weight: 600;
      color: #555;
      margin-bottom: 8px;
    }

    .form-control,
    .form-select {
      border-radius: 12px;
      padding: 12px 16px;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: var(--primary-pink);
      box-shadow: 0 0 0 0.25rem rgba(228, 151, 170, 0.25);
    }

    /* Image Upload */
    .image-upload-container {
      border: 2px dashed #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #fafafa;
      margin-bottom: 20px;
    }

    .image-upload-container:hover {
      border-color: var(--primary-pink);
      background: rgba(228, 151, 170, 0.05);
    }

    .image-upload-container i {
      font-size: 2.5rem;
      color: var(--primary-pink);
      margin-bottom: 10px;
    }

    .image-preview {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
      margin-top: 15px;
      display: none;
    }

    /* Buttons */
    .btn-primary {
      background: linear-gradient(135deg,
          var(--primary-pink),
          var(--secondary-pink));
      border: none;
      border-radius: 12px;
      padding: 12px 24px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(228, 151, 170, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(228, 151, 170, 0.4);
    }

    .btn-outline-primary {
      border: 2px solid var(--primary-pink);
      color: var(--primary-pink);
      border-radius: 12px;
      padding: 10px 20px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-outline-primary:hover {
      background: var(--primary-pink);
      color: white;
      transform: translateY(-2px);
    }

    .table-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .search-box {
      position: relative;
      flex-grow: 1;
      max-width: 300px;
    }

    .search-box input {
      padding-left: 40px;
      border-radius: 8px;
      border: 1px solid #dee2e6;
    }

    .search-box i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #6c757d;
    }

    .sort-dropdown {
      min-width: 180px;
    }

    /* Clean Table Styles */
    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      background: white;
    }

    .table {
      margin-bottom: 0;
      min-width: 600px;
      border-collapse: separate;
      border-spacing: 0;
    }

    /* Clean Header - Removed Gradient */
    .table thead th {
      background: var(--primary-pink);
      color: white;
      font-weight: 600;
      border: none;
      cursor: pointer;
      user-select: none;
      position: relative;
      padding: 16px 12px;
      font-size: 0.875rem;
      border-bottom: 1px solid #e9ecef;
    }

    .table thead th.sortable:hover {
      background: #c2335c;
    }

    /* Clean Cell Styling */
    .table tbody td {
      padding: 14px 12px;
      vertical-align: middle;
      border-color: #f8f9fa;
      font-size: 0.875rem;
      color: #495057;
    }


    .table th:nth-child(4),
    /* Description header */
    .table td:nth-child(4) {
      max-width: 180px;
      width: 180px;
    }

    .table th:nth-child(2),
    /* name header */
    .table td:nth-child(2) {
      max-width: 150px;
      width: 150px;
    }

    .table th:nth-child(3),
    /* category header */
    .table td:nth-child(3) {
      max-width: 90px;
      width: 90px;
    }

    .table th:nth-child(1),
    /* image header */
    .table td:nth-child(1) {
      max-width: 120px;
      width: 120px;
    }

    .table th:nth-child(5),
    /* shades header */
    .table td:nth-child(5) {
      max-width: 90px;
      width: 90px;
    }

    .table th:nth-child(6),
    /* actions header */
    .table td:nth-child(6) {
      max-width: 90px;
      width: 90px;
    }

    /* Improved Hover Effect */
    .table tbody tr {
      transition: all 0.2s ease;
      border-bottom: 1px solid #f8f9fa;
    }

    .table tbody tr:hover {
      background-color: rgba(228, 151, 170, 0.08);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    /* Enhanced Product Image */
    .product-image {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .product-image:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    /* Clean Status Badges */
    .status-badge {
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      border: 1px solid transparent;
    }

    .status-available {
      background: rgba(40, 167, 69, 0.1);
      color: #28a745;
      border-color: rgba(40, 167, 69, 0.2);
    }

    .status-out-of-stock {
      background: rgba(220, 53, 69, 0.1);
      color: #dc3545;
      border-color: rgba(220, 53, 69, 0.2);
    }

    .status-archived {
      background: rgba(108, 117, 125, 0.1);
      color: #6c757d;
      border-color: rgba(108, 117, 125, 0.2);
    }

    /* Improved Action Buttons */
    .action-buttons {
      display: flex;
      gap: 6px;
      justify-content: center;
    }

    .action-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      border: 1px solid transparent;
      font-size: 0.8rem;
    }

    .btn-edit {
      background: rgba(13, 110, 253, 0.08);
      color: #0d6efd;
      border-color: rgba(13, 110, 253, 0.2);
    }

    .btn-edit:hover {
      background: #0d6efd;
      color: white;
      transform: translateY(-1px);
    }

    .btn-delete {
      background: rgba(220, 53, 69, 0.08);
      color: #dc3545;
      border-color: rgba(220, 53, 69, 0.2);
    }

    .btn-delete:hover {
      background: #dc3545;
      color: white;
      transform: translateY(-1px);
    }

    /* Enhanced Table Controls */
    .table-controls {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      border: 1px solid #e9ecef;
    }

    .search-box {
      position: relative;
      max-width: 300px;
    }

    .search-box .fas.fa-search {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #6c757d;
    }

    .search-box .form-control {
      padding-left: 40px;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }

    .sort-dropdown {
      border-radius: 8px;
      border: 1px solid #e9ecef;
      min-width: 160px;
    }

    /* Improved Nested Table */
    .table-nested {
      background: #fafafa;
      border-left: 4px solid var(--primary-pink);
      margin: 8px 0;
      border-radius: 0 8px 8px 0;
    }

    .table-nested th {
      font-size: 0.8rem;
      /* font-weight: 600; */
      background: rgba(0, 0, 0, 0.02);
      padding: 10px 8px;
    }

    .table-nested td {
      font-size: 0.8rem;
      padding: 8px;
      background: white;
    }

    .variant-row {
      border-bottom: 1px solid #f0f0f0;
      transition: all 0.2s ease;
    }

    .variant-row:hover {
      background: rgba(228, 151, 170, 0.05);
    }

    /* Better Collapse Icon */
    .collapse-icon {
      transition: transform 0.3s ease;
      font-size: 0.8rem;
    }

    .collapse.show+.collapse-icon {
      transform: rotate(90deg);
    }

    /* Improved Scrollbar */
    .table-container::-webkit-scrollbar {
      height: 6px;
    }

    .table-container::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 3px;
    }

    .table-container::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.2);
    }


    /* Animation for page load */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .product-management-container {
      animation: fadeInUp 0.6s ease forwards;
    }

    .skin-tone-options {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      justify-content: space-between;
    }

    .skin-tone {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      text-align: center;
      padding: 2px;
      gap: 10px;
    }

    .skin-tone input {
      display: none;
    }

    .skin-tone .tone {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid #ccc;
      transition: all 0.3s ease;
      box-shadow: 0 0 0 transparent;
    }

    .skin-tone .tone:hover {
      transform: scale(1.05);
      box-shadow: 0 0 8px rgba(255, 182, 193, 0.4);
      /* soft pink hover glow */
    }

    .skin-tone input:checked+.tone {
      border-color: var(--secondary-pink);
      transform: scale(1.1);
      box-shadow: 0 0 15px rgba(255, 105, 180, 0.7),
        0 0 25px rgba(255, 182, 193, 0.5);
      /* glow effect when selected */
    }

    .skin-tone span {
      font-size: 0.85rem;
      margin-top: 4px;
      color: #555;
    }

    #messageModal .modal-content {
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(227, 151, 170, 0.3);
      border: none;
      background: linear-gradient(135deg, #ffffff 0%, #fefafc 100%);
      backdrop-filter: blur(10px);
    }

    #messageModal .modal-header {
      padding: 1.5rem 2rem 0.5rem;
      border-bottom: 1px solid rgba(227, 151, 170, 0.1);
    }

    #messageModal .modal-header .btn-close {
      opacity: 0.7;
      transition: all 0.3s ease;
    }

    #messageModal .modal-header .btn-close:hover {
      opacity: 1;
      transform: scale(1.1);
    }

    #messageModal .modal-body {
      padding: 2rem 2rem 1.5rem;
      text-align: center;
    }

    #messageModal .modal-footer {
      padding: 0 2rem 2rem;
      border-top: none;
    }

    /* Success Modal - Pink Theme */
    .modal-success .modal-content {
      border-top: 4px solid var(--primary-pink);
      background: linear-gradient(135deg, #ffffff 0%, #fff9fb 100%);
    }

    .modal-success #modalIcon {
      color: var(--primary-pink);
      font-size: 4rem;
      margin-bottom: 1.5rem;
      text-shadow: 0 4px 12px rgba(227, 151, 170, 0.3);
    }

    .modal-success .modal-title {
      color: var(--dark-pink);
      font-weight: 600;
    }

    .modal-success #modalActionBtn {
      background: linear-gradient(135deg, var(--primary-pink) 0%, var(--secondary-pink) 100%);
      border: none;
      border-radius: 25px;
      padding: 10px 30px;
      font-weight: 500;
      box-shadow: 0 4px 15px rgba(227, 151, 170, 0.4);
      transition: all 0.3s ease;
    }

    .modal-success #modalActionBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(227, 151, 170, 0.6);
      background: linear-gradient(135deg, var(--secondary-pink) 0%, var(--dark-pink) 100%);
    }

    /* Error Modal - Soft Red Theme */
    .modal-error .modal-content {
      border-top: 4px solid #ff6b8b;
      background: linear-gradient(135deg, #ffffff 0%, #fff9fa 100%);
    }

    .modal-error #modalIcon {
      color: #ff6b8b;
      font-size: 4rem;
      margin-bottom: 1.5rem;
      text-shadow: 0 4px 12px rgba(255, 107, 139, 0.3);
    }

    .modal-error .modal-title {
      color: #e25573;
      font-weight: 600;
    }

    .modal-error #modalActionBtn {
      background: linear-gradient(135deg, #ff6b8b 0%, #ff8fa3 100%);
      border: none;
      border-radius: 25px;
      padding: 10px 30px;
      font-weight: 500;
      box-shadow: 0 4px 15px rgba(255, 107, 139, 0.4);
      transition: all 0.3s ease;
    }

    .modal-error #modalActionBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 139, 0.6);
      background: linear-gradient(135deg, #ff8fa3 0%, #ff6b8b 100%);
    }

    /* Warning Modal - Gold Theme */
    .modal-warning .modal-content {
      border-top: 4px solid #ffb74d;
      background: linear-gradient(135deg, #ffffff 0%, #fffdf9 100%);
    }

    .modal-warning #modalIcon {
      color: #ffb74d;
      font-size: 4rem;
      margin-bottom: 1.5rem;
      text-shadow: 0 4px 12px rgba(255, 183, 77, 0.3);
    }

    .modal-warning .modal-title {
      color: #f57c00;
      font-weight: 600;
    }

    .modal-warning #modalActionBtn {
      background: linear-gradient(135deg, #ffb74d 0%, #ffcc80 100%);
      border: none;
      border-radius: 25px;
      padding: 10px 30px;
      font-weight: 500;
      box-shadow: 0 4px 15px rgba(255, 183, 77, 0.4);
      color: #7d4a00;
      transition: all 0.3s ease;
    }

    .modal-warning #modalActionBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 183, 77, 0.6);
      background: linear-gradient(135deg, #ffcc80 0%, #ffb74d 100%);
    }

    /* Modal Typography */
    #modalTitle {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, var(--dark-pink) 0%, var(--darker-pink) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    #modalMessage {
      color: #6c757d;
      font-size: 1.1rem;
      line-height: 1.6;
      margin-bottom: 0;
    }

    /* Modal Backdrop */
    .modal-backdrop {
      background: rgba(255, 237, 242, 0.039);
      -webkit-backdrop-filter: blur(2px);
      backdrop-filter: blur(2px);
    }

    .modal-backdrop.show {
      opacity: 1;
    }

    /* Modal Animation */
    .modal.fade .modal-dialog {
      transform: translateY(-50px) scale(0.9);
      transition: all 0.3s ease;
    }

    .modal.show .modal-dialog {
      transform: translateY(0) scale(1);
    }

    /* Responsive Design */

    /* Large Screens (1200px - 1399px) */
    @media (min-width: 1200px) and (max-width: 1399px) {
      .page-title {
        font-size: 1.8rem;
      }
    }

    /* Medium Screens (992px - 1199px) */
    @media (min-width: 992px) and (max-width: 1199px) {
      .page-title {
        font-size: 1.6rem;
      }

      .product-management-container {
        padding: 25px;
      }
    }

    /* Tablets (768px - 991px) */
    @media (min-width: 768px) and (max-width: 991px) {
      .mobile-header {
        display: block;
      }

      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100%;
        width: 280px;
        transform: translateX(-100%);
        z-index: 100;
      }

      .sidebar.mobile-open {
        transform: translateX(0);
      }

      .sidebar-overlay.active {
        display: block;
      }

      main {
        margin-left: 0 !important;
        width: 100% !important;
        margin-top: 70px !important;
        padding-top: 20px !important;
      }

      .page-header {
        margin-top: 0 !important;
        padding-top: 0 !important;
      }

      .product-management-container {
        padding: 20px;
      }

      .page-title {
        font-size: 1.5rem;
      }

      main {
        padding: 25px !important;
      }

      .action-buttons {
        flex-direction: column;
      }

      .table-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .search-box {
        max-width: 100%;
      }

      .sort-dropdown {
        width: 100%;
      }
    }

    /* Mobile Landscape (576px - 767px) */
    @media (min-width: 576px) and (max-width: 767px) {
      .mobile-header {
        display: block;
      }

      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100%;
        width: 280px;
        transform: translateX(-100%);
        z-index: 100;
      }

      .sidebar.mobile-open {
        transform: translateX(0);
      }

      .sidebar-overlay.active {
        display: block;
      }

      main {
        margin-left: 0 !important;
        width: 100% !important;
        margin-top: 70px !important;
        padding-top: 20px !important;
      }

      .sidebar .nav-link {
        padding: 12px 15px;
        font-size: 0.9rem;
        margin: 6px 12px;
      }

      .logo-container {
        padding: 20px 15px;
      }

      .store-name {
        font-size: 1rem;
      }

      .product-management-container {
        padding: 18px;
      }

      .page-title {
        font-size: 1.4rem;
      }

      .page-header p {
        font-size: 0.9rem;
      }

      #messageModal .modal-dialog {
        margin: 1rem;
      }

      #messageModal .modal-body {
        padding: 1.5rem 1rem 1rem;
      }

      #modalTitle {
        font-size: 1.3rem;
      }

      #modalMessage {
        font-size: 1rem;
      }

      #modalIcon {
        font-size: 3rem;
      }

      main {
        padding: 20px !important;
      }

      .section-title {
        font-size: 1.1rem;
      }

      .action-buttons {
        flex-direction: column;
      }
    }

    /* Mobile Portrait (up to 575px) */
    @media (max-width: 575px) {
      .mobile-header {
        display: block;
      }

      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100%;
        width: 280px;
        transform: translateX(-100%);
        z-index: 100;
      }

      .sidebar.mobile-open {
        transform: translateX(0);
      }

      .sidebar-overlay.active {
        display: block;
      }

      main {
        margin-left: 0 !important;
        width: 100% !important;
        margin-top: 70px !important;
        padding-top: 15px !important;
      }

      .sidebar .nav-link {
        padding: 10px 12px;
        font-size: 0.85rem;
        margin: 5px 10px;
      }

      .sidebar .nav-link i {
        font-size: 1rem;
        margin-right: 10px;
      }

      .logo-container {
        padding: 18px 12px;
      }

      .logo {
        max-width: 100px;
      }

      .store-name {
        font-size: 0.95rem;
      }

      .product-management-container {
        padding: 16px;
        border-radius: 16px;
      }

      .page-title {
        font-size: 1.3rem;
      }

      .page-header {
        margin-bottom: 20px;
        padding-bottom: 15px;
      }

      .page-header p {
        font-size: 0.85rem;
      }

      main {
        padding: 15px !important;
      }

      .section-title {
        font-size: 1rem;
        margin-bottom: 20px;
      }

      .action-buttons {
        flex-direction: column;
      }
    }

    /* Extra Small Mobile (up to 375px) */
    @media (max-width: 375px) {
      .page-title {
        font-size: 1.2rem;
      }

      main {
        padding: 12px !important;
      }
    }


    .image-preview-box {
      width: 100%;
      padding-top: 100%;
      background-color: #f8f9fa;
      border: 1px dashed #ced4da;
      border-radius: 6px;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }


    .placeholder-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #888;
      font-size: 0.9rem;
      pointer-events: none;
    }


    .image-preview-box img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 6px;
    }

    /* New style for the rectangular gallery container */
    .image-gallery-container {
      width: 100%;
      /* KEEP: Aspect ratio trick */
      padding-top: 50%;
      background-color: #f8f9fa;
      border: 1px dashed #ced4da;
      border-radius: 6px;
      position: relative;
      /* KEEP: This is necessary for the placeholder text to position correctly inside */
      overflow: hidden;
      cursor: pointer;


      /* RE-APPLY grid setup within the correct block: */
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 5px;
      padding: 5px;

      /* Use flexbox to center placeholder content if no images are present */
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    /* Ensure the image-gallery-container placeholder text is centered */
    .image-gallery-container .placeholder-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #888;
      font-size: 0.9rem;
      pointer-events: none;
    }

    /* Style for individual small previews in the gallery */
    .image-gallery-container img {
      /* Reset img style from .image-preview-box img */
      position: static;
      width: 100%;
      height: 100%;
      /* Fill the grid cell */
      object-fit: cover;
      border-radius: 4px;
    }

    /* Styling for the Plus icon */
    .placeholder-icon {
      font-size: 2rem;
      color: #ced4da;
      transition: color 0.2s;
    }

    /* Hover effect on the box */
    .image-preview-box.additional-slot:hover {
      border-color: var(--secondary-pink);
      /* Highlight border on hover */
    }

    .image-preview-box.additional-slot:hover .placeholder-icon {
      color: var(--dark-pink);
      /* Highlight plus icon on hover */
    }

    /* Hide the actual file input elements */
    .hidden-file-input {
      display: none;
    }

    /* Style for the small delete button (we'll add this with JS) */
    .delete-image-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      z-index: 10;
      cursor: pointer;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      line-height: 1;
    }

    /* Styling for the nested table */
    .table-nested {
      width: 100%;
      border-left: 5px solid --primary-pink;
      /* Blue line to distinguish variants */
      margin-left: 10px;
      padding-left: 10px;
    }

    .table-nested th {
      font-size: 0.85rem;
      /* font-weight: 600; */
    }

    .table-nested td {
      font-size: 0.9rem;
      padding-top: 5px;
      padding-bottom: 5px;
    }

    /* Ensure the main rows don't have border under the collapse row */
    .parent-product-row {
      border-bottom: 0 !important;
    }

    /* Style the rows for the variants */
    .variant-row {
      background-color: #f8f9fa;
      /* Light background for variant rows */
    }

    td div::-webkit-scrollbar {
      width: 4px;
    }

    td div::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }

    .parent-product-row img {
      transition: transform 0.2s ease;
    }

    .parent-product-row img:hover {
      transform: scale(1.1);
    }

    .variant-row img {
      transition: transform 0.2s ease;
    }

    .variant-row img:hover {
      transform: scale(1.1);
    }

    .bg-soft-red {
      background-color: #c2335c;
      color: white;
    }

    .btn-outline-soft-pink {
      color: var(--secondary-pink);
    }
  </style>
</head>

<body>
  <!-- Mobile Header -->
  <div class="mobile-header">
    <div class="mobile-header-content">
      <button class="hamburger-btn" id="hamburgerBtn">
        <i class="fas fa-bars"></i>
      </button>
      <div class="mobile-logo">
        <a href="admin.html" class="nav-link">
          <img src="mainlogo.png" alt="Store Logo" />
          <span>Beauty & Blessed</span>
        </a>
      </div>
    </div>
  </div>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav class="col-md-2 d-md-block sidebar" id="sidebar">
        <div class="logo-container">
          <a href="admin.html">
            <img src="../images/mainlogo.png" alt="Store Logo" class="logo" />
          </a>
          <div class="store-name">Beauty & Blessed</div>

        </div>
        <div class="nav flex-column">
          <a href="product-management.html" class="nav-link">
            <i class="fa-solid fa-box"></i>
            <span>Product Management</span>
          </a>
          <a href="recommendation-insights.html" class="nav-link">
            <i class="fa-solid fa-lightbulb"></i>
            <span>Recommendation Insights</span>
          </a>
          <a href="customer-managemnet.html" class="nav-link">
            <i class="fa-solid fa-users"></i>
            <span>Customer Management</span>
          </a>
          <a href="order-transactions.html" class="nav-link">
            <i class="fa-solid fa-credit-card"></i>
            <span>Order Transaction</span>
          </a>
          <a href="store-settings.html" class="nav-link">
            <i class="fa-solid fa-gear"></i>
            <span>Store Setting</span>
          </a>
          <a href="activity-log.html" class="nav-link">
            <i class="fa-solid fa-clock-rotate-left"></i>
            <span>Activity Log</span>
          </a>
        </div>
      </nav>

      <!-- Main content -->
      <main class="col-md-10">
        <!-- Page Header -->
        <div class="page-header">
          <h2 class="page-title">Product Management</h2>
          <!-- <p class="text-muted">
              Manage your products, inventory, and categories.
            </p> -->
        </div>

        <div class="row">
          <!-- Product Form Section -->
          <div class="col-lg-5">
            <div class="product-management-container">
              <div class="d-flex justify-content-between align-items-center">
                <h3 class="section-title mb-0" id="productFormTitle">
                  <i class="fas fa-plus-circle"></i> Add New Product
                </h3>
                <button type="button" class="btn btn-outline-soft-pink btn-sm" id="headerRefreshBtn"
                  title="Reset Form/Refresh Page">
                  <i class="fas fa-sync-alt"></i>
                </button>
              </div>

              <form id="productForm" enctype="multipart/form-data">
                <div class="form-group">
                  <label class="form-label">Product Type <span class="text-danger">*</span></label>
                  <div class="d-flex gap-3">
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="productType" id="typeNewProduct" value="new"
                        checked />
                      <label class="form-check-label" for="typeNewProduct">
                        New Product Line
                      </label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="productType" id="typeNewVariant"
                        value="variant" />
                      <label class="form-check-label" for="typeNewVariant">
                        New Variant (Shade/Size)
                      </label>
                    </div>
                  </div>
                </div>

                <div class="form-group " id="parentProductGroup">
                  <label for="parentProductID" class="form-label">Select Parent Product Line <span
                      class="text-danger">*</span></label>
                  <select class="form-select" id="parentProductID" name="parentProductID">
                    <option value="" selected disabled>Select an existing product line</option>
                  </select>
                </div>


                <div class="row g-3 mb-4">

                  <div class="col-6 col-lg-6 parent-product-field" id="previewImageGroup">
                    <label for="previewImage" class="form-label">Preview Image <span
                        class="text-danger">*</span></label>

                    <div class="image-preview-box" id="previewImagePreview">
                      <span class="placeholder-text">Line Preview</span>
                    </div>

                    <input type="file" id="previewImage" class="form-control mt-2" name="previewImage" accept="image/*">
                    <small class="text-muted">Main listing image</small>
                  </div>

                  <div class="col-6 col-lg-6  variant-product-field">
                    <label for="variantImage" class="form-label">Variant Image <span
                        class="text-danger">*</span></label>

                    <div class="image-preview-box" id="variantImagePreview">
                      <span class="placeholder-text">Variant Shade</span>
                    </div>

                    <input type="file" id="variantImage" class="form-control mt-2" name="variantImage" accept="image/*">
                    <small class="text-muted">Image for this specific shade</small>
                  </div>
                </div>


                <div class="row mb-4">
                  <div class="col-12 parent-product-field" id="additionalImagesGroup">
                    <label class="form-label">Additional Images (Max 4)</label>

                    <div class="row g-3">
                      <div class="col-3 additional-image-slot-wrapper">
                        <div class="image-preview-box additional-slot" data-slot="1">
                          <i class="fas fa-plus placeholder-icon"></i>
                        </div>
                        <input type="file" id="detailImage1" class="hidden-file-input" name="detailImages[]"
                          accept="image/*">
                      </div>

                      <div class="col-3 additional-image-slot-wrapper">
                        <div class="image-preview-box additional-slot" data-slot="2">
                          <i class="fas fa-plus placeholder-icon"></i>
                        </div>
                        <input type="file" id="detailImage2" class="hidden-file-input" name="detailImages[]"
                          accept="image/*">
                      </div>

                      <div class="col-3 additional-image-slot-wrapper">
                        <div class="image-preview-box additional-slot" data-slot="3">
                          <i class="fas fa-plus placeholder-icon"></i>
                        </div>
                        <input type="file" id="detailImage3" class="hidden-file-input" name="detailImages[]"
                          accept="image/*">
                      </div>

                      <div class="col-3 additional-image-slot-wrapper">
                        <div class="image-preview-box additional-slot" data-slot="4">
                          <i class="fas fa-plus placeholder-icon"></i>
                        </div>
                        <input type="file" id="detailImage4" class="hidden-file-input" name="detailImages[]"
                          accept="image/*">
                      </div>
                    </div>
                    <small class="text-muted mt-2">Click the plus icon to add an image.</small>
                  </div>
                </div>
                <div class="form-group variant-product-field">
                  <label for="hexCode" class="form-label">Shade Hex Code <span class="text-danger">*</span></label>
                  <input type="color" id="hexCode" name="hexCode" class="form-control form-control-color"
                    value="#ffffff">
                </div>


                <!-- Product Name -->
                <div class="form-group parent-product-field">
                  <label for="productName" class="form-label">Product Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="productName" name="productName"
                    placeholder="Enter product name" />
                </div>

                <div class="form-group  variant-product-field">
                  <label for="productVariantName" class="form-label">Shade/Variant Name <span
                      class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="productVariantName" name="productVariantName"
                    placeholder="e.g., Black, Shade 03, 50ml, Large" />
                </div>

                <div class="form-group">
                  <label for="productCategory" class="form-label">Category <span class="text-danger">*</span></label>
                  <div class="d-flex gap-2">
                    <select class="form-select" id="productCategorySelect" name="productCategory">
                      <option value="" selected disabled>Select category</option>
                    </select>

                    <input type="text" class="form-control d-none" id="productCategoryInput" name="productCategory"
                      placeholder="Enter new category name" disabled>

                    <button type="button" id="addCategoryBtn" class="btn btn-outline-secondary btn-sm">
                      Add New
                    </button>
                  </div>
                </div>

                <!-- Stock -->
                <div class="form-group variant-product-field">
                  <label for="productStock" class="form-label">Stocks <span class="text-danger">*</span></label>
                  <input type="number" class="form-control" id="productStock" name="productStock" value="12" min="0" />
                </div>

                <!-- Price -->
                <div class="form-group variant-product-field">
                  <label for="productPrice" class="form-label">Price (â‚±)<span class="text-danger">*</span></label>
                  <input type="number" class="form-control" id="productPrice" name="productPrice" placeholder="0.00"
                    min="0" step="0.01" />
                </div>

                <!-- Description -->
                <div class="form-group variant-product-field">
                  <label for="productDescription" class="form-label">Description <span
                      class="text-danger">*</span></label>
                  <textarea class="form-control" id="productDescription" name="productDescription" rows="1"
                    placeholder="Enter product description"></textarea>
                </div>

                <div class="form-group variant-product-field">
                  <label for="productIngredients" class="form-label">Ingredients (optional)</label>
                  <textarea class="form-control" id="productIngredients" name="productIngredients" rows="3"
                    placeholder="List all ingredients, separated by commas or new lines."></textarea>
                </div>

                <!-- Expiration Date -->
                <div class="form-group variant-product-field">
                  <label for="productExpiration" class="form-label">Expiration Date <span
                      class="text-danger">*</span></label>
                  <input type="date" class="form-control" id="productExpiration" name="productExpiration" />
                </div>

                <div class="form-group variant-product-field">
                  <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="collapse"
                    data-bs-target="#attributesSection">
                    Add Product Attributes for Recommendation
                  </button>

                  <div class="collapse mt-3" id="attributesSection">

                    <label class="form-label mt-3">Skin Type</label>
                    <div class="skin-type-options">
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="skinType[]" id="skin_normal"
                          value="Normal" />
                        <label class="form-check-label" for="skin_normal">Normal</label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="skinType[]" id="skin_oily" value="Oily" />
                        <label class="form-check-label" for="skin_oily">Oily</label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="skinType[]" id="skin_dry" value="Dry" />
                        <label class="form-check-label" for="skin_dry">Dry</label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="skinType[]" id="skin_sensitive"
                          value="Sensitive" />
                        <label class="form-check-label" for="skin_sensitive">Sensitive</label>
                      </div>
                    </div>

                    <label class="form-label mt-3">Skin Tone</label>
                    <div class="skin-tone-options">
                      <label class="skin-tone">
                        <input type="checkbox" name="skinTone[]" value="Fair" />
                        <div class="tone" style="background-color: #f5d6b3;"></div>
                        <span>Fair</span>
                      </label>
                      <label class="skin-tone">
                        <input type="checkbox" name="skinTone[]" value="Medium" />
                        <div class="tone" style="background-color: #d2a679;"></div>
                        <span>Medium</span>
                      </label>
                      <label class="skin-tone">
                        <input type="checkbox" name="skinTone[]" value="Tan" />
                        <div class="tone" style="background-color: #b47b52;"></div>
                        <span>Tan</span>
                      </label>
                      <label class="skin-tone">
                        <input type="checkbox" name="skinTone[]" value="Deep" />
                        <div class="tone" style="background-color: #5a3825;"></div>
                        <span>Deep</span>
                      </label>
                    </div>

                    <label class="form-label mt-3">Undertone</label>
                    <select class="form-select" id="undertone" name="undertone">
                      <option value="">None</option>
                      <option value="Warm">Warm</option>
                      <option value="Cool">Cool</option>
                      <option value="Neutral">Neutral</option>
                      <option value="All">All</option>
                    </select>

                    <label class="form-label mt-3">Skin Concerns</label>
                    <div class="skin-tone-options">
                      <label class="skin-tone">
                        <input type="checkbox" name="acne" value="1" />
                        <div class="tone" style="background-color: #ffb6b9;"></div>
                        <span>Acne</span>
                      </label>
                      <label class="skin-tone">
                        <input type="checkbox" name="dryness" value="1" />
                        <div class="tone" style="background-color: #ffe4b5;"></div>
                        <span>Dryness</span>
                      </label>
                      <label class="skin-tone">
                        <input type="checkbox" name="darkSpots" value="1" />
                        <div class="tone" style="background-color: #cdb79e;"></div>
                        <span>Dark Spots</span>
                      </label>
                    </div>

                    <label class="form-label mt-3">Finish</label>
                    <div class="form-check">
                      <input type="checkbox" class="form-check-input" id="matte" name="matte" value="1" /> <label
                        class="form-check-label" for="matte">Matte</label>
                    </div>
                    <div class="form-check">
                      <input type="checkbox" class="form-check-input" id="dewy" name="dewy" value="1" /> <label
                        class="form-check-label" for="dewy">Dewy</label>
                    </div>
                    <div class="form-check">
                      <input type="checkbox" class="form-check-input" id="longLasting" name="longLasting" value="1" />
                      <label class="form-check-label" for="longLasting">Long-lasting</label>
                    </div>

                  </div>
                </div>

                <input type="hidden" id="hiddenProductID" name="productID" value="">
                <input type="hidden" id="hiddenParentProductID" name="ParentProductID">


                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                  <button type="reset" id="clearFormBtn" class="btn btn-outline-primary me-md-2">
                    Clear Form
                  </button>
                  <button type="submit" id="addProductBtn" class="btn btn-primary">Add Product</button>

                  <button type="button" id="updateProductBtn" class="btn btn-success d-none">
                    <i class="fas fa-save"></i> Update Product
                  </button>
                </div>
              </form>
            </div>

          </div>

          <!-- Product Table Section -->
          <div class="col-lg-7">
            <div class="product-management-container">
              <h3 class="section-title">
                <i class="fas fa-list"></i> Product List
              </h3>
              <!-- ADD THIS SECTION - Table Controls -->
              <div class="table-controls">
                <div class="search-box">
                  <i class="fas fa-search"></i>
                  <input type="text" id="productSearch" class="form-control" placeholder="Search products...">
                </div>
                <div class="d-flex gap-2">
                  <select id="categoryFilter" class="form-select sort-dropdown">
                    <option value="">All Categories</option>
                    <!-- Categories will be populated dynamically -->
                  </select>
                  <select id="sortSelect" class="form-select sort-dropdown">
                    <option value="name-asc">Name: A to Z</option>
                    <option value="name-desc">Name: Z to A</option>
                    <option value="category-asc">Category: A to Z</option>
                    <option value="category-desc">Category: Z to A</option>
                  </select>
                </div>
              </div>

              <div class="table-container">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th class="sortable" data-sort="image">Image</th>
                      <th class="sortable" data-sort="name">Name</th>
                      <th class="sortable" data-sort="category">Category</th>
                      <th class="sortable" data-sort="description">Description</th>
                      <th class="sortable" data-sort="status">Available Shades</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="productTableBody">
                    <!-- Empty state -->
                    <tr>
                      <td colspan="6" class="text-center py-5">
                        <div class="empty-state">
                          <i class="fas fa-box-open"></i>
                          <h5>No Products Yet</h5>
                          <p>
                            Add your first product using the form on the left
                          </p>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="text-muted">
                  Showing <span id="productCount">0</span> products
                </div>
                <nav>
                  <ul class="pagination mb-0">
                    <li class="page-item disabled">
                      <a class="page-link" href="#">Previous</a>
                    </li>
                    <li class="page-item active">
                      <a class="page-link" href="#">1</a>
                    </li>
                    <li class="page-item">
                      <a class="page-link" href="#">2</a>
                    </li>
                    <li class="page-item">
                      <a class="page-link" href="#">3</a>
                    </li>
                    <li class="page-item">
                      <a class="page-link" href="#">Next</a>
                    </li>
                  </ul>
                </nav>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Success/Error Modal -->
  <div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="messageModalLabel"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <div class="mb-3" id="modalIcon">
            <!-- Icon will be inserted here -->
          </div>
          <h4 id="modalTitle" class="mb-2"></h4>
          <p id="modalMessage" class="mb-0"></p>
        </div>
        <div class="modal-footer border-0 justify-content-center">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="modalActionBtn">Continue</button>
        </div>
      </div>
    </div>
  </div>



  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Function to explicitly toggle fields based on mode, used ONLY in Edit context.
    function toggleEditFormFields() {
      // This is the logic you already have.
      const isVariantMode = document.getElementById('typeNewVariant').checked;
      const parentProductGroup = document.getElementById("parentProductGroup");
      const categorySelect = document.getElementById('productCategorySelect');

      const parentFields = document.querySelectorAll('.parent-product-field');
      const variantFields = document.querySelectorAll('.variant-product-field');

      if (isVariantMode) {
        // Variant Update Mode
        variantFields.forEach(el => el.classList.remove('d-none'));
        parentFields.forEach(el => el.classList.add('d-none'));
        if (parentProductGroup) parentProductGroup.classList.remove('d-none');
        if (categorySelect) categorySelect.disabled = true;
      } else {
        // Parent Update Mode
        parentFields.forEach(el => el.classList.remove('d-none'));
        variantFields.forEach(el => el.classList.add('d-none'));
        if (parentProductGroup) parentProductGroup.classList.add('d-none');
        if (categorySelect) categorySelect.disabled = false;
      }
    }
    // Define loadCategories globally
    function loadCategories() {
      // Ensure productCategorySelect is accessible here, or get it by ID
      const productCategorySelect = document.getElementById('productCategorySelect');

      fetch("../php/fetch_categories.php")
        .then(res => {
          if (!res.ok) throw new Error("Category fetch failed.");
          return res.json();
        })
        .then(data => {
          if (data.success && data.categories && productCategorySelect) {

            productCategorySelect.innerHTML = '<option value="" selected disabled>Select category</option>';

            data.categories.forEach(category => {
              if (category === 'All' && productCategorySelect.options.length === 1) return;

              const option = document.createElement('option');
              option.value = category;
              option.textContent = category;
              productCategorySelect.appendChild(option);
            });
          } else {
            console.error("Failed to load categories:", data.message || "No categories found or select element missing.");
          }
        })
        .catch(err => {
          console.error("Error loading categories:", err);
        });
    }

    // Function to handle the complete form reset
    function resetProductForm() {
      // This immediately reloads the current page, simulating a browser refresh.
      window.location.reload();
    }
    let currentSearch = '';
    let currentSort = 'name-asc';
    let currentCategory = '';
    let filteredProducts = [];

    document.addEventListener("DOMContentLoaded", function () {

      const hamburgerBtn = document.getElementById("hamburgerBtn");
      const sidebar = document.getElementById("sidebar");
      const sidebarOverlay = document.getElementById("sidebarOverlay");
      const navLinks = document.querySelectorAll(".sidebar .nav-link");
      const mobileHeader = document.querySelector(".mobile-header");
      const mainContent = document.querySelector("main");

      // --- Product Form References ---
      const productForm = document.getElementById("productForm");
      const typeNewProduct = document.getElementById("typeNewProduct");
      const typeNewVariant = document.getElementById("typeNewVariant");
      const parentProductGroup = document.getElementById("parentProductGroup");
      const parentProductID = document.getElementById("parentProductID");


      const productNameInput = document.getElementById("productName");
      const productDescriptionTextarea = document.getElementById("productDescription");

      const previewImageInput = document.getElementById("previewImage");
      const variantImageInput = document.getElementById("variantImage");
      const previewImageGroup = document.getElementById("previewImageGroup");
      const additionalImagesGroup = document.getElementById("additionalImagesGroup");

      const clearFormBtn = document.getElementById('clearFormBtn');
      const headerRefreshBtn = document.getElementById('headerRefreshBtn');

      const productSearch = document.getElementById('productSearch');
      const sortSelect = document.getElementById('sortSelect');
      const categoryFilter = document.getElementById('categoryFilter');
      const tableHeaders = document.querySelectorAll('th.sortable');


      // Search handler
      function handleSearch(e) {
        currentSearch = e.target.value.toLowerCase();

        if (currentSearch === '') {
          // If search is cleared, refresh to server pagination
          fetchAndRenderProducts(1);
        } else {
          // If searching, use client-side filtering (no pagination)
          renderFilteredProducts();
        }
      }

      // Sort handler  
      function handleSortChange(e) {
        currentSort = e.target.value;

        // Check if we have active filters
        const hasActiveFilters = currentSearch || currentCategory;

        if (hasActiveFilters) {
          // If filters are active, sort the filtered results
          renderFilteredProducts();
        } else {
          // If no filters, fetch fresh data from server (standard paginated view)
          fetchAndRenderProducts(1);
        }
      }
      // Category filter handler
      function handleCategoryChange(e) {
        currentCategory = e.target.value;

        if (currentCategory === '') {
          // If "All Categories" is selected, refresh to standard server pagination
          fetchAndRenderProducts(1);
        } else {
          // For specific categories, use client-side filtering (no pagination)
          renderFilteredProducts();
        }
      }
      // Toggle sort direction for table headers
      function toggleSort(header, sortField) {
        // Reset all headers
        tableHeaders.forEach(h => {
          h.classList.remove('sort-asc', 'sort-desc');
        });

        // Determine new sort direction
        let sortDirection = 'asc';
        if (header.classList.contains('sort-asc')) {
          sortDirection = 'desc';
        }

        // Apply to clicked header
        header.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');

        // Update sort select to match
        const sortValue = `${sortField}-${sortDirection}`;
        sortSelect.value = sortValue;
        currentSort = sortValue;

        filterAndRenderProducts();
      }

      // Filter and render products based on current filters
      function filterAndRenderProducts() {
        if (!allProducts || allProducts.length === 0) return;

        // Apply search filter
        let filtered = allProducts;

        if (currentSearch) {
          filtered = filtered.filter(product =>
            product.ParentName.toLowerCase().includes(currentSearch) ||
            (product.Description && product.Description.toLowerCase().includes(currentSearch)) ||
            (product.Category && product.Category.toLowerCase().includes(currentSearch))
          );
        }

        // Apply category filter
        if (currentCategory) {
          filtered = filtered.filter(product =>
            product.Category === currentCategory
          );
        }

        // Apply sorting
        filtered = sortProducts(filtered, currentSort);

        filteredProducts = filtered;
        renderProducts(currentPage);
      }

      // Sort products based on current sort setting
      function sortProducts(products, sortSetting) {
        const [field, direction] = sortSetting.split('-');

        return [...products].sort((a, b) => {
          let aValue, bValue;

          switch (field) {
            case 'name':
              aValue = a.ParentName || '';
              bValue = b.ParentName || '';
              break;
            case 'category':
              aValue = a.Category || '';
              bValue = b.Category || '';
              break;
            case 'description':
              aValue = a.Description || '';
              bValue = b.Description || '';
              break;
            case 'status':
              aValue = a.Status || '';
              bValue = b.Status || '';
              break;
            default:
              return 0;
          }

          // Convert to string for comparison
          aValue = String(aValue).toLowerCase();
          bValue = String(bValue).toLowerCase();

          if (aValue < bValue) return direction === 'asc' ? -1 : 1;
          if (aValue > bValue) return direction === 'asc' ? 1 : -1;
          return 0;
        });
      }
      // Populate category filter dropdown using your existing categories
      function populateCategoryFilter() {
        // Use your existing loadCategories function but populate the filter dropdown instead
        fetch("../php/fetch_categories.php")
          .then(res => {
            if (!res.ok) throw new Error("Category fetch failed.");
            return res.json();
          })
          .then(data => {
            if (data.success && data.categories && categoryFilter) {

              categoryFilter.innerHTML = '<option value="">All Categories</option>';

              data.categories.forEach(category => {
                if (category === 'All' && categoryFilter.options.length === 1) return;

                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
              });
            } else {
              console.error("Failed to load categories for filter:", data.message || "No categories found or select element missing.");
            }
          })
          .catch(err => {
            console.error("Error loading categories for filter:", err);
          });
      }

      if (clearFormBtn) {
        clearFormBtn.addEventListener('click', function (e) {
          e.preventDefault();
          resetProductForm();
        });
      }

      // BIND THE SAME FUNCTION TO THE NEW HEADER BUTTON
      if (headerRefreshBtn) {
        headerRefreshBtn.addEventListener('click', function (e) {
          e.preventDefault();
          resetProductForm();
        });
      }

      const updateBtn = document.getElementById('updateProductBtn');

      if (updateBtn) {
        updateBtn.addEventListener('click', async (e) => {
          e.preventDefault();

          const formData = new FormData(productForm);
          const productID = document.getElementById('hiddenProductID').value;
          formData.append('ProductID', productID);

          const isParentUpdate = document.getElementById('typeNewProduct').checked;
          formData.append('isParentUpdate', isParentUpdate ? 'true' : 'false');

          const parentProductIDField = document.getElementById('hiddenParentProductID');
          if (parentProductIDField) {
            const parentProductID = parentProductIDField.value;
            formData.append('ParentProductID', parentProductID);
          }

          // Show loading state
          updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
          updateBtn.disabled = true;

          try {
            const response = await fetch('../php/update_product.php', {
              method: 'POST',
              body: formData
            });

            const rawResponse = await response.text();
            console.log("ðŸ“„ RAW PHP RESPONSE:", rawResponse);

            let result;
            try {
              result = JSON.parse(rawResponse);
            } catch (jsonError) {
              console.error("âŒ JSON Parse Error");
              showModal('error', 'Server Error', 'There was a server error while updating the product. Please try again.');
              return;
            }

            if (!response.ok || result.error) {
              throw new Error(result.error || `HTTP error! status: ${response.status}`);
            }

            const productType = isParentUpdate ? 'Parent Product' : 'Variant';
            showModal('success', `${productType} Updated!`,
              `Successfully updated the ${productType.toLowerCase()}!\n\nThe page will refresh automatically.`,
              true);

          } catch (error) {
            console.error('Update failed:', error);
            showModal('error', 'Update Failed', `Failed to update product: ${error.message}`);
          } finally {
            updateBtn.innerHTML = '<i class="fas fa-save"></i> Update Product';
            updateBtn.disabled = false;
          }
        });
      }
      if (productSearch) {
        productSearch.addEventListener('input', handleSearch);
      }
      if (sortSelect) {
        sortSelect.addEventListener('change', handleSortChange);
      }
      if (categoryFilter) {
        categoryFilter.addEventListener('change', handleCategoryChange);
      }

      if (tableHeaders) {
        tableHeaders.forEach(header => {
          header.addEventListener('click', () => {
            const sortField = header.getAttribute('data-sort');
            toggleSort(header, sortField);
          });
        });
      }

      document.getElementById('previewImage').addEventListener('change', function () {
        setupImagePreview(this, 'previewImagePreview');
      });

      document.getElementById('variantImage').addEventListener('change', function () {
        setupImagePreview(this, 'variantImagePreview');
      });


      document.getElementById('previewImagePreview').innerHTML = `<span class="placeholder-text">Line Preview</span>`;
      document.getElementById('variantImagePreview').innerHTML = `<span class="placeholder-text">Variant Shade</span>`;


      const additionalSlots = document.querySelectorAll('.image-preview-box.additional-slot');
      const imageInputs = [
        document.getElementById('detailImage1'),
        document.getElementById('detailImage2'),
        document.getElementById('detailImage3'),
        document.getElementById('detailImage4')
      ];

      additionalSlots.forEach(box => {
        const slotNumber = parseInt(box.dataset.slot);
        const hiddenInput = document.getElementById(`detailImage${slotNumber}`);

        // 1. Click Listener (Links the visual box click to the hidden file input)
        box.addEventListener('click', function () {
          // Trigger the hidden file input click
          hiddenInput.click();
        });
      });

      // 2. Change Listener (Handles file selection and visual update)
      imageInputs.forEach(input => {
        input.addEventListener('change', function () {
          const slotNumber = this.id.replace('detailImage', '');
          const previewBox = document.querySelector(`.image-preview-box[data-slot="${slotNumber}"]`);

          if (this.files && this.files[0]) {
            const file = this.files[0];
            const reader = new FileReader();

            reader.onload = (e) => {
              // Remove existing content and delete button
              previewBox.innerHTML = '';


              // Add the image
              previewBox.innerHTML = `<img src="${e.target.result}" alt="Additional Image ${slotNumber}">`;

              // Add a delete button (using a simple X icon, requires Font Awesome or equivalent)
              const deleteBtn = document.createElement('span');
              deleteBtn.className = 'delete-image-btn';
              deleteBtn.innerHTML = '<i class="fas fa-times"></i>'; // 'X' icon

              deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Stop click from propagating to the box (which would open file dialog)

                // Clear the file input value (crucial for form submission)
                this.value = '';

                // Reset the visual box
                previewBox.innerHTML = `<i class="fas fa-plus placeholder-icon"></i>`;
              });

              previewBox.appendChild(deleteBtn);
            };
            reader.readAsDataURL(file);

          } else {
            // Reset back to plus icon if file selection was cancelled
            previewBox.innerHTML = `<i class="fas fa-plus placeholder-icon"></i>`;
          }
        });
      });
      const hexCodeInput = document.getElementById("hexCode");


      const productCount = document.getElementById("productCount");
      if (productCount) productCount.textContent = "0";


      const productCategorySelect = document.getElementById('productCategorySelect');
      const productCategoryInput = document.getElementById('productCategoryInput');
      const addCategoryBtn = document.getElementById('addCategoryBtn');
      addCategoryBtn.addEventListener('click', () => {
        if (categoryMode === 'select') {
          // Switch to Input mode
          productCategorySelect.classList.add('d-none');
          productCategoryInput.classList.remove('d-none');
          addCategoryBtn.textContent = 'Select Existing';
          categoryMode = 'input';

          // Ensure only the active element submits its value
          productCategorySelect.setAttribute('disabled', 'disabled');
          productCategoryInput.removeAttribute('disabled');
        } else {
          // Switch back to Select mode
          productCategorySelect.classList.remove('d-none');
          productCategoryInput.classList.add('d-none');
          addCategoryBtn.textContent = 'Add New';
          categoryMode = 'select';


          productCategorySelect.removeAttribute('disabled');
          productCategoryInput.setAttribute('disabled', 'disabled');
        }
      });

      const parentProductIDSelect = document.getElementById('parentProductID');
      if (parentProductIDSelect) {
        parentProductIDSelect.addEventListener('change', function () {
          document.getElementById('hiddenParentProductID').value = this.value;
          console.log("ðŸ”„ ParentProductID updated to:", this.value);
        });
      }

      function resetProductForm() {

        window.location.reload();
      }

      let categoryMode = 'select';
      let currentPage = 1;
      const productsPerPage = 10;


      async function fetchAndRenderProducts(page = 1) {
        const tableBody = document.getElementById('productTableBody');
        const productCountSpan = document.getElementById('productCount');
        const paginationContainer = document.querySelector('.pagination');

        tableBody.innerHTML = `
        <tr>
            <td colspan="6" class="text-center py-5">
                <i class="fas fa-spinner fa-spin"></i> Loading Products...
            </td>
        </tr>`;

        try {
          const response = await fetch(`../php/fetch_table.php?page=${page}`);
          const data = await response.json();
          const productGroups = data.parents;
          const totalParents = data.total;
          if (!Array.isArray(productGroups) || productGroups.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-5">
                        <div class="empty-state">
                            <i class="fas fa-box-open"></i>
                            <h5>No Products Yet</h5>
                            <p>Add your first product using the form on the left</p>
                        </div>
                    </td>
                </tr>`;
            productCountSpan.textContent = '0';
            paginationContainer.innerHTML = '';
            return;
          }
          allProducts = productGroups;

          // PAGINATION LOGIC
          const totalPages = Math.ceil(totalParents / productsPerPage);
          currentPage = Math.min(Math.max(page, 1), totalPages);
          const start = (currentPage - 1) * productsPerPage;
          const end = start + productsPerPage;
          const productsToDisplay = productGroups.slice(start, end);

          tableBody.innerHTML = '';
          let totalVariants = 0;

          productsToDisplay.forEach(parent => {
            const variants = parent.Variants || [];
            totalVariants += variants.length;

            const parentImage = parent.Image
              ? `<img src="${parent.Image}" alt="${parent.ParentName}" style="width80px;height:80px;object-fit:cover;border-radius:6px;">`
              : `<div class="text-muted small">No Image</div>`;

            // Parent Row
            const parentRow = document.createElement('tr');
            parentRow.classList.add('parent-product-row');
            parentRow.setAttribute('data-product-id', parent.ProductID);
            parentRow.setAttribute('data-bs-toggle', 'collapse');
            parentRow.setAttribute('data-bs-target', `#variants-${parent.ProductID}`);
            parentRow.setAttribute('aria-expanded', 'false');
            parentRow.style.cursor = 'pointer';

            parentRow.innerHTML = `
    <td style="vertical-align: middle;">
        <div class="d-flex align-items-center">
            <i class="fas fa-chevron-right me-2 collapse-icon text-muted"></i>
            ${parentImage}
        </div>
    </td>
    <td style="vertical-align: middle;">
        <span style="font-size: 14px; color: #333;">
            ${parent.ParentName || parent.Name}
        </span>
    </td>
    <td style="vertical-align: middle;">${parent.Category || 'N/A'}</td>
    <td style="vertical-align: middle;">
        <div style="
            max-height: 50px;
            overflow-y: auto;
            white-space: normal;
            font-size: 13px;
            padding-right: 4px;
        ">
            ${parent.Description || 'N/A'}
        </div>
    </td>
    <td style="vertical-align: middle;">
       <span class="badge ${parent.Status.includes('No') ? 'bg-soft-red' : 'bg-success'}">
    ${parent.Status}
</span>

    </td>
    <td class="text-nowrap" style="vertical-align: middle;">
        <div class="d-flex flex-column align-items-start gap-1">
            <button class="btn btn-sm btn-primary edit-parent-btn" data-id="${parent.ProductID}"
                style="padding: 2px 8px; font-size: 12px; width: 70px;">
                <i class="fas fa-edit"></i> Edit
            </button>
            <button class="btn btn-sm btn-danger delete-parent-btn" data-id="${parent.ProductID}"
                style="padding: 2px 8px; font-size: 12px; width: 70px;">
                <i class="fas fa-trash-alt"></i> Delete
            </button>
        </div>
    </td>
`;
            tableBody.appendChild(parentRow);

            // Variants
            const variantsTableRows = variants
              .filter(v => v.ShadeOrVariant?.toUpperCase() !== 'PARENT_GROUP')
              .map(variant => {
                const variantImage = variant.Image
                  ? `<img src="${variant.Image}" alt="${variant.ShadeOrVariant || variant.Name}" 
                    style="width:80px;height:80px;object-fit:cover;border-radius:4px;">`
                  : `<div class="text-muted small">No Image</div>`;

                const attributesHtml = `
            <span class="d-block text-muted small">Skin Type: <strong class="text-dark">${variant["Skin Type"] || 'N/A'}</strong></span>
            <span class="d-block text-muted small">Skin Tone: <strong class="text-dark">${variant["Skin Tone"] || 'N/A'}</strong></span>
            <span class="d-block text-muted small">Undertone: <strong class="text-dark">${variant["Undertone"] || 'N/A'}</strong></span>
            <span class="d-block text-muted small">Skin Concern: <strong class="text-dark">${variant["Skin Concern"] || 'N/A'}</strong></span>
            <span class="d-block text-muted small">Finish: <strong class="text-dark">${variant["Finish"] || 'N/A'}</strong></span>
        `;

                // âœ… Match badge color with actual DB status
                const statusColor = {
                  'Available': 'success',
                  'Low Stock': 'warning',
                  'No Stock': 'danger',
                  'Expired': 'secondary'
                }[variant.Status] || 'secondary';

                return `
            <tr class="variant-row" data-product-id="${variant.ProductID}">
                <td>${variantImage} 
                    <strong>${variant.ShadeOrVariant || variant.Name || 'Unnamed Variant'}</strong>
                </td>
                <td>${attributesHtml}</td>
                <td>â‚±${parseFloat(variant.Price || 0).toFixed(2)}</td>
                <td>${variant.Stocks || 0}</td>
                <td>
                    <span class="badge bg-${statusColor}">
                        ${variant.Status || 'N/A'}
                    </span>
                </td>
                <td class="text-nowrap">
                    <div class="d-flex flex-column align-items-start gap-1">
                        <button class="btn btn-sm btn-primary edit-variant-btn" data-id="${variant.ProductID}" style="padding: 2px 8px; font-size: 12px; width: 70px;">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger delete-variant-btn" data-id="${variant.ProductID}" style="padding: 2px 8px; font-size: 12px; width: 70px;">
                            <i class="fas fa-trash-alt"></i> Delete
                        </button>
                    </div>
                </td>
            </tr>`;
              }).join('');


            const variantsRow = document.createElement('tr');
            variantsRow.classList.add('collapse-row');
            variantsRow.innerHTML = `
                <td colspan="6" class="p-0 border-0">
                    <div class="collapse" id="variants-${parent.ProductID}">
                        <table class="table table-sm table-nested mb-0">
                            <thead>
                                <tr class="table-light">
                                    <th>Shade Name</th>
                                    <th>Attributes</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody class="table-group-divider">
                                ${variantsTableRows}
                            </tbody>
                        </table>
                    </div>
                </td>`;
            tableBody.appendChild(variantsRow);
          });

          productCountSpan.textContent = totalVariants;

          // PAGINATION DISPLAY (limit to 3 visible page numbers)
          const maxVisiblePages = 3;
          let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
          let endPage = startPage + maxVisiblePages - 1;

          if (endPage > totalPages) {
            endPage = totalPages;
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
          }

          let paginationHTML = `
  <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
    <button class="page-link" data-page="${currentPage - 1}">Previous</button>
  </li>
`;

          for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
    <li class="page-item ${i === currentPage ? 'active' : ''}">
      <button class="page-link" data-page="${i}">${i}</button>
    </li>
  `;
          }

          paginationHTML += `
  <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
    <button class="page-link" data-page="${currentPage + 1}">Next</button>
  </li>
`;

          paginationContainer.innerHTML = paginationHTML;

          // Pagination click events
          paginationContainer.querySelectorAll('.page-link').forEach(button => {
            button.addEventListener('click', e => {
              const page = parseInt(e.target.getAttribute('data-page'));
              if (!isNaN(page) && page >= 1 && page <= totalPages) {
                fetchAndRenderProducts(page);
              }
            });
          });

          populateCategoryFilter();


          // Locate the product table container (assuming the table is nearby or easy to select)
          const productTableBody = document.getElementById('productTableBody');

          if (productTableBody) {
            productTableBody.querySelectorAll('.collapse').forEach(collapseEl => {
              // The event listeners now only attach to variants collapse divs created in the table
              collapseEl.addEventListener('show.bs.collapse', function () {
                const parentRow = document.querySelector(`[data-bs-target="#${this.id}"]`);
                // Add an extra check to ensure the collapse icon exists before trying to access its classList
                if (parentRow) {
                  const icon = parentRow.querySelector('.collapse-icon');
                  if (icon) icon.classList.replace('fa-chevron-right', 'fa-chevron-down');
                }
              });

              collapseEl.addEventListener('hide.bs.collapse', function () {
                const parentRow = document.querySelector(`[data-bs-target="#${this.id}"]`);
                // Add an extra check
                if (parentRow) {
                  const icon = parentRow.querySelector('.collapse-icon');
                  if (icon) icon.classList.replace('fa-chevron-down', 'fa-chevron-right');
                }
              });
            });
          }

        } catch (error) {
          console.error('Error fetching products:', error);
          tableBody.innerHTML = `
            <tr><td colspan="6" class="text-center py-5 text-danger">
                Failed to load products. Check console for details.
            </td></tr>`;
        }
      }

      fetchAndRenderProducts();
      document.addEventListener('click', async function (e) {
        const parentBtn = e.target.closest('.delete-parent-btn');
        const variantBtn = e.target.closest('.delete-variant-btn');

        if (parentBtn) {
          e.stopPropagation();
          e.preventDefault();
          const productId = parentBtn.getAttribute('data-id');
          const productName = parentBtn.closest('tr').querySelector('td:nth-child(2) span').textContent;

          // Store the product info for later use
          window.pendingDelete = { id: productId, isParent: true };

          showModal('warning', 'Delete Product Line?',
            `Are you sure you want to delete "${productName}"?\n\nThis will also delete ALL its variants and cannot be undone.`);
          return;
        }

        if (variantBtn) {
          e.stopPropagation();
          e.preventDefault();
          const variantId = variantBtn.getAttribute('data-id');
          const variantName = variantBtn.closest('tr').querySelector('td strong').textContent;

          // Store the variant info for later use
          window.pendingDelete = { id: variantId, isParent: false };

          showModal('warning', 'Delete Variant?',
            `Are you sure you want to delete the variant "${variantName}"?\n\nThis action cannot be undone.`);
        }
      });

      // Updated showModal function to handle delete confirmations
      function showModal(type, title, message, autoClose = false) {
        const modal = new bootstrap.Modal(document.getElementById('messageModal'));
        const modalElement = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalIcon = document.getElementById('modalIcon');
        const modalActionBtn = document.getElementById('modalActionBtn');

        // Remove previous classes
        modalElement.classList.remove('modal-success', 'modal-error', 'modal-warning');

        // Set styles based on type
        switch (type) {
          case 'success':
            modalElement.classList.add('modal-success');
            modalIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
            modalActionBtn.className = 'btn';
            modalActionBtn.textContent = 'Continue';
            break;
          case 'error':
            modalElement.classList.add('modal-error');
            modalIcon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
            modalActionBtn.className = 'btn';
            modalActionBtn.textContent = 'Try Again';
            break;
          case 'warning':
            modalElement.classList.add('modal-warning');
            modalIcon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
            modalActionBtn.className = 'btn';
            modalActionBtn.textContent = 'Yes, Delete';
            break;
        }

        // Set content with better formatting
        modalTitle.textContent = title;
        modalMessage.innerHTML = message.replace(/\n/g, '<br>');

        // Clear previous event listeners
        const newActionBtn = modalActionBtn.cloneNode(true);
        modalActionBtn.parentNode.replaceChild(newActionBtn, modalActionBtn);

        // Set up event listener based on modal type
        if (type === 'warning') {
          newActionBtn.onclick = async function () {
            modal.hide();
            if (window.pendingDelete) {
              await deleteProduct(window.pendingDelete.id, window.pendingDelete.isParent);
              window.pendingDelete = null;
            }
          };
        } else if (type === 'success') {
          newActionBtn.onclick = function () {
            modal.hide();
            if (autoClose) {
              window.location.reload();
            }
          };

          if (autoClose) {
            setTimeout(() => {
              modal.hide();
              window.location.reload();
            }, 2000);
          }
        } else {
          newActionBtn.onclick = function () {
            modal.hide();
          };
        }

        // Show modal
        modal.show();
      }

      async function deleteProduct(id, isParent) {
        console.log("ðŸ§© Deleting:", { id, isParent });

        try {
          const response = await fetch('../php/delete_product.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `id=${id}&isParent=${isParent ? 1 : 0}`
          });

          const text = await response.text();
          console.log("ðŸ§¾ Raw response:", text);

          if (text.trim().startsWith('{')) {
            const result = JSON.parse(text);
            if (result.success) {
              const productType = isParent ? 'Parent Product' : 'Variant';
              showModal('success', `${productType} Deleted!`,
                `${productType} has been successfully deleted!\n\nThe page will refresh automatically.`,
                true);
            } else {
              showModal('error', 'Delete Failed', result.message || 'Failed to delete the product.');
            }
          } else {
            showModal('error', 'Unexpected Response', 'Server returned an unexpected response.');
          }
        } catch (error) {
          console.error('Error deleting product:', error);
          showModal('error', 'Delete Error', 'An error occurred while deleting the product.');
        }
      }

      // âœ… ADD THIS NEW FUNCTION - Client-side filtering and rendering
      function renderFilteredProducts() {
        if (!allProducts || allProducts.length === 0) return;

        const tableBody = document.getElementById('productTableBody');
        const productCountSpan = document.getElementById('productCount');
        const paginationContainer = document.querySelector('.pagination');

        // Apply filters
        let filtered = allProducts;

        // Search filter
        if (currentSearch) {
          filtered = filtered.filter(product =>
            (product.ParentName && product.ParentName.toLowerCase().includes(currentSearch)) ||
            (product.Description && product.Description.toLowerCase().includes(currentSearch)) ||
            (product.Category && product.Category.toLowerCase().includes(currentSearch))
          );
        }

        // Category filter
        if (currentCategory) {
          filtered = filtered.filter(product =>
            product.Category === currentCategory
          );
        }

        // Sorting
        filtered = sortProducts(filtered, currentSort);

        if (filtered.length === 0) {
          tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-5">
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h5>No Products Found</h5>
                        <p>Try adjusting your search or filters</p>
                    </div>
                </td>
            </tr>`;
          productCountSpan.textContent = '0';
          if (paginationContainer) paginationContainer.innerHTML = '';
          return;
        }

        // Show ALL filtered results (no pagination for filtered results)
        productCountSpan.textContent = filtered.length;

        // Render the products (using your existing rendering code)
        tableBody.innerHTML = '';
        let totalVariants = 0;

        filtered.forEach(parent => {
          const variants = parent.Variants || [];
          totalVariants += variants.length;

          const parentImage = parent.Image
            ? `<img src="${parent.Image}" alt="${parent.ParentName}" style="width80px;height:80px;object-fit:cover;border-radius:6px;">`
            : `<div class="text-muted small">No Image</div>`;

          // Parent Row (your existing code)
          const parentRow = document.createElement('tr');
          parentRow.classList.add('parent-product-row');
          parentRow.setAttribute('data-product-id', parent.ProductID);
          parentRow.setAttribute('data-bs-toggle', 'collapse');
          parentRow.setAttribute('data-bs-target', `#variants-${parent.ProductID}`);
          parentRow.setAttribute('aria-expanded', 'false');
          parentRow.style.cursor = 'pointer';

          parentRow.innerHTML = `
            <td style="vertical-align: middle;">
                <div class="d-flex align-items-center">
                    <i class="fas fa-chevron-right me-2 collapse-icon text-muted"></i>
                    ${parentImage}
                </div>
            </td>
            <td style="vertical-align: middle;">
                <span style="font-size: 14px; color: #333;">
                    ${parent.ParentName || parent.Name}
                </span>
            </td>
            <td style="vertical-align: middle;">${parent.Category || 'N/A'}</td>
            <td style="vertical-align: middle;">
                <div style="
                    max-height: 50px;
                    overflow-y: auto;
                    white-space: normal;
                    font-size: 13px;
                    padding-right: 4px;
                ">
                    ${parent.Description || 'N/A'}
                </div>
            </td>
            <td style="vertical-align: middle;">
            <span class="badge ${parent.Status.includes('No') ? 'bg-soft-red' : 'bg-success'}">
                ${parent.Status}
            </span>
            </td>
            <td class="text-nowrap" style="vertical-align: middle;">
                <div class="d-flex flex-column align-items-start gap-1">
                    <button class="btn btn-sm btn-primary edit-parent-btn" data-id="${parent.ProductID}"
                        style="padding: 2px 8px; font-size: 12px; width: 70px;">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-danger delete-parent-btn" data-id="${parent.ProductID}"
                        style="padding: 2px 8px; font-size: 12px; width: 70px;">
                        <i class="fas fa-trash-alt"></i> Delete
                    </button>
                </div>
            </td>
        `;
          tableBody.appendChild(parentRow);

          // Variants (same as your existing code)
          const variantsTableRows = variants
            .filter(v => v.ShadeOrVariant?.toUpperCase() !== 'PARENT_GROUP')
            .map(variant => {
              const variantImage = variant.Image
                ? `<img src="${variant.Image}" alt="${variant.ShadeOrVariant || variant.Name}" 
                            style="width:80px;height:80px;object-fit:cover;border-radius:4px;">`
                : `<div class="text-muted small">No Image</div>`;

              const attributesHtml = `
                    <span class="d-block text-muted small">Skin Type: <strong class="text-dark">${variant["Skin Type"] || 'N/A'}</strong></span>
                    <span class="d-block text-muted small">Skin Tone: <strong class="text-dark">${variant["Skin Tone"] || 'N/A'}</strong></span>
                    <span class="d-block text-muted small">Undertone: <strong class="text-dark">${variant["Undertone"] || 'N/A'}</strong></span>
                    <span class="d-block text-muted small">Skin Concern: <strong class="text-dark">${variant["Skin Concern"] || 'N/A'}</strong></span>
                    <span class="d-block text-muted small">Finish: <strong class="text-dark">${variant["Finish"] || 'N/A'}</strong></span>
                `;

              const statusColor = {
                'Available': 'success',
                'Low Stock': 'warning',
                'No Stock': 'danger',
                'Expired': 'secondary'
              }[variant.Status] || 'secondary';

              return `
                    <tr class="variant-row" data-product-id="${variant.ProductID}">
                        <td>${variantImage} 
                            <strong>${variant.ShadeOrVariant || variant.Name || 'Unnamed Variant'}</strong>
                        </td>
                        <td>${attributesHtml}</td>
                        <td>â‚±${parseFloat(variant.Price || 0).toFixed(2)}</td>
                        <td>${variant.Stocks || 0}</td>
                        <td>
                            <span class="badge bg-${statusColor}">
                                ${variant.Status || 'N/A'}
                            </span>
                        </td>
                        <td class="text-nowrap">
                            <div class="d-flex flex-column align-items-start gap-1">
                                <button class="btn btn-sm btn-primary edit-variant-btn" data-id="${variant.ProductID}" style="padding: 2px 8px; font-size: 12px; width: 70px;">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger delete-variant-btn" data-id="${variant.ProductID}" style="padding: 2px 8px; font-size: 12px; width: 70px;">
                                    <i class="fas fa-trash-alt"></i> Delete
                                </button>
                            </div>
                        </td>
                    </tr>`;
            }).join('');

          const variantsRow = document.createElement('tr');
          variantsRow.classList.add('collapse-row');
          variantsRow.innerHTML = `
            <td colspan="6" class="p-0 border-0">
                <div class="collapse" id="variants-${parent.ProductID}">
                    <table class="table table-sm table-nested mb-0">
                        <thead>
                            <tr class="table-light">
                                <th>Shade Name</th>
                                <th>Attributes</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody class="table-group-divider">
                            ${variantsTableRows}
                        </tbody>
                    </table>
                </div>
            </td>`;
          tableBody.appendChild(variantsRow);
        });

        productCountSpan.textContent = filtered.length;

        // Hide pagination for filtered results (since we're showing all matching products)
        if (paginationContainer) paginationContainer.innerHTML = '';

        // Re-attach collapse event listeners
        const productTableBody = document.getElementById('productTableBody');
        if (productTableBody) {
          productTableBody.querySelectorAll('.collapse').forEach(collapseEl => {
            collapseEl.addEventListener('show.bs.collapse', function () {
              const parentRow = document.querySelector(`[data-bs-target="#${this.id}"]`);
              if (parentRow) {
                const icon = parentRow.querySelector('.collapse-icon');
                if (icon) icon.classList.replace('fa-chevron-right', 'fa-chevron-down');
              }
            });

            collapseEl.addEventListener('hide.bs.collapse', function () {
              const parentRow = document.querySelector(`[data-bs-target="#${this.id}"]`);
              if (parentRow) {
                const icon = parentRow.querySelector('.collapse-icon');
                if (icon) icon.classList.replace('fa-chevron-down', 'fa-chevron-right');
              }
            });
          });
        }
      }


      function setupImagePreview(fileInput, previewElementId, imagePath = null) {
        const previewContainer = document.getElementById(previewElementId);

        // Clear previous content
        previewContainer.innerHTML = '';

        // Handle container classes (as you had before)
        if (previewElementId !== 'detailImagesPreview') {
          previewContainer.classList.remove('image-gallery-container');
        }

        // --- NEW LOGIC: Display existing image path ---
        if (imagePath && typeof imagePath === 'string') {
          // Display the existing image from the path
          previewContainer.innerHTML = `<img src="${imagePath}" alt="Existing Preview Image">`;

          // Add a delete button for the existing main image (optional, but good for UX)
          const deleteBtn = document.createElement('span');
          deleteBtn.className = 'delete-image-btn';
          deleteBtn.innerHTML = '<i class="fas fa-times"></i>';

          deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            // Clear the preview and the hidden image path input (you'll need to create this hidden input)
            previewContainer.innerHTML = `<i class="fas fa-plus placeholder-icon"></i>`;
            // You will need a hidden input here to tell the update script to DELETE the main image
            // document.getElementById('hiddenMainImagePath').value = 'DELETE';
            // Also, reset the file input visually/programmatically
            const fileInputId = previewElementId.replace('Preview', '');
            document.getElementById(fileInputId).value = '';
          });

          previewContainer.appendChild(deleteBtn);

          return; // Stop here if we successfully loaded an existing image
        }

        // --- EXISTING LOGIC: Handle file input ---

        // 1. Handle No Files Selected (and no imagePath passed)
        // Check if fileInput is null OR if no files are selected
        if (!fileInput || fileInput.files.length === 0) {
          let placeholderText = 'Image Preview';
          if (previewElementId === 'previewImagePreview') placeholderText = 'Line Preview';
          else if (previewElementId === 'variantImagePreview') placeholderText = 'Variant Shade';

          previewContainer.innerHTML = `<span class="placeholder-text">${placeholderText}</span>`;
          return;
        }


        // 2. Handle Single File (Preview & Variant Image)
        // Note: The input has NO 'multiple' attribute for the first two.
        if (!fileInput.multiple) {
          const file = fileInput.files[0];
          const reader = new FileReader();
          reader.onload = (e) => {
            previewContainer.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
          };
          reader.readAsDataURL(file);
        }

        // 3. Handle Multiple Files (Additional Images - RECTANGULAR GALLERY)
        else {
          // The container is already styled as a grid via .image-gallery-container in the HTML

          // Loop through all selected files (limiting to 4)
          Array.from(fileInput.files).slice(0, 4).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
              const img = document.createElement('img');
              img.src = e.target.result;
              img.alt = "Gallery Image";
              previewContainer.appendChild(img);
            };
            reader.readAsDataURL(file);
          });
        }
      }
      function setFormMode(mode, productID = null) {
        const title = document.getElementById('productFormTitle');
        const labelNewProduct = document.querySelector('label[for="typeNewProduct"]');
        const labelNewVariant = document.querySelector('label[for="typeNewVariant"]');
        const addBtn = document.getElementById('addProductBtn');
        const updateBtn = document.getElementById('updateProductBtn');
        const hiddenID = document.getElementById('hiddenProductID');

        if (mode === 'update') {
          // --- A. Main Title and Buttons ---
          title.innerHTML = '<i class="fas fa-edit"></i> Update Product';
          addBtn.classList.add('d-none');
          updateBtn.classList.remove('d-none');
          hiddenID.value = productID;

          // --- B. Update Radio Button Labels ---
          if (labelNewProduct) {
            labelNewProduct.textContent = 'Update Product Line';
          }
          if (labelNewVariant) {
            labelNewVariant.textContent = 'Update Variant (Shade/Size)';
          }

          // âœ… RE-ATTACH EVENT LISTENER when button becomes visible
          if (updateBtn) {
            // Remove any existing event listeners by cloning
            updateBtn.replaceWith(updateBtn.cloneNode(true));
            const newUpdateBtn = document.getElementById('updateProductBtn');

            // Add new event listener
            newUpdateBtn.addEventListener('click', handleUpdateProduct);
          }

        } else { // 'add' mode
          // --- A. Main Title and Buttons ---
          title.innerHTML = '<i class="fas fa-plus-circle"></i> Add New Product';
          addBtn.classList.remove('d-none');
          updateBtn.classList.add('d-none');
          hiddenID.value = '';

          // --- B. Restore Radio Button Labels ---
          if (labelNewProduct) {
            labelNewProduct.textContent = 'New Product Line';
          }
          if (labelNewVariant) {
            labelNewVariant.textContent = 'New Variant (Shade/Size)';
          }

          // âœ… Clear the hidden ParentProductID when in add mode
          document.getElementById('hiddenParentProductID').value = '';

          // âœ… Enable category dropdown when in add mode
          document.getElementById('productCategorySelect').disabled = false;

          // Set to default 'new product line' state
          document.getElementById('typeNewProduct').checked = true;
        }
      }

      // Separate function for update logic
      async function handleUpdateProduct(e) {
        e.preventDefault();

        const updateBtn = document.getElementById('updateProductBtn');
        if (!updateBtn) return;

        const formData = new FormData(productForm);
        const productID = document.getElementById('hiddenProductID').value;
        formData.append('ProductID', productID);

        const isParentUpdate = document.getElementById('typeNewProduct').checked;
        formData.append('isParentUpdate', isParentUpdate ? 'true' : 'false');

        const parentProductIDField = document.getElementById('hiddenParentProductID');
        if (parentProductIDField) {
          const parentProductID = parentProductIDField.value;
          formData.append('ParentProductID', parentProductID);
        }

        // Show loading state
        updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        updateBtn.disabled = true;

        try {
          const response = await fetch('../php/update_product.php', {
            method: 'POST',
            body: formData
          });

          const rawResponse = await response.text();
          console.log("ðŸ“„ RAW PHP RESPONSE:", rawResponse);

          let result;
          try {
            result = JSON.parse(rawResponse);
          } catch (jsonError) {
            console.error("âŒ JSON Parse Error");
            showModal('error', 'Server Error', 'There was a server error while updating the product. Please try again.');
            return;
          }

          if (!response.ok || result.error) {
            throw new Error(result.error || `HTTP error! status: ${response.status}`);
          }

          const productType = isParentUpdate ? 'Parent Product' : 'Variant';
          showModal('success', `${productType} Updated!`,
            `Successfully updated the ${productType.toLowerCase()}!\n\nThe page will refresh automatically.`,
            true);

        } catch (error) {
          console.error('Update failed:', error);
          showModal('error', 'Update Failed', `Failed to update product: ${error.message}`);
        } finally {
          updateBtn.innerHTML = '<i class="fas fa-save"></i> Update Product';
          updateBtn.disabled = false;
        }
      }
      // Function to populate the main form for Parent/Simple product
      function populateParentForm(data) {
        // 1. Set Form Mode & Title
        setFormMode('update', data.ProductID);

        // 2. CRUCIAL TOGGLE LOGIC:
        // Force switch to Parent Product Line mode display
        document.getElementById('typeNewProduct').checked = true;
        toggleEditFormFields(); // <-- ADD THIS LINE! This reveals the parent fields.

        // 3. Basic Fields (These should now be visible)
        document.getElementById('productName').value = data.Name || '';
        document.getElementById('productDescription').value = data.Description || '';
        document.getElementById('productIngredients').value = data.Ingredients || '';

        document.getElementById('productStock').value = data.Stocks || 0;
        document.getElementById('productPrice').value = data.Price || 0.00;
        document.getElementById('productExpiration').value = data.ExpirationDate || '';

        // 4. Category Select
        const categorySelect = document.getElementById('productCategorySelect');
        if (categorySelect.querySelector(`option[value="${data.Category}"]`)) {
          categorySelect.value = data.Category;
        } else {
          categorySelect.value = '';
        }

        // 5. Image Fields

        // 1. Preview Image (Main Image)
        // Assuming your setupImagePreview is now updated to handle imagePath (URL)
        if (data.MainImage) {
          setupImagePreview(null, 'previewImagePreview', data.MainImage);
        } else {
          // Clear the main image preview and show placeholder
          setupImagePreview(null, 'previewImagePreview');
        }

        // 2. Additional Images
        resetAdditionalImages(data.DetailImages);

        // 6. Final cleanup (only needed once)
        // setFormMode('update', data.ProductID); // REMOVE: Already called at the start
      }

      function populateVariantForm(data) {
        // 1. Set Form Mode & Title
        // Assuming you have a form mode handler for variants (or reuse setFormMode)
        setFormMode('update', data.ProductID);
        // Force switch to Variant mode display
        document.getElementById('typeNewVariant').checked = true;
        toggleEditFormFields();

        // 2. Basic Fields
        // Use the Name, Stocks, Price from the variant row
        document.getElementById('productName').value = data.Name || '';
        document.getElementById('productDescription').value = data.Description || '';
        document.getElementById('productIngredients').value = data.Ingredients || '';
        document.getElementById('productStock').value = data.Stocks || 0;
        document.getElementById('productPrice').value = data.Price || 0.00;
        document.getElementById('productExpiration').value = data.ExpirationDate || '';

        document.getElementById('productCategorySelect').disabled = true;


        // 3. Variant Fields
        document.getElementById('hexCode').value = data.HexCode || '';
        document.getElementById('productVariantName').value = data.ShadeOrVariant || '';
        document.getElementById('hiddenParentProductID').value = data.ParentProductID || '';
        // 4. Debug parent product info
        console.log("ðŸ“¦ Variant Parent Data:", {
          variantID: data.ProductID,
          variantName: data.Name,
          parentProductID: data.ParentProductID,
          parentProductName: data.ParentProductName
        });

        loadParentProducts(() => {
          const parentProductIDSelect = document.getElementById('parentProductID');
          const targetValue = data.ParentProductID;

          if (targetValue) {
            // Method 1: Direct value assignment
            parentProductIDSelect.value = targetValue;

            // Method 2: If Method 1 fails, wait a bit and try again (for async issues)
            setTimeout(() => {
              if (parentProductIDSelect.value !== targetValue) {
                console.log("ðŸ”„ Retrying dropdown selection...");
                parentProductIDSelect.value = targetValue;

                // Method 3: If still not working, force by iterating options
                if (parentProductIDSelect.value !== targetValue) {
                  for (let i = 0; i < parentProductIDSelect.options.length; i++) {
                    if (parentProductIDSelect.options[i].value === targetValue) {
                      parentProductIDSelect.selectedIndex = i;
                      break;
                    }
                  }
                }
              }

              // Final check and event trigger
              console.log("ðŸŽ¯ Final selection - Value:", parentProductIDSelect.value, "Text:", parentProductIDSelect.options[parentProductIDSelect.selectedIndex]?.text);
              parentProductIDSelect.dispatchEvent(new Event('change', { bubbles: true }));
            }, 100);
          }
        });
        // 4. Attributes (CRUCIAL REWRITE)

        // --- A. Handle Single-Value Checkboxes (0 or 1) ---
        const booleanFields = [
          'Acne',
          'Dryness',
          // CHANGE 1: Use the camelCase name for lookup
          { db: 'DarkSpots', name: 'darkSpots' },
          'Matte',
          'Dewy',
          // CHANGE 2: Use the camelCase name for lookup
          { db: 'LongLasting', name: 'longLasting' }
        ];

        booleanFields.forEach(item => {
          // Determine the lowercase name to use for the selector
          const fieldName = typeof item === 'string' ? item.toLowerCase() : item.name;
          const dbKey = typeof item === 'string' ? item : item.db;

          const element = document.querySelector(`[name="${fieldName}"]`);

          if (element && (element.type === 'checkbox' || element.type === 'radio')) {
            // Use the DB key to fetch the data value
            element.checked = (data[dbKey] == 1);
          }
        });

        // --- B. Handle Select/Dropdown (Undertone) ---
        const undertoneSelect = document.getElementById('undertone');
        if (undertoneSelect) {
          // Set the select box value directly
          undertoneSelect.value = data.Undertone || '';
        }

        // --- C. Handle Multi-Value Checkboxes (SkinType & SkinTone) ---

        // Helper function to prepare the database array for safe matching
        const prepareDBArray = (dataString) => {
          if (!dataString) return [];
          // 1. Split the string by comma
          // 2. Trim whitespace from each element
          // 3. Convert all elements to uppercase for case-insensitive matching
          return dataString.split(',')
            .map(s => s.trim().toUpperCase());
        };

        // 1. Skin Type
        const dbSkinTypes = prepareDBArray(data.SkinType);

        // Find ALL checkboxes with name="skinType[]"
        document.querySelectorAll('[name="skinType[]"]').forEach(checkbox => {
          // Check if the checkbox's uppercase value is in the cleaned DB array
          checkbox.checked = dbSkinTypes.includes(checkbox.value.toUpperCase());
        });

        // 2. Skin Tone
        const dbSkinTones = prepareDBArray(data.SkinTone);

        // Find ALL checkboxes with name="skinTone[]"
        document.querySelectorAll('[name="skinTone[]"]').forEach(checkbox => {
          // Check if the checkbox's uppercase value is in the cleaned DB array
          checkbox.checked = dbSkinTones.includes(checkbox.value.toUpperCase());
        });
        // --- D. Force Collapse to Open (Optional, but recommended for UX) ---
        // Use the function from our previous conversation if you have the Bootstrap JS available
        const attributesCollapse = document.getElementById('attributesSection');
        if (attributesCollapse) {
          // This is the correct Bootstrap 5 way:
          new bootstrap.Collapse(attributesCollapse, { toggle: false }).show();
        }
        // 5. Image (Variant Image)
        // Assuming you have an ID 'variantImagePreview' for the image box
        if (data.VariantImage) {
          setupImagePreview(null, 'variantImagePreview', data.VariantImage);
        } else {
          setupImagePreview(null, 'variantImagePreview');
        }

        // Note: The Parent Product fields (MainImage, DetailImages, CategorySelect) 
        // will remain as they were set, but the variant form should visually hide them.
        // The handleProductTypeChange() function is responsible for hiding irrelevant Parent fields.
      }

      // Function to reset and display additional images
      function resetAdditionalImages(imagePaths = []) {
        const additionalSlots = document.querySelectorAll('.image-preview-box.additional-slot');
        const imageInputs = [
          document.getElementById('detailImage1'),
          document.getElementById('detailImage2'),
          document.getElementById('detailImage3'),
          document.getElementById('detailImage4')
        ];

        imageInputs.forEach(input => input.value = ''); // Clear file inputs first

        additionalSlots.forEach((box, index) => {
          const path = imagePaths[index];
          box.innerHTML = '';

          if (path) {
            // Display the image
            box.innerHTML = `<img src="${path}" alt="Additional Image ${index + 1}">`;

            // Add delete button (no file input clear needed, as it's an existing image)
            const deleteBtn = document.createElement('span');
            deleteBtn.className = 'delete-image-btn';
            deleteBtn.innerHTML = '<i class="fas fa-times"></i>';

            deleteBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              box.innerHTML = `<i class="fas fa-plus placeholder-icon"></i>`;

              // >>> CRITICAL NEW LOGIC: ADD HIDDEN INPUT <<<
              const deletedInput = document.createElement('input');
              deletedInput.type = 'hidden';
              deletedInput.name = 'deleted_images[]'; // Array to collect all deleted paths
              deletedInput.value = path; // The path of the image being deleted
              document.getElementById('productForm').appendChild(deletedInput); // Append to the form

              console.log(`Image at index ${index} (path: ${path}) marked for deletion`);
            });

            box.appendChild(deleteBtn);

          } else {
            // Reset to plus icon
            box.innerHTML = `<i class="fas fa-plus placeholder-icon"></i>`;
          }
        });
      }

      // Event listener for the "Clear Form" button to switch back to "Add" mode
      document.getElementById('clearFormBtn').addEventListener('click', () => {
        productForm.reset();
        setFormMode('add');
      });

      document.getElementById('productTableBody').addEventListener('click', async (e) => {
        // 1. PARENT EDIT BUTTON
        if (e.target.closest('.edit-parent-btn')) {
          const btn = e.target.closest('.edit-parent-btn');
          const productID = btn.getAttribute('data-id');

          if (!productID) {
            console.error('No Product ID found for parent edit.');
            return;
          }

          // Show a loading indicator (Should happen immediately)
          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
          btn.disabled = true;

          try {
            // STEP 1: Execute the network request and DEFINE 'response'
            const response = await fetch(`../php/fetch_parent_details.php?id=${productID}`);

            if (!response.ok) {
              // If the HTTP status is bad (e.g., 404, 500)
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            // STEP 2: Process the response into JSON and DEFINE 'data'
            const data = await response.json();

            // Log the data for debugging (Good practice!)
            console.log("Parent Product Data Response:", data);

            // STEP 3: Check for application-level errors
            if (data.error) {
              console.error(data.error);
              alert('Error fetching product details: ' + data.error);
              return;
            }

            // STEP 4: Load the form with the fetched data
            populateParentForm(data);

          } catch (error) {
            console.error('Error during product fetch:', error);
            alert('An error occurred while fetching product details: ' + error.message);
          } finally {
            // Restore button state
            btn.innerHTML = '<i class="fas fa-edit"></i> Edit';
            btn.disabled = false;
          }
        }

        // 2. VARIANT EDIT BUTTON
        if (e.target.closest('.edit-variant-btn')) {
          const btn = e.target.closest('.edit-variant-btn');
          const variantID = btn.getAttribute('data-id');

          if (!variantID) {
            console.error('No Product ID found for variant edit.');
            return;
          }

          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
          btn.disabled = true;

          try {
            const response = await fetch(`../php/fetch_variant_details.php?id=${variantID}`);

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data.error) {
              alert('Error fetching variant details: ' + data.error);
              console.error(data.error);
              return;
            }

            // Load the form with the fetched variant data
            populateVariantForm(data);

          } catch (error) {
            console.error('Network error during variant fetch:', error);
            alert('A network error occurred while fetching variant details.');
          } finally {
            // Restore button state
            btn.innerHTML = '<i class="fas fa-edit"></i> Edit';
            btn.disabled = false;
          }
        }
      });


      function adjustContentForMobileHeader() {
        if (window.innerWidth < 992 && mobileHeader && mainContent) {
          const headerHeight = mobileHeader.offsetHeight;
          mainContent.style.marginTop = `${headerHeight}px`;
        } else if (mainContent) {
          mainContent.style.marginTop = "";
        }
      }

      if (hamburgerBtn && sidebar) {
        hamburgerBtn.addEventListener("click", function () {
          sidebar.classList.toggle("mobile-open");
          if (sidebarOverlay) sidebarOverlay.classList.toggle("active");
        });
        hamburgerBtn.addEventListener("click", () => setTimeout(adjustContentForMobileHeader, 300));
      }
      if (sidebarOverlay) {
        sidebarOverlay.addEventListener("click", function () {
          sidebar.classList.remove("mobile-open");
          sidebarOverlay.classList.remove("active");
        });
      }
      navLinks.forEach((link) => {
        link.addEventListener("click", function () {
          if (window.innerWidth < 992 && sidebar) {
            sidebar.classList.remove("mobile-open");
            if (sidebarOverlay) sidebarOverlay.classList.remove("active");
          }
        });
      });

      window.addEventListener("load", adjustContentForMobileHeader);
      window.addEventListener("resize", adjustContentForMobileHeader);


      function toggleFormMode(mode) {
        if (mode === 'variant') {
          parentProductGroup.classList.remove('d-none');
          productNameInput.placeholder = 'Product Name (Auto-filled from Parent)';
          productNameInput.readOnly = true;
          productNameInput.required = false;

          productCategorySelect.disabled = true;

          if (previewImageGroup) previewImageGroup.classList.add('d-none');
          if (additionalImagesGroup) additionalImagesGroup.classList.add('d-none');


          productNameInput.placeholder = 'Product Name (Auto-filled from Parent)';
          productNameInput.readOnly = true;
          productNameInput.required = false;
          productCategorySelect.disabled = true;
          productDescriptionTextarea.readOnly = false;

          loadParentProducts();

        } else {

          parentProductGroup.classList.add('d-none'); // Hide parent product select


          if (previewImageGroup) previewImageGroup.classList.remove('d-none');
          if (additionalImagesGroup) additionalImagesGroup.classList.remove('d-none');

          productNameInput.placeholder = 'Enter product name';
          productNameInput.readOnly = false;
          productNameInput.required = true;
          productCategorySelect.disabled = false;
          productDescriptionTextarea.readOnly = false;
        }
      }


      typeNewProduct.addEventListener("change", () => toggleFormMode('new'));
      typeNewVariant.addEventListener("change", () => toggleFormMode('variant'));


      loadCategories();
      toggleFormMode('new');




      function loadParentProducts(callback = null) { // Add callback parameter
        fetch("../php/fetch_parent_products.php")
          .then((res) => {
            if (!res.ok) throw new Error("Network response was not ok");
            return res.json();
          })
          .then((data) => {
            parentProductID.innerHTML = '<option value="" selected disabled>Select an existing product line</option>';
            data.forEach((product) => {
              const opt = document.createElement("option");
              opt.value = product.ProductID;
              opt.textContent = product.Name;

              opt.dataset.category = product.Category;
              opt.dataset.description = product.Description;

              parentProductID.appendChild(opt);
            });

            // âœ… CRITICAL: Execute the callback after products are loaded
            if (callback && typeof callback === 'function') {
              callback();
            }
          })
          .catch((err) => console.error("Error loading parent products:", err));
      }

      parentProductID.addEventListener('change', () => {
        const selectedOption = parentProductID.options[parentProductID.selectedIndex];
        if (selectedOption.value) {
          productNameInput.value = selectedOption.textContent;
          productCategorySelect.value = selectedOption.dataset.category;
          productDescriptionTextarea.value = selectedOption.dataset.description;
        }
      });


      productForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const productType = document.querySelector('input[name="productType"]:checked').value;

        if (!validateForm(productType)) {
          showModal('error', 'Missing Information', 'Please fill in all required fields before submitting.');
          return;
        }

        const formData = new FormData(productForm);

        // Show loading state
        const addBtn = document.getElementById('addProductBtn');
        const originalText = addBtn.innerHTML;
        addBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding Product...';
        addBtn.disabled = true;

        // DEBUG
        console.log("--- Form Data Contents ---");
        for (const [key, value] of formData.entries()) {
          if (value instanceof File) {
            console.log(`INPUT: ${key}: File - ${value.name} (${value.size} bytes)`);
          } else {
            console.log(`INPUT: ${key}: "${value}"`);
          }
        }
        console.log("--------------------------");

        // Send data to backend
        fetch("../php/add_product.php", {
          method: "POST",
          body: formData,
        })
          .then((res) => {
            return res.text().then(text => {
              console.log("HTTP Status:", res.status);

              if (!res.ok) {
                console.error("âŒ Server Error Response:", text);
                showModal('error', 'Error Adding Product', 'There was an error adding the product. Please check the console for details.');
                throw new Error("Server response status not OK: " + text);
              }
              return text;
            });
          })
          .then((response) => {
            console.log("âœ… Success:", response);

            // Parse the response to show appropriate message
            if (response.includes('New product line and first variant')) {
              const match = response.match(/Parent ID: (\w+), Variant ID: (\w+)/);
              if (match) {
                showModal('success', 'Product Line Created!',
                  `Successfully created new product line!\n\nParent Product: ${match[1]}\nFirst Variant: ${match[2]}\n\nThe page will refresh automatically.`,
                  true);
              } else {
                showModal('success', 'Product Line Created!',
                  'Successfully created new product line with first variant!\n\nThe page will refresh automatically.',
                  true);
              }
            } else if (response.includes('New variant added')) {
              const match = response.match(/Variant ID: (\w+)/);
              if (match) {
                showModal('success', 'Variant Added!',
                  `Successfully added new variant!\n\nVariant ID: ${match[1]}\n\nThe page will refresh automatically.`,
                  true);
              } else {
                showModal('success', 'Variant Added!',
                  'Successfully added new variant!\n\nThe page will refresh automatically.',
                  true);
              }
            } else {
              showModal('success', 'Success!',
                'Product operation completed successfully!\n\nThe page will refresh automatically.',
                true);
            }
          })
          .catch((err) => {
            console.error("ðŸš¨ Fetch/Network Error:", err);
            showModal('error', 'Network Error',
              'A network error occurred while adding the product. Please check your connection and try again.');
          })
          .finally(() => {
            // Restore button state
            addBtn.innerHTML = originalText;
            addBtn.disabled = false;
          });

        function validateForm(type) {
          const name = document.getElementById('productName').value.trim();
          const variantName = document.getElementById('productVariantName').value.trim();
          const categoryElement = productCategorySelect.hasAttribute('disabled')
            ? productCategoryInput
            : productCategorySelect;

          const category = categoryElement.value.trim()
          const variantImage = document.getElementById('variantImage').files.length;
          const parentProductID = document.getElementById('parentProductID').value;
          const previewImage = document.getElementById('previewImage').files.length;

          let errors = [];

          // --- Validation for ALL product types ---
          if (!name) errors.push("Product Name is required.");
          if (!variantName) errors.push("Shade/Variant Name is required.");
          if (variantImage === 0) errors.push("Variant Product Image is required.");

          // --- Conditional Validation based on Product Type ---
          if (type === 'new') {
            if (!category) errors.push("Category is required for a New Product Line.");
            if (previewImage === 0) errors.push("Preview Image is required for a New Product Line.");
          } else if (type === 'variant') {
            if (!parentProductID) errors.push("You must select a Parent Product Line for a New Variant.");
          }

          if (errors.length > 0) {
            alert("Please correct the following errors before submitting:\n" + errors.join('\n'));
            return false;
          }

          return true;
        }

        // Modal message handler
        function showModal(type, title, message, autoClose = false) {
          const modal = new bootstrap.Modal(document.getElementById('messageModal'));
          const modalElement = document.getElementById('messageModal');
          const modalTitle = document.getElementById('modalTitle');
          const modalMessage = document.getElementById('modalMessage');
          const modalIcon = document.getElementById('modalIcon');
          const modalActionBtn = document.getElementById('modalActionBtn');

          // Remove previous classes
          modalElement.classList.remove('modal-success', 'modal-error', 'modal-warning');

          // Set styles based on type
          switch (type) {
            case 'success':
              modalElement.classList.add('modal-success');
              modalIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
              modalActionBtn.className = 'btn btn-success';
              break;
            case 'error':
              modalElement.classList.add('modal-error');
              modalIcon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
              modalActionBtn.className = 'btn btn-danger';
              break;
            case 'warning':
              modalElement.classList.add('modal-warning');
              modalIcon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
              modalActionBtn.className = 'btn btn-warning';
              break;
          }

          // Set content
          modalTitle.textContent = title;
          modalMessage.textContent = message;
          modalActionBtn.textContent = type === 'error' ? 'Try Again' : 'Continue';

          // Show modal
          modal.show();

          // Auto close for success after 2 seconds
          if (autoClose && type === 'success') {
            setTimeout(() => {
              modal.hide();
              window.location.reload();
            }, 2000);
          }

          // Add event listener for the action button
          modalActionBtn.onclick = function () {
            modal.hide();
            if (type === 'success') {
              window.location.reload();
            }
          };
        }

      });
    });
    // Highlight active sidebar link based on current URL
  document.addEventListener('DOMContentLoaded', () => {
    const navLinks = document.querySelectorAll('.sidebar .nav-link');
    const currentPath = window.location.pathname.split('/').pop();

    navLinks.forEach(link => {
      const linkPath = link.getAttribute('href');
      if (linkPath === currentPath) {
        link.classList.add('active');
      } else {
        link.classList.remove('active');
      }
    });
  });
  </script>
</body>

</html>